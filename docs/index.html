<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta property="og:url" content="https://japanexchangegroup.github.io/J-Quants-Tutorial/" />
<meta property="og:type" content="website" />
<meta property="og:title" content="J-Quants-Tutorial" />
<meta property="og:description" content="（JPX）株式分析チュートリアル" />
<meta property="og:site_name" content="J-Quants-Tutorial" />
<meta property="og:image" content="https://jquants-tutorial.s3-ap-northeast-1.amazonaws.com/J-Quants-ogp.png" />
<meta name="author" content="本資料は、(株)日本取引所グループがデータサイエンスに興味のある個人向けに提供する、ITやデータ分析を活用した取引の学習を目的とした、ハンズオン形式のチュートリアルです。">
<title>株式分析チュートリアル | 日本取引所グループ</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:'Hiragino Sans',sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-weight:bold}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:"Courier New",monospace;}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
/* fix serif; body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased} */
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:'Hiragino Sans',"Noto Serif","DejaVu Serif";font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.7;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-weight:bold}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:'Hiragino Sans',"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#2d466b;text-rendering:optimizeLegibility;margin-top:1.5em;margin-bottom:1.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-weight:bold;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Courier New",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Courier New",monospace;font-size:16px;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Courier New",monospace;display:inline-block;color:rgba(0,0,0,.8);line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-weight:bold}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#2d466b;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#2d466b;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:2em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:'Hiragino Sans',"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-weight:normal}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-top:3em;margin-bottom:3em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#2d466b;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.listingblock{margin: 2em 0}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:2.25em 1em 2.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
/* fix font style; .quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-weight:bold;text-align:justify} */
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1em;line-height:1.75;word-spacing:.1em;letter-spacing:0;}
.quoteblock blockquote{margin:0;padding:0;border:0;background-color:#fff;}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#2d466b;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-weight:normal}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate;margin: 2em 0;}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock{margin: 2em 0}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock{margin: 2em 0}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>株式分析チュートリアル | 日本取引所グループ</h1>
<div class="details">
<span id="author" class="author">本資料は、(株)日本取引所グループがデータサイエンスに興味のある個人向けに提供する、ITやデータ分析を活用した取引の学習を目的とした、ハンズオン形式のチュートリアルです。</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目次</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. はじめに</a></li>
<li><a href="#_財務諸表で株価の先行きを予測しよう">2. 財務諸表で株価の先行きを予測しよう</a>
<ul class="sectlevel2">
<li><a href="#_予測対象">2.1. 予測対象</a></li>
<li><a href="#_データセットの説明">2.2. データセットの説明</a></li>
<li><a href="#_実行環境及び必要なライブラリ">2.3. 実行環境及び必要なライブラリ</a></li>
<li><a href="#_データセットの読み込み">2.4. データセットの読み込み</a></li>
<li><a href="#_データセットの可視化">2.5. データセットの可視化</a></li>
<li><a href="#_データセットの前処理">2.6. データセットの前処理</a></li>
<li><a href="#anchor-2.7">2.7. 特徴量の生成</a></li>
<li><a href="#_バックテスト用のテストデータ作成">2.8. バックテスト用のテストデータ作成</a></li>
<li><a href="#_モデルの構築">2.9. モデルの構築</a></li>
<li><a href="#_モデルの推論">2.10. モデルの推論</a></li>
<li><a href="#_予測結果に対する分析の道筋">2.11. 予測結果に対する分析の道筋</a></li>
<li><a href="#_モデルの評価">2.12. モデルの評価</a></li>
<li><a href="#_モデルの提出">2.13. モデルの提出</a></li>
</ul>
</li>
<li><a href="#_ポートフォリオを構築しよう">3. ポートフォリオを構築しよう</a>
<ul class="sectlevel2">
<li><a href="#_ニュース分析チャレンジのチュートリアルの構成">3.1. 「ニュース分析チャレンジ」のチュートリアルの構成</a></li>
<li><a href="#_ニュース分析チャレンジについて">3.2. 「ニュース分析チャレンジ」について</a></li>
<li><a href="#_予測対象_2">3.3. 予測対象</a></li>
<li><a href="#anchor-3.4">3.4. データセットの説明</a></li>
<li><a href="#_環境構築">3.5. 環境構築</a></li>
<li><a href="#anchor-3.6">3.6. バックテスト環境の構築</a></li>
<li><a href="#_シンプルなポートフォリオ組成モデルの作成">3.7. シンプルなポートフォリオ組成モデルの作成</a></li>
<li><a href="#_投稿用パッケージの作成">3.8. 投稿用パッケージの作成</a></li>
</ul>
</li>
<li><a href="#_ファンダメンタルズ分析チャレンジで作成したモデルを使用してポートフォリオを構築しよう">4. 「ファンダメンタルズ分析チャレンジ」で作成したモデルを使用してポートフォリオを構築しよう</a>
<ul class="sectlevel2">
<li><a href="#_環境設定">4.1. 環境設定</a></li>
<li><a href="#_必要なライブラリの読み込み_2">4.2. 必要なライブラリの読み込み</a></li>
<li><a href="#_データセット及び2章のモデル準備">4.3. データセット及び2章のモデル準備</a></li>
<li><a href="#_2章で作成した_predictor_py_の変更">4.4. 2章で作成した <code>predictor.py</code> の変更</a></li>
<li><a href="#_バックテスト">4.5. バックテスト</a></li>
<li><a href="#_適時開示情報を使用して特別損失銘柄を除外">4.6. 適時開示情報を使用して特別損失銘柄を除外</a></li>
<li><a href="#_投稿用パッケージの作成_2">4.7. 投稿用パッケージの作成</a></li>
</ul>
</li>
<li><a href="#_ニュースデータから特徴量を抽出しよう">5. ニュースデータから特徴量を抽出しよう</a>
<ul class="sectlevel2">
<li><a href="#_テキストからの特徴量抽出方法の紹介">5.1. テキストからの特徴量抽出方法の紹介</a></li>
<li><a href="#anchor-5.2">5.2. 実行環境</a></li>
<li><a href="#anchor-5.2.6">5.3. テキスト解析について</a></li>
<li><a href="#_ニュースデータ処理の流れ">5.4. ニュースデータ処理の流れ</a></li>
<li><a href="#_利用するテキストデータについて">5.5. 利用するテキストデータについて</a></li>
<li><a href="#_データセットの前処理_2">5.6. データセットの前処理</a></li>
<li><a href="#_テキストデータの可視化">5.7. テキストデータの可視化</a></li>
<li><a href="#_特徴量抽出機前処理機の定義">5.8. 特徴量抽出機、前処理機の定義</a></li>
</ul>
</li>
<li><a href="#_bert特徴量を用いてポートフォリオを構築しよう">6. BERT特徴量を用いてポートフォリオを構築しよう</a>
<ul class="sectlevel2">
<li><a href="#_予測対象の検討">6.1. 予測対象の検討</a></li>
<li><a href="#_lstmによる可変特徴量の統合処理">6.2. LSTMによる可変特徴量の統合処理</a></li>
<li><a href="#_合成特徴量の解析">6.3. 合成特徴量の解析</a></li>
<li><a href="#_結果の可視化">6.4. 結果の可視化</a></li>
<li><a href="#_ストラテジーへの適用の実装例">6.5. ストラテジーへの適用の実装例</a></li>
<li><a href="#_投稿用コードの実装例">6.6. 投稿用コードの実装例</a></li>
</ul>
</li>
<li><a href="#_tips集">7. tips集</a>
<ul class="sectlevel2">
<li><a href="#_コンペティションフォーラムの紹介">7.1. コンペティションフォーラムの紹介</a></li>
<li><a href="#_金融用語集">7.2. 金融用語集</a></li>
<li><a href="#_東証マネ部">7.3. 東証マネ部</a></li>
<li><a href="#_参考になる書籍">7.4. 参考になる書籍</a></li>
<li><a href="#_参考になるコンペティション">7.5. 参考になるコンペティション</a></li>
<li><a href="#_ファンダメンタルズ分析の活用方法">7.6. ファンダメンタルズ分析の活用方法</a></li>
<li><a href="#_テクニカル分析の活用方法">7.7. テクニカル分析の活用方法</a></li>
<li><a href="#_ファクター分析の活用方法">7.8. ファクター分析の活用方法</a></li>
<li><a href="#_複数個のモデルの出力をアンサンブルするアプローチ">7.9. 複数個のモデルの出力をアンサンブルするアプローチ</a></li>
<li><a href="#_プライベート期間の性能の向上のために考慮すべきこと">7.10. プライベート期間の性能の向上のために考慮すべきこと</a></li>
<li><a href="#_本コンペでは利用できないがモデルを将来的に発展させるために検討する価値のある外部データ">7.11. 本コンペでは利用できないが、モデルを将来的に発展させるために検討する価値のある外部データ</a></li>
<li><a href="#_モデルの再学習の運用について">7.12. モデルの再学習の運用について</a></li>
<li><a href="#_google_colaboratoryの使用法">7.13. Google Colaboratoryの使用法</a></li>
<li><a href="#_内国株の売買制度">7.14. 内国株の売買制度</a></li>
<li><a href="#_バックテスト用ライブラリ">7.15. バックテスト用ライブラリ</a></li>
</ul>
</li>
<li><a href="#_j_quantsapi">8. J-QuantsAPI</a>
<ul class="sectlevel2">
<li><a href="#_概要">8.1. 概要</a></li>
<li><a href="#_apiの利用">8.2. APIの利用</a></li>
<li><a href="#_必要なパッケージのインポート">8.3. 必要なパッケージのインポート</a></li>
<li><a href="#_refresh_api">8.4. Refresh API</a></li>
<li><a href="#_共通で使用するメソッド">8.5. 共通で使用するメソッド</a></li>
<li><a href="#_stock_lists_api">8.6. Stock Lists API</a></li>
<li><a href="#_prices_api">8.7. Prices API</a></li>
<li><a href="#_stock_fins_api">8.8. Stock Fins API</a></li>
<li><a href="#_stock_labels_api">8.9. Stock Labels API</a></li>
<li><a href="#_news_api">8.10. News API</a></li>
<li><a href="#_tdnet_api">8.11. TDnet API</a></li>
</ul>
</li>
<li><a href="#_チュートリアル作成環境の参考文献">9. チュートリアル作成環境の参考文献</a>
<ul class="sectlevel2">
<li><a href="#_商標">9.1. 商標</a></li>
</ul>
</li>
<li><a href="#_ライセンス">10. ライセンス</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>本​チュー​ト​リ​ア​ル​に​関​し​て​の​ご​質​問​は、​SIGNATE​に​て​開​催​中​の​コ​ン​ペ​ティ​ショ​ン​サ​イ​ト​( <a href="https://signate.jp/competitions/443" class="bare">https://signate.jp/competitions/443</a> )​の​フォー​ラ​ム​に​お​き​ま​し​て、新規のスレッド（ディスカッション）にて​ご​質​問​し​て​い​た​だ​け​ま​す​と​幸​い​で​す。</p>
</div>
<div class="paragraph">
<p>また、本チュートリアルに関してのご要望があれば、Githubリポジトリ( <a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial" class="bare">https://github.com/JapanExchangeGroup/J-Quants-Tutorial</a> )の <code>Issues</code> からご意見をいただけますと幸いです。 (なお、投稿の際には、過去に同じご要望がないかご確認ください。)</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>更新履歴</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>2021-01-29: 初版リリース
2021-02-05: 誤字や表記の修正を中心に改良
2021-02-12: ランタイム環境のデータの扱い、GoogleColaboratoryについて追記
2021-02-19: predictor.pyの修正、stocklabelsAPIの修正
2021-02-26: 予測対象のエッジケースにおいて追記
2021-03-19: 問題２のチュートリアルを追加
2021-03-29: 問題２のチュートリアルを一部修正
2021-04-09: backtest.pyの修正（株式分割の対応）
2021-04-16: ３章の加筆</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">1. はじめに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>証券市場では、長年、様々なデータや数学的手法を用いて市場を分析したり、金融商品の組成や投資戦略の立案が行われたりしてきました。以前はこのような分析を行うことができるのは、金融機関や機関投資家と呼ばれる大手の投資家に限られてきました。しかし近年では、個人の方にも、ITやデータを活用した金融市場の分析や取引が拡大しています。</p>
</div>
<div class="paragraph">
<p>日本取引所グループは、証券分野におけるデータ活用や人工知能の活用を発展させたいと考えています。日本においてもさまざまなデータの活用やデータサイエンティストの育成が推進されていますが、金融分野に特化したチュートリアルの作成やコンペティションはあまり行われてきていませんでした。</p>
</div>
<div class="paragraph">
<p>そこで、日本取引所グループは、投資にまつわるデータ・環境を提供し、個人投資家の皆様によるデータ利活用の可能性を検証するための実証実験プロジェクトとして、J-Quantsを立ち上げました。本プロジェクトでは、「ファンダメンタルズ分析チャレンジ」と「ニュース分析チャレンジ」の2本のコンペティションの開催を予定しています。本ページでは、これらのコンペティションに係る学習環境という位置付けで、ハンズオン形式のチュートリアルを提供します。本チュートリアルを学ぶことで、データサイエンスを活用した株価予測を行う際に、最低限必要な知識や実践方法を学ぶことができます。</p>
</div>
<div class="paragraph">
<p>本コンペティションは幅広い方にご参加いただけることを期待していますが、プログラミングの経験があり確率・統計の基礎などを勉強された学生の方や、他分野でのデータ分析経験をお持ちの社会人の方、金融分野での知見はあるがデータサイエンスについてこれから勉強をされたいと考えている社会人の方には特に楽しんでいただける内容となっています。</p>
</div>
<div class="paragraph">
<p>本チュートリアル及び本コンペティションを通じて金融データやデータ分析について理解を深めていただき、ポートフォリオ分析や資産運用に活用いただきたいと考えています。また、データサイエンスを学ぶ学生の方々にとっては、金融データを用いたデータ活用や人工知能の活用に関する研究にも興味を持っていただきたいと考えています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="注記"></i>
</td>
<td class="content">
本プロジェクトの概要やハンズオンで使うソースコード類は以下のページで公開しています。
</td>
</tr>
</table>
</div>
<table class="tableblock frame-ends grid-none stripes-even stretch">
<colgroup>
<col style="width: 66.6666%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロジェクト概要</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.jpx-jquants-info.com/" class="bare">https://www.jpx-jquants-info.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">チュートリアル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial" class="bare">https://github.com/JapanExchangeGroup/J-Quants-Tutorial</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jupyterノートブック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/" class="bare">https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">J-QuantsAPI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://jpx-jquants.com/" class="bare">https://jpx-jquants.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファンダメンタルズ分析チャレンジ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/423" class="bare">https://signate.jp/competitions/423</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ニュース分析チャレンジ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/443" class="bare">https://signate.jp/competitions/443</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_財務諸表で株価の先行きを予測しよう">2. 財務諸表で株価の先行きを予測しよう</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章では、J-Quantsで開催するコンペティションのうち、「ファンダメンタルズ分析チャレンジ」（https://signate.jp/competitions/423）に係るチュートリアルを提供します。本コンペティションでは、データ分析や株式取引には興味はあるが、きっかけがないという方を主な対象として、投資にまつわるデータ・環境を提供し、株式市場におけるデータ利活用の可能性を試していただくことを期待しています。</p>
</div>
<div class="paragraph">
<p><strong>スケジュール</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>日時</strong></th>
<th class="tableblock halign-left valign-top"><strong>内容</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年1月29日（金）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンペティション開始</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年3月28日（日）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデル提出締切</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年3月29日（月） 〜 6月14日（月）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデル評価期間</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年7月頃</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入賞者の決定</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>本コンペティションでは、東証上場企業（普通株式のみ。ETF及びREITは除きます。）が、決算短信（本資料では、四半期決算短信や訂正開示等を総称し、決算短信と表記します。）を発表した後の20営業日の間における、当該企業の株価の最高値及び最安値を、銘柄情報・株価情報・ファンダメンタル情報等を用いて予測いただきます。</p>
</div>
<div class="paragraph">
<p><strong>コンペティションの概要</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>項目</strong></th>
<th class="tableblock halign-left valign-top"><strong>内容</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンペティション名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファンダメンタルズ分析チャレンジ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">主な対象者</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式市場を対象としたデータ分析の初学者</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力内容（利用データ）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄情報・株価情報・ファンダメンタル情報等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力内容（予測対象）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各東証上場企業が、決算短信を発表した後の20営業日の間における、当該企業の株価の最高値及び最安値</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">参加を通じて得られる知見</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- 株価や企業業績の推移などの時系列データの解析手法<br>
- 市場動向の把握手法<br>
- リスク分析</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>本章の構成は、まず、2.1節にて、本コンペティションにおける予測対象等の詳細について説明し、2.2節にて、本コンペティションで提供するデータセットの仕様について説明します。そして、2.3節以降で、本コンペティションのベースラインモデルの開発からモデル提出までの一連のフローを説明します。</p>
</div>
<div class="sect2">
<h3 id="_予測対象">2.1. 予測対象</h3>
<div class="paragraph">
<p>本コンペティションの予測対象は、東証上場企業が、決算短信を発表した後の20営業日の期間における、当該企業の株価の最高値及び最安値です。 上場企業は決算期末を含め四半期毎に決算内容が定まった際、決算内容の開示が義務付けられています。決算の内容として開示される決算短信には財務諸表が添付されており、財務諸表は企業のファンダメンタル情報を含む複数の表で構成されています。</p>
</div>
<div class="paragraph">
<p>2.1.1項では予測対象の銘柄について、2.1.2項では予測対象の決算短信について、2.1.3項では本コンペティションの評価方法について、2.1.4項では本コンペティションのリーダーボードの仕様について、2.1.5項では決算短信と財務諸表の概要について、それぞれ説明します。</p>
</div>
<div class="sect3">
<h4 id="_予測対象の銘柄">2.1.1. 予測対象の銘柄</h4>
<div class="paragraph">
<p>本コンペティションの予測対象となる銘柄は、次に挙げる条件を全て満たします。</p>
</div>
<div class="paragraph">
<p>A)	2020年12月末日時点で、東京証券取引所に上場していること</p>
</div>
<div class="paragraph">
<p>B)	普通株式であること（種類株ではないこと）</p>
</div>
<div class="paragraph">
<p>C)	ETF、ETN、REIT、優先出資証券、インフラファンド、外国株のいずれにも該当しないこと</p>
</div>
<div class="paragraph">
<p>D)	2020年12月末日時点で、上場後2年を経過していること</p>
</div>
</div>
<div class="sect3">
<h4 id="_予測対象の決算短信">2.1.2. 予測対象の決算短信</h4>
<div class="paragraph">
<p>本コンペティションでは、2021年3月27日から同年5月15日の期間中に開示された決算短信を対象に、その開示日から起算して20営業日を経過した期間における、各銘柄の最高値及び最安値を予測します。厳密には、本コンペティションで予測対象となる決算短信は、次に挙げる条件を全て満たします。</p>
</div>
<div class="paragraph">
<p>A)	直近の決算期末または四半期期末に係る決算短信であること</p>
</div>
<div class="paragraph">
<p>B)	2021年3月27日から同年5月15日までの期間に開示されていること</p>
</div>
<div class="paragraph">
<p>C)	開示日及び同日から起算して20営業日を経過した日までの期間、訂正開示等が行われていないこと</p>
</div>
<div class="paragraph">
<p>D)	開示日及び同日から起算して20営業日を経過した日までの期間、上場廃止になっていないこと</p>
</div>
<div class="paragraph">
<p>条件Cに示す「訂正開示等」とは、決算発表資料の訂正、業績予想の修正・予想値と決算値との差異等、配当予想・配当予想の修正にかかる開示を指します。これらの詳細については、以下のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>決算発表資料の訂正<br>
決算短信等を開示した後に、開示した内容について、変更又は訂正すべき事情が生じた場合に義務付けられている訂正開示をいいます。</p>
</li>
<li>
<p>業績予想の修正・予想値と決算値との差異等<br>
売上高や営業利益、経常利益、当期純利益等について、公表がされた直近の予想値等と比較して、新たに算出した予想値または決算における数値に一定以上の差異が生じた場合に義務付けられている開示をいいます。</p>
</li>
<li>
<p>配当予想・配当予想の修正<br>
公表がされた直近の配当の予想値と比較して、新たに算出した予想値に差異が生じた場合を含め、剰余金の配当について予想値を算出した場合に義務付けられている開示をいいます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、上記の決算短信の訂正開示等が、ファンダメンタル情報（stock_fin）の変更を伴い、かつ、次に挙げる条件を全て満たす場合、これも予測対象に含まれます。</p>
</div>
<div class="paragraph">
<p><span class="line-through">E)直近の決算期末または四半期期末に係る決算短信に対する訂正開示等であること</span></p>
</div>
<div class="paragraph">
<p>F)	2021年3月27日から同年5月15日までの期間に開示されていること</p>
</div>
<div class="paragraph">
<p>G)	訂正開示等の開示日及び同日から起算して20営業日を経過した日までの期間、当該開示に対する訂正開示等が行われていないこと</p>
</div>
<div class="paragraph">
<p>H)	訂正開示等の開示日及び同日から起算して20営業日を経過した日までの期間、上場廃止になっていないこと</p>
</div>
<div class="paragraph">
<p>なお、ある同一銘柄について、これらの条件を満たす決算短信が複数存在する場合は、最も新しく開示されたもののみを予測の対象とします。</p>
</div>
<div class="paragraph">
<p>（追記：予測対象期間の20営業日の全てにおいて、株価が存在しない銘柄は、評価の対象外とします。）</p>
</div>
<div class="paragraph">
<p>以上を踏まえ、各決算短信等（訂正開示等を含みます。）が予測対象に該当するかどうかの事例を、図に示します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/predict_target.png" alt="predict_target">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_評価方法">2.1.3. 評価方法</h4>
<div class="paragraph">
<p>本コンペティションでは、モデルの予測と真の値（決算短信の開示後から起算して20営業日以内に発生する最高値及び最安値）との順位相関係数（算出式１）による定量評価方法を採用します。<br></p>
</div>
<div class="paragraph">
<p>先ず、最高値もしくは最安値への変化率について、（算出式１）を用いてそれぞれスピアマンの順位相関係数を計算します。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>（算出式１）順位相関係数の計算</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/math-sample1.svg" alt="math sample1" width="170" height="57">
</div>
</div>
<div class="paragraph">
<p>d = 対応するXとYの値の順位の差</p>
</div>
<div class="paragraph">
<p>n = 値のペアの数</p>
</div>
<div class="paragraph">
<p>dのXとYは、</p>
</div>
<div class="paragraph">
<p>X = 該当期間の決算日に対して出力されたモデルのスコア（予測値）</p>
</div>
<div class="paragraph">
<p>Y = 決算短信の開示後から起算して20営業日以内に発生した最高値もしくは最安値への変化率</p>
</div>
</div>
</div>
<div class="paragraph">
<p>(式は一部英語Wikipediaスピアマンの順位相関係数より引用 <a href="https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%94%E3%82%A2%E3%83%9E%E3%83%B3%E3%81%AE%E9%A0%86%E4%BD%8D%E7%9B%B8%E9%96%A2%E4%BF%82%E6%95%B0">https://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient</a>)</p>
</div>
<div class="paragraph">
<p>その上で、それぞれの順位相関係数を以下の（算出式２）を用いて算出した統合スコアを最終スコアとして評価します。<br>
なお、最終スコアは0～8の値をとり、精度が高いほど <strong>小さな値</strong> となります。
（ただし、予測対象期間の20営業日の全てにおいて、株価が存在しない銘柄は、評価の対象外とします。）</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>（算出式２）最終スコアの計算</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/math-sample2.svg" alt="math sample2" width="291" height="33">
</div>
</div>
<div class="paragraph">
<p>P_high : 最高値の順位相関係数</p>
</div>
<div class="paragraph">
<p>P_low : 最安値の順位相関係数</p>
</div>
</div>
</div>
<div class="paragraph">
<p>今回、順位相関係数を採用する理由としては、以下の説明にもあるとおり、金融商品の価格変動の変化率の分布は必ずしも正規分布になるとは限りません。
そのため、本コンペティションでは、特定の分布を仮定しない順位相関係数を採用しています。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>一定間隔刻みで集計した騰落率の度数（頻度）分布が、騰落率の平均値を中心軸として左右対称の釣り鐘型の形状になる分布 (正規分布＝Normal Distribution) では、「平均値±標準偏差」の範囲に全データの約7割が収まるという確率的な特性を持ちます。ただし、金融商品の価格変動が厳密な意味での正規分布に従うことは実際上ほとんどありません。このため、「平均±標準偏差の範囲に騰落率の約7割が収まる」という考え方は理論的な目安に過ぎなく、発生確率は低いものの標準偏差を大幅に超す価格変動も起こりえます。こうした価格変動のリスクをテールリスクと呼び、とくに、金融市場の混乱期には分布がマイナス方向に偏るケースや、裾が極端に広く厚い"ファット・テール"という現象が確認できます。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>(野村証券証券用語解説集より引用 <a href="https://www.nomura.co.jp/terms/japan/hi/A02397.html" class="bare">https://www.nomura.co.jp/terms/japan/hi/A02397.html</a>)</p>
</div>
<div class="paragraph">
<p>本コンペにおいても、例えば新型コロナウイルス感染症 (COVID-19)のような外部影響を受け、マーケットの変化率の分布が歪む期間が存在すると想定されます。したがって、順位相関係数は相関係数と比較して特定の分布を仮定しないことから、本コンペティションにおいては、より適した評価方法であると考えられます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_リーダーボード">2.1.4. リーダーボード</h4>
<div class="paragraph">
<p>一般的に、データ分析コンペティションにおけるリーダーボード（Leaderboard）とは、コンペティション参加者の投稿内容に対する評価（スコア、実行時間等）をランキング形式で並べる表を意味します。本コンペティションで提供するリーダーボードは、パブリックリーダーボード（以下、Public LB）とプライベートリーダーボード（以下、Private LB）の2つで構成されます。以下では、それぞれのリーダーボードの仕様等について説明します。</p>
</div>
<div class="paragraph">
<p>まず、本コンペティションのPublic LBは、コンペティション開催日より過去の期間を対象として評価を実施します。具体的には、本コンペティションのPublic LBでは、2020年1月1日（水）〜2020年11月30日（月）の期間中に開示された決算短信等を対象に、開示日より起算して20営業日を経過した期間における最高値及び最安値を予測します。</p>
</div>
<div class="paragraph">
<p>過去の各銘柄の株価は、各Webサイト等で取得可能であることから、本コンペティションのPublic LBではチーティングが容易という特徴があります。そのため。本コンペティションのPublic LBは、他の一般的なPublic LBとは異なり、スコアや実行時間を競うというよりは、モデルが正常に投稿できることを確認するための環境として位置付けられています。</p>
</div>
<div class="paragraph">
<p>次に、本コンペティションのPrivate LBについて説明します。本コンペティションでは、モデル提出締切日よりも将来のデータを用いて、Private LBを出力します。具体的には、本コンペティションのPrivate LBでは、2021年3月27日（土）〜2021年5月15日（土）に開示された決算短信を対象に、その開示日から起算して20営業日を経過した期間における最高値及び最安値を予測します。</p>
</div>
<div class="paragraph">
<p>また、この予測に当たっては、決算短信の開示日の期間に応じて5回に分けて実施し、最終的な順位は5回目の評価で決定します。(評価の計算は5回行われますが、最後の1回を除く4回は途中経過をリーダーボードでご確認いただけるように計算しているものになります。)</p>
</div>
<div class="paragraph">
<p>この5回の評価のスケジュールは次を予定しております。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5月10日（月）に3月27日（土）〜4月5日（月）分の財務諸表の評価</p>
</li>
<li>
<p>5月17日（月）に3月27日（土）〜4月12日（月）分の財務諸表の評価</p>
</li>
<li>
<p>5月24日（月）に3月27日（土）〜4月19日（月）分の財務諸表の評価</p>
</li>
<li>
<p>5月31日（月）に3月27日（土）〜4月26日（月）分の財務諸表の評価</p>
</li>
<li>
<p>6月14日（月）に3月27日（土）〜5月15日（土）分の財務諸表の評価</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上を踏まえ、本コンペティションにおけるPublic LBとPrivate LBの概要を、表に示します。</p>
</div>
<div class="paragraph">
<p><strong>本コンペティションにおけるリーダーボードの仕様</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>項目</strong></th>
<th class="tableblock halign-left valign-top"><strong>Public LB</strong></th>
<th class="tableblock halign-left valign-top"><strong>Private LB</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用途</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデルが正常に投稿できることを確認するための環境</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本コンペティションの最終的なランキングを表示</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象となる決算短信の開示日の期間</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2020年1月1日（水）〜2020年11月30日（月）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年3月27日（土）〜2021年5月15日（土）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象となる決算短信の開示日の条件</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄の各四半期ごとに一番開示日が新しい開示　</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.2項に示すとおり</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測内容</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算短信の開示日から起算して20営業日を経過した期間における、各銘柄の最高値及び最安値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同左</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">評価方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.3項に示す評価方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.3項に示す評価方法を、5回の決算短信開示期間に応じて実施</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_決算短信財務諸表">2.1.5. 決算短信・財務諸表</h4>
<div class="paragraph">
<p>上場企業の株価は、各社の経営状態等を反映して日々刻々と変化します。そのため、金融商品市場において公正な価格形成と円滑な流通を確保するためには公平で適時、適切な情報開示が必要不可欠なものとなっています。</p>
</div>
<div class="paragraph">
<p>東京証券取引所では、投資者が投資判断を行ううえで必要な会社情報を、迅速、正確かつ公平に提供するための制度として、適時開示制度を設けており、上場企業は、報道機関等を通じてあるいはTDnet（適時開示情報伝達システム）により直接に、広く、かつタイムリーに伝達することという特徴があります。適時開示制度の下で上場企業が開示する資料のことを、適時開示資料と呼びます。適時開示資料とそのメタデータ（タイトル、開示日時等）を総称して適時開示情報と呼び、適時開示情報は「<a href="https://www.release.tdnet.info/inbs/I_main_00.html">適時開示情報閲覧サービス</a>」で開示されます。下図に投資家における適時開示資料の代表的な用途を示します。</p>
</div>
<div class="paragraph">
<p><strong>投資家における適時開示資料の代表的な用途</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/structure.png" alt="structure">
</div>
</div>
<div class="paragraph">
<p>(開示資料と翻訳より引用 <a href="https://aamt.info/wp-content/uploads/2019/11/%E3%83%91%E3%83%8D%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3_%E5%B1%B1%E8%97%A4%E6%95%A6%E5%8F%B2%E6%B0%8F_AAMT2019Tokyo-1.pdf" class="bare">https://aamt.info/wp-content/uploads/2019/11/%E3%83%91%E3%83%8D%E3%83%AB%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3_%E5%B1%B1%E8%97%A4%E6%95%A6%E5%8F%B2%E6%B0%8F_AAMT2019Tokyo-1.pdf</a>)</p>
</div>
<div class="paragraph">
<p>上場企業が開示を義務付けられている適時開示資料の一つに、決算短信があります。決算短信とは、決算発表及び四半期決算発表を行う際に、決算内容の要点をまとめた書類のことです。本資料では、決算発表時に開示する決算短信と、四半期決算発表時に開示する四半期決算短信を総称して、決算短信と呼びます。上場企業は、決算期末を含め四半期毎に決算内容が定まった際、決算内容の開示が義務付けられています。四半期決算短信については、金商法に基づく四半期報告書の法定提出期限が45日とされていることから、また、決算短信については、決算期末後45日以内に決算の内容を開示することを東証が要請していることから、決算短信等の多くは期末後45日以内に開示されています。決算短信の作成要領等は、下記Webサイトで公開されています。</p>
</div>
<div class="paragraph">
<p>決算短信作成要領・四半期決算短信作成要領 | 日本取引所グループ<br>
<a href="https://www.jpx.co.jp/equities/listed-co/format/summary/index.html" class="bare">https://www.jpx.co.jp/equities/listed-co/format/summary/index.html</a></p>
</div>
<div class="paragraph">
<p>決算の内容として開示される決算短信は、大きく、サマリー情報と添付資料で構成されます。<br></p>
</div>
<div class="paragraph">
<p>サマリー情報は、投資者の投資判断に重要な影響を与える上場会社の決算の内容について、その要点の一覧性及び比較可能性を確保する観点から、簡潔に取りまとめたものとして、参考様式に基づいて東証が作成を要請している資料です。<br></p>
</div>
<div class="paragraph">
<p>添付資料とは、サマリー情報に記載される主要な決算数値を投資者が適切に理解できるようにする目的で作成される、経営成績・財政状態の概況、今後の見通し、財務諸表、主な注記等を記載した資料です。</p>
</div>
<div class="paragraph">
<p>前述のとおり、決算短信には、財務諸表が添付されています。財務諸表とは、財政状態、経営成績及びキャッシュ・フローの状況を外部の情報利用者に明らかにするためのもので、有価証券届出書や有価証券報告書等に記載される財務計算に関する書類のうち、貸借対照表、損益計算書、株主資本等変動計算書、キャッシュ・フロー計算書の総称を指します。これらの内、貸借対照表、損益計算書、キャッシュ・フロー計算書の3つは、総称して「財務三表」と呼ばれており、上場企業に対する投資判断において特に重要視されています。財務三表の読み方については、下記Webサイトが参考になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>投資に不可欠な財務三表の見方 | 東証マネ部！
<a href="https://money-bu-jpx.com/news/article022723/" class="bare">https://money-bu-jpx.com/news/article022723/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、各上場企業の決算発表予定日（決算短信の開示予定日）は、下記JPXのWebサイトにて随時公開されています。投資家の投資判断において、各上場企業の決算発表は特に重要視されていることから、当該Webサイトは多くの投資家より注目を集めていると推察されます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>決算発表予定日 | 日本取引所グループ
　
<a href="https://www.jpx.co.jp/listing/event-schedules/financial-announcement/index.html" class="bare">https://www.jpx.co.jp/listing/event-schedules/financial-announcement/index.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上のとおり、本コンペティションで予測対象の起点となる決算短信には、各上場企業の重要な決算内容が記されています。本コンペティションでは、決算短信に含まれる財務諸表から抽出したファンダメンタル情報をコンペティションページ若しくは専用のAPIにおいて配信しており、これを用いることで株価の先行きを予測していただきます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセットの説明">2.2. データセットの説明</h3>
<div class="paragraph">
<p>ここでは、コンペティションで提供している各データについて説明します。提供されるデータは以下の5種類です。</p>
</div>
<div class="paragraph">
<p><strong>データ概要</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>ファイル名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄の情報が記録されたデータ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄の株価情報（始値・高値・安値・終値等）が記録されたデータ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_fin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄のファンダメンタル情報（決算数値データや配当データ等）が記録されたデータ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_fin_price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データが扱いやすいようにstock_price及びstock_finをマージしたデータ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_labels</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本コンペティションで学習に用いるラベル（目的変数）が記録されたデータ</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>提供データについては、2016年1月初から2020年12月末をcsvファイル形式、2021年１月初からのデータについては、本コンペティション専用のAPIにて提供いたします。APIによるデータ取得につきましては、8章をご参照ください。</p>
</div>
<div class="sect3">
<h4 id="_銘柄情報_stock_list">2.2.1. 銘柄情報: stock_list</h4>
<div class="paragraph">
<p>stock_listは、銘柄の名前や業種区分などの基本情報が含まれています。発行済株式数は、会社が発行することをあらかじめ定款に定めている株式数（授権株式数）のうち、会社が既に発行した株式数のことです。発行済株式数と株価とかけ合わせて時価総額を計算することができます。時価総額は企業価値を評価する際に用いられる重要な指標です。業種区分情報は、マーケットにおける業種別の平均などを計算する時に役立つ情報です。33業種は証券コード協議会が定めており、17業種はTOPIX-17シリーズとして「投資利便性を考慮して17業種に再編したもの」(JPX東証33業種別株価指数・TOPIX-17シリーズファクトシートより引用 <a href="https://www.jpx.co.jp/markets/indices/line-up/index.html" class="bare">https://www.jpx.co.jp/markets/indices/line-up/index.html</a>) です。</p>
</div>
<div class="paragraph">
<p>「業種」(JPX用語集より引用 <a href="https://www.jpx.co.jp/glossary/ka/112.html" class="bare">https://www.jpx.co.jp/glossary/ka/112.html</a>)</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prediction_target</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象銘柄</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Effective Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄情報の基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20201030</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1301</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name (English)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KYOKUYO CO.,LTD.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Section/Products</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">市場・商品区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First Section (Domestic)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">33 Sector(Code)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の33業種区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">33 Sector(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の33業種区分(名前)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fishery, Agriculture and Forestry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17 Sector(Code)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の17業種区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17 Sector(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の17業種区分(名前)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOODS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size Code (New Index Series)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIXニューインデックスシリーズ規模区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size (New Index Series)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIXニューインデックスシリーズ規模区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIX Small 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote AccountingStandard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会計基準 単独:NonConsolidated、連結国内:ConsolidatedJP、連結SEC:ConsolidatedUS、連結IFRS:ConsolidatedIFRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConsolidatedJP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2020/11/06</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote IssuedShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">発行済株式数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10928283.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(JPX東証上場銘柄一覧より引用 <a href="https://www.jpx.co.jp/markets/statistics-equities/misc/01.html" class="bare">https://www.jpx.co.jp/markets/statistics-equities/misc/01.html</a>)<br>
(Quick xignite API Market Data API Catalogより引用 <a href="https://www.marketdata-cloud.quick-co.jp/Products/" class="bare">https://www.marketdata-cloud.quick-co.jp/Products/</a>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_stock_list.png" alt="sample_stock_list">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_株価情報_stock_price">2.2.2. 株価情報 : stock_price</h4>
<div class="paragraph">
<p>stock_priceには各銘柄の各日付の始値や終値などの株価情報が記録されています。テクニカル分析などで終値ベースの分析を実施する場合は、ExchangeOfficialCloseを利用します。<br>
ここでいうテクニカル分析というのは、マーケットデータから計算される指標に基づいた分析のことです。また、終値ベースの分析とは、マーケットデータの中でも、終値のみを用いた分析を表しています。</p>
</div>
<div class="paragraph">
<p>株価情報は、「株式分割」や「株式併合」が発生した際に生じる株価の変動を、株式数の変化率に応じて調整されています。特徴量の定義によっては、その日付時点で実際に取引された株価や出来高を取得したい場合がありますが、その場合は累積調整係数を使用して<br>
 <code>[調整前株価] = [調整済株価] * [累積調整係数]</code> 及び <code>[調整前出来高] = [調整済出来高] / [累積調整係数]</code> <br>
 という計算で算出可能です。<br>
「株式分割」(JPX用語集より引用 <a href="https://www.jpx.co.jp/glossary/ka/81.html" class="bare">https://www.jpx.co.jp/glossary/ka/81.html</a>)<br>
「株式併合」(JPX用語集より引用 <a href="https://www.jpx.co.jp/glossary/ka/83.html" class="bare">https://www.jpx.co.jp/glossary/ka/83.html</a>)</p>
</div>
<div class="paragraph">
<p><strong>ただし、これらの特徴量をモデルに使用する場合には注意が必要です。</strong></p>
</div>
<div class="paragraph">
<p>履歴データの累積調整係数は過去のある日時点では知り得ない未来の情報を含んでいることに注意する必要があります。具体的には、過去のある日時点の累積調整係数が2である場合、その日以降に1:2の株式分割が発生していることがわかります。</p>
</div>
<div class="paragraph">
<p>一般に株式分割は流動性向上を期待できるポジティブなイベントとみなされています。仮に、モデル学習時に累積調整係数をモデルへ入力し、モデルが累積調整係数が大きい銘柄は未来の株価が上がる傾向があるということを学習し、履歴データを使用したバックテストでは良い結果がでたとします。しかし、このモデルに最新データを入力して予測を出力した場合、その予測は期待する結果を得られない可能性があります。なぜなら、最新データの累積調整係数にはまだ発生していない未来の情報は含まれていないためです。</p>
</div>
<div class="paragraph">
<p>このように、その日付時点では取得できない未来の情報をモデルに入力することをリークといい、時系列データには累積調整係数のようにその日付時点では取得できない情報が含まれていることがあるため、リークにはとくに注意する必要があります。</p>
</div>
<div class="paragraph">
<p><strong>データの特性</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>マーケットが開いている日に取引が成立しなかった銘柄は、売買高が0となり、四本値 (始値、高値、安値、終値) 全てが0と表示されます。</p>
</li>
<li>
<p>stock_priceのデータは、そのデータに含まれている最新日付時点で累積調整係数1となるように調整されます。調整済み株価についても同様に過去に遡って更新されます。</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1301</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote Open</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">始値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">高値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2820</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">安値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2740</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote Close</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">終値。大引け後にセットされる</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2750</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote ExchangeOfficialClose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取引所公式終値。最終の特別気配または最終気配を含む終値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2750</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote Volume</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売買高</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote CumulativeAdjustmentFactor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">累積調整係数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote PreviousClose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回の終値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2770</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote PreviousCloseDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回の終値が発生した日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015/12/30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote PreviousExchangeOfficialClose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回の取引所公式終値</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2770</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote PreviousExchangeOfficialCloseDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">前回の取引所公式終値が発生した日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015/12/30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote ChangeFromPreviousClose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">騰落幅。前回終値と直近約定値の価格差</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote PercentChangeFromPreviousClose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">騰落率。前回終値からの直近約定値の上昇率または下落率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-0.722</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EndOfDayQuote VWAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売買高加重平均価格(VWAP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2778.25</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(Quick xignite API Market Data API Catalogより引用 <a href="https://www.marketdata-cloud.quick-co.jp/Products/" class="bare">https://www.marketdata-cloud.quick-co.jp/Products/</a>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_stock_price.png" alt="sample_stock_price">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ファンダメンタル情報_stock_fin">2.2.3. ファンダメンタル情報: stock_fin</h4>
<div class="paragraph">
<p>株式投資における <code>ファンダメンタル情報</code> とは、対象銘柄の純資産といった財務状況や当期純利益といった業績状況を表す情報のことです。ファンダメンタル情報を用いて、各銘柄の成長性、収益性、安全性、割安度などの投資判断に活用することができます。ファンダメンタル情報を利用した解析は、さまざまな手法が考案されています。</p>
</div>
<div class="paragraph">
<p>ファンダメンタル情報のデータセットであるstock_finにおいて、いくつかの変数名は <code>Forecast</code> から始まっていますが、これらは各企業が来期の自社の業績・財務状況を予想したデータです。例えば、企業が来期の業績が厳しいことが予め分かっている場合には、予想として早めに開示することがあるため、予想のデータも重要な可能性があります。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">base_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2753</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement AccountingStandard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会計基準　単独:NonConsolidated、連結国内:ConsolidatedJP、連結SEC:ConsolidatedUS、連結IFRS:ConsolidatedIFRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConsolidatedJP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement FiscalPeriodEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算期</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015/12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement ReportType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算種別　第1四半期:Q1、中間決算:Q2、第3四半期:Q3、本決算:Annual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Q3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement FiscalYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算年度。本決算の決算期末が属する年。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement CompanyType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会社区分 一般事業会社:GB、銀行:BK、証券会社:SE、損保会社:IN ※上記に該当しない場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement ChangeOfFiscalYearEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算期変更フラグ 決算期変更あり:true、決算期変更なし:false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement NetSales</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">売上高（単位：百万円） 会社区分によって項目名の読替えを行ういます。 銀行：経常収益、証券：営業収益、損保：経常収益 ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22354</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement OperatingIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">営業利益（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2391</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement OrdinaryIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">経常利益（単位：百万円） 会計基準が連結SECの場合は、項目名を「税引前利益」に読み替えます。 ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2466</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement NetIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">当期純利益（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1645</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement TotalAssets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">総資産（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21251</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement NetAssets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">純資産（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16962</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement CashFlowsFromOperatingActivities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">営業キャッシュフロー（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12404</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement CashFlowsFromFinancingActivities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務キャッシュフロー（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-98</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_FinancialStatement CashFlowsFromInvestingActivities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">投資キャッシュフロー（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1307</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement AccountingStandard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想: 会計基準　単独:NonConsolidated、連結国内:ConsolidatedJP、連結SEC:ConsolidatedUS、連結IFRS:ConsolidatedIFRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConsolidatedJP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement FiscalPeriodEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　決算期</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/03</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement ReportType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　決算種別　第1四半期:Q1、中間決算:Q2、第3四半期:Q3、本決算:Annual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Annual</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement FiscalYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　決算年度。本決算の決算期末が属する年。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement CompanyType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　会社区分 一般事業会社:GB、銀行:BK、証券会社:SE、損保会社:IN ※上記に該当しない場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement ChangeOfFiscalYearEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　決算期変更フラグ 決算期変更あり:true、決算期変更なし:false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement NetSales</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　売上高（単位：百万円） 会社区分によって項目名の読替えを行います。 銀行：経常収益、証券：営業収益、損保：経常収益 ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement OperatingIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　営業利益（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3110</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement OrdinaryIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　経常利益（単位：百万円） 会計基準が連結SECの場合は、項目名を「税引前利益」に読み替えます。 ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_FinancialStatement NetIncome</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">来期予想情報:　当期純利益（単位：百万円） ※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2130</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend FiscalPeriodEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　決算期</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015/11</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend ReportType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　決算種別　第1四半期:Q1、中間決算:Q2、第3四半期:Q3、本決算:Annual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Annual</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend FiscalYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　決算年度。本決算の決算期末が属する年。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/07</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend RecordDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　配当基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2015/11/30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend DividendPayableDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　配当支払開始日　※予想の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/02/29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend QuarterlyDividendPerShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　一株当たり四半期配当金（単位：円）　※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result_Dividend AnnualDividendPerShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">配当情報:　一株当たり年間配当金累計（単位：円）※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend FiscalPeriodEnd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　決算期</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/03</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend ReportType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　決算種別　第1四半期:Q1、中間決算:Q2、第3四半期:Q3、本決算:Annual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Annual</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend FiscalYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　決算年度。本決算の決算期末が属する年。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/01/04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend RecordDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　配当基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016/03/31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend QuarterlyDividendPerShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　一株当たり四半期配当金（単位：円）　※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forecast_Dividend AnnualDividendPerShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予想配当情報:　一株当たり年間配当金累計（単位：円）※未開示の場合は空文字を設定してます。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">90</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(Quick xignite API Market Data API Catalogより引用 <a href="https://www.marketdata-cloud.quick-co.jp/Products/" class="bare">https://www.marketdata-cloud.quick-co.jp/Products/</a>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_stock_fin.png" alt="sample_stock_fin">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_財務諸表株価情報_stock_fin_price">2.2.4. 財務諸表+株価情報: stock_fin_price</h4>
<div class="paragraph">
<p>stock_fin_priceは、株価情報である&lt;&lt;株価情報 : stock_price, stock_price&gt;&gt;と財務諸表である&lt;&lt;ファンダメンタル情報: stock_fin, stock_fin&gt;&gt;をデータとして扱いやすいように結合したデータです。変数名や型などについては、同じであるため記載を省略しています。</p>
</div>
<div class="paragraph">
<p>また、データのサイズが非常に大きいため、必要に応じて活用していただきたいと思います。</p>
</div>
</div>
<div class="sect3">
<h4 id="_目的変数_stock_labels">2.2.5. 目的変数: stock_labels</h4>
<div class="paragraph">
<p>stock_labelsは予測の目的変数のデータであり、各銘柄で決算発表が行われた日の取引所公式終値から、その日の翌営業日以降N（5，10，20）営業日間における最高値及び最安値への変化率を記録したデータです。<br>
各値の計算式は、 <code>([基準日付の翌日以降N営業日間における高値/安値] / [基準日付の終値]) - 1</code> です。<br>
なお、ラベルの対象期間 (5、10、20営業日の間) に値が付かなかった場合は、ラベルを <code>NaN</code> としております。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">base_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付（各銘柄で決算短信等の開示がされた日）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-01-04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1301</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_date_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付から5営業日後の日付。label_high_5算出に使用される終値範囲の基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-01-12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_high_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から5営業日の間の最高値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00364</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_low_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から5営業日の間の最安値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-0.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_date_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付から10営業日後の日付。label_high_10算出に使用される終値範囲の基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-01-19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_high_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から10営業日の間の最高値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00364</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_low_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から10営業日の間の最安値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-0.05455</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_date_20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付から20営業日後の日付。label_high_20算出に使用される終値範囲の基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-02-02</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_high_20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から20営業日の間の最高値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00364</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label_low_20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基準日付の終値から20営業日の間の最安値への変化率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-0.08364</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_stock_labels.png" alt="sample_stock_label">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_実行環境及び必要なライブラリ">2.3. 実行環境及び必要なライブラリ</h3>
<div class="sect3">
<h4 id="_実行環境">2.3.1. 実行環境</h4>
<div class="paragraph">
<p>本チュートリアルの実行環境は、本コンペティションで提出するモデルの実行環境と同一環境とするために以下のpython環境を用います。環境構築方法について、詳しくは <a href="https://signate.jp/features/runtime/detail">SIGNATE: Runtime 投稿方法: ローカル開発環境の構築方法は？</a> をご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>anaconda3-2019.03</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_google_colaboratoryの利用">2.3.2. Google Colaboratoryの利用</h4>
<div class="paragraph">
<p>本章はDockerを用いた実行環境の利用を想定して記述しておりますが、Dockerの実行環境構築がご利用のOSなど何らかの理由により困難な方、より簡便にチュートリアルを実行したい方はGoogle Colaboratoryの利用をご検討ください。本チュートリアルで提供されるNotebookはGoogle Colaboratoryでも実行可能です。詳細は第7章をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_dockerを用いた実行環境構築方法">2.3.3. Dockerを用いた実行環境構築方法</h4>
<div class="paragraph">
<p>本チュートリアルのリポジトリを <code>git clone</code> していただき、以下の手順を実行していただくことで実行環境のdockerコンテナ内でjupyter notebookを起動可能となっています。 <code>Chapter02</code> ディレクトリ内には、本チュートリアルのコードを記載した ipynb ファイルを配置しておりますので必要に応じてご活用ください。</p>
</div>
<div class="paragraph">
<p>Windows環境の場合、コマンド実行には「PowerShell」などをご使用ください。なお、PowerShellの利用に当たっては、最新のセキュリティ事情を踏まえご自身でご判断ください。</p>
</div>
<div class="paragraph">
<p>docker のインストールについては <a href="http://docs.docker.jp/get-docker.html" class="bare">http://docs.docker.jp/get-docker.html</a> をご参照ください。docker の制約としてマウントするパスにはアルファベット、数字、「_」、「.」、「-」以外の文字を使用するとエラーとなることがあるようです。その場合は、パスが前述の文字のみで構成されているディレクトリをご使用ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd handson/

# データ配置先のディレクトリを作成
mkdir data_dir
# その後作成したhandson/data_dirに、コンペティションサイトよりデータをダウンロードし配置します。

# dockerでjupyter notebookを起動します。(初回実行時は約2GB程度コンテナイメージをダウンロードします。)
# データ配置先のディレクトリを /path/to としてマウントしています。
# 学習済みモデル提出用のディレクトリ (handson/Chapter02/archive) を /opt/ml としてマウントしています。
# jupyter notebook作業用に handson ディレクトリを /notebook としてマウントしています。
# jupyter notebook は port 8888でtokenとpasswordを空にして、vscode のjupyter pluginからアクセスできるように xsrf 対策を無効化しています。
docker run --name tutorial -v ${PWD}/data_dir:/path/to -v ${PWD}/Chapter02/archive:/opt/ml -v ${PWD}:/notebook -e PYTHONPATH=/opt/ml/src -p8888:8888 --rm -it continuumio/anaconda3:2019.03 jupyter notebook --ip 0.0.0.0 --allow-root --no-browser --no-mathjax --NotebookApp.disable_check_xsrf=True  --NotebookApp.token='' --NotebookApp.password='' /notebook

# ブラウザで以下のURLにアクセスしてjupyter notebookの画面が表示されていて、本チュートリアル用のnotebookが表示されていることを確認します。
http://localhost:8888/</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_必要なライブラリのインストール">2.3.4. 必要なライブラリのインストール</h4>
<div class="paragraph">
<p>本チュートリアル内では、上記の実行環境に含まれていないライブラリを使用するため、以下のコマンドを使用して個別にインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># shap用にg++とgccをインストールします
apt-get update
apt-get install -y --no-install-recommends g++ gcc

# 必要なライブラリをインストールします
pip install shap==0.37.0 slicer==0.0.3 xgboost==1.3.0.post0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ライブラリの読み込み">2.3.5. ライブラリの読み込み</h4>
<div class="paragraph">
<p>本チュートリアルでは、下記のライブラリのインポートを行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">pickle</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">warnings</span>
<span class="keyword">from</span> <span class="include">glob</span> <span class="keyword">import</span> <span class="include">glob</span>

<span class="keyword">import</span> <span class="include">matplotlib</span>
<span class="keyword">import</span> <span class="include">matplotlib.pyplot</span> <span class="keyword">as</span> plt
<span class="keyword">import</span> <span class="include">numpy</span> <span class="keyword">as</span> np
<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd
<span class="keyword">import</span> <span class="include">seaborn</span> <span class="keyword">as</span> sns
<span class="keyword">import</span> <span class="include">shap</span>
<span class="keyword">import</span> <span class="include">xgboost</span>
<span class="keyword">from</span> <span class="include">scipy.stats</span> <span class="keyword">import</span> <span class="include">spearmanr</span>
<span class="keyword">from</span> <span class="include">sklearn.ensemble</span> <span class="keyword">import</span> (
    ExtraTreesRegressor,
    GradientBoostingRegressor,
    RandomForestRegressor,
)
<span class="keyword">from</span> <span class="include">sklearn.metrics</span> <span class="keyword">import</span> <span class="include">accuracy_score</span>, <span class="include">mean_squared_error</span>
<span class="keyword">from</span> <span class="include">tqdm.auto</span> <span class="keyword">import</span> <span class="include">tqdm</span>


<span class="comment"># 表示用の設定を変更します</span>
%matplotlib inline
pd.options.display.max_rows = <span class="integer">100</span>
pd.options.display.max_columns = <span class="integer">100</span>
pd.options.display.width = <span class="integer">120</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ライブラリ解説">2.3.6. ライブラリ解説</h4>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>ライブラリ名</strong></th>
<th class="tableblock halign-left valign-top"><strong>目的</strong></th>
<th class="tableblock halign-left valign-top"><strong>公式ドキュメント</strong></th>
<th class="tableblock halign-left valign-top"><strong>入門解説</strong> ｑ</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pandas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://pandas.pydata.org/docs/">pandas documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/ysdyt/items/9ccca82fc5b504e7913a">Qiita:データ分析で頻出のPandas基本操作</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">numpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://numpy.org/doc/stable/user/tutorials_index.html">NumPy Tutorials</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/jyori112/items/a15658d1dd17c421e1e2">Qiita:numpyの使い方</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">glob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルの検知</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.python.org/3/library/glob.html">glob — Unix style pathname pattern expansion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/HirosuguTakeshita/items/0e0850362c7eb3b10ea1">Qiita:【備忘録】globの使い方</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tqdm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">計算の進捗確認</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://tqdm.github.io/">tqdm</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/pontyo4/items/76145cb10e030ad8186a">Qiita:tqdmでプログレスバーを表示させる</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sklearn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">機械学習モデルを作成</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://scikit-learn.org/stable/tutorial/index.html">https://scikit-learn.org/stable/tutorial/index.html</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/ynakayama/items/9c5867b6947aa41e9229">Qiita:scikit-learn から学ぶ機械学習の手法の概要</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matplotlib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://matplotlib.org/tutorials/index.html">matplotlib tutorials</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/skotaro/items/08dc0b8c5704c94eafb9">Qiita:早く知っておきたかったmatplotlibの基礎知識、あるいは見た目の調整が捗るArtistの話</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scipy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">統計用のライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.scipy.org/doc/scipy/reference/tutorial/index.html">SciPy Tutorial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://amorphous.tf.chiba-u.jp/lecture.files/chem_computer/11_scipy%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%81%A8%E5%BF%9C%E7%94%A8/11.html">千葉大: コンピュータ処理 ドキュメント 11. scipyの基本と応用</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">seaborn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://seaborn.pydata.org/tutorial.html">User guide and tutorial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/hik0107/items/3dc541158fceb3156ee0">Qiita:pythonで美しいグラフ描画 -seabornを使えばデータ分析と可視化が捗る その1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">shap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHAP分析</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://shap.readthedocs.io/en/latest/">Welcome to the SHAP Documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/shin_mura/items/cde01198552eda9146b7">Shapを用いた機械学習モデルの解釈説明</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xgboost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">機械学習モデル</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://xgboost.readthedocs.io/en/latest/">XGBoost Documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/triwave33/items/aad60f25485a4595b5c8">XGBoost論文を丁寧に解説する(1)</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_実行環境の確認">2.3.7. 実行環境の確認</h4>
<div class="paragraph">
<p>pythonのバージョンが3.7.3であることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">print(sys.version)</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">3.7.3 (default, Mar 27 2019, 22:11:17)
[GCC 7.3.0]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセットの読み込み">2.4. データセットの読み込み</h3>
<div class="paragraph">
<p>本コンペティション用に提供されているデータセットをダウンロードして、ファイルを解凍した場所を定義します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データセット保存先ディレクトリ（&quot;&quot;の中身はご自身の環境に合わせて定義してください。）</span>
dataset_dir=<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>データを読み込みます。なお、本チュートリアルでは <code>stock_fin</code> 及び <code>stock_price</code> を使用するため、 <code>stock_fin_price</code> は読み込まずに進めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 読み込むファイルを定義します。</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># 本チュートリアルでは使用しないため、コメントアウトしています。</span>
    <span class="comment"># &quot;stock_fin_price&quot;: f&quot;{dataset_dir}/stock_fin_price.csv.gz&quot;,</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_labels.csv.gz</span><span class="delimiter">&quot;</span></span>,
}

<span class="comment"># ファイルを読み込みます</span>
dfs = {}
<span class="keyword">for</span> k, v <span class="keyword">in</span> inputs.items():
    print(k)
    dfs[k] = pd.read_csv(v)
    <span class="comment"># DataFrameのindexを設定します。</span>
    <span class="keyword">if</span> k == <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>:
        dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
            dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>]
        )
        dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
    <span class="keyword">elif</span> k <span class="keyword">in</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>]:
        dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
            dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>]
        )
        dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>読み込んだデータを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> k <span class="keyword">in</span> inputs.keys():
    print(k)
    print(dfs[k].info())
    print(dfs[k].head(<span class="integer">1</span>).T)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセットの可視化">2.5. データセットの可視化</h3>
<div class="paragraph">
<p>データセットの各項目の特徴を把握することは、モデルを作成する上で重要な要素の1つです。一般にデータの特徴を把握するためには、各項目の意味を把握し、値の平均や標準偏差などの基本統計量を確認します。可視化もそういった特徴把握の手法の1つで、データをグラフなどで表現することで特性を直感的に理解できるようになります。</p>
</div>
<div class="paragraph">
<p>Chapter 2.2 データセットの説明では、本コンペで用いるデータセットについて説明しました。ここではそれらのデータを、 <code>matplotlib</code> と <code>seaborn</code> を用いて可視化します。財務諸表、株価、移動平均、価格変化率、ヒストリカル・ボラティリティを個別で見て、最後に1つのグラフとしてまとめて可視化します。</p>
</div>
<div class="sect3">
<h4 id="_財務諸表">2.5.1. 財務諸表</h4>
<div class="paragraph">
<p>ファンダメンタル情報は項目が多いため、今回は、売上高、営業利益、純利益、純資産及びその決算期の間の関係について可視化します。サンプルとして、銘柄コード9984の「ソフトバンクグループ」を可視化します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_finの読み込み</span>
fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 銘柄コード9984にデータを絞る</span>
code = <span class="integer">9984</span>
fin_data = fin[fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]

<span class="comment"># 2019年までの値を表示</span>
fin_data = fin_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># プロット対象を定義</span>
columns = [
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 売上高</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 営業利益</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 純利益</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetAssets</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 純資産</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>  <span class="comment"># 決算期</span>
]

<span class="comment"># プロット</span>
sns.pairplot(fin_data[columns], hue=<span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>, height=<span class="integer">5</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_fin_stock.png" alt="sample fin plot">
</div>
</div>
<div class="paragraph">
<p>上記のプロットについて説明しますと、各色（緑、赤、青、オレンジ）はそれぞれQ1,Q2,Q3,Annualにおける決算の値に対応しており、対角に並んでいるプロットは各軸の特徴量の分布を表しています。また、その他のプロットは、各軸2つの変数の散布図を表しています。<br>
例えば、2行1列目のグラフを見ると、横軸が売上高、縦軸が営業利益になっています。高い売上高は高い営業利益に繋がっています。また、決算期がQ1からQ3,本決算に至るまでに基本的に右肩上がりであることが分かります。このことから財務データの純売上高や営業利益などの変数は、各決算期ごとの値ではなく、各決算期を積み上げ式で記録されていると推測できます。</p>
</div>
<div class="sect4">
<h5 id="_複数銘柄のファンダメンタル情報の比較">複数銘柄のファンダメンタル情報の比較</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_finの読み込み</span>
fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 銘柄コード9984と9983を比較する</span>
codes = [<span class="integer">9984</span>, <span class="integer">9983</span>]

multi_df = <span class="predefined">dict</span>()

<span class="comment"># プロット対象を定義</span>
columns = [
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 売上高</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 営業利益</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 純利益</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetAssets</span><span class="delimiter">&quot;</span></span>,  <span class="comment"># 純資産</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>  <span class="comment"># 決算期</span>
]

<span class="comment"># 比較対象の銘柄コード毎に処理</span>
<span class="keyword">for</span> code <span class="keyword">in</span> codes:
    <span class="comment"># 特定の銘柄コードに絞り込み</span>
    fin_data = fin[fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
    <span class="comment"># 2019年までの値を表示</span>
    fin_data = fin_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>].copy()
    <span class="comment"># 重複を排除</span>
    fin_data.drop_duplicates(
        subset=[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement FiscalYear</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>
        ],
        keep=<span class="string"><span class="delimiter">&quot;</span><span class="content">last</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
    <span class="comment"># プロット対象のカラムを取得</span>
    _fin_data = fin_data[columns]
    <span class="comment"># 決算期毎の平均を取得</span>
    multi_df[code] = _fin_data[columns].groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>).mean()

<span class="comment"># 銘柄毎に処理していたものを結合</span>
multi_df = pd.concat(multi_df)
<span class="comment"># 凡例を調整</span>
multi_df.set_index(multi_df.index.map(<span class="keyword">lambda</span> t: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{t[0]}/{t[1]}</span><span class="delimiter">&quot;</span></span>), inplace=<span class="predefined-constant">True</span>)
<span class="comment"># プロット</span>
ax = multi_df.T.plot(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>, figsize=(<span class="integer">12</span>, <span class="integer">6</span>), grid=<span class="predefined-constant">True</span>)
<span class="comment"># Y軸のラベルを調整</span>
ax.get_yaxis().set_major_formatter(matplotlib.ticker.FuncFormatter(<span class="keyword">lambda</span> x, p: <span class="string"><span class="delimiter">&quot;</span><span class="content">{} bYen</span><span class="delimiter">&quot;</span></span>.format(<span class="predefined">int</span>(x / <span class="integer">1</span>_000))))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_comparison.png" alt="sample_comparison">
</div>
</div>
<div class="paragraph">
<p>画像の中にコメントを記載しておりますが、NetSales（売上高）とNetAssets（純資産）の特性の違いがわかります。NetAssetsは一定の数値になっており、決算期の影響をあまり受けていないことがわかります。一方、NetSalesはQ1からAnnualにかけて数値が積み上がっており、Q1から決算期が進むごとに大きくなる特性を持つことがわかります。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_株価">2.5.2. 株価</h4>
<div class="paragraph">
<p>ここでは、サンプルとして銘柄コード9984の「ソフトバンクグループ」の終値の動きを可視化します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceの読み込み</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 特定の銘柄コードに絞り込み</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
<span class="comment"># 2019年までの値を表示</span>
price_data = price_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># プロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))

ax.plot(price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], label=f<span class="string"><span class="delimiter">&quot;</span><span class="content">securities code : {code}.T</span><span class="delimiter">&quot;</span></span>)
ax.set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>)
ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>)
ax.grid(<span class="predefined-constant">True</span>)
ax.legend()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_stock_price_close.png" alt="sample_close_price">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_移動平均">2.5.3. 移動平均</h4>
<div class="paragraph">
<p>ここでは移動平均をプロットします。移動平均にもさまざまな種類がありますが、ここでは単純移動平均線を用います。単純移動平均線というのは、例えば、5日線であれば、直近5営業日の価格の平均値です。これを1つずつ期間をスライドしながら計算したものになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceの読み込み</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 特定の銘柄コードに絞り込み</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
<span class="comment"># 2019年までの値を表示</span>
price_data = price_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>].copy()

<span class="comment"># 5日、25日、75日の移動平均を算出</span>
periods = [<span class="integer">5</span>, <span class="integer">25</span>, <span class="integer">75</span>]
cols = []
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows simple moving average</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(period, min_periods=<span class="integer">1</span>).mean()
    cols.append(col)

<span class="comment"># プロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))

<span class="keyword">for</span> col <span class="keyword">in</span> cols:
    ax.plot(price_data[col], label=col)
ax.set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>)
ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>)
ax.grid(<span class="predefined-constant">True</span>)
ax.legend()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_moving_average.png" alt="sample_SMA">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_価格変化率">2.5.4. 価格変化率</h4>
<div class="paragraph">
<p>価格変化率は、価格がその期間でどれくらい変化したかを(%)で表現したものです。相場の勢いや方向性等を判断する際によく使われます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceの読み込み</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 特定の銘柄コードに絞り込み</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
<span class="comment"># 2019年までの値を表示</span>
price_data = price_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>].copy()

<span class="comment"># 5日、25日、75日の価格変化率を算出</span>
periods = [<span class="integer">5</span>, <span class="integer">25</span>, <span class="integer">75</span>]
cols = []
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows rate of return</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(period) * <span class="integer">100</span>
    cols.append(col)

<span class="comment"># プロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))

<span class="keyword">for</span> col <span class="keyword">in</span> cols:
    ax.plot(price_data[col], label=col)
ax.set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">rate of return (%)</span><span class="delimiter">&quot;</span></span>)
ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>)
ax.grid(<span class="predefined-constant">True</span>)
ax.legend()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_rate_of_return.png" alt="sample_rr">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ヒストリカルボラティリティ">2.5.5. ヒストリカル・ボラティリティ</h4>
<div class="paragraph">
<p>ここではヒストリカル・ボラティリティを計算します。ここで計算するヒストリカル・ボラティリティは、5日、25日、75日の対数リターンの標準偏差です。ヒストリカル・ボラティリティはリスク指標の一つで、価格がどの程度激しく変動したかを把握するために利用します。一般的にヒストリカル・ボラティリティが大きい銘柄は、小さい銘柄よりも資産として保持するリスクが相対的に高いと考えられます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceの読み込み</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 特定の銘柄コードに絞り込み</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
<span class="comment"># 2019年までの値を表示</span>
price_data = price_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>].copy()

<span class="comment"># 5日、25日、75日のヒストリカル・ボラティリティを算出</span>
periods = [<span class="integer">5</span>, <span class="integer">25</span>, <span class="integer">75</span>]
cols = []
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows volatility</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = np.log(price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(period).std()
    cols.append(col)

<span class="comment"># プロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))

<span class="keyword">for</span> col <span class="keyword">in</span> cols:
    ax.plot(price_data[col], label=col)
ax.set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility</span><span class="delimiter">&quot;</span></span>)
ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>)
ax.grid(<span class="predefined-constant">True</span>)
ax.legend()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_volatility.png" alt="sample_volatility">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_複数の株価データを同時にプロット">2.5.6. 複数の株価データを同時にプロット</h4>
<div class="paragraph">
<p>これまで可視化してきた株価に関するデータを同時にプロットすることで、それぞれの値の関連性について考察します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceの読み込み</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 特定の銘柄コードに絞り込み</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
<span class="comment"># 2019年までの値を表示</span>
price_data = price_data[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>].copy()

<span class="comment"># 5日、25日、75日を対象に値を算出</span>
periods = [<span class="integer">5</span>, <span class="integer">25</span>, <span class="integer">75</span>]
ma_cols = []
<span class="comment"># 移動平均線</span>
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows simple moving average</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(period, min_periods=<span class="integer">1</span>).mean()
    ma_cols.append(col)

return_cols = []
<span class="comment"># 価格変化率</span>
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows rate of return</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(period) * <span class="integer">100</span>
    return_cols.append(col)

vol_cols = []
<span class="comment"># ヒストリカル・ボラティリティ</span>
<span class="keyword">for</span> period <span class="keyword">in</span> periods:
    col = <span class="string"><span class="delimiter">&quot;</span><span class="content">{} windows volatility</span><span class="delimiter">&quot;</span></span>.format(period)
    price_data[col] = np.log(price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(period).std()
    vol_cols.append(col)

<span class="comment"># プロット</span>
fig, ax = plt.subplots(nrows=<span class="integer">3</span> ,figsize=(<span class="integer">20</span>, <span class="integer">8</span>))

ax[<span class="integer">0</span>].plot(price_data[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], label=<span class="string"><span class="delimiter">&quot;</span><span class="content">Close Price</span><span class="delimiter">&quot;</span></span>)

<span class="keyword">for</span> col <span class="keyword">in</span> ma_cols:
    ax[<span class="integer">0</span>].plot(price_data[col], label=col)

<span class="keyword">for</span> col <span class="keyword">in</span> return_cols:
    ax[<span class="integer">1</span>].plot(price_data[col], label=col)

<span class="keyword">for</span> col <span class="keyword">in</span> vol_cols:
    ax[<span class="integer">2</span>].plot(price_data[col], label=col)

ax[<span class="integer">0</span>].set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>)
ax[<span class="integer">1</span>].set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">rate of return (%)</span><span class="delimiter">&quot;</span></span>)
ax[<span class="integer">2</span>].set_ylabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility (log return)</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">for</span> _ax <span class="keyword">in</span> ax:
    _ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>)
    _ax.grid(<span class="predefined-constant">True</span>)
    _ax.legend()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/sample_plot_all_features.png" alt="plot_all_features">
</div>
</div>
<div class="paragraph">
<p>ここでは2018年末に起きた株価の下落に着目してみます。複数の特徴量を並べてプロットすると、株価に大きな変動があった時に他の特徴量にどのような影響を与えているかを観測することができます。</p>
</div>
<div class="paragraph">
<p>移動平均の特徴量は、期間が短いほど敏感に株価の下落に反応し、期間が長い特徴量ほど反応が遅れることがわかります。リターンの特徴量も下落時には同一の傾向が見て取れますが、その後高いリターンが観測されることがわかります。一方、ヒストリカル・ボラティリティの挙動をみると、下落の前にじわじわとボラティリティが上昇していることがわかります。このように一つの株価の下落を見ても、それぞれの特徴量の挙動が微妙に異なっており、複数個の特徴量をモデルに投入することで、これらの挙動のパターンを学習することが想像できます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセットの前処理">2.6. データセットの前処理</h3>
<div class="paragraph">
<p>ここまでデータの読み込み及び可視化について説明してきましたが、ここからはデータの前処理やモデル構築に関して説明していきます。
大まかな流れは、次の図のとおりです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/flow_chart.png" alt="pipeline">
</div>
</div>
<div class="paragraph">
<p>上図のとおり、モデルを構築する際には、データセットをそのまま入力するのではなく、欠損値処理や正規化処理などのデータセットの前処理を実施してから入力することが一般的です。ここではデータセットの前処理について解説していきます。</p>
</div>
<div class="sect3">
<h4 id="_欠損値処理">2.6.1. 欠損値処理</h4>
<div class="paragraph">
<p>機械学習モデルの多くは欠損値をそのまま扱うことができないため、補完するなどして対処する必要があります。欠損値補完の方法としては、平均値埋めやリストワイズ法、多重代入法などが存在します。また、変数に欠損が存在するレコードを単に除外することや、欠損を多く含む変数自体を除外することも考えられます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_欠損値の処理方法">2.6.2. 欠損値の処理方法</h4>
<div class="paragraph">
<p>本コンペティションのデータについて、まずは実際に欠損が発生している箇所やパターンを特定するために、欠損の発生状況をプロットして確認してみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_finデータを読み込む</span>
stock_fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 2019年までの値を表示</span>
stock_fin = stock_fin[:<span class="string"><span class="delimiter">&quot;</span><span class="content">2019</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># データ数の確認</span>
print(stock_fin.shape)

<span class="comment"># データの欠損値数を確認</span>
print(stock_fin.isna().sum())

<span class="comment"># 欠損値の数を年別に集計</span>
stock_fin = stock_fin.isna()
stock_fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>] = stock_fin.index.year

<span class="comment"># データの欠損値をプロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">20</span>, <span class="integer">5</span>))
sns.heatmap(stock_fin.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>).agg(<span class="string"><span class="delimiter">&quot;</span><span class="content">sum</span><span class="delimiter">&quot;</span></span>), ax=ax)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/missing_values.png" alt="欠損値">
</div>
</div>
<div class="paragraph">
<p>明るい色で示されている箇所は、欠損値が多く発生していることを表しています。本チュートリアルでは欠損値について以下のように対応します。<br>
・`Result_FinancialStatement` の <code>CashFlowsFromOperatingActivities</code> 、 <code>CashFlowsFromFinancingActivities</code> 、 <code>CashFlowsFromInvestingActivities</code> に多くの欠損値があります（上図中央左）。これらのカラムの値は <code>Result_FinancialStatement ReportType</code> が <code>Annual</code> の場合にのみ値が入っています。これらの欠損値については <code>0</code> を代入することで対処します。<br>
・配当支払開始日を表す <code>Result_Dividend DividendPayableDate</code> や予想配当基準日を表す <code>Forecast_Dividend RecordDate</code> というデータ列等のfloat64型以外のデータ列に数多く欠損が発生していることが分かります（上図右側）。そのため、本チュートリアルではfloat64型として読み込まれているカラムのみを使用することとします。<br>
・上記に記載したキャッシュフローに関するカラム以外のfloat64型として読み込まれているカラムの欠損値についても、 <code>0</code> を代入することで対処します。ただし、変数によっては、0という数字自体に意味があるケースが有るため、気をつける必要があります。</p>
</div>
<div class="paragraph">
<p>実際の欠損値処理は、次のように変数の型 (今回は <code>np.float64</code> という型を選択) 別に後段処理できる値 (今回は <code>0</code>) で欠損値を埋めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_finデータを読み込む</span>
stock_fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 銘柄コード9984にデータを絞る</span>
code = <span class="integer">9984</span>
stock_fin = stock_fin[stock_fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]

<span class="comment"># float64型の列に絞り込み</span>
fin_data = stock_fin.select_dtypes(include=[<span class="string"><span class="delimiter">&quot;</span><span class="content">float64</span><span class="delimiter">&quot;</span></span>])

<span class="comment"># 欠損値を0でフィル</span>
fin_data = fin_data.fillna(<span class="integer">0</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anchor-2.7">2.7. 特徴量の生成</h3>
<div class="sect3">
<h4 id="_なぜ特徴量の設計が重要なのか">2.7.1. なぜ特徴量の設計が重要なのか</h4>
<div class="paragraph">
<p>機械学習の手法には<strong>モデルにできるだけ生に近いデータを与えてその関係性を見つける手法</strong>と<strong>ドメイン知識や専門性を活かして、特徴量を設計する手法</strong>があります。</p>
</div>
<div class="paragraph">
<p>前者の手法はEnd-To-End Learningと呼ばれ、生に近いデータをモデルに与え、そのモデル自体に特徴量を発見させる手法です。音声認識などの分野で活用されています。<br>
本チュートリアルでは、金融データに慣れ親しんでいただくためにも、特徴量の影響を細かく考察しながら汎化性能に貢献する特徴量を設計していくアプローチで、モデルを構築します。</p>
</div>
<div class="paragraph">
<p>特徴量生成は、仮説を考え、その仮説をモデルが学ぶにはどのような特徴量が必要か、ということを想像することが重要です。</p>
</div>
<div class="paragraph">
<p>本チュートリアルでは、「直近株価が上がったら、高値もより大きく変動しやすい」という仮説を立て、この仮説を基に特徴量を生成してみます。この仮説をモデルが学ぶためには直近株価が上がったことを示す特徴量が必要です。直近を仮に1ヶ月と仮定すると、20日リターンや20日移動平均乖離率などが候補になります。</p>
</div>
<div class="paragraph">
<p>また、この仮説が市場においても必ずしも正しいという必要はなく、仮説を思いついたら、その仮説を学ぶことができる特徴量を想像し、実際に実験してみることが重要です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_定常性を意識した特徴量設計">2.7.2. 定常性を意識した特徴量設計</h4>
<div class="paragraph">
<p>時系列データを扱う際には、定常性を意識して特徴量を設計することが重要です。</p>
</div>
<div class="paragraph">
<p><strong>株価をそのまま学習させたケース</strong>と<strong>定常性がある特徴量を利用するケース</strong>について考えてみます。</p>
</div>
<div class="paragraph">
<p><strong>株価をそのまま学習させたケース</strong>: 例えば、モデルの訓練期間における株価が、100円〜110円の範囲で動いたとします。もし、この数値をそのままモデルに投入すると、モデルは株価が100円〜110円近辺で動くことを暗黙に学習します。しかし、この暗黙の仮定は実際のマーケットでは成立しておらず、テスト期間で株価が高騰すると、モデルがうまく動かないことがあります。他にも株価に特有の例としては株式分割や株式併合により株価のレンジが大きく変動する場合があります。</p>
</div>
<div class="paragraph">
<p><strong>定常性がある特徴量を利用するケース</strong>: 例えば、20日の価格変化率を考えると、これは正規分布ではありませんが、一部のマーケットの混乱期を除けばほぼ0を中心とした正規分布に近い分布になります。特徴量は、2%の上昇や4%の下落といった0を中心とした時系列となっており、将来に渡っても似たような分布になることが期待でき、株価範囲に対する暗黙の仮定を学ぶ恐れがなくなります。このように将来に渡っても似たような分布を期待できる特徴量は定常性があるといえます。</p>
</div>
<div class="paragraph">
<p>定常性を意識すると、正規化処理における様々な注意点が見えてきます。たとえば、最小値と最大値を-1から1などにマッピングするMinMax正規化を株価に適用したとしても定常性を期待することはできません。株価をMinMax正規化したときにその最大値・最小値が未来に対しても適用できる保証ができないためです。このように時系列の特徴量の設計をするとき、定常性を意識しながら特徴量を設計していくことが重要です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_特徴量の生成例">2.7.3. 特徴量の生成例</h4>
<div class="paragraph">
<p>ここでは、特徴量の生成を <code>stock_price</code> の株価情報を利用して行います。株価情報には、価格や出来高など市場で公開されている株価の四本値(始値、高値、安値、終値)の時系列データが格納されています。本チュートリアルでは、特徴量の例として1ヶ月、2ヶ月、3ヶ月間の「終値の変化率（リターン）」、「ヒストリカル・ボラティリティ」、「移動平均線からの乖離率」を紹介します。<br>
次のコードで具体的な計算については示しますが、定義は以下のとおりです。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>特徴量の計算に使用する関数</strong></th>
<th class="tableblock halign-left valign-top"><strong>使用する関数の説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pct_change(N)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">現在の観測値とN個前の観測値との変化率</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">diff()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">現在の観測値と一つ前の観測値との差</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rolling(N)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">対象の観測値をN個でグループ化</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">std()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">標準偏差</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mean()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">算術平均</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceデータを読み込む</span>
price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># 銘柄コード9984にデータを絞る</span>
code = <span class="integer">9984</span>
price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]

<span class="comment"># 終値のみに絞る</span>
feats = price_data[[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]].copy()
<span class="comment"># 終値の20営業日リターン</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">20</span>)
<span class="comment"># 終値の40営業日リターン</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">40</span>)
<span class="comment"># 終値の60営業日リターン</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">60</span>)
<span class="comment"># 終値の20営業日ボラティリティ</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_1month</span><span class="delimiter">&quot;</span></span>] = (
    np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">20</span>).std()
)
<span class="comment"># 終値の40営業日ボラティリティ</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_2month</span><span class="delimiter">&quot;</span></span>] = (
    np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">40</span>).std()
)
<span class="comment"># 終値の60営業日ボラティリティ</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_3month</span><span class="delimiter">&quot;</span></span>] = (
    np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">60</span>).std()
)
<span class="comment"># 終値と20営業日の単純移動平均線の乖離</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">20</span>).mean()
)
<span class="comment"># 終値と40営業日の単純移動平均線の乖離</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">40</span>).mean()
)
<span class="comment"># 終値と60営業日の単純移動平均線の乖離</span>
feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">60</span>).mean()
)
<span class="comment"># 欠損値処理</span>
feats = feats.fillna(<span class="integer">0</span>)
<span class="comment"># 元データのカラムを削除</span>
feats = feats.drop([<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], axis=<span class="integer">1</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_テクニカル分析を活用した特徴量の生成">2.7.4. テクニカル分析を活用した特徴量の生成</h4>
<div class="paragraph">
<p>他に株価を扱うための特徴量としてRSIやストキャスティクスのようなテクニカル分析の指標などを活用することもあります。テクニカル分析の利用に関する考察は本章では取り扱わずに、第7章で紹介しています。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_バックテスト用のテストデータ作成">2.8. バックテスト用のテストデータ作成</h3>
<div class="paragraph">
<p>ここでは、バックテストを行うためのデータの分割について説明します。</p>
</div>
<div class="sect3">
<h4 id="_バックテストとは">2.8.1. バックテストとは</h4>
<div class="paragraph">
<p>バックテストとは、モデルの有効性を検証する際に、過去のデータを用いて、一定期間にどの程度のパフォーマンスが得られたかをシミュレーションすることです。モデルの有効性を検証する上で、どのようにバックテストを実施するかは重要なポイントになります。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ホールドアウト検証">2.8.2. ホールドアウト検証</h4>
<div class="paragraph">
<p>ここでは、データセットを訓練データとテストデータに切り分けます。まずデータセットを分ける理由を説明し、次に、データセットの分け方及びコツについて解説します。</p>
</div>
<div class="paragraph">
<p>データセットを分ける理由は、モデルの汎化性能を確認し使用するモデルを決定するためです。</p>
</div>
<div class="paragraph">
<p>汎化性能とは、モデルが訓練データ以外の未知のデータに対しても機能するという能力です。汎化性能が低いモデルは、訓練データでは高い精度が得られますが、訓練データにない未知のデータについては、低い精度しか得られません。この現象を<strong>過学習</strong>と呼びます。データセットを分割せずに、そのまま全体に対して学習し、同じデータセットに対してモデルによる予測をすると、基本的には高い精度の結果を得ることができます。<br>
しかし、未知のデータに対して予測すると、予測がまったく当たらないということが起こり得ます。そのため、データセットを分割して、学習に使用していないデータをモデルの検証用として用意しておくことで、作成したモデルが過学習していないことを確認することが出来ます。</p>
</div>
<div class="paragraph">
<p>基本的な時系列データの分割手法(<strong>ホールドアウト検証</strong>)に関して解説します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1.全体のデータセットを、訓練期間(TRAIN)/検証期間(VAL)/テスト期間(TEST)で分けます。
2.TRAINデータでモデルを学習させ、VALデータでモデルを評価します。これをモデルのさまざまなパラメーターで何度か行い、一番結果が良かったパラメーターを選びます。
3.そして最後にTESTデータでモデルの予測結果を最終評価します。</pre>
</div>
</div>
<div class="paragraph">
<p>本チュートリアルでは、次の期間でデータを分割します。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even" style="width: 50%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">訓練期間</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-01-01 - 2017-12-31</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">評価期間</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">2018-02-01 - 2018-12-01</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">テスト期間</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">2019-01-01 - 2020-12-31</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre>※データの分割に際し、各期間に間隔（1か月）を空けている理由は、未来の情報を含ませないようにするためです。例えば、2017年12月31日の目的変数には5営業日、10営業日、20営業日後の株価リターンの情報が入っているため、2017年12月31日のデータを使って学習したモデルは未来の情報（2018年1月のリターン）を知っていることになってしまいます。したがって、2018年1月のデータを検証データに含めてしまうとリークが発生し、適切なモデルの評価ができなくなってしまいます。</pre>
</div>
</div>
<div class="paragraph">
<p>以下のように変数を定義しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">TRAIN_END = <span class="string"><span class="delimiter">&quot;</span><span class="content">2017-12-31</span><span class="delimiter">&quot;</span></span>
VAL_START = <span class="string"><span class="delimiter">&quot;</span><span class="content">2018-02-01</span><span class="delimiter">&quot;</span></span>
VAL_END = <span class="string"><span class="delimiter">&quot;</span><span class="content">2018-12-01</span><span class="delimiter">&quot;</span></span>
TEST_START = <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-01-01</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_その他の検証方法">2.8.3. その他の検証方法</h4>
<div class="paragraph">
<p>・k-fold 交差検証(k-fold CV): データをまず訓練データとテストデータに分け、その後その訓練データをk個のグループに分割し、k-1個のグループに含まれるものを訓練データ、残りの1個のグループに含まれるものを評価データとすると、このような分割方法はk通り考えられます。<br>
そこで、それぞれの分割方法したがってk回訓練と評価を行い、それぞれの試行結果の平均などを使用して、モデルやそのモデルのパラメータを評価します。なお、時系列データでは、将来の情報を含まないように注意する必要があります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_モデルの構築">2.9. モデルの構築</h3>
<div class="paragraph">
<p>ここでは、モデルの学習に用いるためのデータを準備します。</p>
</div>
<div class="paragraph">
<p>モデル作成のステップは、以下のとおりに行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1. 銘柄を一つ選ぶ
2. その銘柄に対して、財務データ及びマーケットデータから特徴量を作る
3. 全銘柄に対して同じことを繰り返す
4. 作成したデータを結合する
5. 全データを訓練データ、評価データ、テストデータに分ける
6. 訓練データで予測モデルを学習させる</pre>
</div>
</div>
<div class="paragraph">
<p>・<strong>入力用データの作成方法</strong></p>
</div>
<div class="paragraph">
<p>前回までのマーケットデータを用いた特徴量生成方法、及び財務諸表データの欠損値処理を行った後のデータ処理について解説し、今回はそれらのデータを結合させ、モデルが学習できるフォーマットに直すことが目的です。</p>
</div>
<div class="sect3">
<h4 id="_特徴量の生成">2.9.1. 特徴量の生成</h4>
<div class="paragraph">
<p>ここでは、特徴量生成のコードを示しています。コードのおおまかな流れとしては、以下の3ステップに分けられます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1. 財務データの取得及び前処理（Chapter 2.6.2と同様）
2. マーケットデータの取得及び特徴量定義（Chapter 2.7.2と同様）
3. 財務データと生成した特徴量を結合</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_features_for_predict</span>(dfs, code, start_dt=<span class="string"><span class="delimiter">&quot;</span><span class="content">2016-01-01</span><span class="delimiter">&quot;</span></span>):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Args:</span><span class="content">
</span><span class="content">        dfs (dict)  : dict of pd.DataFrame include stock_fin, stock_price</span><span class="content">
</span><span class="content">        code (int)  : A local code for a listed company</span><span class="content">
</span><span class="content">        start_dt (str): specify date range</span><span class="content">
</span><span class="content">    Returns:</span><span class="content">
</span><span class="content">        feature DataFrame (pd.DataFrame)</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    <span class="comment"># おおまかな手順の1つ目</span>
    <span class="comment"># stock_finデータを読み込み</span>
    stock_fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

    <span class="comment"># 特定の銘柄コードのデータに絞る</span>
    fin_data = stock_fin[stock_fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
    <span class="comment"># 特徴量の作成には過去60営業日のデータを使用しているため、</span>
    <span class="comment"># 予測対象日からバッファ含めて土日を除く過去90日遡った時点から特徴量を生成します</span>
    n = <span class="integer">90</span>
    <span class="comment"># 特徴量の生成対象期間を指定</span>
    fin_data = fin_data.loc[pd.Timestamp(start_dt) - pd.offsets.BDay(n) :]
    <span class="comment"># fin_dataのnp.float64のデータのみを取得</span>
    fin_data = fin_data.select_dtypes(include=[<span class="string"><span class="delimiter">&quot;</span><span class="content">float64</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># 欠損値処理</span>
    fin_feats = fin_data.fillna(<span class="integer">0</span>)

    <span class="comment"># おおまかな手順の2つ目</span>
    <span class="comment"># stock_priceデータを読み込む</span>
    price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]
    <span class="comment"># 特定の銘柄コードのデータに絞る</span>
    price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
    <span class="comment"># 終値のみに絞る</span>
    feats = price_data[[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]]
    <span class="comment"># 特徴量の生成対象期間を指定</span>
    feats = feats.loc[pd.Timestamp(start_dt) - pd.offsets.BDay(n) :].copy()

    <span class="comment"># 終値の20営業日リターン</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">20</span>)
    <span class="comment"># 終値の40営業日リターン</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">40</span>)
    <span class="comment"># 終値の60営業日リターン</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].pct_change(<span class="integer">60</span>)
    <span class="comment"># 終値の20営業日ボラティリティ</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_1month</span><span class="delimiter">&quot;</span></span>] = (
        np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">20</span>).std()
    )
    <span class="comment"># 終値の40営業日ボラティリティ</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_2month</span><span class="delimiter">&quot;</span></span>] = (
        np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">40</span>).std()
    )
    <span class="comment"># 終値の60営業日ボラティリティ</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_3month</span><span class="delimiter">&quot;</span></span>] = (
        np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]).diff().rolling(<span class="integer">60</span>).std()
    )
    <span class="comment"># 終値と20営業日の単純移動平均線の乖離</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">20</span>).mean()
    )
    <span class="comment"># 終値と40営業日の単純移動平均線の乖離</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">40</span>).mean()
    )
    <span class="comment"># 終値と60営業日の単純移動平均線の乖離</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">60</span>).mean()
    )

    <span class="comment"># おおまかな手順の3つ目</span>
    <span class="comment"># 欠損値処理</span>
    feats = feats.fillna(<span class="integer">0</span>)
    <span class="comment"># 元データのカラムを削除</span>
    feats = feats.drop([<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], axis=<span class="integer">1</span>)

    <span class="comment"># 財務データの特徴量とマーケットデータの特徴量のインデックスを合わせる</span>
    feats = feats.loc[feats.index.isin(fin_feats.index)]
    fin_feats = fin_feats.loc[fin_feats.index.isin(feats.index)]

    <span class="comment"># データを結合</span>
    feats = pd.concat([feats, fin_feats], axis=<span class="integer">1</span>).dropna()

    <span class="comment"># 欠損値処理を行います。</span>
    feats = feats.replace([np.inf, -np.inf], <span class="integer">0</span>)

    <span class="comment"># 銘柄コードを設定</span>
    feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = code

    <span class="comment"># 生成対象日以降の特徴量に絞る</span>
    feats = feats.loc[pd.Timestamp(start_dt) :]

    <span class="keyword">return</span> feats</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで、 <code>np.inf</code> を0に置換していますが、価格変化率の計算の際に発散してしまったものを、0と定義し直しています。このように、特徴量を定義する際に、特徴量変換により発散してしまった時やnanになった時の処理を、あらかじめ考慮しておくことがスムーズにデータセットを構築する上で重要です。</p>
</div>
<div class="paragraph">
<p>次にここまでの処理の結果を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">df = get_features_for_predict(dfs, <span class="integer">9984</span>)
df.T</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_目的変数の対応付け及び訓練データ評価データテストデータの分割">2.9.2. 目的変数の対応付け及び訓練データ、評価データ、テストデータの分割</h4>
<div class="paragraph">
<p>次に目的変数を定義します。目的変数は、データセットの <code>stock_labels</code> 内にあり、利用する際は先ほど定義した特徴量のデータセットに対して、行（日付）を一致させる必要があります。</p>
</div>
<div class="paragraph">
<p>データセットの訓練期間、評価期間、テスト期間への分割処理も合わせて実施します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_features_and_label</span>(dfs, codes, feature, label):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Args:</span><span class="content">
</span><span class="content">        dfs (dict[pd.DataFrame]): loaded data</span><span class="content">
</span><span class="content">        codes  (array) : target codes</span><span class="content">
</span><span class="content">        feature (pd.DataFrame): features</span><span class="content">
</span><span class="content">        label (str) : label column name</span><span class="content">
</span><span class="content">    Returns:</span><span class="content">
</span><span class="content">        train_X (pd.DataFrame): training data</span><span class="content">
</span><span class="content">        train_y (pd.DataFrame): label for train_X</span><span class="content">
</span><span class="content">        val_X (pd.DataFrame): validation data</span><span class="content">
</span><span class="content">        val_y (pd.DataFrame): label for val_X</span><span class="content">
</span><span class="content">        test_X (pd.DataFrame): test data</span><span class="content">
</span><span class="content">        test_y (pd.DataFrame): label for test_X</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    <span class="comment"># 分割データ用の変数を定義</span>
    trains_X, vals_X, tests_X = [], [], []
    trains_y, vals_y, tests_y = [], [], []

    <span class="comment"># 銘柄コード毎に特徴量を作成</span>
    <span class="keyword">for</span> code <span class="keyword">in</span> tqdm(codes):
        <span class="comment"># 特徴量取得</span>
        feats = feature[feature[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] == code]

        <span class="comment"># stock_labelデータを読み込み</span>
        stock_labels = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>]
        <span class="comment"># 特定の銘柄コードのデータに絞る</span>
        stock_labels = stock_labels[stock_labels[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]

        <span class="comment"># 特定の目的変数に絞る</span>
        labels = stock_labels[label]
        <span class="comment"># nanを削除</span>
        labels.dropna(inplace=<span class="predefined-constant">True</span>)

        <span class="keyword">if</span> feats.shape[<span class="integer">0</span>] &gt; <span class="integer">0</span> <span class="keyword">and</span> labels.shape[<span class="integer">0</span>] &gt; <span class="integer">0</span>:
            <span class="comment"># 特徴量と目的変数のインデックスを合わせる</span>
            labels = labels.loc[labels.index.isin(feats.index)]
            feats = feats.loc[feats.index.isin(labels.index)]
            labels.index = feats.index

            <span class="comment"># データを分割（ホールドアウト法）</span>
            _train_X = feats[: TRAIN_END]
            _val_X = feats[VAL_START : VAL_END]
            _test_X = feats[TEST_START :]

            _train_y = labels[: TRAIN_END]
            _val_y = labels[VAL_START : VAL_END]
            _test_y = labels[TEST_START :]

            <span class="comment"># データを配列に格納 (後ほど結合するため)</span>
            trains_X.append(_train_X)
            vals_X.append(_val_X)
            tests_X.append(_test_X)

            trains_y.append(_train_y)
            vals_y.append(_val_y)
            tests_y.append(_test_y)

    <span class="comment"># 銘柄毎に作成した説明変数データを結合します。</span>
    train_X = pd.concat(trains_X)
    val_X = pd.concat(vals_X)
    test_X = pd.concat(tests_X)
    <span class="comment"># 銘柄毎に作成した目的変数データを結合します。</span>
    train_y = pd.concat(trains_y)
    val_y = pd.concat(vals_y)
    test_y = pd.concat(tests_y)

    <span class="keyword">return</span> train_X, train_y, val_X, val_y, test_X, test_y</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、ここまでの結果を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 対象銘柄コードを定義</span>
codes = [<span class="integer">9984</span>]
<span class="comment"># 対象の目的変数を定義</span>
label = <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>
<span class="comment"># 特徴量を取得</span>
feat = get_features_for_predict(dfs, codes[<span class="integer">0</span>])
<span class="comment"># 特徴量と目的変数を入力し、分割データを取得</span>
ret = get_features_and_label(dfs, codes, feat, label)
<span class="keyword">for</span> v <span class="keyword">in</span> ret:
    print(v.T)</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここまでは一つの銘柄に対して処理をしてきましたが、ここからは全ての予測対象銘柄に対して上記の処理を実施するために、予測対象の銘柄コードを以下のように取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_codes</span>(dfs):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Args:</span><span class="content">
</span><span class="content">        dfs (dict[pd.DataFrame]): loaded data</span><span class="content">
</span><span class="content">    Returns:</span><span class="content">
</span><span class="content">        array: list of stock codes</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    stock_list = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>].copy()
    <span class="comment"># 予測対象の銘柄コードを取得</span>
    codes = stock_list[stock_list[<span class="string"><span class="delimiter">&quot;</span><span class="content">prediction_target</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>][
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
    ].values
    <span class="keyword">return</span> codes</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、目的変数毎にデータセットを作成します。今回は全ての目的変数に同一の特徴量を使用していますが、目的変数に応じて特徴量をチューニングすることでより精度の高いモデルを作成することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 対象の目的変数を定義</span>
labels = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_5</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_10</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_5</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_10</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>,
}
<span class="comment"># 目的変数毎にデータを保存するための変数</span>
train_X, val_X, test_X = {}, {}, {}
train_y, val_y, test_y = {}, {}, {}

<span class="comment"># 予測対象銘柄を取得</span>
codes = get_codes(dfs)

<span class="comment"># 特徴量を作成</span>
buff = []
<span class="keyword">for</span> code <span class="keyword">in</span> tqdm(codes):
    feat = get_features_for_predict(dfs, code)
    buff.append(feat)
feature = pd.concat(buff)

<span class="comment"># 目的変数毎に処理</span>
<span class="keyword">for</span> label <span class="keyword">in</span> tqdm(labels):
    <span class="comment"># 特徴量と目的変数を取得</span>
    _train_X, _train_y, _val_X, _val_y, _test_X, _test_y = get_features_and_label(dfs, codes, feature, label)
    <span class="comment"># 目的変数をキーとして値を保存</span>
    train_X[label] = _train_X
    val_X[label] = _val_X
    test_X[label] = _test_X
    train_y[label] = _train_y
    val_y[label] = _val_y
    test_y[label] = _test_y</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_モデル学習の実行方法">2.9.3. <strong>モデル学習の実行方法</strong></h4>
<div class="paragraph">
<p>データの準備が完了したので、いよいよモデルの学習を実行します。ここでは、sklearnライブラリのRandomForestRegressorモデルを使用します。モデルに設定する各種パラメータは、ここではとくに指定せずにライブラリのデフォルトパラメータを使用します。</p>
</div>
<div class="paragraph">
<p>RandomForestの回帰モデルであるRandomForestRegressorモデルを利用する理由は、予測する目的変数が連続値であるからです。RandomForestモデルは決定木をベースとするモデルであるため、以下の理由から最初に選択するモデルとして扱いやすいです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RandomForest内部で利用する決定木は、特徴量の大小関係のみに着目しており、値自体には意味がないので正規化処理の必要がありません</p>
</li>
<li>
<p>特徴量の重要度を取得することができ、次に実施することの道筋を立てやすい</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 目的変数を指定</span>
label = <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>
<span class="comment"># モデルの初期化</span>
pred_model = RandomForestRegressor(random_state=<span class="integer">0</span>)
<span class="comment"># モデルの学習</span>
pred_model.fit(train_X[label], train_y[label])</code></pre>
</div>
</div>
<div class="paragraph">
<p>一方、サポートベクターマシンやニューラルネットワークを利用する際は、データの前処理における注意点が増えます。選択するモデルの特性に応じた正規化処理と特徴量設計が重要です。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_モデルの推論">2.10. モデルの推論</h3>
<div class="paragraph">
<p>ここでは構築したモデルから予測結果を出力し、可視化などによる分析を実施します。</p>
</div>
<div class="sect3">
<h4 id="_予測結果の出力方法">2.10.1. 予測結果の出力方法</h4>
<div class="paragraph">
<p>ここまで、それぞれの目的変数に対して、訓練データ、評価データ、テストデータに分割しました。ここからは、モデルの学習完了後に、テストデータを入力として予測を出力し、pandas.DataFrame形式に変換します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># モデルを定義</span>
models = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">rf</span><span class="delimiter">&quot;</span></span>: RandomForestRegressor,
}

<span class="comment"># モデルを選択</span>
model = <span class="string"><span class="delimiter">&quot;</span><span class="content">rf</span><span class="delimiter">&quot;</span></span>

<span class="comment"># 目的変数を指定</span>
label = <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>

<span class="comment"># 学習用データセット定義</span>
<span class="comment"># ファンダメンタル情報</span>
fundamental_cols = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>].select_dtypes(<span class="string"><span class="delimiter">&quot;</span><span class="content">float64</span><span class="delimiter">&quot;</span></span>).columns
fundamental_cols = fundamental_cols[fundamental_cols != <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_Dividend DividendPayableDate</span><span class="delimiter">&quot;</span></span>]
fundamental_cols = fundamental_cols[fundamental_cols != <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>]
<span class="comment"># 価格変化率</span>
returns_cols = [x <span class="keyword">for</span> x <span class="keyword">in</span> train_X[label].columns <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> x]
<span class="comment"># テクニカル</span>
technical_cols = [x <span class="keyword">for</span> x <span class="keyword">in</span> train_X[label].columns <span class="keyword">if</span> (x <span class="keyword">not</span> <span class="keyword">in</span> fundamental_cols) <span class="keyword">and</span> (x != <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>)]

columns = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental_only</span><span class="delimiter">&quot;</span></span>: fundamental_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">return_only</span><span class="delimiter">&quot;</span></span>: returns_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">technical_only</span><span class="delimiter">&quot;</span></span>: technical_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental+technical</span><span class="delimiter">&quot;</span></span>: <span class="predefined">list</span>(fundamental_cols) + <span class="predefined">list</span>(technical_cols),
}
<span class="comment"># 学習用データセットを指定</span>
col = <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental_only</span><span class="delimiter">&quot;</span></span>

<span class="comment"># 学習</span>
pred_model = models[model](random_state=<span class="integer">0</span>)
pred_model.fit(train_X[label][columns[col]].values, train_y[label])

<span class="comment"># 予測</span>
result = {}
result[label] = pd.DataFrame(
    pred_model.predict(val_X[label][columns[col]]), columns=[<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>]
)

<span class="comment"># 予測結果に日付と銘柄コードを追加</span>
result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = val_X[label][columns[col]].index
result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = val_X[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].values

<span class="comment"># 予測の符号を取得</span>
result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">predict_dir</span><span class="delimiter">&quot;</span></span>] = np.sign(result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>])

<span class="comment"># 実際の値を追加</span>
result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>] = val_y[label].values</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_予測結果の可視化方法">2.10.2. 予測結果の可視化方法</h4>
<div class="paragraph">
<p>予測結果の確認として、実際に決算開示等のあった銘柄について基準日付の終値から最高値への変化率(actual)と予測スコア(predict)の散布図を見ます。ここで散布図を選択する理由は、予測対象に対して予測スコアがどのような分布をとっているかを見ることが、モデルの挙動を理解するわかりやすい可視化であることが挙げられます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">sns.jointplot(data=result[label], x=<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>, y=<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/actual_pred.png" alt="scatter_plot_actual_predict">
</div>
</div>
<div class="paragraph">
<p>この図では、横軸が予測値で、縦軸が真の値です。予測と真の値には、正の相関(0.144192)が見受けられるので、ある程度の相関関係が発生しています。一般的なデータで0.144という数字が出てもほぼ無相関に見えますが、金融データでは0.144というスコアは高い部類に入ります。このように視覚化すると、予測値と真の値の関係性を可視化できます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_予測結果に対する分析の道筋">2.11. 予測結果に対する分析の道筋</h3>
<div class="paragraph">
<p>予測精度を向上させるためには、特徴量とモデルの分析を集中的に行う必要があります。特徴量の分析では、さまざまな手法がありますが、ここでは特徴量の重要度の分析とSHAPという手法を紹介します。</p>
</div>
<div class="sect3">
<h4 id="_特徴量の重要度">2.11.1. 特徴量の重要度</h4>
<div class="paragraph">
<p>特徴量の重要度は、Random ForestやGradient Boostingなどのいくつかの機械学習モデルで取得でき、モデル内でどの程度それぞれの説明変数が、目的変数に対して重要であるかを判断するために参考になる指標です。</p>
</div>
<div class="paragraph">
<p>重要度が極端に低いものは、そもそも説明変数から除外したり、重要度が高いものは更に分析することで、性能の向上が期待できないか、など分析の道筋をつける上でも役に立ちます。</p>
</div>
<div class="paragraph">
<p>ここではファンダメンタル情報を用いて、モデルの訓練データ(2016年初から2017年末まで)における特徴量の重要度を調査します。</p>
</div>
<div class="paragraph">
<p>次の方法に従って、特徴量の重要度をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 学習済みモデルを指定</span>
rf = pred_model

<span class="comment"># 重要度順を取得</span>
sorted_idx = rf.feature_importances_.argsort()
<span class="comment"># プロット</span>
fig, ax = plt.subplots(figsize=(<span class="integer">8</span>, <span class="integer">8</span>))
ax.barh(fundamental_cols[sorted_idx], rf.feature_importances_[sorted_idx])
ax.set_xlabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">Random Forest Feature Importance</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/feature_importance.png" alt="ファンダメンタル情報の特徴量重要度">
</div>
</div>
<div class="paragraph">
<p>上記の可視化により、 一番上にある <code>NetAssets(純資産)</code> にモデルが注目していることがわかります。純資産は資本金や利益剰余金などを合算した指標で、次に登場する <code>TotalAssets(総資産)</code> から負債を引いたものとなります。 <code>TotalAssets(総資産)</code> は、流動資産や固定資産、繰延資産など、会社の全ての資産を合算したものを示す指標です。<br>
この2つは会社の規模を示す代表的な指標となっています。<br>
Random Forestモデルの内部で、この2つを利用した分岐が多数存在していることを示しており、会社規模が重要な指標である可能性を示唆しています。</p>
</div>
</div>
<div class="sect3">
<h4 id="_shap">2.11.2. SHAP</h4>
<div class="paragraph">
<p>SHAPは、学習済みモデルにおいて、各特徴量がモデルの出力する予測値に与えた影響度を算出してくれるものです。</p>
</div>
<div class="paragraph">
<p>ここでは、サンプルモデルとしてXGBoostモデルを利用し、 <code>label_high_20</code> という目的変数に対して、どの特徴量が学習に効果的な特徴量なのかを見てみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># モデルを定義します</span>
sample_model = xgboost.train({<span class="string"><span class="delimiter">&quot;</span><span class="content">learning_rate</span><span class="delimiter">&quot;</span></span>: <span class="float">0.01</span>}, xgboost.DMatrix(train_X[<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>], label=train_y[<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>]), <span class="integer">100</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>次にshap値を求めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">shap.initjs()
explainer = shap.TreeExplainer(model=sample_model, feature_perturbation=<span class="string"><span class="delimiter">'</span><span class="content">tree_path_dependent</span><span class="delimiter">'</span></span>, model_output=<span class="string"><span class="delimiter">'</span><span class="content">margin</span><span class="delimiter">'</span></span>)
<span class="comment"># SHAP値</span>
shap_values = explainer.shap_values(X=train_X[<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># プロット</span>
shap.summary_plot(shap_values, train_X[<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>], plot_type=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/shap_bar.png" alt="shap importance">
</div>
</div>
<div class="paragraph">
<p>次にshapのsummary_plotを確認します。これは特徴量を少し変化させた時の学習のインパクトを表しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">shap.summary_plot(shap_values, train_X[<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/shap_graph.png" alt="shap summary plot">
</div>
</div>
<div class="paragraph">
<p>この図の見方ですが、上にある特徴量ほどモデルにとって重要であることを意味します。色が赤いのがその特徴量が高い時、青いのがその特徴量が低い時のSHAP値になります。図からは例えば以下のようなことが読み取れます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Total Assets</code> が1番目にモデルに影響を与える特徴量であることがわかります。プラス方向、マイナス方向に関わらず青い色が多いので、モデルが <code>Total Assets</code> が小さい場合にこの特徴量を活用していることがわかります。 <code>Net Assets</code> も同様の傾向が観測されます</p>
</li>
<li>
<p><code>volatility_1month</code> がモデルに大きな影響を与える特徴量であることがわかります。この特徴量は赤い時にプラス方向(高値が大きくなる)の影響が大きいことがわかります。これはボラティリティが上昇すると高値が高くなるということを意味するので直感に合致します。</p>
</li>
<li>
<p><code>MA_gap_1_month</code> が小さい時にプラス方向(高値が大きくなる)に影響を与えています。移動平均乖離率が小さいときは移動平均線がその時点の株価よりも下にいる期間なので、その時に高値が伸びるのは株価が反転している可能性が高いのかもしれません。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>上記のような考察を行いながら、さまざまな特徴量を考え、モデルを改善していくことが重要です。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_モデルの評価">2.12. モデルの評価</h3>
<div class="sect3">
<h4 id="_複数モデルの学習及び結果をまとめる">2.12.1. 複数モデルの学習及び結果をまとめる</h4>
<div class="paragraph">
<p>ここでは、複数モデルを用いて、予測及び結果の比較を行いたいと思います。</p>
</div>
<div class="paragraph">
<p>今回はシンプルなモデルを複数用います。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>モデル名</strong></th>
<th class="tableblock halign-left valign-top"><strong>パラメーター</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RandomForestRegressor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random_state = 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExtraTreesRegressor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random_state = 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GradientBoostingRegressor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">random_state = 0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>次は学習用のデータセットも複数用意します。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>学習用データセット名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fundamental_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務諸表データのみ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">価格変化率のデータのみ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">technical_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テクニカル指標のみ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fundamental+technical</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務諸表とテクニカル指標の両方</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># モデルを定義</span>
models = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">rf</span><span class="delimiter">&quot;</span></span>: RandomForestRegressor,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">extraTree</span><span class="delimiter">&quot;</span></span>: ExtraTreesRegressor,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">gbr</span><span class="delimiter">&quot;</span></span>: GradientBoostingRegressor,
}

<span class="comment"># 学習用データセット定義</span>
columns = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental_only</span><span class="delimiter">&quot;</span></span>: fundamental_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">return_only</span><span class="delimiter">&quot;</span></span>: returns_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">technical_only</span><span class="delimiter">&quot;</span></span>: technical_cols,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental+technical</span><span class="delimiter">&quot;</span></span>: <span class="predefined">list</span>(fundamental_cols) + <span class="predefined">list</span>(technical_cols),
}

<span class="comment"># 学習済みモデル保存用</span>
trained_models = <span class="predefined">dict</span>()
<span class="comment"># 結果保存用</span>
all_results = <span class="predefined">dict</span>()
<span class="comment"># モデル毎に処理</span>
<span class="keyword">for</span> model <span class="keyword">in</span> tqdm(models.keys()):
    all_results[model] = <span class="predefined">dict</span>()
    trained_models[model] = <span class="predefined">dict</span>()
    <span class="comment"># データセット毎に処理</span>
    <span class="keyword">for</span> col <span class="keyword">in</span> tqdm(columns.keys()):
        result = <span class="predefined">dict</span>()
        trained_models[model][col] = <span class="predefined">dict</span>()
        <span class="comment"># 目的変数毎に処理</span>
        <span class="keyword">for</span> label <span class="keyword">in</span> tqdm(labels):
            <span class="keyword">if</span> <span class="predefined">len</span>(test_X[label][columns[col]]) &gt; <span class="integer">0</span>:
                <span class="comment"># モデル取得</span>
                pred_model = models[model](random_state=<span class="integer">0</span>)
                <span class="comment"># 学習</span>
                pred_model.fit(train_X[label][columns[col]].values, train_y[label])
                <span class="comment"># 学習済みモデル保存</span>
                trained_models[model][col][label] = pred_model
                <span class="comment"># 結果データ作成</span>
                result[label] = test_X[label][[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]].copy()
                result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = test_X[label][columns[col]].index
                <span class="comment"># 予測</span>
                result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>] = pred_model.predict(test_X[label][columns[col]])
                result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">predict_dir</span><span class="delimiter">&quot;</span></span>] = np.sign(result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>])
                <span class="comment"># 実際の結果</span>
                result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>] = test_y[label].values
                result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">actual_dir</span><span class="delimiter">&quot;</span></span>] = np.sign(result[label][<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>])
                result[label].dropna(inplace=<span class="predefined-constant">True</span>)

        all_results[model][col] = result</code></pre>
</div>
</div>
<div class="paragraph">
<p>次にデータをまとめます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">results = []
<span class="keyword">for</span> model <span class="keyword">in</span> all_results.keys():
    <span class="keyword">for</span> col <span class="keyword">in</span> all_results[model]:
        tmp = pd.concat(all_results[model][col])
        tmp[<span class="string"><span class="delimiter">&quot;</span><span class="content">model</span><span class="delimiter">&quot;</span></span>] = model
        tmp[<span class="string"><span class="delimiter">&quot;</span><span class="content">feature</span><span class="delimiter">&quot;</span></span>] = col
        results.append(tmp)
results = pd.concat(results)
results[<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>] = [x[<span class="integer">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> results.index]
results.head(<span class="integer">5</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/multiple_data_results.png" alt="データのフォーマット">
</div>
</div>
<div class="paragraph">
<p>では、次に評価していきます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_モデルの性能を示す評価関数の紹介">2.12.2. モデルの性能を示す評価関数の紹介</h4>
<div class="paragraph">
<p>まずは、今回用いる評価関数のリストを紹介します。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>評価関数</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RMSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">二乗平均平方根</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">accuracy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">目的変数の符号と予測した目的変数の符号の精度</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spearman_corr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">スピアマンの順位相関</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">corr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ピアソンの相関係数</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R^2 score</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単回帰した時の直線と観測値のバラつき</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結果保存用変数</span>
all_metrics = []

<span class="comment"># データセット毎に処理</span>
<span class="keyword">for</span> feature <span class="keyword">in</span> columns:
    matrix = <span class="predefined">dict</span>()
    <span class="comment"># モデル毎に処理</span>
    <span class="keyword">for</span> model <span class="keyword">in</span> models:
        <span class="comment"># 目的変数毎に処理</span>
        <span class="keyword">for</span> label <span class="keyword">in</span> labels:
            <span class="comment"># 処理対象データに絞り込み</span>
            tmp_df = results[(results[<span class="string"><span class="delimiter">&quot;</span><span class="content">model</span><span class="delimiter">&quot;</span></span>] == model) &amp; (results[<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>] == label) &amp; (results[<span class="string"><span class="delimiter">&quot;</span><span class="content">feature</span><span class="delimiter">&quot;</span></span>] == feature)]
            <span class="comment"># RMSE</span>
            rmse = np.sqrt(mean_squared_error(tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>], tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>]))
            <span class="comment"># 精度</span>
            accuracy = accuracy_score(tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">predict_dir</span><span class="delimiter">&quot;</span></span>], tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">actual_dir</span><span class="delimiter">&quot;</span></span>])
            <span class="comment"># 相関係数</span>
            corr = np.corrcoef(tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>], tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>])[<span class="integer">0</span>, <span class="integer">1</span>]
            <span class="comment"># 順位相関</span>
            spearman_corr = spearmanr(tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>], tmp_df[<span class="string"><span class="delimiter">&quot;</span><span class="content">predict</span><span class="delimiter">&quot;</span></span>])[<span class="integer">0</span>]
            <span class="comment"># 結果を保存</span>
            matrix[label] = [rmse, accuracy, spearman_corr,corr, corr**<span class="integer">2</span>, feature, model, tmp_df.shape[<span class="integer">0</span>]]
        res = pd.DataFrame.from_dict(matrix).T
        res.columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">RMSE</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">accuracy</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">spearman_corr</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">corr</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">R^2 score</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">feature</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">model</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content"># of samples</span><span class="delimiter">&quot;</span></span>]
        all_metrics.append(res)
all_metrics = pd.concat(all_metrics)
all_metrics.reset_index()</code></pre>
</div>
</div>
<div class="paragraph">
<p>このままだと出力が多すぎるため、集計します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">numeric_cols = [<span class="string"><span class="delimiter">&quot;</span><span class="content">RMSE</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">accuracy</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">spearman_corr</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">corr</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">R^2 score</span><span class="delimiter">&quot;</span></span>]
<span class="keyword">for</span> col <span class="keyword">in</span> numeric_cols:
    all_metrics[col] = all_metrics[col].astype(<span class="predefined">float</span>)
<span class="comment"># indexとデータセット毎に平均を計算</span>
agg = all_metrics.reset_index().groupby([<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">feature</span><span class="delimiter">&quot;</span></span>]).agg(<span class="string"><span class="delimiter">&quot;</span><span class="content">mean</span><span class="delimiter">&quot;</span></span>)
agg</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter02/images/agg_mutiple_models.png" alt="agg mutiple models">
</div>
</div>
<div class="paragraph">
<p>この表のテクニカル分析（technical_only）とファンダメンタルデータ（fundamental_only）にそれぞれ着目すると、テクニカル分析のみを用いた特徴量の方が、ファンダメンタルデータよりも精度（accuracy）という観点で若干優れていることが分かります。<br>
また、テクニカル分析とファンダメンタルデータの両方を特徴量を用いた場合の結果に関しては、テクニカル分析よりも若干全体正解率が高くなっていますが、誤差の範囲内です。相関係数（corr）に関し、テクニカル分析とファンダメンタルデータを両方用いた場合は、用いていない場合に比べて、優れていることが分かります。</p>
</div>
<div class="paragraph">
<p>このように特徴量を選択しながら複数のモデルをつくり、複数の評価関数で評価を行うことで、テクニカル分析とファンダメンタルデータを組み合わせたアプローチのポテンシャルが高いことがわかります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_モデルの提出">2.13. モデルの提出</h3>
<div class="paragraph">
<p>本コンペティションでは、モデルの予測の提出方法はモデル提出方式になります。以下ではこの方式について簡単に説明しますが、詳しくは <a href="https://signate.jp/features/runtime/detail">SIGNATE: Runtime 投稿方法</a>をご参照ください。</p>
</div>
<div class="sect3">
<h4 id="_runtimeの概要">2.13.1. Runtimeの概要</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>学習済モデルを投稿すると、アルゴリズム (推論プログラム) が実行され、推論時間・推論結果が出力されます。
出力された推論結果は、評価関数（既存の投稿機能）に自動で投稿されます。</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Runtime 機能でできること<br>
<cite><a href="https://signate.jp/features/runtime/detail">SIGNATE: Runtime 投稿方法</a></cite>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_提出ファイルの作成">2.13.2. 提出ファイルの作成</h4>
<div class="sect4">
<h5 id="_1_提出ファイルのテンプレートをダウンロード">1.提出ファイルのテンプレートをダウンロード</h5>
<div class="paragraph">
<p><a href="https://signate-prd-public.s3.ap-northeast-1.amazonaws.com/features/runtime/archive.zip">こちら</a>からダウンロード</p>
</div>
</div>
<div class="sect4">
<h5 id="_2_ディレクトリの構造を確認する">2.ディレクトリの構造を確認する</h5>
<div class="paragraph">
<p>アップロードするディレクトリ構造は次のとおりです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
├── model                  必須 学習済モデルを置くディレクトリ
│   └── ...
├── src                    必須 Python のプログラムを置くディレクトリ
│   ├── predictor.py       必須 最初のプログラムが呼び出すファイル
│   └── ...                その他のファイル (ディレクトリ作成可能)
└── requirements.txt       任意</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_3_学習済みモデルの作成">3.学習済みモデルの作成</h5>
<div class="paragraph">
<p>以下の環境でモデルを構築してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python3 Anaconda3-2019.03 インストールガイドは次のとおりです。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>一般的なケース</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>https://repo.continuum.io/archive/ からバージョン2019.03をダウンロードしてください</pre>
</div>
</div>
<div class="paragraph">
<p><strong>pyenv</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>pyenv install anaconda3-2019.03</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Docker</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker pull continuumio/anaconda3:2019.03</pre>
</div>
</div>
<div class="paragraph">
<p>ここで、学習済みモデルの保存方法について説明します。
学習済みモデルは <code>pickle</code> で保存します。保存場所はChapter 2.13.2で説明したディレクトリ構造の学習済みモデルの配置先である <code>model</code> ディレクトリになります。任意のファイル名を設定可能なので、今回はモデルの対象としている目的変数がわかるように <code>my_model_{label}.pkl</code> という名前で保存します。具体的にはモデルの保存は以下のように行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># モデル保存用にメソッドを定義します</span>
<span class="keyword">def</span> <span class="function">save_model</span>(model, label, model_path=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>):
    <span class="comment"># モデル保存先ディレクトリを作成</span>
    os.makedirs(model_path, exist_ok=<span class="predefined-constant">True</span>)
    <span class="keyword">with</span> <span class="predefined">open</span>(os.path.join(model_path, f<span class="string"><span class="delimiter">&quot;</span><span class="content">my_model_{label}.pkl</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">wb</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
        <span class="comment"># モデルをpickle形式で保存</span>
        pickle.dump(model, f)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 保存した学習済みモデルから、提出するモデルを選択してpickle形式で保存します。</span>
<span class="comment"># 使用するモデルや特徴量を変更する際は、学習時と推論時で同一の特徴量をモデルに</span>
<span class="comment"># 入力するために提出用のpredictor.pyについても変更する必要があることにご注意ください。</span>

<span class="comment"># モデルの保存先を指定します。</span>
model_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">archive/model</span><span class="delimiter">&quot;</span></span>
<span class="comment"># モデルの種類</span>
models = [<span class="string"><span class="delimiter">&quot;</span><span class="content">rf</span><span class="delimiter">&quot;</span></span>]
<span class="comment"># 使用する特徴量カラム</span>
columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental+technical</span><span class="delimiter">&quot;</span></span>]
<span class="comment"># 目的変数</span>
labels = [
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>,
]

<span class="comment"># モデル毎に処理</span>
<span class="keyword">for</span> model <span class="keyword">in</span> models:
    <span class="comment"># 特徴量毎に処理</span>
    <span class="keyword">for</span> col <span class="keyword">in</span> columns:
        <span class="comment"># 目的変数毎に処理</span>
        <span class="keyword">for</span> label <span class="keyword">in</span> labels:
            <span class="comment"># 学習済みモデルを取得</span>
            pred_model = trained_models[model][col][label]
            <span class="comment"># モデルを保存</span>
            save_model(pred_model, label, model_path=model_path)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_4_predictor_py_を記述する">4.predictor.py を記述する</h5>
<div class="paragraph">
<p>ここでは、提出する予測モデルを読み込み、当該モデルを用いて予測を出力させるコードの書き方について説明します。
<code>predictor.py</code> ファイルには、少なくとも以下のクラス及びメソッドを作成する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ScoringService
推論実行のためのクラスです。
以下のメソッドを実装してください。

get_model
モデルを取得するメソッドです。以下の条件があります。
- クラスメソッドであること
- 引数 model_path (str 型) を指定すること
- 正常終了時は返り値を true (bool 型) とすること

predict
推論を実行するメソッドです。以下の条件があります。
- クラスメソッドであること
- 引数 input (dict[str] 型) を指定すること
※ 詳しくはテンプレート内の、predictor.pyファイルをご確認ください。</pre>
</div>
</div>
<div class="paragraph">
<p>本コンペティションにおけるpredictメソッドの返り値の定義は以下となります。詳細は以下に記載したコードをご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>結果を以下のcsv形式の文字列として出力する。
１列目:datetimeとcodeをつなげたもの(Ex 2016-05-09-1301)
２列目:label_high_20　終値→最高値への変化率
３列目:label_low_20　終値→最安値への変化率
headerはなし、B列C列はfloat64</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下は、本チュートリアルで説明した内容をこの規約に合わせて記載したpredictor.pyです。
本コンペティションのPublic LBの評価期間と一致するようにデータの分割期間を調整してあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># -*- coding: utf-8 -*-</span>
<span class="keyword">import</span> <span class="include">io</span>
<span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">pickle</span>

<span class="keyword">import</span> <span class="include">numpy</span> <span class="keyword">as</span> np
<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd
<span class="keyword">from</span> <span class="include">sklearn.ensemble</span> <span class="keyword">import</span> <span class="include">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="include">tqdm.auto</span> <span class="keyword">import</span> <span class="include">tqdm</span>


<span class="keyword">class</span> <span class="class">ScoringService</span>(<span class="predefined">object</span>):
    <span class="comment"># 訓練期間終了日</span>
    TRAIN_END = <span class="string"><span class="delimiter">&quot;</span><span class="content">2018-12-31</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 評価期間開始日</span>
    VAL_START = <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-02-01</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 評価期間終了日</span>
    VAL_END = <span class="string"><span class="delimiter">&quot;</span><span class="content">2019-12-01</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># テスト期間開始日</span>
    TEST_START = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 目的変数</span>
    TARGET_LABELS = [<span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>]

    <span class="comment"># データをこの変数に読み込む</span>
    dfs = <span class="predefined-constant">None</span>
    <span class="comment"># モデルをこの変数に読み込む</span>
    models = <span class="predefined-constant">None</span>
    <span class="comment"># 対象の銘柄コードをこの変数に読み込む</span>
    codes = <span class="predefined-constant">None</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_inputs</span>(cls, dataset_dir):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dataset_dir (str)  : path to dataset directory</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            dict[str]: path to dataset files</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        inputs = {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin.csv.gz</span><span class="delimiter">&quot;</span></span>,
            <span class="comment"># &quot;stock_fin_price&quot;: f&quot;{dataset_dir}/stock_fin_price.csv.gz&quot;,</span>
            <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_labels.csv.gz</span><span class="delimiter">&quot;</span></span>,
        }
        <span class="keyword">return</span> inputs

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_dataset</span>(cls, inputs):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            inputs (list[str]): path to dataset files</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            dict[pd.DataFrame]: loaded data</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="keyword">if</span> cls.dfs <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            cls.dfs = {}
        <span class="keyword">for</span> k, v <span class="keyword">in</span> inputs.items():
            cls.dfs[k] = pd.read_csv(v)
            <span class="comment"># DataFrameのindexを設定します。</span>
            <span class="keyword">if</span> k == <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>:
                cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
                    cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>]
                )
                cls.dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
            <span class="keyword">elif</span> k <span class="keyword">in</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>]:
                cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
                    cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>]
                )
                cls.dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
        <span class="keyword">return</span> cls.dfs

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_codes</span>(cls, dfs):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict[pd.DataFrame]): loaded data</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            array: list of stock codes</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        stock_list = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>].copy()
        <span class="comment"># 予測対象の銘柄コードを取得</span>
        cls.codes = stock_list[stock_list[<span class="string"><span class="delimiter">&quot;</span><span class="content">prediction_target</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>][
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
        ].values
        <span class="keyword">return</span> cls.codes

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_features_and_label</span>(cls, dfs, codes, feature, label):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict[pd.DataFrame]): loaded data</span><span class="content">
</span><span class="content">            codes  (array) : target codes</span><span class="content">
</span><span class="content">            feature (pd.DataFrame): features</span><span class="content">
</span><span class="content">            label (str) : label column name</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            train_X (pd.DataFrame): training data</span><span class="content">
</span><span class="content">            train_y (pd.DataFrame): label for train_X</span><span class="content">
</span><span class="content">            val_X (pd.DataFrame): validation data</span><span class="content">
</span><span class="content">            val_y (pd.DataFrame): label for val_X</span><span class="content">
</span><span class="content">            test_X (pd.DataFrame): test data</span><span class="content">
</span><span class="content">            test_y (pd.DataFrame): label for test_X</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="comment"># 分割データ用の変数を定義</span>
        trains_X, vals_X, tests_X = [], [], []
        trains_y, vals_y, tests_y = [], [], []

        <span class="comment"># 銘柄コード毎に特徴量を作成</span>
        <span class="keyword">for</span> code <span class="keyword">in</span> tqdm(codes):
            <span class="comment"># 特徴量取得</span>
            feats = feature[feature[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] == code]

            <span class="comment"># stock_labelデータを読み込み</span>
            stock_labels = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>]
            <span class="comment"># 特定の銘柄コードのデータに絞る</span>
            stock_labels = stock_labels[stock_labels[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]

            <span class="comment"># 特定の目的変数に絞る</span>
            labels = stock_labels[label].copy()
            <span class="comment"># nanを削除</span>
            labels.dropna(inplace=<span class="predefined-constant">True</span>)

            <span class="keyword">if</span> feats.shape[<span class="integer">0</span>] &gt; <span class="integer">0</span> <span class="keyword">and</span> labels.shape[<span class="integer">0</span>] &gt; <span class="integer">0</span>:
                <span class="comment"># 特徴量と目的変数のインデックスを合わせる</span>
                labels = labels.loc[labels.index.isin(feats.index)]
                feats = feats.loc[feats.index.isin(labels.index)]
                labels.index = feats.index

                <span class="comment"># データを分割</span>
                _train_X = feats[: cls.TRAIN_END]
                _val_X = feats[cls.VAL_START : cls.VAL_END]
                _test_X = feats[cls.TEST_START :]

                _train_y = labels[: cls.TRAIN_END]
                _val_y = labels[cls.VAL_START : cls.VAL_END]
                _test_y = labels[cls.TEST_START :]

                <span class="comment"># データを配列に格納 (後ほど結合するため)</span>
                trains_X.append(_train_X)
                vals_X.append(_val_X)
                tests_X.append(_test_X)

                trains_y.append(_train_y)
                vals_y.append(_val_y)
                tests_y.append(_test_y)
        <span class="comment"># 銘柄毎に作成した説明変数データを結合します。</span>
        train_X = pd.concat(trains_X)
        val_X = pd.concat(vals_X)
        test_X = pd.concat(tests_X)
        <span class="comment"># 銘柄毎に作成した目的変数データを結合します。</span>
        train_y = pd.concat(trains_y)
        val_y = pd.concat(vals_y)
        test_y = pd.concat(tests_y)

        <span class="keyword">return</span> train_X, train_y, val_X, val_y, test_X, test_y

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_features_for_predict</span>(cls, dfs, code, start_dt=<span class="string"><span class="delimiter">&quot;</span><span class="content">2016-01-01</span><span class="delimiter">&quot;</span></span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict)  : dict of pd.DataFrame include stock_fin, stock_price</span><span class="content">
</span><span class="content">            code (int)  : A local code for a listed company</span><span class="content">
</span><span class="content">            start_dt (str): specify date range</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            feature DataFrame (pd.DataFrame)</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="comment"># stock_finデータを読み込み</span>
        stock_fin = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>]

        <span class="comment"># 特定の銘柄コードのデータに絞る</span>
        fin_data = stock_fin[stock_fin[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
        <span class="comment"># 特徴量の作成には過去60営業日のデータを使用しているため、</span>
        <span class="comment"># 予測対象日からバッファ含めて土日を除く過去90日遡った時点から特徴量を生成します</span>
        n = <span class="integer">90</span>
        <span class="comment"># 特徴量の生成対象期間を指定</span>
        fin_data = fin_data.loc[pd.Timestamp(start_dt) - pd.offsets.BDay(n) :]
        <span class="comment"># fin_dataのnp.float64のデータのみを取得</span>
        fin_data = fin_data.select_dtypes(include=[<span class="string"><span class="delimiter">&quot;</span><span class="content">float64</span><span class="delimiter">&quot;</span></span>])
        <span class="comment"># 欠損値処理</span>
        fin_feats = fin_data.fillna(<span class="integer">0</span>)

        <span class="comment"># stock_priceデータを読み込む</span>
        price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]
        <span class="comment"># 特定の銘柄コードのデータに絞る</span>
        price_data = price[price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
        <span class="comment"># 終値のみに絞る</span>
        feats = price_data[[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]]
        <span class="comment"># 特徴量の生成対象期間を指定</span>
        feats = feats.loc[pd.Timestamp(start_dt) - pd.offsets.BDay(n) :].copy()

        <span class="comment"># 終値の20営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_1month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">20</span>)
        <span class="comment"># 終値の40営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_2month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">40</span>)
        <span class="comment"># 終値の60営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_3month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">60</span>)
        <span class="comment"># 終値の20営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_1month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">20</span>)
            .std()
        )
        <span class="comment"># 終値の40営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_2month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">40</span>)
            .std()
        )
        <span class="comment"># 終値の60営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_3month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">60</span>)
            .std()
        )
        <span class="comment"># 終値と20営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">20</span>).mean()
        )
        <span class="comment"># 終値と40営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">40</span>).mean()
        )
        <span class="comment"># 終値と60営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">60</span>).mean()
        )
        <span class="comment"># 欠損値処理</span>
        feats = feats.fillna(<span class="integer">0</span>)
        <span class="comment"># 元データのカラムを削除</span>
        feats = feats.drop([<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], axis=<span class="integer">1</span>)

        <span class="comment"># 財務データの特徴量とマーケットデータの特徴量のインデックスを合わせる</span>
        feats = feats.loc[feats.index.isin(fin_feats.index)]
        fin_feats = fin_feats.loc[fin_feats.index.isin(feats.index)]

        <span class="comment"># データを結合</span>
        feats = pd.concat([feats, fin_feats], axis=<span class="integer">1</span>).dropna()

        <span class="comment"># 欠損値処理を行います。</span>
        feats = feats.replace([np.inf, -np.inf], <span class="integer">0</span>)

        <span class="comment"># 銘柄コードを設定</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = code

        <span class="comment"># 生成対象日以降の特徴量に絞る</span>
        feats = feats.loc[pd.Timestamp(start_dt) :]

        <span class="keyword">return</span> feats

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_feature_columns</span>(cls, dfs, train_X, column_group=<span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental+technical</span><span class="delimiter">&quot;</span></span>):
        <span class="comment"># 特徴量グループを定義</span>
        <span class="comment"># ファンダメンタル</span>
        fundamental_cols = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>].select_dtypes(<span class="string"><span class="delimiter">&quot;</span><span class="content">float64</span><span class="delimiter">&quot;</span></span>).columns
        fundamental_cols = fundamental_cols[
            fundamental_cols != <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_Dividend DividendPayableDate</span><span class="delimiter">&quot;</span></span>
        ]
        fundamental_cols = fundamental_cols[fundamental_cols != <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>]
        <span class="comment"># 価格変化率</span>
        returns_cols = [x <span class="keyword">for</span> x <span class="keyword">in</span> train_X.columns <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> x]
        <span class="comment"># テクニカル</span>
        technical_cols = [
            x <span class="keyword">for</span> x <span class="keyword">in</span> train_X.columns <span class="keyword">if</span> (x <span class="keyword">not</span> <span class="keyword">in</span> fundamental_cols) <span class="keyword">and</span> (x != <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>)
        ]
        columns = {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental_only</span><span class="delimiter">&quot;</span></span>: fundamental_cols,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">return_only</span><span class="delimiter">&quot;</span></span>: returns_cols,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">technical_only</span><span class="delimiter">&quot;</span></span>: technical_cols,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">fundamental+technical</span><span class="delimiter">&quot;</span></span>: <span class="predefined">list</span>(fundamental_cols) + <span class="predefined">list</span>(technical_cols),
        }
        <span class="keyword">return</span> columns[column_group]

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">create_model</span>(cls, dfs, codes, label):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict)  : dict of pd.DataFrame include stock_fin, stock_price</span><span class="content">
</span><span class="content">            codes (list[int]): A local code for a listed company</span><span class="content">
</span><span class="content">            label (str): prediction target label</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            RandomForestRegressor</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="comment"># 特徴量を取得</span>
        buff = []
        <span class="keyword">for</span> code <span class="keyword">in</span> codes:
            buff.append(cls.get_features_for_predict(cls.dfs, code))
        feature = pd.concat(buff)
        <span class="comment"># 特徴量と目的変数を一致させて、データを分割</span>
        train_X, train_y, _, _, _, _ = cls.get_features_and_label(
            dfs, codes, feature, label
        )
        <span class="comment"># 特徴量カラムを指定</span>
        feature_columns = cls.get_feature_columns(dfs, train_X)
        <span class="comment"># モデル作成</span>
        model = RandomForestRegressor(random_state=<span class="integer">0</span>)
        model.fit(train_X[feature_columns], train_y)

        <span class="keyword">return</span> model

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">save_model</span>(cls, model, label, model_path=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            model (RandomForestRegressor): trained model</span><span class="content">
</span><span class="content">            label (str): prediction target label</span><span class="content">
</span><span class="content">            model_path (str): path to save model</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            -</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="comment"># tag::save_model_partial[]</span>
        <span class="comment"># モデル保存先ディレクトリを作成</span>
        os.makedirs(model_path, exist_ok=<span class="predefined-constant">True</span>)
        <span class="keyword">with</span> <span class="predefined">open</span>(os.path.join(model_path, f<span class="string"><span class="delimiter">&quot;</span><span class="content">my_model_{label}.pkl</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">wb</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
            <span class="comment"># モデルをpickle形式で保存</span>
            pickle.dump(model, f)
        <span class="comment"># end::save_model_partial[]</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_model</span>(cls, model_path=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>, labels=<span class="predefined-constant">None</span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">Get model method</span><span class="content">
</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            model_path (str): Path to the trained model directory.</span><span class="content">
</span><span class="content">            labels (arrayt): list of prediction target labels</span><span class="content">
</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            bool: The return value. True for success, False otherwise.</span><span class="content">
</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="keyword">if</span> cls.models <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            cls.models = {}
        <span class="keyword">if</span> labels <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            labels = cls.TARGET_LABELS
        <span class="keyword">for</span> label <span class="keyword">in</span> labels:
            m = os.path.join(model_path, f<span class="string"><span class="delimiter">&quot;</span><span class="content">my_model_{label}.pkl</span><span class="delimiter">&quot;</span></span>)
            <span class="keyword">with</span> <span class="predefined">open</span>(m, <span class="string"><span class="delimiter">&quot;</span><span class="content">rb</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
                <span class="comment"># pickle形式で保存されているモデルを読み込み</span>
                cls.models[label] = pickle.load(f)

        <span class="keyword">return</span> <span class="predefined-constant">True</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">train_and_save_model</span>(
        cls, inputs, labels=<span class="predefined-constant">None</span>, codes=<span class="predefined-constant">None</span>, model_path=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>
    ):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">Predict method</span><span class="content">
</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            inputs (str)   : paths to the dataset files</span><span class="content">
</span><span class="content">            labels (array) : labels which is used in prediction model</span><span class="content">
</span><span class="content">            codes  (array) : target codes</span><span class="content">
</span><span class="content">            model_path (str): Path to the trained model directory.</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            Dict[pd.DataFrame]: Inference for the given input.</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="keyword">if</span> cls.dfs <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            cls.get_dataset(inputs)
            cls.get_codes(cls.dfs)
        <span class="keyword">if</span> codes <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            codes = cls.codes
        <span class="keyword">if</span> labels <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            labels = cls.TARGET_LABELS
        <span class="keyword">for</span> label <span class="keyword">in</span> labels:
            print(label)
            model = cls.create_model(cls.dfs, codes=codes, label=label)
            cls.save_model(model, label, model_path=model_path)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">predict</span>(cls, inputs, labels=<span class="predefined-constant">None</span>, codes=<span class="predefined-constant">None</span>, start_dt=TEST_START):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">Predict method</span><span class="content">
</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            inputs (dict[str]): paths to the dataset files</span><span class="content">
</span><span class="content">            labels (list[str]): target label names</span><span class="content">
</span><span class="content">            codes (list[int]): traget codes</span><span class="content">
</span><span class="content">            start_dt (str): specify date range</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            str: Inference for the given input.</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>

        <span class="comment"># データ読み込み</span>
        <span class="keyword">if</span> cls.dfs <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            cls.get_dataset(inputs)
            cls.get_codes(cls.dfs)

        <span class="comment"># 予測対象の銘柄コードと目的変数を設定</span>
        <span class="keyword">if</span> codes <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            codes = cls.codes
        <span class="keyword">if</span> labels <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            labels = cls.TARGET_LABELS

        <span class="comment"># 特徴量を作成</span>
        buff = []
        <span class="keyword">for</span> code <span class="keyword">in</span> codes:
            buff.append(cls.get_features_for_predict(cls.dfs, code, start_dt))
        feats = pd.concat(buff)

        <span class="comment"># 結果を以下のcsv形式で出力する</span>
        <span class="comment"># １列目:datetimeとcodeをつなげたもの(Ex 2016-05-09-1301)</span>
        <span class="comment"># ２列目:label_high_20　終値→最高値への変化率</span>
        <span class="comment"># ３列目:label_low_20　終値→最安値への変化率</span>
        <span class="comment"># headerはなし、B列C列はfloat64</span>

        <span class="comment"># 日付と銘柄コードに絞り込み</span>
        df = feats.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]].copy()
        <span class="comment"># codeを出力形式の１列目と一致させる</span>
        df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = df.index.strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d-</span><span class="delimiter">&quot;</span></span>) + df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].astype(
            <span class="predefined">str</span>
        )

        <span class="comment"># 出力対象列を定義</span>
        output_columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]

        <span class="comment"># 特徴量カラムを指定</span>
        feature_columns = cls.get_feature_columns(cls.dfs, feats)

        <span class="comment"># 目的変数毎に予測</span>
        <span class="keyword">for</span> label <span class="keyword">in</span> labels:
            <span class="comment"># 予測実施</span>
            df[label] = cls.models[label].predict(feats[feature_columns])
            <span class="comment"># 出力対象列に追加</span>
            output_columns.append(label)

        out = io.StringIO()
        df.to_csv(out, header=<span class="predefined-constant">False</span>, index=<span class="predefined-constant">False</span>, columns=output_columns)

        <span class="keyword">return</span> out.getvalue()</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_モジュールの追加">モジュールの追加</h6>
<div class="paragraph">
<p><a href="https://docs.anaconda.com/anaconda/packages/py3.7_linux-64/" class="bare">https://docs.anaconda.com/anaconda/packages/py3.7_linux-64/</a>
この表の [In Installer] にチェックが入っているものが、すでにインストールされています（ただしバージョンは異なります）。</p>
</div>
<div class="paragraph">
<p>Runtime環境にモジュールを追加するためには <code>requirements.txt</code> に追記します。requirements.txtに記載したモジュールは実行時にpipでインストールされます。</p>
</div>
<div class="paragraph">
<p>モジュールを追加する際はRuntime環境でインストール及び使用可能かをご確認ください。本チュートリアルで評価のために使用したSHAPのように、一部のモジュールはインストール時にビルドが必要となるものもあります。そのためRuntime環境では使用することのできないモジュールもあります。以下のように実行環境のdocker container内でインストールすることで確認可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker run --rm -it continuumio/anaconda3:2019.03 bash
# pip install tensorflow==2.4.0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>requirements.txt</code> には以下のようにモジュールのバージョンを指定して記載します。これは、モデルを提出してから全ての評価が完了するまで数ヶ月かかるためその間にモジュールの最新バージョンがリリースされても影響を受けないようにするためです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tensorflow==2.4.0</pre>
</div>
</div>
<div class="paragraph">
<p><code>requirements.txt</code> の作成には <code>pip freeze</code> コマンドを使用すると便利です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker run --rm -it continuumio/anaconda3:2019.03 bash
# pip install [インストールするモジュール]
# pip freeze</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_デバッグ方法">デバッグ方法</h6>
<div class="paragraph">
<p>通常</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ pip install -r requirements.txt   # モジュールが必要な場合は pip でインストールします
$ cd src    # ソースディレクトリに移動
$ python    # python の実行
Python 3.7.3 (default, Mar 27 2019, 16:54:48)
[Clang 4.0.1 (tags/RELEASE_401/final)] :: Anaconda, Inc. on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; DATASET_DIR= "/path/to" # データ保存先ディレクトリ
&gt;&gt;&gt; from predictor import ScoringService  # モジュール読み込み
&gt;&gt;&gt; inputs = ScoringService.get_inputs(DATASET_DIR)  # 推論入力データ取得
&gt;&gt;&gt; ScoringService.get_model()  # モデルの取得
True
&gt;&gt;&gt; ScoringService.predict(inputs)  # 推論の実行
'[推論結果]'</pre>
</div>
</div>
<div class="paragraph">
<p>pyenvを使用</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ pyenv local anaconda3-2019.03</pre>
</div>
</div>
<div class="paragraph">
<p>以降 通常のインストールの場合と同様のデバッグ方法です。</p>
</div>
<div class="paragraph">
<p>Docker を使用</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker run -it -v $(pwd):/opt/ml continuumio/anaconda3:2019.03 /bin/bash
$ cd /opt/ml</pre>
</div>
</div>
<div class="paragraph">
<p>以降は、通常のインストールの場合と同様のデバッグ方法になります。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_5_zip_で圧縮して提出する">5.zip で圧縮して提出する。</h5>
<div class="paragraph">
<p>指定されたディレクトリ構成で学習済みモデルを保存した上で、predictor.pyを作成したら、以下のようにzipで圧縮して提出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ls
model  requirements.txt  src
$ zip -v submit.zip requirements.txt src/*.py model/*.pkl
updating: requirements.txt	(in=0) (out=0) (stored 0%)
updating: src/predictor.py	(in=11408) (out=2417) (deflated 79%)
updating: model/my_model_label_high_20.pkl .	(in=18919345) (out=5071005) (deflated 73%)
updating: model/my_model_label_low_20.pkl .	(in=18704305) (out=5006613) (deflated 73%)
total bytes=37635058, compressed=10080035 -&gt; 73% savings</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ランタイム環境に関して">2.13.3. ランタイム環境に関して</h4>
<div class="paragraph">
<p>■ランタイム環境での利用可能なデータについて</p>
</div>
<div class="paragraph">
<p>・ランタイム環境に提出したモデルは、各銘柄の株価の最高値及び最安値を予測する際、評価対象となる決算短信の開示日以前のデータ（銘柄、株価、ファンダメンタル情報）を利用することができます。</p>
</div>
<div class="paragraph">
<p>・ただし、ランタイム環境では、評価対象となる決算短信の開示日の期間のデータを全て格納しているため、予測時に開示日より未来のデータを利用すると、リークが生じることになります。</p>
</div>
<div class="paragraph">
<p>・ランタイム環境でこれらのデータを用いて特徴量生成やモデルの再学習を行う際は、リークが含まれないようご留意ください。</p>
</div>
<div class="paragraph">
<p>以下、ランタイム実行日が5月10日のケース（Private 1st）を例として取り上げます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>・ランタイム環境には、2016年1月1日から2021年4月5日までのデータが配置されています
・提出モデルは、3月29日に開示された決算短信について翌営業日より20営業日間の最高値及び最安値を予測する際、3月29日までのデータを利用できます。3月30日以降のデータを利用するとリークとなり、入賞資格を失います
・同様に、4月1日に開示された決算短信について予測する際には、4月2日以降のデータは利用できません</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ポートフォリオを構築しよう">3. ポートフォリオを構築しよう</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ニュース分析チャレンジのチュートリアルの構成">3.1. 「ニュース分析チャレンジ」のチュートリアルの構成</h3>
<div class="paragraph">
<p>　3章から6章では、J-Quantsで開催するコンペティションのうち、<a href="https://signate.jp/competitions/443">「ニュース分析チャレンジ」</a>に係るチュートリアルを提供します。
本コンペティションでは、2章に記載している「ファンダメンタルズ分析チャレンジ」と同様に、データ分析や株式取引には興味はあるが、きっかけがないという方を主な対象として、投資にまつわるデータ・環 境を提供し、株式市場におけるデータ利活用の可能性を試していただくことを期待しています。</p>
</div>
<div class="paragraph">
<p>大まかに3章から6章にかけてどのようなことが記載されているのかを以下で説明します。</p>
</div>
<div class="sect3">
<h4 id="_3章の概要">3.1.1. 3章の概要</h4>
<div class="paragraph">
<p>　3章では本コンペティションに参加するための基本知識を学ぶことができます。主に以下のような題材を扱います。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>コンペティション課題の説明</p>
</li>
<li>
<p>データセットの説明</p>
</li>
<li>
<p>提出モデルの予測出力の定義</p>
</li>
<li>
<p>バックテスト手法</p>
</li>
<li>
<p>シンプルなポートフォリオの組成方法</p>
</li>
<li>
<p>ポートフォリオの評価方法</p>
</li>
<li>
<p>構築したモデルの提出方法</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_4章の概要">3.1.2. 4章の概要</h4>
<div class="paragraph">
<p>　4章では本チュートリアルの2章で構築した最高値・最安値モデルを使用したポートフォリオの構築方法を紹介しています。3章では機械学習的な手法を用いていませんが、4章では機械学習的手法で作成したモデルを利用しています。また、本コンペティションで提供されている適時開示情報についても簡単に触れています。3章より内容は複雑になりますが、実際に機械学習をポートフォリオ組成に活かすための知識を学ぶことができます。主に以下のような題材を扱います。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>2章で作成したモデルの修正</p>
</li>
<li>
<p>モデルを用いたポートフォリオの組成方法</p>
</li>
<li>
<p>適時開示情報の有効活用</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_5章の概要">3.1.3. 5章の概要</h4>
<div class="paragraph">
<p>　5章では本コンペティションの特色であるニュースデータを活用した取引戦略を構築するための手法を紹介しています。近年のディープニューラルネットワークの研究の発展により、自然言語処理の分野においても大きな技術の発展がありました。5章ではその中でも大きな成果の一つであるBERT(Bidirectional Encoder Representations from Transformers) (参考: <a href="https://qiita.com/omiita/items/72998858efc19a368e50">自然言語処理の王様「BERT」の論文を徹底解説</a>) を用いた特徴量抽出手法を紹介しています。
　また、ニュースデータの前処理や可視化も丁寧に説明しており、本コンペの特色であるニュースデータの解析に必要な以下のような基礎知識を学ぶことができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>テキストデータの基礎知識</p>
</li>
<li>
<p>テキストデータの前処理方法</p>
</li>
<li>
<p>テキストデータの可視化方法</p>
</li>
<li>
<p>BERTモデルによるニュースデータからの特徴量抽出手法</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_6章の概要">3.1.4. 6章の概要</h4>
<div class="paragraph">
<p>　6章では5章で取得したBERT特徴量を用いた取引戦略を構築するための手法の一つとしてLSTM(Long Short Term Memory)(参考: <a href="https://qiita.com/KojiOhki/items/89cd7b69a8a6239d67ca">LSTMネットワークの概要</a>)を用いたスコア生成手法を紹介しています。ただし、本章はディープニューラルネットワークの基礎知識等を前提とした、かなり高度な内容になっており、少し発展的な内容となります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ニュース分析チャレンジについて">3.2. 「ニュース分析チャレンジ」について</h3>
<div class="paragraph">
<p>　本節では、本コンペティションについての概要やスケジュールを記載しています。</p>
</div>
<div class="paragraph">
<p><strong>コンペティションの課題内容</strong></p>
</div>
<div class="paragraph">
<p>　本コンペティションでは、現金100万円を原資として、ある週の週初営業日に始値で購入、その週の週末営業日に売却するとした場合に、できる限り利益を得るポートフォリオの予測に取り組んでいただきます。<br>
　そして、前述の予測を予め決められた4週間の間に4ラウンド行っていただき、その4ラウンド全ての合計の利益を競っていただきます。</p>
</div>
<div class="paragraph">
<p><strong>コンペティションの概要</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>項目</strong></th>
<th class="tableblock halign-left valign-top"><strong>内容</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンペティション名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ニュース分析チャレンジ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">主な対象者</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式市場を対象としたデータ分析の初学者・データサイエンスに知見のある有識者・テキストデータ分析の有識者等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">入力内容（利用データ）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄情報・株価情報・ファンダメンタル情報等・日経電子版見出しテキストデータ・適時開示データ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">出力内容（予測対象）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">現金100万円を原資とし、ある週の週初営業日に複数銘柄（最低5銘柄以上）を始値で購入、その週の週末営業日に終値で売却するとした場合のポートフォリオ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">参加を通じて得られる知見</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- 株価や企業業績の推移などの時系列データの解析手法<br>
- 市場動向の把握手法<br>
- リスク分析<br>
- テキストデータの解析手法</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>スケジュール</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>日時</strong></th>
<th class="tableblock halign-left valign-top"><strong>内容</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年3月19日（金）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コンペティション開始（データダウンロードのみ可能、モデル提出は不可）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年3月26日（金）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデル提出開始</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年5月9日（日）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデル提出締切</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年5月10日（月）〜 6月4日（金）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデル評価期間（4週間4ラウンド）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年7月頃</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">入賞者の決定</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_予測対象_2">3.3. 予測対象</h3>
<div class="paragraph">
<p>　本節では、本コンペティションの予測対象であるポートフォリオやその構成銘柄の条件等について詳しく説明しています。</p>
</div>
<div class="paragraph">
<p><strong>予測対象</strong></p>
</div>
<div class="paragraph">
<p>　本コンペティションの予測対象は、現金100万円を原資として、ある週の週初営業日に始値で購入、その週の週末営業日に売却するとした場合に高い利益を得るポートフォリオとなります。下図に最終的な課題内容及び評価についてイメージを示しています。<br>
　ポートフォリオとは、「資産運用の世界で様々な資産または銘柄の組み合わせのこと」（引用：<a href="https://www.jpx.co.jp/glossary/ha/417.html">JPXHP用語集</a>）を指します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/news_predict_target.png" alt="news_predict_target">
</div>
</div>
<div class="sect3">
<h4 id="_ポートフォリオに組入れできる銘柄の条件">3.3.1. ポートフォリオに組入れできる銘柄の条件</h4>
<div class="paragraph">
<p>　本コンペティションの予測対象となるポートフォリオを構成する銘柄は、次に挙げる条件を全て満たすものになりますのでご注意ください。</p>
</div>
<div class="paragraph">
<p>A)	2020年12月末時点で、東京証券取引所に上場していること</p>
</div>
<div class="paragraph">
<p>B)	普通株式であること（種類株ではないこと）</p>
</div>
<div class="paragraph">
<p>C)	ETF、ETN、REIT、優先出資証券、インフラファンド、外国株のいずれにも該当しないこと</p>
</div>
<div class="paragraph">
<p>D)  2020年12月末時点で、時価総額が200億を上回っていること</p>
</div>
</div>
<div class="sect3">
<h4 id="_ポートフォリオの条件">3.3.2. ポートフォリオの条件</h4>
<div class="paragraph">
<p>　本コンペティションの予測対象となるポートフォリオは、次に挙げる条件を全て満たすものになります。条件を満たさないポートフォリオは失格となります。</p>
</div>
<div class="paragraph">
<p>A)	原資100万円のうち、少なくとも50万円は株の購入に充てられていること（すなわち、原資100万円全てを投資しなくても良く、50万円は銘柄購入に、残り50万円を現金として保有することは可能）</p>
</div>
<div class="paragraph">
<p>B)	少なくとも5銘柄以上で構成されるポートフォリオであること</p>
</div>
</div>
<div class="sect3">
<h4 id="anchor-3.3.4">3.3.3. 提出するモデルの予測出力の定義</h4>
<div class="paragraph">
<p>　本コンペティションで提出していただくモデルの出力は以下のフォーマット及び条件を満たす必要があります。</p>
</div>
<div class="sect4">
<h5 id="_出力フォーマット">出力フォーマット</h5>
<div class="paragraph">
<p>　以下のcsv形式で出力</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>列</strong></th>
<th class="tableblock halign-left valign-top"><strong>名前</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1列目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021-02-01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株を購入する日付（各週の月曜日の日付）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2列目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8697</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄コード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3列目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">budget</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">購入金額</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>CSVの出力例を以下に示します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/csv_sample.png" alt="csv_format_sample">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_フォーマットの条件">フォーマットの条件</h5>
<div class="ulist">
<ul>
<li>
<p>ヘッダが付与されていること</p>
</li>
<li>
<p>5銘柄以上選択されていること</p>
</li>
<li>
<p>dateは予測対象の週の月曜日の日付であること</p>
</li>
<li>
<p>購入金額は1以上であること</p>
</li>
<li>
<p>銘柄を購入優先度順に上から出力すること</p>
</li>
<li>
<p>Nanが含まれないようにすること</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_特記事項及び注意点">特記事項及び注意点</h5>
<div class="paragraph">
<p>　以下では、各条件を踏まえた特記事項及び注意点につきまして、説明します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>本コンペティションでは、*各銘柄は1株単位で購入可能* とします。</p>
<div class="ulist">
<ul>
<li>
<p>東京証券取引所をはじめとする全国の証券取引所で実際に売買する際は、売買単位は100株単位に統一されていますが、本コンペティションでは、ポートフォリオの組成を可能な限り幅広く行っていたくことを考慮して、売買単位を1株単位としています。</p>
</li>
</ul>
</div>
</li>
<li>
<p>ポートフォリオに組入れできる銘柄の条件に合致しない銘柄がモデルの予測に含まれている場合は、評価の際に該当のレコードは評価対象外として無視されます。（エラーとはなりません。）</p>
</li>
<li>
<p>モデルの予測においてdate列が週初営業日以外の日付のレコードは、評価対象外として無視されます。</p>
</li>
<li>
<p>Budget列が1未満のレコードは評価対象外として無視されます。</p>
</li>
<li>
<p>週初営業日に値段が付かなかった銘柄*のレコードは評価対象外として無視されます。<br>
※ なお、週末営業日に値段が付かなかった場合には、その日より前の日で終値が存在する日の終値を用います。</p>
</li>
<li>
<p>購入金額が50万円に到達していなかった場合は、選択された銘柄を入力順（テーブルデータの並び順）に1株ずつ50万円以上になるまで買い足されます。（評価時の具体的な処理は<a href="#anchor-3.3.5">3.3.5. 評価方法</a>を参照してください。）</p>
</li>
<li>
<p>購入金額が100万円を超える場合は、100万円以内の範囲で購入可能な株数に調整されます。（評価時の具体的な処理は<a href="#anchor-3.3.5">3.3.5. 評価方法</a>を参照してください。）</p>
</li>
<li>
<p><strong>最終的に購入された銘柄数が5銘柄未満の場合若しくは購入した金額が50万円未満の場合は、エラーとなり失格となります。</strong></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="anchor-3.3.5">3.3.4. 評価方法</h4>
<div class="paragraph">
<p>　本コンペティションでは、モデルで予測したポートフォリオで得られる利益の総合計による定量評価方法を採用します。<br>
　まず、各週にポートフォリオから得られる利益を以下の算出式を用いて計算します。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/math-sample1.svg" alt="math sample1" width="729" height="32">
</div>
</div>
<div class="paragraph">
<p>保有している株式の合計評価額 = 保有している株式のその週の週末営業日の終値 × 保持する株数<br>
保持現金 = その週の週初営業日に株式の購入に利用せずに手元に残った現金</p>
</div>
</div>
</div>
<div class="paragraph">
<p>　その上で、各週の運用実績を合計し、最終スコアとして評価し、<strong>利益の高い順に</strong>順位付けします。(ただし、利益が全く同じであった場合には、提出が早かった方を上位とします。)</p>
</div>
<div class="sect4">
<h5 id="_バックテスト関数backtest_pyの挙動">バックテスト関数（backtest.py）の挙動</h5>
<div class="paragraph">
<p>　本コンペティションにおける評価では、チュートリアルレポジトリに配置してある独自のバックテストライブラリ <code>backtest.py</code> を用いています。<br>
　モデルにより予測されたポートフォリオについて、具体的な処理の概要は以下のとおりです。なお、詳細な挙動につきましては、実際のコードをご参照ください。</p>
</div>
<div class="paragraph">
<p>【前提条件チェック等】<br>
1. 予測されたポートフォリオのフォーマットについて以下のチェックを行う(※)。<br>
　　- date列（ヘッダー）が存在するか<br>
　　- Local Code列（ヘッダー）が存在するか<br>
　　- budget列（ヘッダー）が存在するか<br>
　　- データにNaNが含まれていないか<br>
2. 予測されたポートフォリオのLocal Code列について、「ポートフォリオに組入れできる条件」に合致するレコードに絞り込む。<br>
3. 予測されたポートフォリオのdate列について、月曜日のみのレコードに絞り込む。<br>
4. 予測されたポートフォリオのbudget列について、1円以上のレコードに絞り込む。</p>
</div>
<div class="paragraph">
<p>【購入処理】<br>
5. 2〜4で絞り込んだポートフォリオについて、５銘柄以上選択されているかチェックを行う(※)。<br>
6. ポートフォリオのLocal Code列の上から順に、原資金100万円を上限として、budget列で指定された金額で購入処理を行う。（なお、各ラウンドの週初営業日の始値で購入するため、指定された金額と実際の購入金額は異なることが想定され、予算と実際の購入金額の差額は残額となります。）<br>
7. 予測されたポートフォリオの全てのレコードについて6の処理を行い、実際の購入金額が50万円未満の場合は、ポートフォリオのLocal Code列の上から順に、更に1株ずつ50万円以上となるまで購入処理を繰り返す。<br>
8. 購入処理後に残った原資金は現金保有とする。<br>
9. 6〜8 までの購入処理を終えたポートフォリオについて、実際に購入した銘柄数が５銘柄以上かつ実際の購入金額が50万円以上かチェックを行う(※)。</p>
</div>
<div class="paragraph">
<p>【売却処理・評価】<br>
10. 購入した各銘柄について、各ラウンドの週末営業日の終値で売却したこととし、週初営業日からの始値からの運用実績（保有している株式の合計評価額 ＋ 保持現金 - 購入原資金）を算出する。<br>
　<strong>なお、(※)と記されているチェック項目については、チェックでエラーとなった場合は、評価算出されず失格となりますので、ご注意ください。以下に、Public期間について具体例を用いて処理について例示しております。</strong></p>
</div>
<div class="paragraph">
<p>以下に、本コンペティションのPublic期間における評価について具体例を用いて処理について例示しております。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/public_csv_sample.png" alt="public_csv_sample">
</div>
</div>
<div class="paragraph">
<p>　上表の左側がモデルが予測したポートフォリオの出力例です。上表の右側は説明のために付け加えたものになります。</p>
</div>
<div class="paragraph">
<p>・前提条件チェック等の1〜4に従い、条件の確認と銘柄等の絞り込みを行います。<br>
・購入処理の5で５銘柄以上含まれていることを確認し、6の処理により購入を行います。<br>
・ポートフォリオの全てのレコード列を処理した結果、実際の購入金額の総額は474,860円/5銘柄だった（9983の始値が指定してbudgetを超過し購入できていない）ため、7の処理により再度ポートフォリオの上から１株ずつ追加で購入する処理が行われます。具体的には7203を１株購入→50万円check→未達→9984を１株購入→50万円check→未達→9983を1株購入→50万円基準達成（実際の購入金額588,960円/６銘柄、保持現金411,040円）<br>
・6〜８までの処理を終え、９で実際に購入した銘柄数が５銘柄以上及び実際の購入金額が50万円以上かをチェックし、購入処理は完了します。<br>
・最後に購入した銘柄について、そのラウンドの週末営業日の終値で評価し、保持現金と合わせてそのラウンドの運用実績とします。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_リーダーボード_2">3.3.5. リーダーボード</h4>
<div class="paragraph">
<p>　一般的に、データ分析コンペティションにおけるリーダーボード（Leaderboard）とは、コンペティション参加者の投稿内容に対する評価（スコア、実行時間等）をランキング形式で並べる表を意味します。本コンペティションで提供するリーダーボードは、パブリックリーダーボード（以下、Public LB）とプライベートリーダーボード（以下、Private LB）の2つで構成されます。以下では、それぞれのリーダーボードの仕様等について説明します。</p>
</div>
<div class="paragraph">
<p>　まず、本コンペティションのPublic LBは、コンペティション開催日より過去の期間を対象として評価を実施します。具体的には、本コンペティションのPublic LBでは、2021年2月1日（月）に始値で購入し、2021年2月5日（金）の終値で売却するとした際に、できる限り利益を得ることができるポートフォリオを予測します。よってPublic LBでは、予測されたポートフォリオで利益の高い順に順位付けされます。</p>
</div>
<div class="paragraph">
<p>　なお、Public LBの評価期間における各銘柄の株価は、各Webサイト等で取得可能であることから、本コンペティションのPublic LBではチーティングが容易であるため、本コンペティションのPublic LBは、他の一般的なコンペティションにおけるPublic LBとは異なり、スコアを競うというよりは、モデルが正常に投稿できることを確認するための環境として位置付けとしておりますので、ご留意ください。以下に、Public LBの評価例として図を示します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/public_evaluation.png" alt="public_evaluation">
</div>
</div>
<div class="paragraph">
<p>　次に、本コンペティションのPrivate LBについて説明します。本コンペティションのPrivate LBでは、リークを可能な限り防止するため、モデル提出締切日よりも将来のデータを用いて、Private LBを出力します。<br>
　Private LBの各ラウンドの具体的な評価期間は以下のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>2021年5月10日（月）の始値で購入し、2021年5月14日（金）の終値で売却とした際の運用実績（ラウンド1）</p>
</li>
<li>
<p>2021年5月17日（月）の始値で購入し、2021年5月21日（金）の終値で売却とした際の運用実績（ラウンド2）</p>
</li>
<li>
<p>2021年5月24日（月）の始値で購入し、2021年5月28日（金）の終値で売却とした際の運用実績（ラウンド3）</p>
</li>
<li>
<p>2021年5月31日（月）の始値で購入し、2021年6月 4日（金）の終値で売却とした際の運用実績（ラウンド4）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>上記期間における4ラウンドの運用実績を合計し、総利益の高い順に順位付けされます。</strong></p>
</div>
<div class="paragraph">
<p>以下に、Private LBの評価例として図を示します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/private_evaluation.png" alt="private_evaluation">
</div>
</div>
<div class="paragraph">
<p>以上を踏まえ、本コンペティションにおけるPublic LBとPrivate LBの概要を、表にまとめます。</p>
</div>
<div class="sect4">
<h5 id="_本コンペティションにおけるリーダーボードの仕様">本コンペティションにおけるリーダーボードの仕様</h5>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>項目</strong></th>
<th class="tableblock halign-left valign-top"><strong>Public LB</strong></th>
<th class="tableblock halign-left valign-top"><strong>Private LB</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用途</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデルが正常に投稿できることを確認するための環境</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本コンペティションの最終的なランキングを表示</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象の期間</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年2月1日（月）〜2021年2月5日（金）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021年5月10日（月）〜2021年6月4日（金）までの4ラウンド</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象の条件</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.1及び3.3.2項に示すとおり　</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">同左</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測内容</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象期間の週初営業日に購入し、当該期間の週末営業日に売却した際にできる限り利益を得るポートフォリオ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各週の週初営業日に購入し、その週の週末営業日に売却した際にできる限り利益を得るポートフォリオ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">評価方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.3項に示す評価方法</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.3項に示す評価方法を、4ラウンド行いその合計</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anchor-3.4">3.4. データセットの説明</h3>
<div class="paragraph">
<p>　ここでは、本コンペティションで提供している各データについて説明します。提供されるデータは以下の13種類です。<br>
<a href="https://signate.jp/competitions/443/data">SIGNATEのコンペティションサイト</a>よりダウンロードしてください。</p>
</div>
<div class="paragraph">
<p><strong>データ概要</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>ファイル名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄の情報が記録されたデータ ※1 ※2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄の株価情報（始値・高値・安値・終値等）が記録されたデータ ※1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_fin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄のファンダメンタル情報（決算数値データや配当データ等）が記録されたデータ ※1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_labels</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各銘柄で決算発表が行われた日の取引所公式終値から、その日の翌営業日以降N営業日間における取引所公式終値の最高値および最安値への変化率を記録したデータ ※1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stock_fin_price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データが扱いやすいようにstock_price及びstock_finをマージしたデータ ※1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nikkei_article</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータ *3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">article</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータの分類語 記事種別</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">industry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータの分類語 業界コード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">industry2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータの分類語 業界コード(PDコード)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">region</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータの分類語 地域</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">theme</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日経電子版見出し・メタデータの分類語 記事内容のテーマコード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tdnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">適時開示資料のメタデータ (API経由でPDFを取得可能 ※4)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disclosureItems</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">適時開示資料の公開項目コード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">headline_features.pkl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本チュートリアルの5章で作成したヘッドラインの特徴量をpkl化したファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keywords_features.pkl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本チュートリアルの5章で作成したキーワードの特徴量をpkl化したファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">headline_features.zip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本チュートリアルの6章で作成したヘッドラインの特徴量及びsentiment scoreをpkl化したファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keywords_features.zip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本チュートリアルの6章で作成したキーワードの特徴量及びsentiment scoreをpkl化したファイル</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">purchase_date.csv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">評価対象週における 初日の日付を指定するファイル</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>　提供データについては、一部データを除き2016年1月初から2020年12月末をcsvファイル形式、2021年1月初からのデータについては、本コンペティション専用のAPIにて提供いたします。APIによるデータ取得につきましては、8章をご参照ください。</p>
</div>
<div class="paragraph">
<p>※1 ファンダメンタルズ分析チャレンジと共通の5種類のデータについては「2.2. データセットの説明」をご参照ください。<br>
※2 stock_listについては、ニュース分析チャレンジでは「universe_comp2」という列が追加されているため、以下に説明を記載しています。<br>
*3 当該データについては、2020年以降のデータとなります。<br>
※4 PDFのファイル取得は、2020年1月以降のものが対象です。ランタイム環境ではPDF/XBRLの提供はございません。</p>
</div>
<div class="sect3">
<h4 id="_銘柄情報_stock_list_2">3.4.1. 銘柄情報: stock_list</h4>
<div class="paragraph">
<p>　stock_listは、基本的にはファンダメンタルズ分析チャレンジと共通となりますが、ニュース分析チャレンジの予測対象銘柄を判別するための「universe_comp2」というカラムが追加されています。本コンペティションではポートフォリオに「universe_comp2」が True と設定されている銘柄のみを組み入れる必要があります。<br>
　<strong>ポートフォリオに予測対象銘柄以外を組み入れた場合は、その銘柄についての購入指示は無視されて評価対象外となります。</strong></p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prediction_target</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">予測対象銘柄</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Effective Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄情報の基準日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20201030</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1301</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name (English)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">KYOKUYO CO.,LTD.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Section/Products</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">市場・商品区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First Section (Domestic)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">33 Sector(Code)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の33業種区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">33 Sector(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の33業種区分(名前)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fishery, Agriculture and Forestry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17 Sector(Code)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の17業種区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17 Sector(name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄の17業種区分(名前)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOODS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size Code (New Index Series)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIXニューインデックスシリーズ規模区分(コード)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size (New Index Series)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIXニューインデックスシリーズ規模区分</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOPIX Small 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote AccountingStandard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会計基準 単独:NonConsolidated、連結国内:ConsolidatedJP、連結SEC:ConsolidatedUS、連結IFRS:ConsolidatedIFRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConsolidatedJP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote ModifyDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更新日</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2020/11/06</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IssuedShareEquityQuote IssuedShare</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">発行済株式数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10928283.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">universe_comp2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ニュース分析チャレンジの予測対象銘柄</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(JPX東証上場銘柄一覧より引用 <a href="https://www.jpx.co.jp/markets/statistics-equities/misc/01.html" class="bare">https://www.jpx.co.jp/markets/statistics-equities/misc/01.html</a>)<br>
(Quick xignite API Market Data API Catalogより引用 <a href="https://www.marketdata-cloud.quick-co.jp/Products/" class="bare">https://www.marketdata-cloud.quick-co.jp/Products/</a>)</p>
</div>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータ_nikkei_article">3.4.2. 日経電子版見出し・メタデータ: nikkei_article</h4>
<div class="paragraph">
<p>　nikkei_articleでは、日経電子版の見出しおよびメタデータを提供しています。記事見出しやキーワードなどの言語データに加え、一部のレコードには該当の記事に関連する株式コードや、記事の分類情報が含まれています。分類情報については別途CSVファイルでも提供しておりますのでご参照ください。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">article_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">記事ID(DBユニークキー)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TDSKDBDGXMZO5518670003022020QM8000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">publish_datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"掲載日(datetime型)""2016-09-25T23:33:26Z"" など ※新聞各紙の時分は00:00:00固定"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2020-02-03T17:58:25+09:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">media_code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"媒体略号 媒体のユニークコード ・日本経済新聞朝刊:NKM、NK2、NK3、NK4、NK5、NK6 ・日本経済新聞夕刊:NKE ・日本経済新聞地方経済面:NKL ・日経産業新聞:NSS、SS2・日経MJ:NRS、RS2 ・日経速報ニュースアーカイブ:NKR"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NKE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">media_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"媒体名称 ""日本経済新聞 朝刊""、""日経速報ニュースアーカイブ""など"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日本経済新聞電子版</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">men_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"面名 地方経済面の場合に収録。""名古屋朝刊社会面""、""埼玉”など"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">名古屋朝刊社会面</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">page_from</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"検索掲載開始ページ掲載ページ。但し、地方経済面のページ情報は、掲載されたページではなく、どの地方の記事であるかを意味する。※対応表参照"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">picture_flag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"絵・写真・表の有無”” or ”有”"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">有</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paragraph_cnt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"記事本文段落数"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">char_length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"記事本文文字数"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">221</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">headline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"記事見出し"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">東商取の売買高、１月は10％増、４カ月ぶり前年越え</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keywords</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"キーワード 記事の文中から主題語として切り出したワード(またはその正式名称)"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">東京商品取引所\n売買高\n前年\n日本取引所グループ\n同月</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">classifications</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"分類情報 記事内容のテーマコード(#W〜)・業界コード(#B〜)、証券コード等の会社コード(T〜、N〜、PD〜)、紙 面名等の記事分類キーワード($〜)、コラム名(「〜」)"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">＄絵写表記事\nＴ８６９７\nＰＤ５２１\nＮ００４０４３１\nＮ００７５１０７</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">company_g.stock_code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8697</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_日経電子版見出しメタデータの確認">日経電子版見出し・メタデータの確認</h5>
<div class="paragraph">
<p>ここでは「日経電子版見出し・メタデータ」を把握するために、データを確認していきます。データの確認に使用したnotebookは「handson/Chapter03/20210415_chapter03_news_data_visualization.ipynb」に配置しています。必要に応じてご参照ください。</p>
</div>
<div class="paragraph">
<p>データを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 入力パラメーターを設定します。ランタイム環境での実行時と同一フォーマットにします</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">nikkei_article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/nikkei_article.csv.gz</span><span class="delimiter">&quot;</span></span>,
}
<span class="comment"># 銘柄リストを取得</span>
df_stock_list = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># 投資対象銘柄を取得</span>
stock_codes = df_stock_list.loc[df_stock_list.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>]
<span class="comment"># 日経電子版見出し・メタデータ読み込み</span>
df_nikkei_article = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">nikkei_article</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># インデックスを記事の掲載日に設定</span>
df_nikkei_article.set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">publish_datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
<span class="comment"># インデックスを日付型に変換</span>
df_nikkei_article.index = pd.to_datetime(df_nikkei_article.index)
<span class="comment"># インデックスで安定ソート</span>
df_nikkei_article.sort_index(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">mergesort</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>データの件数を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 件数を確認</span>
df_nikkei_article.info()</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 178393 entries, 2020-01-01 00:00:00+09:00 to 2020-12-31 23:26:35+09:00
Data columns (total 12 columns):
 #   Column                Non-Null Count   Dtype
---  ------                --------------   -----
 0   article_id            178393 non-null  object
 1   media_code            178393 non-null  object
 2   media_name            178393 non-null  object
 3   men_name              0 non-null       float64
 4   page_from             0 non-null       float64
 5   picture_flag          75294 non-null   object
 6   paragraph_cnt         178393 non-null  int64
 7   char_length           178393 non-null  int64
 8   headline              178393 non-null  object
 9   keywords              177894 non-null  object
 10  classifications       173346 non-null  object
 11  company_g.stock_code  68369 non-null   object
dtypes: float64(2), int64(2), object(8)
memory usage: 17.7+ MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記からデータの件数とデータの範囲がわかったので、より具体的な値を把握するために先頭の1レコードを出力します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データの開始日と内容を確認</span>
df_nikkei_article.head(<span class="integer">1</span>).T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article01.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>データの最終行を表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データの最終日を確認</span>
df_nikkei_article.tail(<span class="integer">1</span>).T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article02.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>記事の見出しである headline 列の文字数の分布をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 見出しの文字数の分布をプロット</span>
df_nikkei_article.headline.str.len().hist(figsize=(<span class="integer">10</span>,<span class="integer">10</span>), bins=<span class="integer">50</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article03.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>記事の見出しは25文字がピークであることを確認できます。</p>
</div>
<div class="paragraph">
<p>company_g.stock_code 列にはニュースに関連する銘柄コードが含まれています。銘柄コードが含まれているデータを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄コードが含まれているデータを確認</span>
df_nikkei_article.loc[~df_nikkei_article.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">company_g.stock_code</span><span class="delimiter">&quot;</span></span>].isnull()].head().T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article04.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>一つのニュース記事について「\n」を区切り文字として複数の銘柄コードが格納されていることがわかります。</p>
</div>
<div class="paragraph">
<p>1週間毎のニュースの記事件数と銘柄コードが含まれている記事の件数をプロットするためのデータを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 月曜日を開始日として、週次の記事件数と銘柄コードを含む記事件数を取得</span>
df_weekly_count = df_nikkei_article.resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">W-MON</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>, closed=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>)[[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_id</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">company_g.stock_code</span><span class="delimiter">&quot;</span></span>]].count()
<span class="comment"># 集計内容を確認</span>
df_weekly_count.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article05.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>1週間毎の記事件数の統計量を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 週次件数の統計量を確認</span>
df_weekly_count.describe()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article06.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>1週間毎の記事件数の平均は3,300件超、銘柄コードが含まれている記事件数の平均は1,200件超であることがわかります。</p>
</div>
<div class="paragraph">
<p>次に、1週間毎の記事件数の分布を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#  週次件数の分布を確認</span>
df_weekly_count.hist(figsize=(<span class="integer">20</span>, <span class="integer">10</span>), alpha=<span class="float">0.5</span>, bins=<span class="integer">25</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article07.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>1週間毎の記事件数の推移をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># プロット</span>
ax = df_weekly_count.plot(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment"># グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article08.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>データの始点・終点では月曜日を起点としているため曜日の数が十分でないこと、5,7,8,9月は祝日が影響して記事件数が少なくなっているようです。</p>
</div>
<div class="paragraph">
<p>ここからは記事に紐付けられている銘柄コードについて確認します。
記事データから抽出した銘柄コード毎に記事件数をプロットします。ここでは対象とする銘柄コードを投資対象銘柄に限定して確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 記事に記載されている銘柄コードを取得</span>
s_stocks = df_nikkei_article.loc[~df_nikkei_article.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">company_g.stock_code</span><span class="delimiter">&quot;</span></span>].isnull(), <span class="string"><span class="delimiter">&quot;</span><span class="content">company_g.stock_code</span><span class="delimiter">&quot;</span></span>].str.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 銘柄コード別の件数を取得し、記事件数の多い順にソート</span>
s_stock_counts = pd.Series(Counter(chain.from_iterable(s_stocks))).sort_values(ascending=<span class="predefined-constant">False</span>)
<span class="comment"># 投資対象銘柄に絞り込み</span>
s_stock_counts = s_stock_counts.loc[s_stock_counts.index.astype(<span class="predefined">int</span>).isin(stock_codes)]
<span class="comment"># データフレームに変換して、インデックスをリセット</span>
df_stock_counts = s_stock_counts.to_frame().reset_index(drop=<span class="predefined-constant">True</span>)
<span class="comment"># カラム名を設定</span>
df_stock_counts.rename(columns={<span class="integer">0</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">article_count</span><span class="delimiter">&quot;</span></span>}, inplace=<span class="predefined-constant">True</span>)
<span class="comment"># 投資対象銘柄全体におけるdisclosureItems別の件数の割合を算出</span>
df_stock_counts.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>] = (df_stock_counts[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_count</span><span class="delimiter">&quot;</span></span>] / df_stock_counts[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_count</span><span class="delimiter">&quot;</span></span>].sum()) * <span class="integer">100</span>
<span class="comment"># 件数割合の累積を計算</span>
df_stock_counts.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>] = df_stock_counts[<span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>].cumsum()
<span class="comment"># 投資対象銘柄コード別の件数をプロット (全銘柄)</span>
ax = df_stock_counts[[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_count</span><span class="delimiter">&quot;</span></span>]].plot(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment">#  グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 凡例を左上に表示</span>
ax.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper left</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 2つ目のy軸を作成</span>
ax2 = ax.twinx()
<span class="comment"># 開示件数割合の累積をプロット</span>
df_stock_counts[[<span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>]].reset_index(drop=<span class="predefined-constant">True</span>).plot(ax=ax2, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 凡例を右上に表示</span>
ax2.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper right</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article09.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>x軸は銘柄の数を示しています。青色線は左側のy軸に対応しており記事件数を表しています、黄色線は右側のy軸に対応しており記事件数全体における累積割合を示しています。一部の銘柄に記事件数が集中しており、約1750銘柄中250銘柄で記事件数全体の70%程度を占めていることがわかります。</p>
</div>
<div class="paragraph">
<p>記事件数の多い順に上位50銘柄をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄コード別の記事件数 (件数上位50銘柄)</span>
ax = s_stock_counts.head(<span class="integer">50</span>).plot.bar(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment">#  グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/nikkei_article/nikkei_article10.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p><code>7203</code> のトヨタ自動車、および <code>9984</code> のソフトバンクグループに関する記事件数が突出しており、以後記事件数が減少していることがわかります。ニュースの件数は銘柄ごとにかなり偏っていることがわかります。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータの分類語_記事種別_article">3.4.3. 日経電子版見出し・メタデータの分類語 記事種別: article</h4>
<div class="paragraph">
<p>　articleでは、日経電子版見出し・メタデータの分類情報(classifications)に記載の記事種類の項目一覧を提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類情報コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">#K1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">article</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">記事種類項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">人事記事</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータの分類語_業界コード_industry">3.4.4. 日経電子版見出し・メタデータの分類語 業界コード: industry</h4>
<div class="paragraph">
<p>　industryでは、日経電子版見出し・メタデータの分類情報に記載の業界一覧を提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類情報コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">＃Ｂ００１０</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">industry1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">業界項目一覧の大項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">資源・エネルギー</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">industry2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">業界項目一覧の小項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">石油・鉱業・エネルギー</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータの分類語_業界コードpdコード_industry2">3.4.5. 日経電子版見出し・メタデータの分類語 業界コード(PDコード): industry2</h4>
<div class="paragraph">
<p>　industry2では、日経電子版見出し・メタデータの分類情報の業界(PDコード)一覧を提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pdcode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類情報</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ＰＤ０１１</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Industry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">業界項目一覧</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">飼料</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータの分類語_地域_region">3.4.6. 日経電子版見出し・メタデータの分類語 地域: region</h4>
<div class="paragraph">
<p>　regionでは、日経電子版見出し・メタデータの分類情報の地域一覧を提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類情報</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">＃Ａ７００</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">地域一覧の大項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">外国</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">地域一覧の小項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">インド</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_日経電子版見出しメタデータの分類語_記事内容のテーマコード_theme">3.4.7. 日経電子版見出し・メタデータの分類語 記事内容のテーマコード: theme</h4>
<div class="paragraph">
<p>　themeでは、日経電子版見出し・メタデータの分類情報のテーマ一覧を提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類情報</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">＃Ｗ１０１０１</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テーマ一覧の大項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">企業</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テーマ一覧の中項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">事業組み替え</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テーマ一覧の小項目</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">事業組み替え</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_適時開示資料のメタデータ_tdnet">3.4.8. 適時開示資料のメタデータ: tdnet</h4>
<div class="paragraph">
<p>　tdnetでは、適時開示資料のメタデータを提供しています。適時開示資料については「2.1.5. 決算短信・財務諸表」をご参照ください。「disclosureItems (公開項目コード)」の一覧は別途csvファイルで提供しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">開示日付および開示番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-02-19:16:00:00#20160210412154</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disclosedDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">開示日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2016-02-19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disclosedTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">開示時刻</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16:00:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disclosureNumber</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">開示番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20160210412154</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">79860</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">銘柄略称</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ｊ－日本アイエスケイ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disclosureItems</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開項目コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">["11301"]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">表題</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">平成27年12月期　決算短信〔日本基準〕（連結）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">handlingType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">取扱属性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modifiedHistory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">開示履歴番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pdfGeneralFlag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全文情報PDFファイル存在フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pdfSumaryFlag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">サマリ情報PDFファイル存在フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xbrlFlag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XBRL関連ファイル存在フラグ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_適時開示資料のメタデータの確認">適時開示資料のメタデータの確認</h5>
<div class="paragraph">
<p>ここでは「適時開示資料のメタデータ」を把握するために、データを確認していきます。データの確認に使用したnotebookは「handson/Chapter03/20210415_chapter03_news_data_visualization.ipynb」に配置しています。必要に応じてご参照ください。</p>
</div>
<div class="paragraph">
<p>データを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 入力パラメーターを設定します。ランタイム環境での実行時と同一フォーマットにします</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">nikkei_article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/nikkei_article.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/disclosureItems.csv.gz</span><span class="delimiter">&quot;</span></span>,
}
<span class="comment"># 銘柄リストを取得</span>
df_stock_list = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># 投資対象銘柄を取得</span>
stock_codes = df_stock_list.loc[df_stock_list.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>]
<span class="comment"># 適時開示資料のメタデータ読み込み</span>
df_tdnet = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># インデックスを開示日時に設定</span>
df_tdnet.index = pd.to_datetime(df_tdnet[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosedDate</span><span class="delimiter">&quot;</span></span>].astype(<span class="predefined">str</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + df_tdnet[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosedTime</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># インデックスで安定ソート</span>
df_tdnet.sort_index(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">mergesort</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
<span class="comment"># 公開項目コード一覧を読み込み</span>
df_disclosureitems = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>データの件数を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 件数を確認</span>
df_tdnet.info()</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 510962 entries, 2016-01-12 08:00:00 to 2020-12-30 21:00:00
Data columns (total 13 columns):
 #   Column            Non-Null Count   Dtype
---  ------            --------------   -----
 0   datetime          510962 non-null  object
 1   disclosedDate     510962 non-null  object
 2   disclosedTime     510962 non-null  object
 3   disclosureNumber  510962 non-null  int64
 4   code              510962 non-null  int64
 5   name              510962 non-null  object
 6   disclosureItems   510962 non-null  object
 7   title             510962 non-null  object
 8   handlingType      1694 non-null    object
 9   pdfGeneralFlag    510962 non-null  int64
 10  modifiedHistory   510962 non-null  int64
 11  pdfSumaryFlag     510962 non-null  int64
 12  xbrlFlag          510962 non-null  int64
dtypes: int64(6), object(7)
memory usage: 54.6+ MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記からデータの件数とデータの範囲がわかったので、より具体的な値を把握するために先頭の1レコードを出力します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データの開始日と内容を確認</span>
df_tdnet.head(<span class="integer">1</span>).T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet01.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>データの最終行を表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データの最終日を確認</span>
df_tdnet.tail(<span class="integer">1</span>).T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet02.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>データを加工して解析しやすくします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄コードを4桁に変更</span>
df_tdnet.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_code</span><span class="delimiter">&quot;</span></span>] = df_tdnet.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].astype(<span class="predefined">str</span>).str[:<span class="integer">4</span>].astype(<span class="predefined">int</span>)
<span class="comment"># 投資対象銘柄に絞り込み</span>
filter_universe = df_tdnet.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_code</span><span class="delimiter">&quot;</span></span>].isin(stock_codes)
<span class="comment"># 月曜日を開始日として、投資対象銘柄の週次の件数を取得</span>
df_tdnet_weekly_count = df_tdnet.loc[filter_universe].resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">W-MON</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>, closed=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>)[[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>]].count()
<span class="comment"># 集計内容を確認</span>
df_tdnet_weekly_count.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet03.png" alt="処理結果" width="30%">
</div>
</div>
<div class="paragraph">
<p>週毎の開示件数をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># プロット</span>
ax = df_tdnet_weekly_count.plot(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment"># グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet04.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>開示件数には波があることがわかります。</p>
</div>
<div class="paragraph">
<p>週毎の開示件数の分布をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#  資対象銘柄の週次件数の分布を確認</span>
df_tdnet_weekly_count.hist(figsize=(<span class="integer">10</span>, <span class="integer">10</span>))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet05.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>開示情報の公開項目コードについて確認していきます。</p>
</div>
<div class="paragraph">
<p>まずは、公開項目コードをリストとして取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄のdisclosureItemsをリスト形式のシリーズとして取得</span>
s_disclosureItems = df_tdnet.loc[filter_universe, <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>].apply(literal_eval)
<span class="comment"># データを確認</span>
s_disclosureItems[:<span class="integer">10</span>]</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet06.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>次に、公開項目毎の件数を集計したあとに、公開項目コードと日本語名を結合します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄のdisclosureItems別の件数を取得</span>
s_disclosureitems_count = pd.Series(Counter(chain.from_iterable(s_disclosureItems)))
<span class="comment"># カラム名を設定</span>
s_disclosureitems_count.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>
<span class="comment"># 公開項目コードをint型に変更</span>
s_disclosureitems_count.index = s_disclosureitems_count.index.astype(<span class="predefined">int</span>)
<span class="comment"># 項目の日本語名を表示するために適時開示資料の公開項目コードと結合</span>
df_disclosureitems_with_label = pd.merge(s_disclosureitems_count, df_disclosureitems, left_index=<span class="predefined-constant">True</span>, right_on=[<span class="string"><span class="delimiter">&quot;</span><span class="content">公開項目コード</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># indexを設定</span>
df_disclosureitems_with_label.set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">コード値定義</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
<span class="comment"># 項目の日本語名を表示するために適時開示資料の公開項目コードと結合</span>
df_disclosureitems_with_label = pd.merge(s_disclosureitems_count, df_disclosureitems, left_index=<span class="predefined-constant">True</span>, right_on=[<span class="string"><span class="delimiter">&quot;</span><span class="content">公開項目コード</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># indexを設定</span>
df_disclosureitems_with_label.set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">コード値定義</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>公開項目コード毎の開示情報件数をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄のdisclosureItems別の件数を多い順に並び替え</span>
df_count_by_disclosureitems_with_label = df_disclosureitems_with_label.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>]].sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>, ascending=<span class="predefined-constant">False</span>).reset_index(drop=<span class="predefined-constant">True</span>)
<span class="comment"># 投資対象銘柄全体におけるdisclosureItems別の件数の割合を算出</span>
df_count_by_disclosureitems_with_label.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>] = (df_count_by_disclosureitems_with_label[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>] / df_count_by_disclosureitems_with_label[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>].sum()) * <span class="integer">100</span>
<span class="comment"># 件数割合の累積を計算</span>
df_count_by_disclosureitems_with_label.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>] = df_count_by_disclosureitems_with_label[<span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>].cumsum()
<span class="comment"># プロット (全て)</span>
ax = df_count_by_disclosureitems_with_label[[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>]].plot(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment">#  グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 凡例を左上に表示</span>
ax.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper left</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 2つ目のy軸を作成</span>
ax2 = ax.twinx()
<span class="comment"># 開示件数割合の累積をプロット</span>
df_count_by_disclosureitems_with_label[[<span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>]].reset_index(drop=<span class="predefined-constant">True</span>).plot(ax=ax2, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 凡例を右上に表示</span>
ax2.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper right</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet07.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>件数の多い上位50項目を公開項目名をX軸にしてプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄のdisclosureItems別に件数を多い順にプロット (上位50項目)</span>
ax = df_disclosureitems_with_label.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>]].sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems_count</span><span class="delimiter">&quot;</span></span>, ascending=<span class="predefined-constant">False</span>).head(<span class="integer">50</span>).plot(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment">#  グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet08.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>銘柄毎に開示情報の件数をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄別に開示件数を集計して、開示件数の多い順に並び替え</span>
df_tdnet_count_by_stock_code = df_tdnet.loc[filter_universe].groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_code</span><span class="delimiter">&quot;</span></span>)[[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>]].count().sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>, ascending=<span class="predefined-constant">False</span>)
<span class="comment"># 投資対象銘柄全体における開示件数の割合を集計</span>
df_tdnet_count_by_stock_code.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>] = (df_tdnet_count_by_stock_code[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>] / df_tdnet_count_by_stock_code[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>].sum()) * <span class="integer">100</span>
<span class="comment"># 開示件数割合の累積を計算</span>
df_tdnet_count_by_stock_code.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>] = df_tdnet_count_by_stock_code[<span class="string"><span class="delimiter">&quot;</span><span class="content">percentage</span><span class="delimiter">&quot;</span></span>].cumsum()
<span class="comment"># 投資対象銘柄別に開示件数を多い順にプロット</span>
ax = df_tdnet_count_by_stock_code[[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>]].reset_index(drop=<span class="predefined-constant">True</span>).plot(figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment"># グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 凡例を左上に表示</span>
ax.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper left</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 2つ目のy軸を作成</span>
ax2 = ax.twinx()
<span class="comment"># 開示件数割合の累積をプロット</span>
df_tdnet_count_by_stock_code[[<span class="string"><span class="delimiter">&quot;</span><span class="content">cumulative_percentage</span><span class="delimiter">&quot;</span></span>]].reset_index(drop=<span class="predefined-constant">True</span>).plot(ax=ax2, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 凡例を右上に表示</span>
ax2.legend(loc=<span class="string"><span class="delimiter">&quot;</span><span class="content">upper right</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet09.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>開示件数の多い上位50銘柄をプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象銘柄別に開示件数を多い順にプロット (上位50銘柄)</span>
ax = df_tdnet.loc[filter_universe].groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_code</span><span class="delimiter">&quot;</span></span>)[[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>]].count().sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>, ascending=<span class="predefined-constant">False</span>).head(<span class="integer">50</span>).plot(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>))
<span class="comment"># 　グリッド設定</span>
ax.grid(<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/tdnet/tdnet10.png" alt="処理結果" width="70%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_適時開示資料の公開項目コード_disclosureitems">3.4.9. 適時開示資料の公開項目コード: disclosureItems</h4>
<div class="paragraph">
<p>　disclosureItemsは、適時開示資料の公開項目が含まれています。例えば、一般に「自己株式の取得」はポジティブなイベント、「災害に起因する損害又は業務遂行の過程で生じた損害」はネガティブなイベントとして認識されます。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分類番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開項目番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開項目番号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">102</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開項目コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開項目コード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11102</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コード値定義</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">内容説明</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">発行登録及び需要状況調査の開始</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ニュース記事ヘッドライン特徴量_headline_features_pkl">3.4.10. ニュース記事ヘッドライン特徴量: headline_features.pkl</h4>
<div class="paragraph">
<p>　headline_features.pklは、本チュートリアルの5章で作成したヘッドラインの特徴量をpkl化したファイルです。詳細は本チュートリアルの5.8.4をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ニュース記事キーワード特徴量_keywords_features_pkl">3.4.11. ニュース記事キーワード特徴量: keywords_features.pkl</h4>
<div class="paragraph">
<p>　keywords_features.pklは、本チュートリアルの5章で作成したキーワードの特徴量をpkl化したファイルです。詳細は本チュートリアルの5.8.4をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ニュース記事ヘッドライン特徴量lstm_headline_features_zip">3.4.12. ニュース記事ヘッドライン特徴量（LSTM）: headline_features.zip</h4>
<div class="paragraph">
<p>　headline_features.zipは、本チュートリアルの6章で作成したヘッドラインの特徴量及びsentiment scoreをpkl化したファイルです。詳細は本チュートリアルの6.2.9. 特徴量合成モデルの学習及び特徴量合成をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ニュース記事キーワード特徴量lstm_keywords_features_zip">3.4.13. ニュース記事キーワード特徴量（LSTM）: keywords_features.zip</h4>
<div class="paragraph">
<p>　keywords_features.zipは、本チュートリアルの6章で作成したキーワードの特徴量及びsentiment scoreをpkl化したファイルです。詳細は本チュートリアルの6.2.9. 特徴量合成モデルの学習及び特徴量合成をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_日付指定ファイル_purchase_date_csv">3.4.14. 日付指定ファイル: purchase_date.csv</h4>
<div class="paragraph">
<p>　評価対象週について、初日の日付を指定するファイルです。ランタイム環境ではこのファイルから日付を取得してポートフォリオを作成します。その際に株価データなどは指定された日付のデータを含んでいない点に注意が必要です。例えば、purchase_dateに <code>2021/02/01</code> が指定されている場合、stock_priceデータの最も日付の新しいデータは <code>2021/01/29</code> になります。そのため、本チュートリアルでは主に金曜日の日付を使用して予測を出力した後、予測からポートフォリオを組成する際に対象日付が翌週の月曜日となるように調整しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>変数名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>型</strong></th>
<th class="tableblock halign-left valign-top"><strong>例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">purchase date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">評価対象週の初日の日付</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2021/02/01</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_環境構築">3.5. 環境構築</h3>
<div class="sect3">
<h4 id="_実行環境の選択">3.5.1. 実行環境の選択</h4>
<div class="paragraph">
<p>　環境構築方法については <a href="https://signate.jp/features/runtime/detail">SIGNATE: Runtime 投稿方法: ローカル開発環境の構築方法は？</a> にも説明がありますが、本コンペの特色を考慮し、実行環境の選択方法を説明します。</p>
</div>
<div class="paragraph">
<p>　3章・4章のチュートリアルではDockerとGoogle Colaboratoryの両方を利用可能です。特にWindows環境をご利用でDocker環境の構築が難しい場合は、ぜひGoogle Colaboratoryをご利用ください。本チュートリアルで提供されるnotebookはGoogle Colaboratoryでも動作可能となっております。*なお、Google Colaboratoryをご利用になる場合には、以下のように各ライブラリのバージョンを指定する必要がございます。*</p>
</div>
<div class="listingblock">
<div class="content">
<pre>joblib==1.0.1
numpy==1.19.5
pandas==1.1.5
scikit-learn==0.20.3
scipy==1.2.1
seaborn==0.9.0</pre>
</div>
</div>
<div class="paragraph">
<p>　5章・6章で提供しているnotebookを最後まで実行する場合、ディープニューラルネットワークの学習・推論を行うため、*CPU環境ではかなり時間がかかります。そのため、GPU環境での実行をおすすめしております。* なお、Google ColaboratoryではGPU環境がご利用いただけますので、GPU環境をお持ちでない場合はGoogle Colaboratoryをご利用ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="anchor-3.5.2">3.5.2. Google Colaboratoryをご利用の場合</h4>
<div class="paragraph">
<p>　本コンペティションの3章、4章のチュートリアルをGoogle Colaboratory上で動かすためには、まず以下の手順でGoogle Drive上にファイルを設置します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Google DriveのMy Driveに<code>JPX_competition</code>というフォルダーを作成します。</p>
</li>
<li>
<p>1で作成した<code>JPX_competition</code>フォルダーにデータを保存するための<code>data_dir_comp2</code>フォルダーを作成します。</p>
</li>
<li>
<p>1で作成した<code>JPX_competition</code>フォルダーにバックテスト用コードを保存するための<code>backtest</code>フォルダーを作成します。</p>
</li>
<li>
<p><a href="https://signate.jp/competitions/443/data">SIGNATEのコンペティションサイト</a> よりダウンロードした各種データを2で作成した<code>data_dir_comp2</code>フォルダーにアップロードします。</p>
</li>
<li>
<p><code>backtest.py</code> を <a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/Chapter03/backtest/backtest.py">こちら</a> からダウンロードし、3で作成した<code>backtest</code>フォルダにアップロードします。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　次にGoogle Colaboratory上でチュートリアルのnotebookを展開します。本チュートリアルのnotebookはGoogle Colaboratory上でも実行可能となっております。各章のnotebookは以下のそれぞれのリンク先を開き、開いたページでRawを右クリックし、「リンク先を名前をつけて保存」を選択することでダウンロード可能です。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter03/20210224_chapter03_tutorial.ipynb">3章のnotebook</a><br>
<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter04/20210224_chapter04_tutorial.ipynb">4章のnotebook</a></p>
</div>
<div class="paragraph">
<p>以下、3章を例にGoogle Colaboratoryでチュートリアルのnoteboookを使用する方法を説明します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Google Drive の My Drive 内に作成した<code>JPX_competition</code>フォルダーに3章用のnotebookを保存するための<code>Chapter03</code>フォルダーを作成します。</p>
</li>
<li>
<p>上記のリンク先から3章のnotebookをダウンロードして、先程作成した<code>Chapter03</code>フォルダーに<code>20210224_chapter03_tutorial.ipynb</code>というファイル名で保存してください。</p>
</li>
<li>
<p>Google Driveにアップロードした <code>20210224_chapter03_tutorial.ipynb</code> ファイルをダブルクリックして Google Colaboratory で開きます。</p>
</li>
<li>
<p>Google Colaboratoryの環境で本チュートリアルを実行する場合、最初に以下のコードを実行して Google Colaboratory 上の notebook から Google Drive にアクセスできるようにしてください。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Google Colab環境ではGoogle Driveをマウントしてアクセスできるようにします。</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    <span class="comment"># Google Drive をマウントします</span>
    <span class="keyword">from</span> <span class="include">google.colab</span> <span class="keyword">import</span> <span class="include">drive</span>
    mount_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/content/drive</span><span class="delimiter">&quot;</span></span>
    drive.mount(mount_dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここまでの作業を実施した結果、Google Driveの<code>JPX_competition</code>フォルダーは以下になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/content/drive/MyDrive/JPX_competition/
├── Chapter03
│   ├── 20210224_chapter03_tutorial.ipynb
│   └── backtest
│       └── backtest.py
└── data_dir_comp2
    ├── article.csv.gz
    ├── disclosureItems.csv.gz
    ├── industry2.csv.gz
    ├── industry.csv.gz
    ├── nikkei_article.csv.gz
    ├── region.csv.gz
    ├── stock_fin.csv.gz
    ├── stock_fin_price.csv.gz
    ├── stock_labels.csv.gz
    ├── stock_list.csv.gz
    ├── stock_price.csv.gz
    ├── tdnet.csv.gz
    └── theme.csv.gz</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dockerをご利用の場合">3.5.3. Dockerをご利用の場合</h4>
<div class="paragraph">
<p>　本チュートリアルのリポジトリを <code>git clone</code> した後、以下の手順を実行していただくことで、Dockerコンテナ内でjupyter notebookを動かすことができます。リポジトリ内の <code>Chapter03</code> ディレクトリには、本チュートリアルのコードを記載した ipynb(<code>20210224_chapter03_tutorial.ipynb</code>) ファイルを配置しておりますので必要に応じてご活用ください。</p>
</div>
<div class="paragraph">
<p>　Windows環境の場合、コマンド実行には「PowerShell」などをご使用ください。なお、PowerShellの利用に当たっては、最新のセキュリティ事情を踏まえご自身でご判断ください。Dockerのインストールについては<a href="http://docs.docker.jp/get-docker.html">こちら</a>をご参照ください。Dockerの制約としてマウントするパスにはアルファベット、数字、「_」、「.」、「-」以外の文字を使用するとエラーとなることがあるため、パスが前述の文字のみで構成されているディレクトリをご使用ください。<br>
　なお、Windows 10 Homeをご利用の場合、Dockerの利用に制限がある場合がありますので、Dockerに習熟した方以外はGoogle Colaboratoryの利用を推奨します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd handson/

# 実行するコンテナはsignateユーザーで実行されるため、マウントした領域に書き込めるようにパーミッションを変更します。
chmod -R 777 .

# データ配置先のディレクトリを作成
mkdir data_dir_comp2
# その後作成したhandson/data_dir_comp2に、コンペティションサイトよりデータをダウンロードし配置します。

# Dockerでjupyter notebookを起動します。(初回実行時は約10GBのコンテナイメージをダウンロードします。)
# jupyter notebook作業用に handson ディレクトリを /notebook としてマウントしています。
# jupyter notebook は port 8888でtokenとpasswordを空にして、vscode のjupyter pluginからアクセスできるように xsrf 対策を無効化しています。
docker run --name tutorial --shm-size=2G -v ${PWD}:/notebook -p8888:8888 --rm -it signate/runtime-jpx:2021.03 jupyter notebook --ip 0.0.0.0 --allow-root --no-browser --no-mathjax --NotebookApp.disable_check_xsrf=True  --NotebookApp.token='' --NotebookApp.password='' /notebook

# ブラウザで以下のURLにアクセスしてjupyter notebookの画面が表示されていて、本チュートリアル用のnotebookが表示されていることを確認します。
http://localhost:8888/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anchor-3.6">3.6. バックテスト環境の構築</h3>
<div class="paragraph">
<p>　本コンペティション用のバックテスト環境を構築します。金融の世界でバックテストとは一般に価格時系列データを使用して取引をシミュレーションし取引ルールやアルゴリズムなどを評価することを言います。本コンペティションの課題は、モデルにより予測されたポートフォリオのパフォーマンスを競う課題であるため、実際にポートフォリオとして運用した際の期待収益性等について確認・評価することが重要です。また、本コンペティションの評価においても使用しております。実際の評価の具体的な流れは、<a href="#anchor-3.3.5">3.3.5. 評価方法</a>をご参照ください。</p>
</div>
<div class="paragraph">
<p>　バックテストを実施するために最初に必要なことは要件を適切に把握することです。例えば、投資対象となる銘柄群 (ユニバースとも言います)、取引の時間間隔 (数分、数時間、数日)、投資予算の上限、同時に保有可能な銘柄数、1銘柄に投資可能な上限等です。これらを把握しバックテストを実装していくことになります。バックテストの要件を把握することは、モデルを作る際にもモデルの出力要件や評価方法を把握することにもつながります。</p>
</div>
<div class="paragraph">
<p>　評価を公正にするために本コンペティションの評価に用いるものと全く同じロジックが実装されたバックテスト用のコード <code>backtest.py</code> を公開します。このファイルは、<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/Chapter03/backtest/backtest.py">こちら</a>からダウンロードしてください。</p>
</div>
<div class="paragraph">
<p>　なお、本チュートリアルではバックテストをスクラッチで実装していますが、アルゴリズムトレーディング用のバックテストライブラリも存在します。有名なライブラリをtips集の「バックテスト用ライブラリ」でご紹介していますのでご参照ください。</p>
</div>
<div class="sect3">
<h4 id="_必要なデータ">3.6.1. 必要なデータ</h4>
<div class="paragraph">
<p>　バックテストの実行には以下のデータが必要になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ポートフォリオ: バックテスト対象のポートフォリオデータです。（モデルにより予測されたポートフォリオ）</p>
</li>
<li>
<p>stock_price: 株価情報を使用してポートフォリオのリターンを算出します。（stock_price.csv.gz）</p>
</li>
<li>
<p>stock_list: 銘柄リストを使用して予測対象銘柄の情報を取得します。（stock_list.csv.gz）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　ポートフォリオは、<a href="#anchor-3.3.4">3.3.4. 提出するモデルの予測出力の定義</a>に記載されているフォーマットのcsvとなります。</p>
</div>
</div>
<div class="sect3">
<h4 id="_使い方">3.6.2. 使い方</h4>
<div class="paragraph">
<p>　Backtestモジュールをインポートします。パスが通っていない場合は必要に応じて、sys.pathにBacktestモジュールを配置しているディレクトリを追加してからimportします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 以下はパスを通すためのコードになりますので、必要に応じてアンコメントして実行してください。</span>
<span class="comment"># import sys</span>
<span class="comment"># module_dir = &quot;Backtestモジュールを配置したディレクトリへのフルパス&quot;</span>
<span class="comment"># sys.path.append(module_dir)</span>

<span class="keyword">from</span> <span class="include">backtest</span> <span class="keyword">import</span> <span class="include">Backtest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテストを実行するための事前準備として、バックテストに必要なデータを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">data_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/data_dir_comp2</span><span class="delimiter">&quot;</span></span>  <span class="comment"># &quot;左記パスは例です。各自データを配置してるディレクトリへのパスへ変更してください&quot;</span>

<span class="comment"># バックテストに必要なデータを取得します。</span>
backtest_codes, backtest_price = Backtest.prepare_data(data_dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテストを実行したいポートフォリオデータを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">portofolio_file_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">SUBMIT.csv</span><span class="delimiter">&quot;</span></span>  <span class="comment"># 左記パスは例です。各自モデルにより予測されたポートフォリオデータが格納されているパスへ変更してください。</span>
df_submit = Backtest.load_submit(portofolio_file_path)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテストを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">df_results, df_stocks = Backtest.run(df_submit, backtest_codes, backtest_price)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_backtest_runメソッドの説明">「Backtest.run」メソッドの説明</h5>
<div class="paragraph">
<p>　バックテストの実行用メソッドである Backtest.run() への入力データは以下になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>第一引数: ポートフォリオ (DataFrame)
第二引数: ユニバース (銘柄コード) (List)
第三引数: 株価情報 (DataFrame)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテストの返り値は以下になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>df_results: バックテスト結果のサマリー (DataFrame)
df_stocks: 個別銘柄の購入数や日々の価格情報 (DataFrame)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_結果の見方">3.6.3. 結果の見方</h4>
<div class="paragraph">
<p>　バックテストを実行するとバックテスト結果のサマリーが格納された <code>df_results</code> と、購入数および日々の価格情報が格納された <code>df_stocks</code> の2つのDataFrameが返されます。それぞれのDataFrameの項目は以下の通りです。</p>
</div>
<div class="paragraph">
<p>　<code>df_results</code> の項目は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bought: 購入金額
cash: 現金
date: 対象週の開始日
day_1: ポートフォリオの月曜日終値での基準価格 (現金含む)
day_2: ポートフォリオの火曜日終値での基準価格 (現金含む)
day_3: ポートフォリオの水曜日終値での基準価格 (現金含む)
day_4: ポートフォリオの木曜日終値での基準価格 (現金含む)
day_5: ポートフォリオの金曜日終値での基準価格 (現金含む)
day_1_return: 月曜日のリターン (%)
day_2_return: 火曜日のリターン (%)
day_3_return: 水曜日のリターン (%)
day_4_return: 木曜日のリターン (%)
day_5_return: 金曜日のリターン (%)
day_1_pl: 月曜日の損益
day_2_pl: 火曜日の損益
day_3_pl: 水曜日の損益
day_4_pl: 木曜日の損益
day_5_pl: 金曜日の損益
exp: 日次リターンの平均
holiday: 祝日の曜日 (0: 月曜日, 4: 金曜日)
sharp: 日次リターンのシャープレシオ
std: 日次リターンの標準偏差
week_pl: 週の損益
week_return: 週のリターン</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>df_stocks</code> の項目は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>actual: 実際に購入した数量
date: 基準日付 (月曜日日付)
Local Code: 銘柄コード
budget: 指定した購入金額
n: 購入順
entry: 週の始値
day_1: 月曜日の終値
day_2: 火曜日の終値
day_3: 水曜日の終値
day_4: 木曜日の終値
day_5: 金曜日の終値
bought: 購入金額
actual: 購入株数</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="anchor-3.6.4">3.6.4. バックテストの評価軸と取引戦略</h4>
<div class="paragraph">
<p>　バックテストを実行するとトレードの履歴を得ることができます。それらのトレード履歴を分析して評価してみましょう。トレードの代表的な評価軸としては、以下のようなものがあります。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">評価軸</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">勝率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレードがどの程度勝つかを示す指標です。勝ちトレード数 (利益が0を超えるトレード数) を総トレード数で割ることで算出します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">平均リターン</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレード1回あたりの平均の利益率を示します。合計損益を総トレード数で割ることで算出します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">最大ドローダウン</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">累積リターンの最大地点からの下落率のことです。取引戦略のリスクを知る上で重要な指標です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ベータ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ベンチマークとなる指数や取引対象のユニバースに対する合計収益の連動率です。たとえば、ベンチマークとなる指数が10%上昇したときに11%上昇したらベータは1.1となります。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ペイオフレシオ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トレード1回あたりの損益率を示します。トレードの平均利益を平均損失で割ることで算出します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">シャープレシオ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">リスクに応じた利益を得られているかを示します。リターンから安全資産利回りを引いてそのリターンの標準偏差で割ることで算出します。週・月・年などの計算の単位で大きく結果が変わることに注意が必要です。日本株のアルゴリズムトレードの評価では、安定資産利回りは0%で計算することが多いです。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">インフォメーション・レシオ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ベンチマークと比べて安定した利益を得られているかを示します。リターンからベンチマーク利回りを引いたものを平均して標準偏差で割ることで算出します。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>　バックテスト実行時は、一つの評価軸のみを確認するのではなく、複数の評価軸を組み合わせて解釈することでトレード戦略の特性を把握することが重要です。考慮すべき観点は多数存在しますが、その一部を紹介します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>勝率のみに注目すると、小さい勝ちを積み重ねていても、実際には大きな負けにより収益を失っていることに気づかないことがあります。そのため、平均リターンやペイオフレシオとセットで確認し、高い勝率を実現するために何をトレードオフにしているかに注目しましょう。</p>
</li>
<li>
<p>取引戦略はマーケット全体の動きの影響を強く受けます。その取引戦略のユニバースに対する特性を知るために、まずはベータを確認しましょう。一般的にベータが高い取引戦略を取っている場合、マーケット全体の暴落時に大きな暴落が発生することになるため、ベータが高い取引戦略では最大ドローダウンが大きくなる傾向があることに注意が必要です。逆に低いベータで同等の収益性が実現できている取引戦略は、高いベータの取引戦略よりも相対的にリスクが低く、パフォーマンスが安定すると考えることができます。</p>
</li>
<li>
<p>最大ドローダウンは、その取引戦略のリスクを評価する上で重要な評価軸です。自分の取引戦略が過去に最大でどのくらいの下落をしたかは常に把握しましょう。</p>
</li>
<li>
<p>取引戦略の評価をする際に対比軸となるベンチマークをどのように設定するかを常に考えましょう。本チュートリアルでは、取引戦略の効果を評価するため取引可能な全銘柄の平均リターンをベンチマークに採用しています。本コンペティションではデータは提供されていませんが、TOPIXや日経平均株価等もベンチマークとして採用されることが多く、それぞれ特性が異なります。</p>
</li>
<li>
<p>取引戦略を評価する際は、バックテストを行う期間におけるマーケットの特性を把握することが重要です。例えば、2020年は新型コロナウイルス感染症(COVID‑19)の影響で、前半マーケットは大きく値下がりした後、世界的に経済対策のための金融緩和が加速し結果的に歴史的な株高となりました。このような期間でも安定的に勝てる取引戦略は、前半の暴落に対する備えと、後半のトレンドが発生した時に収益化できる特性を両方備えている必要があります。2016年から2019年においてもそれぞれマーケットの特性がありますので、取引戦略の評価をする際はできるだけ多角的に多用な期間を評価し、その取引戦略の強み・弱みをしっかりと把握することが重要です。</p>
</li>
<li>
<p>取引戦略を評価する上で重要となるのが実現可能性です。今回は取引コストを0と仮定しているため、細かくポートフォリオを入れ替えることにパフォーマンスのペナルティは発生しませんが、実際に取引を行う場合は取引手数料は重要な要素となります。また、本コンペの評価手法に関連する箇所としては、取引対象として指定した数量を市場の始値で本当に購入できるか、というポイントもあります。本コンペでは取引対象のユニバースを時価総額200億円以上としているため、個人で取引を行う上でも流動性等についてそこまで大きな問題にはなりませんが、より時価総額が小型の株式銘柄をユニバースとして利用する場合はこの観点も注意してください。</p>
</li>
<li>
<p>平均リターンや勝率などを株価の動きそのものではなく、取引対象銘柄の平均をベンチマークとして、ベンチマークとの相対的な差を計算することで相対的なリターン(残差リターンなどと呼ばれます)や相対的な勝率を計算することができます。例えば、ベンチマークが10％下落したときに、ポートフォリオが1%の下落に収まっている場合、相対的なリターンは+9%勝っていることになります。このようなベンチマーク対比の計算も合わせて行うことで、より多角的な評価をすることが可能になります。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_シンプルなポートフォリオ組成モデルの作成">3.7. シンプルなポートフォリオ組成モデルの作成</h3>
<div class="paragraph">
<p>　バックテストの実行方法を理解したので、いよいよシンプルなポートフォリオ組成モデルを作成しましょう。ポートフォリオ組成モデルを作成することを通して、本コンペティションに投稿するモデルの出力や評価方法を把握し、最終的には作成したモデルを投稿して結果がリーダーボードに掲載されることを確認します。</p>
</div>
<div class="paragraph">
<p>　本節では以下を説明しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ポートフォリオ組成モデルの作成方法</p>
</li>
<li>
<p>バックテストの使用方法</p>
</li>
<li>
<p>投稿用パッケージの作成方法</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　具体的には、以下のステップで進めていきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1. 必要なライブラリの読み込み
2. データセットの読み込み
3. ポートフォリオ組成戦略の策定
4. ポートフォリオの組成
5. 出力の調整
6. バックテストの実行
7. バックテストの評価
8. 投稿用パッケージのディレクトリ作成
9. 作成したコードをランタイム実行用にクラスにまとめる
10. 提出用パッケージの作成と提出</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_必要な入力データ等">3.7.1. 必要な入力データ等</h4>
<div class="paragraph">
<p>■バックテスト用クラス<br>
本コンペティションの評価方法と同等のロジックを実装したバックテスト用のクラスを提供しています。本notebookからimportできる必要があります。import時にエラーとなる場合は、`backtest.py` ファイルをダウンロードしている確認の上、sys.path に追加して再実行してください。なお、バックテスト用のクラスの取得方法は、「<a href="#anchor-3.6">3.6. バックテスト環境の構築</a>」をご参照ください。</p>
</div>
<div class="paragraph">
<p>■データセット<br>
本章で構築するモデルにおいては、以下のデータファイルを使用します。そのため、コンペティションサイトからダウンロードしたデータファイルを配置し、ディレクトリパスを <code>dataset_dir</code> 変数に設定してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>stock_list.csv.gz</p>
</li>
<li>
<p>stock_price.csv.gz</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_必要なライブラリの読み込み">3.7.2. 必要なライブラリの読み込み</h4>
<div class="paragraph">
<p>　ランタイム環境とGoogle Colaboratory環境の両者で共通のライブラリを使用するためにバージョンを調整します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="error">!</span>pip install --no-cache-<span class="predefined">dir</span> joblib==<span class="float">1.0</span><span class="float">.1</span> numpy==<span class="float">1.19</span><span class="float">.5</span> pandas==<span class="float">1.1</span><span class="float">.5</span> scikit-learn==<span class="float">0.20</span><span class="float">.3</span> scipy==<span class="float">1.2</span><span class="float">.1</span> seaborn==<span class="float">0.9</span><span class="float">.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　以下のライブラリを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">io</span>
<span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">zipfile</span>

<span class="keyword">import</span> <span class="include">matplotlib</span>
<span class="keyword">import</span> <span class="include">matplotlib.pyplot</span> <span class="keyword">as</span> plt
<span class="keyword">import</span> <span class="include">numpy</span> <span class="keyword">as</span> np
<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd
<span class="keyword">import</span> <span class="include">seaborn</span> <span class="keyword">as</span> sns
<span class="keyword">from</span> <span class="include">tqdm.auto</span> <span class="keyword">import</span> <span class="include">tqdm</span>
<span class="keyword">from</span> <span class="include">scipy</span> <span class="keyword">import</span> <span class="include">stats</span>
<span class="keyword">from</span> <span class="include">IPython.core.magic</span> <span class="keyword">import</span> <span class="include">register_cell_magic</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　次に本コンペティションの評価検証用のバックテストモジュールを読み込みます。インポート時にエラーが出た場合は、sys.path に backtest.py ファイルを配置したディレクトリを追加してから再度インポートしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># インポート時にエラーが出た場合は、以下のmodule_dirをbacktest.pyを配置したディレクトリに変更してください。</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
  <span class="comment"># Backtestを配置したディレクトリへのフルパスを指定します</span>
  module_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter03/backtest</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
  <span class="comment"># Backtestを配置したディレクトリへのフルパスを指定します</span>
  module_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/Chapter03/backtest</span><span class="delimiter">&quot;</span></span>
sys.path.append(module_dir)

<span class="keyword">from</span> <span class="include">backtest</span> <span class="keyword">import</span> <span class="include">Backtest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　Pandasのデータを表示する際に表略されないように設定を変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 表示用の設定を変更します</span>
pd.options.display.max_rows = <span class="integer">100</span>
pd.options.display.max_columns = <span class="integer">100</span>
pd.options.display.width = <span class="integer">120</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_データセットの読み込み_2">3.7.3. データセットの読み込み</h4>
<div class="paragraph">
<p>　データセットを配置したディレクトリのパスを設定します。Google Colabをご利用の場合は Google Drive にデータセットをアップロードして、そのディレクトリを指定してください。また、データセットの取得方法および内容については「<a href="#anchor-3.4">3.4. データセットの説明</a>」をご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データセットを配置したディレクトリのパスを設定</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    dataset_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
    dataset_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/data_dir_comp2</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　本コンペティションのランタイム環境におけるデータセットへのアクセスは、 <code>ScoringService.predict()</code> メソッドに渡されるinputsパラメーターを通して行う必要があります。そのため、以下のように本notebook環境でもランタイム環境と共通の方法でデータセットにアクセスすることで、コードが複雑になったり投稿用にコードを編集したりしなくても済むようにしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 入力パラメーターを設定します。ランタイム環境での実行時と同一フォーマットにします</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　本コンペティションでは2016年以降のデータを提供していますが、本notebookではモデル作成・評価時の処理時間を短くするために 2020-01-01 以降のデータを使用してバックテストを実施・評価します。なお、実際に評価をする場合は可能な限り長い期間を評価に利用することを推奨します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象日付を指定します</span>
start_dt = pd.Timestamp(<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ランタイム環境においては <code>ScoringService.predict()</code> メソッドに渡されるinputsパラメーターに <code>purchase_date</code> というキー名で予測対象日が記載されたCSV形式のファイルへのパスが渡され、そのファイル内に記載されている日付を予測対象日として使用します。ここではランタイム環境に対応するために <code>purchase_date</code> が存在する場合は、指定された日付を使用するロジックを組み込んでおきます。purchase_date のフォーマットについては <a href="https://signate.jp/competitions/443/data">SIGNATEのコンペティションサイト</a> にサンプルファイルが配置されているためそちらをご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> inputs.keys():
    <span class="comment"># ランタイム環境では指定された投資対象日付を使用します</span>
    <span class="comment"># purchase_dateを読み込み</span>
    df_purchase_date = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># purchase_dateの最も古い日付を投資対象日付として使用します</span>
    start_dt = pd.Timestamp(df_purchase_date.sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">Purchase Date</span><span class="delimiter">&quot;</span></span>).iloc[<span class="integer">0</span>, <span class="integer">0</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　本コンペティションでは投資対象となる銘柄群 (ユニバース) が設定されています。そのため、ユニバース内の銘柄に絞って処理を実施するために銘柄情報を読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄情報読み込み</span>
df_stock_list = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>])
<span class="comment"># 問題2のユニバース (投資対象の条件を満たす銘柄群) 取得</span>
codes = df_stock_list.loc[
    df_stock_list.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
].unique()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　以下では、シンプルに株価情報のみを利用してポートフォリオを組成するために株価情報を読み込んでいます。本コンペティションでは、データセットはcsv.gz形式で提供していますので、データの型情報が保存されていません。そのため、特に日付型のカラムについては明示的に変換する必要があります。read_csvのparse_dateパラメーター等、日付型を指定する方法は複数ありますが、本notebookでは一度読み込んでから変換しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 価格情報読み込み、インデックス作成</span>
df_price = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]).set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 日付型に変換</span>
df_price.index = pd.to_datetime(df_price.index, format=<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　処理時間を最適化するために処理対象データを日付でフィルタをして絞り込みます。本notebookでは過去20営業日のデータを使用して特徴量を作成するため、投資対象日付から過去20営業日時点のデータを含める必要がありますが、バッファとして過去30日のデータを含めることにします。同時に株価情報をユニバースと一致するように絞り込んでいます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 投資対象日の前週金曜日時点で予測を出力するため、予測出力用の日付を設定します。</span>
pred_start_dt = pd.Timestamp(start_dt) - pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 特徴量の生成に必要な日数をバッファとして設定</span>
n = <span class="integer">30</span>
<span class="comment"># データ絞り込み日付設定</span>
data_start_dt = pred_start_dt - pd.offsets.BDay(n)
<span class="comment"># 日付で絞り込み</span>
filter_date = df_price.index &gt;= data_start_dt
<span class="comment"># 銘柄をユニバースで絞り込み</span>
filter_universe = df_price.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>].isin(codes)
<span class="comment"># 絞り込み実施</span>
df_price = df_price.loc[filter_date &amp; filter_universe]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>head()</code> や <code>tail()</code> メソッドを使用して処理結果が期待通りとなっていることを確認しながら進めていきます。ここではデータが2019年11月20日以降に絞り込まれていることが確認できます。`.T`  プロパティ <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.transpose.html#pandas.DataFrame.transpose" class="bare">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.transpose.html#pandas.DataFrame.transpose</a> を使用して行と列を入れ替えることで可読性が上がる場合があります。</p>
</div>
<div class="paragraph">
<p>　ここで計算したデータセットのフォーマットを確認するために、データセットの先頭を見てみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">df_price.head(<span class="integer">3</span>).T</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple.png" alt="処理結果" width="70%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="anchor-3.7.4">3.7.4. ポートフォリオ構築戦略の策定</h4>
<div class="paragraph">
<p>　ポートフォリオを組成するための特徴量を作成します。今回は以下の2種類の戦略を採用します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>リターン・リバーサル (逆張り) 戦略を採用して、過去1ヶ月(約20営業日)の株価下落率の上位25銘柄を選択します。
(「リターン・リバーサル」 野村證券証券用語解説集より引用 <a href="https://www.nomura.co.jp/terms/japan/ri/A01944.html" class="bare">https://www.nomura.co.jp/terms/japan/ri/A01944.html</a>)</p>
</li>
<li>
<p>トレンドフォロー (順張り) 戦略を採用して、過去1ヶ月(約20営業日)の株価上昇率の上位25銘柄を選択します。
(「トレンドフォロー」 野村證券証券用語解説集より引用 <a href="https://www.nomura.co.jp/terms/japan/ta/A02002.html" class="bare">https://www.nomura.co.jp/terms/japan/ta/A02002.html</a>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　過去1ヶ月(20営業日)の株価下落率/上昇率を計算するために、銘柄毎にグループ化してから株価変化率を計算します。<br>
　本コンペティションに提出するポートフォリオは各週の週初の営業日に買付実施されるため、買付日前週の金曜日終値時点を銘柄選択の基準とします。基準日のデータを取得するために単純に金曜日にのみ絞り込んだ場合、金曜日が祝日の場合にその翌週の銘柄を選択できなくなるおそれがあるため、平日でリサンプル(pandasにおいて平日を意味する <code>B</code> を指定してresample関数を呼んでいます)し、欠損値がある場合には前日の値を使うように前方補完(pandasではffill関数を利用)を実施します。これにより、金曜日に必ずデータが存在するようにしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 欠損値がある場合にも正しく動作しているかを確認するため、処理前に木曜日、金曜日が祝日である2020-07-23、2020-07-24のレコードが存在しないことを確認しておきます。</span>
df_price.loc[<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-07-22</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-07-27</span><span class="delimiter">&quot;</span></span>].head(<span class="integer">4</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple1.png" alt="処理結果" width="90%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># groupby を使用して処理するために並び替え</span>
df_price.sort_values([<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>], inplace=<span class="predefined-constant">True</span>)
<span class="comment"># 銘柄毎にグループにします。</span>
grouped_price = df_price.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>)[
    <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
]
<span class="comment"># 銘柄毎に20営業日の変化率を作成してから、金曜日に必ずデータが存在するようにリサンプルして前方補完します。</span>
df_feature = grouped_price.apply(
    <span class="keyword">lambda</span> x: x.pct_change(<span class="integer">20</span>).resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>).ffill().dropna()
).to_frame()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　大量のデータを処理する場合、処理によっては数分から数時間かかる場合があります。処理済みのデータを保存しておくことで、処理時間のかかる処理を省略して作業できるようにすることは重要なテクニックの一つです。今回はメモリ上に別の変数として保存しておきますが、セッションが閉じられる際に処理済みデータもクリアされてしまうことに加えて、大量のデータである場合はメモリ上に保存しておくとメモリを圧迫するため、ファイルに書き出しておいて必要な時にファイルから読み込むのが良い方法です。</p>
</div>
<div class="paragraph">
<p>　Pandasには様々な形式でのデータの入出力用メソッド (<a href="https://pandas.pydata.org/pandas-docs/stable/user_guide/io.html">リンク</a>) が用意されています。例えば、データが圧縮されて型が保存される <code>to_hdf</code> メソッド (<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_hdf.html">リンク</a>)を使用してファイルに書き出し、対応する <code>read_hdf</code> メソッド (<a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_hdf.html">リンク</a>)で読み出すことで簡単にデータフレームを読み書きできます。</p>
</div>
<div class="paragraph">
<p>　平日を指定してデータのリサンプル行い、欠損値に前日の値を使うように前方補完した結果が期待通りになっているかを確認しましょう。2020-07-23及び2020-07-24はそれぞれ木曜日及び金曜日の祝日でしたので、2020-07-23及び2020-07-24に2020-07-22の値が入っていれば良いことになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 上記は比較的時間のかかる処理なので、処理済みデータを別に残しておきます。</span>
df_work = df_feature.copy()

<span class="comment"># 処理後に木曜日、金曜日が祝日である2020-07-23、2020-07-24のレコードが前方補完されていることを確認します。</span>
df_work.loc[(<span class="predefined">slice</span>(<span class="predefined-constant">None</span>), <span class="predefined">slice</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-07-22</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-07-27</span><span class="delimiter">&quot;</span></span>)),].head(<span class="integer">4</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　下図のように木曜及び金曜の祝日である2020-07-23及び2020-07-24に2020-07-22の値が入っていることが確認できます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple2.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>　以下のコードでデータを整えます。インデックスとカラム名を調整しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># インデックスが銘柄コードと日付になっているため、日付のみに変更します。</span>
df_work = df_work.reset_index(level=[<span class="integer">0</span>])
<span class="comment"># カラム名を変更します。</span>
df_work.rename(
    columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">pct_change</span><span class="delimiter">&quot;</span></span>},
    inplace=<span class="predefined-constant">True</span>,
)
<span class="comment"># データをpred_start_dt以降の日付に絞り込みます。</span>
df_work = df_work.loc[df_work.index &gt;= pred_start_dt]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　特徴量が生成されていることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># df_workの最初の3行を出力する。</span>
df_work.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple3.png" alt="処理結果" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ポートフォリオ組成を行う上での注意事項">3.7.5. ポートフォリオ組成を行う上での注意事項</h4>
<div class="paragraph">
<p>　本コンペのようにデータサイエンス的な手法で取引戦略を構築する上で重要なのは、取引戦略に合致した銘柄選択を実施してポートフォリオを組成することです。取引戦略をデータサイエンスな的手法で構築している場合、そこから実現したい収益は、統計的に他の銘柄よりも収益性が高い銘柄をモデルが選択することで達成しているはずです。しかし、実際に良いモデルを作ることができても、そこから収益を実現するためには工夫が必要となります。ここでは、その際の注意点を考察します。</p>
</div>
<div class="sect4">
<h5 id="_取引対象銘柄数の選択">取引対象銘柄数の選択</h5>
<div class="paragraph">
<p>　予測モデルのスコアから収益を実現するためには、ポートフォリオを組成する取引対象銘柄の数の選択が重要となります。予測モデルから算出されるスコアが高い収益を仮に予測できていたとしても、取引対象銘柄の数が少なすぎると決算などの銘柄の個々の要因により予測した収益性の効果が消されることがあります。</p>
</div>
<div class="paragraph">
<p>　同一の合計金額で株式を購入する際、スコアの上位5銘柄で組成したポートフォリオと上位20銘柄で組成したポートフォリオのどちらのポートフォリオが、銘柄の個々の要因の影響を受けにくいかを考えると、20銘柄の方が影響を受けにくいことになります。ただし、取引銘柄数を増やしすぎると取引戦略の実現に必要な現金が増えたり、スコアの有効性があまり無い銘柄もポートフォリオに含まれる可能性があるため、最終的な購入銘柄数はバックテストを通して調整する必要があります。</p>
</div>
<div class="paragraph">
<p>　なお、データサイエンス的手法の利用用途において、まれに発生する現象を探索するような方法(アノマリーディテクションなどと呼ばれます)があります。このようなモデルでは20銘柄も有効なスコアが出ていない可能性があります。この場合、バックテストを通して、有効性が高いスコアのしきい値を探索し、ある一定のスコアを超えていたら売買を行うようなロジックを構築することもあります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_購入金額の決定">購入金額の決定</h5>
<div class="paragraph">
<p>　購入金額は特別な理由が無い限りは、銘柄ごとにある程度均等になるように購入するのが良いでしょう。直感的には予測スコアの上位の銘柄を、より多く購入したいと考えるかもしれませんが、この試みは結果的に予測スコアの上位の銘柄の個々の要因により負ける可能性を増やすことに繋がります。予測モデルで収益性を予測してみると、そのスコアの統計的な効果はさほど強くない(未来の値動きに対する相関係数は0.1から高くても0.2程度に収まる)ことが多く、上位のスコアの銘柄に対して取引金額の割合をより多くするほどの統計的な強度は観測されていないことが多いです。</p>
</div>
<div class="paragraph">
<p>　また、最上位の予測スコアの銘柄には注意が必要です。データサイエンス的な手法でモデルを作ると、外れ値等に反応するモデルが出来上がることがあります。このような動きは、例えば特別損失の適時開示等のコーポレーションアクションで引き起こされている事が多く、リスク回避の観点からはそのようなモデルは取引対象に含めるべきではありません。本コンペティションのデータには、TDnetのデータが含まれているため、そのような銘柄を予め取引対象のユニバースから除外するアプローチも後ほど紹介しています。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ポートフォリオの組成手順">3.7.6. ポートフォリオの組成手順</h4>
<div class="paragraph">
<p>　今回のポートフォリオでは買付日前週の金曜日終値時点を銘柄選択の基準とするため、金曜日のデータのみに絞り込みます。すでに「<a href="#anchor-3.7.4">3.7.4. ポートフォリオ構築戦略の策定</a>」において、金曜日が祝日の場合の処理はしていますので、そのまま金曜日に絞り込んで問題ありません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 金曜日のデータのみに絞り込みます</span>
df_work = df_work.loc[df_work.index.dayofweek == <span class="integer">4</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　金曜日のデータのみとなっていることを確認します</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># df_workの最初の2行を出力する。</span>
df_work.head(<span class="integer">2</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple4.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>　次に、日付毎にグループ化してから、下落率上位25銘柄を選択しています。本コンペティションの評価では、出力されたポートフォリオに記載されている順番で銘柄が購入されるため、なるべくリターンが高くなる銘柄から先に出力して購入されるようにすることが最適と考えられます。ここでは、下落率が高い銘柄ほどリターンの大きくなるとの仮説を立てて、`pct_change` について昇順で並べ替えてから銘柄を選択しています。こうすることで下落率が高い銘柄順に出力されるようにしています。</p>
</div>
<div class="paragraph">
<p>　なお、ここでは説明をシンプルにするために特に理由なく25銘柄を選択していますが、例えば、5銘柄から50銘柄まで5銘柄ずつ増加させた合計10個のポートフォリオを組成してバックテストでパフォーマンスを比較することで、この戦略における最適な選択銘柄数を見つけられるかもしれません。また、その場合、50銘柄のポートフォリオを組成しておいて、バックテスト投入時に銘柄数を絞り込むロジックを組むことで処理時間を最適化できるかもしれません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 日付毎に処理するためグループ化します</span>
grouped_work = df_work.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>, as_index=<span class="predefined-constant">False</span>)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 選択する銘柄数を指定します</span>
number_of_portfolio_stocks = <span class="integer">25</span>

<span class="comment"># ポートフォリオの組成方法を戦略に応じて調整します</span>
strategies = {
    <span class="comment"># リターン・リバーサル戦略</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>: {<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>: <span class="predefined-constant">True</span>},
    <span class="comment"># トレンドフォロー戦略</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">trend</span><span class="delimiter">&quot;</span></span>: {<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>: <span class="predefined-constant">False</span>},
}

<span class="comment"># 戦略に応じたポートフォリオを保存します</span>
df_portfolios = {}

<span class="comment"># strategy_id が設定されていない場合は全ての戦略のポートフォリオを作成します</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="predefined">locals</span>():
    strategy_id = <span class="predefined-constant">None</span>

<span class="keyword">for</span> i <span class="keyword">in</span> [strategy_id] <span class="keyword">if</span> strategy_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="predefined-constant">None</span> <span class="keyword">else</span> strategies.keys():
    <span class="comment">#  日付毎に戦略に応じた上位25銘柄を選択します。</span>
    df_portfolios[i] = grouped_work.apply(
        <span class="keyword">lambda</span> x: x.sort_values(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">pct_change</span><span class="delimiter">&quot;</span></span>, ascending=strategies[i][<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>]
        ).head(number_of_portfolio_stocks)
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>　以下を確認します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>1つの週に対して25銘柄選択されていること</p>
</li>
<li>
<p>戦略に応じてpct_changeの値が反転していること</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結果結合用</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># ポートフォリオを表示用に保存</span>
    buff.append(
        df_portfolios[i]
        <span class="comment"># マルチインデックスは操作しにくいので日付のみに変更します</span>
        .reset_index(level=[<span class="integer">0</span>])
        <span class="comment"># 先頭の26レコードを取得します</span>
        .head(<span class="integer">26</span>)
        <span class="comment"># 結合した後の列名をわかりやすくするために変更します</span>
        .rename(columns={v: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{i}_</span><span class="delimiter">&quot;</span></span> + v <span class="keyword">for</span> v <span class="keyword">in</span> df_portfolios[i].columns})
    )
<span class="comment"># 結合して保存</span>
pd.concat(buff, axis=<span class="integer">1</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple5.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>　ポートフォリオに組み入れる銘柄を決めたので、各銘柄について購入金額を指定します。今回はシンプルにするために50,000円を一律で指定して購入金額の総額を25銘柄分で合計125万とすることで、1株の価格が5万円を超えている銘柄が含まれていても予算上限に近い金額を購入できるようにしています。株価を参照して銘柄数や購入金額を調整することも検討してみてください。なお、本コンペティションのポートフォリオは、対象週の月曜日日付を指定する必要がありますので、金曜日から月曜日日付に変更しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄ごとの購入金額を指定</span>
budget = <span class="integer">50000</span>
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># 購入株式数を設定</span>
    df_portfolios[i].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>] = budget
    <span class="comment"># インデックスを日付のみにします</span>
    df_portfolios[i].reset_index(level=[<span class="integer">0</span>], inplace=<span class="predefined-constant">True</span>)
    <span class="comment"># 金曜日から月曜日日付に変更</span>
    df_portfolios[i].index = df_portfolios[i].index + pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>これでポートフォリオが完成しました。完成したデータを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># 戦略名を表示</span>
    display(i)
    <span class="comment"># 表示</span>
    display(df_portfolios[i].head(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple6.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>　ポートフォリオ組成に用いた特徴量やその他のカラムが残っているため、本コンペティションで決められている出力フォーマットと一致するように出力を調整します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_出力の調整">3.7.7. 出力の調整</h4>
<div class="paragraph">
<p>　本コンペティションのポートフォリオの出力フォーマットは「<a href="#anchor-3.3.4">3.3.4. 提出するモデルの予測出力の定義</a>」をご参照ください。ここでは出力フォーマットに合わせるためにインデックス名やカラム数を調整します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># インデックス名を設定</span>
    df_portfolios[i].index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 出力するカラムを絞り込みます</span>
    df_portfolios[i] = df_portfolios[i].loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ポートフォリオが出力フォーマットと一致していることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># ポートフォリオを確認</span>
    display(df_portfolios[i].head(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple7.png" alt="処理結果" width="30%">
</div>
</div>
<div class="paragraph">
<p>　本コンペティションの <code>ScoringService.predict</code> の出力仕様はcsv形式の文字列であるため、仕様に合わせて出力します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 出力保存用</span>
outputs = {}
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
    <span class="comment"># 出力します</span>
    out = io.StringIO()
    <span class="comment"># CSV形式で出力</span>
    df_portfolios[i].to_csv(out, header=<span class="predefined-constant">True</span>)
    <span class="comment"># 出力を保存</span>
    outputs[i] = out.getvalue()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> outputs.keys():
    <span class="comment"># 戦略名を表示</span>
    print(f<span class="string"><span class="delimiter">'</span><span class="content">// &quot;{i}&quot;</span><span class="delimiter">'</span></span>)
    <span class="comment"># 出力を確認</span>
    print(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.join(outputs[i].split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)[:<span class="integer">4</span>]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// &quot;reversal&quot;
date,Local Code,budget
2020-01-06,4592,50000
2020-01-06,3254,50000
2020-01-06,6875,50000
// &quot;trend&quot;
date,Local Code,budget
2020-01-06,6387,50000
2020-01-06,4772,50000
2020-01-06,6195,50000</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテスト用に出力を保存しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> outputs.keys():
    <span class="comment"># 出力を保存します。</span>
    <span class="keyword">with</span> <span class="predefined">open</span>(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-01-{i}.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
        <span class="comment"># ポートフォリオをファイルに書き出します。</span>
        f.write(outputs[i])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_バックテストの実行">3.7.8. バックテストの実行</h4>
<div class="paragraph">
<p>　本コンペティションの Public LB および Private LB と同等の評価ロジックを実装したバックテスト用の <code>backtest.py</code> ファイルを使用して、作成したポートフォリオを評価します。
バックテストの使用法などの詳細は、「<a href="#anchor-3.6">3.6. バックテスト環境の構築</a>」をご参照ください。</p>
</div>
<div class="paragraph">
<p>　初めにバックテストを使用する際に必要なデータを準備します。バックテストの実行には以下の3つのデータが必要になります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ユニバース (stock_list.csv.gz)</p>
</li>
<li>
<p>株価 (stock_price.csv.gz)</p>
</li>
<li>
<p>テスト対象のポートフォリオ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　<code>Backtest.prepare_data</code> に1および2のデータを保存しているディレクトリへのパスを指定して、必要なデータをロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データを保存しているディレクトリを指定します。</span>
backtest_dataset_dir = dataset_dir
<span class="comment"># バックテストに必要なデータを読み込みます。</span>
backtest_codes, backtest_price = Backtest.prepare_data(backtest_dataset_dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテスト対象の戦略であるリターン・リバーサル戦略とトレンドフォロー戦略を定義します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># ポートフォリオの組成方法</span>
backtest_strategies = {
    <span class="comment"># リターン・リバーサル戦略</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>: {},
    <span class="comment"># トレンドフォロー戦略</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">trend</span><span class="delimiter">&quot;</span></span>: {},
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>Backtest.load_submit</code> にテスト対象のポートフォリオを保存したファイルへのパスを指定して読み込みます。`load_submit` ではデータを読み込み時にフォーマットのチェックをしたり、レコード順を付与するなどのバックテスト実行のための前処理を実施しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># ポートフォリオデータ保存用</span>
df_submits = {}
<span class="comment"># 先ほど出力したポートフィリオデータを読み込みます</span>
<span class="keyword">for</span> i <span class="keyword">in</span> backtest_strategies.keys():
    <span class="comment"># ポートフォリオを読み込み</span>
    df_submits[i] = Backtest.load_submit(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-01-{i}.csv</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　3つのデータを指定してバックテストを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># バックテスト結果リターン情報保存用</span>
results = {}
<span class="comment"># バックテスト結果銘柄情報保存用</span>
stocks = {}
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> tqdm(backtest_strategies.keys()):
    <span class="comment"># バックテストを実行します</span>
    results[i], stocks[i] = Backtest.run(df_submits[i], backtest_codes, backtest_price)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple8.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>　返り値を確認します。評価は下記で実施します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># バックテスト結果のサマリー</span>
results[<span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>].head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple9.png" alt="処理結果" width="100%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄毎の情報</span>
stocks[<span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>].head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple10.png" alt="処理結果" width="70%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_バックテストの評価">3.7.9. バックテストの評価</h4>
<div class="paragraph">
<p>　バックテストを実行して取得した、週毎のリターン情報と各銘柄毎の購入結果数の情報を評価していきます。各評価項目の定義については、「<a href="#anchor-3.6.4">3.6.4. バックテストの評価軸と取引戦略</a>」をご参照ください。</p>
</div>
<div class="paragraph">
<p>　結果の評価として以下を実施します。</p>
</div>
<div class="paragraph">
<p><strong>週毎のリターンデータ</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>週毎の運用実績（PL）の分布をプロット (週毎の運用実績の合計値が本コンペティションの評価項目)</p>
</li>
<li>
<p>週毎の運用実績の統計量の算出</p>
</li>
<li>
<p>週毎の勝率・ペイオフレシオ・シャープレシオの算出</p>
</li>
<li>
<p>週毎のリターン推移のプロット</p>
</li>
<li>
<p>曜日別分析のためのバイオリンプロット</p>
</li>
<li>
<p>週毎のリターンの累積プロット</p>
</li>
<li>
<p>ユニバースとの散布図</p>
</li>
<li>
<p>ユニバースに対するベータを計算</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_1_週毎の運用実績の分布をプロット">1.週毎の運用実績の分布をプロット</h5>
<div class="paragraph">
<p>　まず、週毎の運用実績の分布をプロットしてみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="predefined">len</span>(results), figsize=(<span class="integer">8</span> * <span class="predefined">len</span>(results), <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(results.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># 分布をプロット</span>
    results[k].week_pl.hist(bins=<span class="integer">25</span>, ax=ax)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week pl distribution</span><span class="delimiter">&quot;</span></span>)
<span class="comment">#　描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple11.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>　trendとreversalは共にほぼ0平均に見えますが、reversalは分布が若干広いように見え、週によっては大きなマイナスも観測されていることがわかります。おそらくCOVID-19の暴落が発生した週が該当すると想像できます。ただし、大きなプラスの週もあるため、その負けを取り返しているかもしれません。ただ、このプロットだけではあまり戦略の良し悪しはわかりません。</p>
</div>
</div>
<div class="sect4">
<h5 id="_2_週毎の運用実績の統計量を算出">2.週毎の運用実績の統計量を算出</h5>
<div class="paragraph">
<p>　週毎の運用実績の統計量を算出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># week_plの分布の統計量</span>

<span class="comment"># 結合用データ保存</span>
buff = []
<span class="comment"># ストラテジー毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># week_plの統計量を取得します。</span>
    df = results[k].loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>]].describe().T
    <span class="comment"># インデックスを編集してストラテジーのIDにする</span>
    df.index = [k]
    <span class="comment"># インデックス名変更</span>
    df.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 結合用に保存</span>
    buff.append(df)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple12.png" alt="処理結果" width="70%">
</div>
</div>
<div class="paragraph">
<p>　週毎の運用実績の統計量を確認すると、reversalがtrendより平均(mean)が高いことがわかります。ただし、中央値(50%)を確認するとtrendの方が高いのでreversalは小さな勝ちではなく、大きな勝ちを利用して平均を押し上げていることがわかります。また、25%分位点では大きな差異はないのに最小値はreversalがずっと小さいことから、大きな負けがあると想定されます。</p>
</div>
</div>
<div class="sect4">
<h5 id="_3_週毎の勝率ペイオフレシオシャープレシオを算出">3.週毎の勝率、ペイオフレシオ、シャープレシオを算出</h5>
<div class="paragraph">
<p>　週毎の勝率、ペイオフレシオ、シャープレシオを算出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結合用データ保存</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    df_return = results[k]
    <span class="comment"># 計算結果保存用</span>
    d = {}
    <span class="comment"># 件数</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>] = df_return.shape[<span class="integer">0</span>]
    <span class="comment"># 勝率</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">win_ratio</span><span class="delimiter">&quot;</span></span>] = (
        df_return.loc[df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &gt; <span class="integer">0</span>].shape[<span class="integer">0</span>] / d[<span class="string"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>]
    )
    <span class="comment"># ペイオフレシオ</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">payoff_ratio</span><span class="delimiter">&quot;</span></span>] = df_return.loc[
        df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &gt; <span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>
    ].mean() / (
        -<span class="integer">1</span> * df_return.loc[df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &lt;= <span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].mean()
    )
    <span class="comment"># シャープレシオ</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">sharp</span><span class="delimiter">&quot;</span></span>] = (
        df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].mean() / df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].std()
    )
    <span class="comment"># 平均PL</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">avgPL</span><span class="delimiter">&quot;</span></span>] = df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>].mean()
    <span class="comment"># week_plの合計</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">PL</span><span class="delimiter">&quot;</span></span>] = df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>].sum()
    <span class="comment"># strategy_idを設定</span>
    df = pd.DataFrame([d], index=[k])
    <span class="comment"># インデックス名を指定</span>
    df.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 結合用に保存</span>
    buff.append(df)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple13.png" alt="処理結果" width="50%">
</div>
</div>
<div class="paragraph">
<p>　reversalの週毎の勝率は50%ですが、payoff_ratioも1がより大きく一回の勝ちが負けよりおおきいことがわかります。trendはを勝率が60%を超えており、reversalよりも安定的に勝てるポートフォリオの可能性があります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_4_週毎に曜日別のリターンをプロット">4.週毎に曜日別のリターンをプロット</h5>
<div class="paragraph">
<p>　週毎の1日目から5日目までのリターンの推移をプロットし、曜日毎に勝ち負けの分布に差異が無いかを確認しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(
    <span class="predefined">len</span>(results), <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">4</span> * <span class="predefined">len</span>(results)), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>
)

<span class="comment"># 描画用データ保存用</span>
dfs_plot = {}

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(results.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># 列を行に変換</span>
    dfs_plot[k] = (
        results[k]
        .set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)
        .loc[
            :,
            [
                <span class="string"><span class="delimiter">&quot;</span><span class="content">day_1_return</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">day_2_return</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">day_3_return</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">day_4_return</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5_return</span><span class="delimiter">&quot;</span></span>,
            ],
        ]
        .stack()
        .to_frame()
        .reset_index()
        .rename(columns={<span class="integer">0</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>})
    )
    <span class="comment"># 作業用に変数設定</span>
    df_plot = dfs_plot[k]
    <span class="comment"># 曜日毎のreturnをプロット</span>
    df_plot.groupby([<span class="string"><span class="delimiter">&quot;</span><span class="content">level_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>]).first().unstack().plot(ax=ax, legend=<span class="predefined-constant">False</span>)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: Daily returns</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># リターンが0の位置に基準線を描画</span>
    ax.axhline(y=<span class="integer">0</span>, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># グリッドを表示</span>
    ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple14.png" alt="処理結果" width="70%">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_5_曜日別分析のためのバイオリンプロット">5. 曜日別分析のためのバイオリンプロット</h5>
<div class="paragraph">
<p>　上のグラフでは何が起きているかわかりにくいので、seabornのバイオリンプロット(<a href="https://seaborn.pydata.org/generated/seaborn.violinplot.html">リンク</a>)を利用します。バイオリンプロットはデータの密度分布を確認できるグラフであり、統計的な差異がありそうな箇所を発見するために便利です。バイオリンの形状はカーネル密度推定による確率密度関数を表しており、バイオリンの中心部分に平均、中央値、25%タイル、75%タイルを示す箱が表示されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="predefined">len</span>(results), <span class="integer">1</span>, figsize=(<span class="integer">15</span>, <span class="integer">4</span> * <span class="predefined">len</span>(results)), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(results.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># 箱が見やすいように横方向を指定してプロット</span>
    sns.violinplot(x=<span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>, y=<span class="string"><span class="delimiter">&quot;</span><span class="content">level_1</span><span class="delimiter">&quot;</span></span>, data=dfs_plot[k], ax=ax, orient=<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: daily return</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># グリッドを表示</span>
    ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 文字が重なって読みにくいので間隔調整</span>
fig.tight_layout(pad=<span class="float">2.0</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple15.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　reversal/trendは木・金曜日に負ける傾向がありそうです。trendはプラス側の裾野が若干広いように思われます。これはトレンドフォローを行うと大きな勝ちが取れている可能性が示唆されます。</p>
</div>
<div class="paragraph">
<p>　取引戦略によっては月曜日に大きく勝つモデルや金曜日に大きく負けるなど曜日によって強さが異なることも多く、このような曜日ごとのプロットはその銘柄の特性を知る上で、確認する価値があります。特に曜日や月などの周期でチェックする場合、負けている方(このグラフでいうととマイナス側の分布)に注目することが重要です。周期性を狙って収益を意図的に取得することは難易度の高いテクニックですが、負けの場合は理由をしっかりと分析すると防げる可能性があるためです。例えば、よくあるのが金曜日特有の週末に発生するクローズオーダーなど、機関投資家のルールにより発生する取引です。</p>
</div>
</div>
<div class="sect4">
<h5 id="_6_収益率の時系列を累積プロット">6.収益率の時系列を累積プロット</h5>
<div class="paragraph">
<p>　次にいよいよ取得した収益率の時系列を累積プロットします。まず、比較対象として取引対象の全銘柄の平均週次リターンを計算します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 変数名を調整します。</span>
<span class="comment"># backtest_priceはユニバースで絞り込み済みです</span>
df_price = backtest_price</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 週毎に始値と終値を取得</span>
df_wp = (
    <span class="comment"># start_dt以降の日付のみ計算</span>
    df_price.loc[df_price.index &gt;= start_dt].sort_values([<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># 銘柄コード毎に処理</span>
    .groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># 月曜日スタートで週にリサンプル</span>
    .resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">W-MON</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>, closed=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># 始値は最初のレコード、終値は最後のレコードを取得</span>
    .agg({<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">first</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">last</span><span class="delimiter">&quot;</span></span>})
    <span class="comment"># マルチインデックスを解除</span>
    .reset_index(level=[<span class="integer">0</span>])
)
<span class="comment"># Open が 0.0 の銘柄は値段が付かなかった銘柄で、バックテストでは購入対象外であるため除外する</span>
df_wp = df_wp.loc[df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>] != <span class="float">0.0</span>]
<span class="comment"># 銘柄毎の週次リターンを計算</span>
df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>] = (
    (
        (
            df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]
            / df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>]
        )
        - <span class="integer">1</span>
    )
    * <span class="integer">100</span>
)
<span class="comment"># ユニバースの週毎のリターンを計算します。</span>
df_universe_return = df_wp.groupby(df_wp.index)[<span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>].mean().to_frame()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　対比軸である取引対象の全銘柄の平均週次リターンが準備できたら、今回の取引戦略の結果と一緒にプロットしてみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># 描画位置を指定</span>
    ax = axes
    <span class="comment"># 戦略別の累積リターンを描画</span>
    results[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>).loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>]].rename(
        columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week_return</span><span class="delimiter">&quot;</span></span>}
    ).cumsum().plot(ax=ax)

<span class="comment"># ユニバースの週次リターンの累積をプロット</span>
df_universe_return.cumsum().plot(ax=ax, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># 表示を調整</span>
ax.set_title(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cumulative week_return</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># グリッドを表示</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple16.png" alt="処理結果" width="90%">
</div>
</div>
<div class="paragraph">
<p>　このプロットは興味深いことがわかります。</p>
</div>
<div class="paragraph">
<p>　まずreversalは、3月に発生した負けが非常に大きいことがわかります。ベンチマークはおよそ-20%の負けとなっているのに対し、reversalでは-40%に到達しています。これはリターン・リバーサル戦略を採用した場合、マーケット暴落時に負けが積み重なる現象として知られています。一方、その後に0%近辺まで戻しているので3月後半から5月末にかけて、取得できたリターンは非常に大きいこともわかります。ただ、対比軸である取引対象の全銘柄の平均週次リターンには到達していません。その後、reversal戦略のユニバースに対する有意性は6月以降はあまり観測できず、12月までユニバースの平均に勝てないまま最終的に負けています。</p>
</div>
<div class="paragraph">
<p>　次に、trendは3月上旬の負けがユニバースの平均と比較すると小さいことがわかります。一方、reversal戦略の場合に観測された大きな収益性は観測できず、6月にユニバースの平均と同一の水準になると、以降はreversalと同等に12月までユニバースの平均に勝てないまま最終的に負けています。</p>
</div>
</div>
<div class="sect4">
<h5 id="_7_ユニバースとリターンの散布図をプロット">7.ユニバースとリターンの散布図をプロット</h5>
<div class="paragraph">
<p>　ユニバースとリターンの散布図は、マーケットの動きに対してポートフォリオの運用実績がどのように分布するかを確認するために利用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># 散布図をプロット</span>
    p = sns.jointplot(
        x=df_universe_return.iloc[:, <span class="integer">0</span>],
        y=results[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>],
        kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">reg</span><span class="delimiter">&quot;</span></span>,
        height=<span class="integer">5</span>,
        stat_func=stats.pearsonr,
    )
    <span class="comment"># タイトルを設定</span>
    p.fig.suptitle(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week_return vs universe</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># タイトル表示用に位置を調整</span>
    p.fig.subplots_adjust(top=<span class="float">0.95</span>)
    <span class="comment"># 描画</span>
    plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple17.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　reversalはユニバースに対して、全体が下がった時に負けが大きく、ユニバースが上がった時に勝ちがわずかにユニバースを上回ることが観測できます。trendは分布が広がっており、ユニバースの影響をあまり受けていないことがわかります。また、0でリターンを稼いでいる週が多く観測出来、マーケットが動いていない時に細かく勝てている可能性が示唆されます。</p>
</div>
</div>
<div class="sect4">
<h5 id="_8_ベータ値の算出">8.ベータ値の算出</h5>
<div class="paragraph">
<p>　上記の傾向はベータを計算すると一目瞭然です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結合用に保存</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># ベータを計算</span>
    res = stats.linregress(df_universe_return.iloc[:,<span class="integer">0</span>], results[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># 一覧表示用にデータフレームを作成</span>
    df_beta = pd.DataFrame([res.slope], index=[k], columns=[<span class="string"><span class="delimiter">&quot;</span><span class="content">beta</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># インデックス名を設定</span>
    df_beta.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">storategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 保存</span>
    buff.append(df_beta)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple19.png" alt="処理結果" width="30%">
</div>
</div>
<div class="paragraph">
<p>　reversalはベータがおよそ1.6となっており、ユニバースが10%変動すると16%程度の変動が発生する取引戦略であることがわかります。ユニバースが-20%変動したときは-32%変動しますので、暴落時の大きな負けもこのベータ値の高さで説明ができます。3月のようにドローダウンが深くなる現象は、高いベータを持つ取引戦略にはよく観測されます。trendはベータが0.8近辺となっており、reversalと比較すると低いベータとなっています。</p>
</div>
</div>
<div class="sect4">
<h5 id="_銘柄毎に分析するための準備">銘柄毎に分析するための準備</h5>
<div class="paragraph">
<p>　最後に銘柄毎のデータを使用して分析していきます。</p>
</div>
<div class="paragraph">
<p><strong>各銘柄毎のデータ</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>銘柄毎の運用実績の分布をプロット</p>
</li>
<li>
<p>銘柄毎のreturnの分布をプロット</p>
</li>
<li>
<p>週毎の勝ち銘柄率をプロット、統計量の算出</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>銘柄毎のデータを使用して分析するために必要な計算を実施します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 分析用データ保存用</span>
dfs_analyze = {}
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> stocks.keys():
    <span class="comment"># 分析用にデータをコピー</span>
    df_analyze = stocks[i].copy()
    <span class="comment"># day5に必ず値が存在するように調整します</span>
    df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">day_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]] = (
        df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">day_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]]
        .replace(<span class="float">0.0</span>, np.nan)
        .ffill(axis=<span class="integer">1</span>)
    )
    <span class="comment"># 終値とエントリーの差分を計算</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">diff</span><span class="delimiter">&quot;</span></span>] = df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">entry</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]].diff(axis=<span class="integer">1</span>)[
        <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>
    ]
    <span class="comment"># 損益を計算します</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">pl</span><span class="delimiter">&quot;</span></span>] = df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">diff</span><span class="delimiter">&quot;</span></span>] * df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>]
    <span class="comment"># リターンを計算します</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>] = (
        (df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>] / df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">entry</span><span class="delimiter">&quot;</span></span>]) - <span class="integer">1</span>
    ) * <span class="integer">100</span>
    <span class="comment"># infを0.0に変換</span>
    df_analyze = df_analyze.replace(np.inf, <span class="float">0.0</span>)
    <span class="comment"># 処理結果を保存</span>
    dfs_analyze[i] = df_analyze</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_1_銘柄毎の運用実績の分布をプロット">1.銘柄毎の運用実績の分布をプロット</h5>
<div class="paragraph">
<p>分析用データを表示して確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">dfs_analyze[<span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>].head(<span class="integer">2</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple20.png" alt="処理結果" width="80%">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_2_銘柄毎のリターンの分布をヒストグラムでプロット">2.銘柄毎のリターンの分布をヒストグラムでプロット</h5>
<div class="paragraph">
<p>銘柄毎の各週のデータを確認します。銘柄毎のリターンの分布をヒストグラムでまずはプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="predefined">len</span>(dfs_analyze), figsize=(<span class="integer">8</span> * <span class="predefined">len</span>(dfs_analyze), <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(dfs_analyze.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># ヒストグラムをプロット</span>
    dfs_analyze[k].groupby([<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>])[<span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>].sum().hist(bins=<span class="integer">50</span>, log=<span class="predefined-constant">True</span>, ax=ax)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: Weekly PL distribution</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple21.png" alt="処理結果" width="70%"">
</div>
</div>
<div class="paragraph">
<p>　銘柄毎リターンの分布をプロットしてみましたが、ここから何か知見は得ることは難しそうです。上のプロットからもこれといった知見をえることはできません。あえて言うなら、reversalが若干trendと比較すると裾野が広い程度です。ただし、リターンを大きな勝ちに依存している戦略や、負けの裾野が非常に広い戦略などもこのプロットで観測できるため、リターンの分布は常に確認することをおすすめします。</p>
</div>
</div>
<div class="sect4">
<h5 id="_3_週毎に勝ち銘柄率を算出統計量の算出">3.週毎に勝ち銘柄率を算出、統計量の算出</h5>
<div class="paragraph">
<p>最後に週毎の銘柄の勝率を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, ax = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 統計量表示用</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> dfs_analyze.keys():
    <span class="comment"># 週毎の勝ち銘柄率を計算</span>
    win_ratio = (
        dfs_analyze[k]
        .set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)
        .groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)
        .apply(<span class="keyword">lambda</span> x: (x.pl &gt; <span class="integer">0</span>).sum() / x.shape[<span class="integer">0</span>])
        .to_frame()
        .rename(columns={<span class="integer">0</span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: win_ratio</span><span class="delimiter">&quot;</span></span>})
    )
    <span class="comment"># プロット</span>
    win_ratio.plot(ax=ax)
    <span class="comment"># 統計量を保存</span>
    buff.append(win_ratio.describe().T)
<span class="comment"># ユニバースの勝ち銘柄率をプロット</span>
df_wp.groupby(df_wp.index).apply(<span class="keyword">lambda</span> x: (x.universe &gt; <span class="integer">0</span>).sum() / x.shape[<span class="integer">0</span>]).rename(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>
).to_frame().plot(ax=ax, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># タイトルを設定</span>
ax.set_title(<span class="string"><span class="delimiter">&quot;</span><span class="content">win ratio of selected stocks</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># グリッド表示</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 0.5に基準線を描画</span>
ax.axhline(y=<span class="float">0.5</span>, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
<span class="comment">#  描画</span>
plt.show()
<span class="comment"># 週毎の勝ち銘柄率の統計量</span>
display(pd.concat(buff))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter03/images/simple/simple22.png" alt="処理結果" width="90%">
</div>
</div>
<div class="paragraph">
<p>　このプロットは黒線のuniverseに対してどの時期に銘柄単位で勝率が低く、どの時期に勝率が高かったを確認しています。trendは暴落後にあまり収益を得ることができませんでしたが、revesalやunivereとの差異が観測できます。<br>
もし、銘柄単位の勝率で大きな差異が発生していないのに、収益に差異が出ている場合はその時の銘柄の勝ち幅が大きい可能性があります。また、9月以降にもみ合いになってしまった時期はこの勝率でも50%近辺で揉み合っており、取引戦略の優位性が発揮できていない時期であることがわかります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_考察">考察</h5>
<div class="paragraph">
<p>　ここまででいろいろな観点からreversalとtrendの評価を実施してきました。3月末以降のリターン・リバーサル戦略が有効に働いている時期もありましたし、トレンドフォロー戦略でベータ値を低く抑える可能性があることがわかりました。</p>
</div>
<div class="paragraph">
<p>　基本的にリターン・リバーサル戦略とトレンドフォロー戦略は安定して勝てる手法ではなく、リバーサル・モメンタムという代表的なファクターと密接な関係があり、マーケットの局面ごとに有効な戦略が変わっていることが知られています。ここまでの結果から、適切にリターン・リバーサル戦略とトレンドフォロー戦略をモデルで切り替えることが実現できれば、高い収益が実現できるポテンシャルがありそうです。そのような機械学習モデルの構築を検討する価値はあるでしょう。</p>
</div>
<div class="paragraph">
<p>　このように様々な可視化を通して、取引戦略を評価することで、取引戦略を発展させていくことができます。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_投稿用パッケージの作成">3.8. 投稿用パッケージの作成</h3>
<div class="sect3">
<h4 id="_投稿用パッケージのディレクトリの作成">3.8.1. 投稿用パッケージのディレクトリの作成</h4>
<div class="paragraph">
<p>　ここまで、モデルの作成及び評価をしてきました。ここからは、投稿用のパッケージを作成します。ランタイム環境用のモデルは以下の構成である必要がありますので、まずは必要なディレクトリを作成していきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>.
├── model                  必須 学習済モデルを置くディレクトリ
│   └── ...
├── src                    必須 Python のプログラムを置くディレクトリ
│   ├── predictor.py       必須 最初にプログラムが呼び出すファイル
│   └── ...                その他のファイル (ディレクトリも作成可能)
└── requirements.txt       任意</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 作業用のディレクトリを設定</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    working_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/content/drive/MyDrive/JPX_competition/Chapter03</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
    working_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span>
<span class="comment"># パッケージのrootディレクトリ</span>
package_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{working_dir}/archive</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 必要なディレクトリを作成します</span>
os.makedirs(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{package_dir}/model</span><span class="delimiter">&quot;</span></span>, exist_ok=<span class="predefined-constant">True</span>)
os.makedirs(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{package_dir}/src</span><span class="delimiter">&quot;</span></span>, exist_ok=<span class="predefined-constant">True</span>)
<span class="comment"># 今回はmodelディレクトリに保存するファイルがないため空ファイルを作成します</span>
<span class="predefined">open</span>(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{package_dir}/model/dummy.txt</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>).close()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ランタイム実行用クラスの作成">3.8.2. ランタイム実行用クラスの作成</h4>
<div class="paragraph">
<p>　notebookの各セルで実行する内容をファイルに書き出すために、jupyter notebookにマジックコマンドを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># jupyter notebookにマジックコマンドを追加します</span>
<span class="comment"># セル実行と同時にセル内の記載内容をファイルに書き込みます</span>
<span class="decorator">@register_cell_magic</span>
<span class="keyword">def</span> <span class="function">writerun</span>(line, cell):
    <span class="comment"># 書き込み先ファイルパスを取得</span>
    file_path = line.split()[-<span class="integer">1</span>]
    <span class="comment"># 親ディレクトリ名を取得</span>
    p_dir = os.path.dirname(file_path)
    <span class="comment"># 親ディレクトリが存在する場合は</span>
    <span class="keyword">if</span> p_dir != <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>:
        <span class="comment"># ディレクトリ作成</span>
        os.makedirs(p_dir, exist_ok=<span class="predefined-constant">True</span>)
    <span class="comment"># cellの内容をファイルに書き込み</span>
    <span class="keyword">with</span> <span class="predefined">open</span>(file_path, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
        f.write(cell)
    <span class="comment"># cellを実行</span>
    get_ipython().run_cell(cell)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　以下のコードは、ここまでに一行ずつ作成したコードを投稿用の <code>ScoringService</code> としてまとめて実装したものになります。また、今回は学習済モデルのパラメーターなどをファイルに書き出していないため、`get_model` メソッドでは何もせずにTrueを返しています。そして、`predict` メソッドには上記で実行したコードをコピーして貼り付けています。表示用のコードおよび作業用データのコピーについてはランタイム環境では実行する必要がないため削除しています。</p>
</div>
<div class="paragraph">
<p>　jupyter notebookのセルに <code>ScoringService</code> クラスを作成している理由は、`ScoringService` クラスの出力するポートフォリオがこれまで検証してきたポートフォリオと同一であることの検証が容易であるためです。慣れている方は直接`predictor.py` ファイル上で作業することを好まれるかもしれません。</p>
</div>
<div class="paragraph">
<p>　次のセルでは、セルの先頭で <code>writerun</code> マジックコマンドを指定することで、実行時にセルの内容が <code>$package_dir/src/predictor.py</code> ファイルに書き込まれます。すでにファイルが存在している場合は上書きされるためご注意ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">%%writerun <span class="error">$</span>package_dir/src/predictor.py
<span class="comment"># -*- coding: utf-8 -*-</span>
<span class="keyword">import</span> <span class="include">io</span>

<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd


<span class="keyword">class</span> <span class="class">ScoringService</span>(<span class="predefined">object</span>):
    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_model</span>(cls, model_path=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>):
        <span class="keyword">return</span> <span class="predefined-constant">True</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">predict</span>(
        cls, inputs, start_dt=pd.Timestamp(<span class="string"><span class="delimiter">&quot;</span><span class="content">2021-02-01</span><span class="delimiter">&quot;</span></span>), strategy_id=<span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>
    ):
        <span class="comment">####</span>
        <span class="comment"># データセットを読み込みます</span>
        <span class="comment">####</span>
        <span class="comment"># 銘柄情報読み込み</span>
        df_stock_list = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>])
        <span class="comment"># 問題2のユニバース (投資対象銘柄群) 取得</span>
        codes = df_stock_list.loc[
            df_stock_list.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
        ].unique()

        <span class="comment"># 価格情報読み込み、インデックス作成</span>
        df_price = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>]).set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>)
        <span class="comment"># 日付型に変換</span>
        df_price.index = pd.to_datetime(df_price.index, format=<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d</span><span class="delimiter">&quot;</span></span>)

        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> inputs.keys():
            <span class="comment"># ランタイム環境では指定された投資対象日付を使用します</span>
            <span class="comment"># purchase_dateを読み込み</span>
            df_purchase_date = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span>])
            <span class="comment"># purchase_dateの最も古い日付を設定</span>
            start_dt = pd.Timestamp(
                df_purchase_date.sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">Purchase Date</span><span class="delimiter">&quot;</span></span>).iloc[<span class="integer">0</span>, <span class="integer">0</span>]
            )

        <span class="comment"># 投資対象日の前週金曜日時点で予測を出力するため、予測出力用の日付を設定します。</span>
        pred_start_dt = pd.Timestamp(start_dt) - pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)
        <span class="comment"># 特徴量の生成に必要な日数をバッファとして設定</span>
        n = <span class="integer">30</span>
        <span class="comment"># データ絞り込み日付設定</span>
        data_start_dt = pred_start_dt - pd.offsets.BDay(n)
        <span class="comment"># 日付で絞り込み</span>
        filter_date = df_price.index &gt;= data_start_dt
        <span class="comment"># 銘柄をユニバースで絞り込み</span>
        filter_universe = df_price.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>].isin(codes)
        <span class="comment"># 絞り込み実施</span>
        df_price = df_price.loc[filter_date &amp; filter_universe]

        <span class="comment">####</span>
        <span class="comment"># シンプルな特徴量を作成します</span>
        <span class="comment">####</span>
        <span class="comment"># groupby を使用して処理するために並び替え</span>
        df_price.sort_values([<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>], inplace=<span class="predefined-constant">True</span>)
        <span class="comment"># 銘柄毎にグループにします。</span>
        grouped_price = df_price.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>)[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ]
        <span class="comment"># 銘柄毎に20営業日の変化率を作成してから、金曜日に必ずデータが存在するようにリサンプルしてフィルします</span>
        df_feature = grouped_price.apply(
            <span class="keyword">lambda</span> x: x.pct_change(<span class="integer">20</span>).resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>).ffill().dropna()
        ).to_frame()

        <span class="comment"># 上記が比較的時間のかかる処理なので、処理済みデータを残しておきます。</span>
        df_work = df_feature  <span class="comment"># copyはランタイム実行時には不要なので削除しています</span>

        <span class="comment"># インデックスが銘柄コードと日付になっているため、日付のみに変更します。</span>
        df_work = df_work.reset_index(level=[<span class="integer">0</span>])
        <span class="comment"># カラム名を変更します</span>
        df_work.rename(
            columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">pct_change</span><span class="delimiter">&quot;</span></span>},
            inplace=<span class="predefined-constant">True</span>,
        )
        <span class="comment"># データをpred_start_dt以降の日付に絞り込みます</span>
        df_work = df_work.loc[df_work.index &gt;= pred_start_dt]

        <span class="comment">####</span>
        <span class="comment"># ポートフォリオを組成します</span>
        <span class="comment">####</span>
        <span class="comment"># 金曜日のデータのみに絞り込みます</span>
        df_work = df_work.loc[df_work.index.dayofweek == <span class="integer">4</span>]

        <span class="comment"># 日付毎に処理するためグループ化します</span>
        grouped_work = df_work.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>, as_index=<span class="predefined-constant">False</span>)

        <span class="comment"># 選択する銘柄数を指定します</span>
        number_of_portfolio_stocks = <span class="integer">25</span>

        <span class="comment"># ポートフォリオの組成方法を戦略に応じて調整します</span>
        strategies = {
            <span class="comment"># リターン・リバーサル戦略</span>
            <span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>: {<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>: <span class="predefined-constant">True</span>},
            <span class="comment"># トレンドフォロー戦略</span>
            <span class="string"><span class="delimiter">&quot;</span><span class="content">trend</span><span class="delimiter">&quot;</span></span>: {<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>: <span class="predefined-constant">False</span>},
        }

        <span class="comment"># 戦略に応じたポートフォリオを保存します</span>
        df_portfolios = {}

        <span class="comment"># strategy_id が設定されていない場合は全ての戦略のポートフォリオを作成します</span>
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="predefined">locals</span>():
            strategy_id = <span class="predefined-constant">None</span>

        <span class="keyword">for</span> i <span class="keyword">in</span> [strategy_id] <span class="keyword">if</span> strategy_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="predefined-constant">None</span> <span class="keyword">else</span> strategies.keys():
            <span class="comment">#  日付毎に戦略に応じた上位25銘柄を選択します。</span>
            df_portfolios[i] = grouped_work.apply(
                <span class="keyword">lambda</span> x: x.sort_values(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">pct_change</span><span class="delimiter">&quot;</span></span>, ascending=strategies[i][<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>]
                ).head(number_of_portfolio_stocks)
            )

        <span class="comment"># 銘柄ごとの購入金額を指定</span>
        budget = <span class="integer">50000</span>
        <span class="comment"># 戦略毎に処理</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
            <span class="comment"># 購入株式数を設定</span>
            df_portfolios[i].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>] = budget
            <span class="comment"># インデックスを日付のみにします</span>
            df_portfolios[i].reset_index(level=[<span class="integer">0</span>], inplace=<span class="predefined-constant">True</span>)
            <span class="comment"># 金曜日から月曜日日付に変更</span>
            df_portfolios[i].index = df_portfolios[i].index + pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)

        <span class="comment">####</span>
        <span class="comment"># 出力を調整します</span>
        <span class="comment">####</span>
        <span class="comment"># 戦略毎に処理</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
            <span class="comment"># インデックス名を設定</span>
            df_portfolios[i].index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>
            <span class="comment"># 出力するカラムを絞り込みます</span>
            df_portfolios[i] = df_portfolios[i].loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>]]

        <span class="comment"># 出力保存用</span>
        outputs = {}
        <span class="comment"># 戦略毎に処理</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> df_portfolios.keys():
            <span class="comment"># 出力します</span>
            out = io.StringIO()
            <span class="comment"># CSV形式で出力</span>
            df_portfolios[i].to_csv(out, header=<span class="predefined-constant">True</span>)
            <span class="comment"># 出力を保存</span>
            outputs[i] = out.getvalue()

        <span class="keyword">return</span> outputs[strategy_id]</code></pre>
</div>
</div>
<div class="paragraph">
<p>ファイルが書き込まれていることを確認します</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>! ls -l $package_dir/src/</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>total 3
-rw-r--r-- 1 root root 4450 Feb 27 09:40 predictor.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>　作成したクラスが適切に動くかを動作確認します。 上記で1行ずつ実行した場合と同一の出力であれば良いことになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 動作確認します</span>
str_ret = ScoringService.predict(inputs, start_dt=pd.Timestamp(<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 出力を確認</span>
print(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.join(str_ret.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)[:<span class="integer">10</span>]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力させます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>date,Local Code,budget
2020-01-06,4592,50000
2020-01-06,3254,50000
2020-01-06,6875,50000
2020-01-06,4571,50000
2020-01-06,7956,50000
2020-01-06,6049,50000
2020-01-06,7744,50000
2020-01-06,2395,50000
2020-01-06,3660,50000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 出力を保存</span>
<span class="keyword">with</span> <span class="predefined">open</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-01-class.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
    f.write(str_ret)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力が一致していることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">assert</span> outputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">reversal</span><span class="delimiter">&quot;</span></span>] == str_ret</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_提出用パッケージの作成と提出">3.8.3. 提出用パッケージの作成と提出</h4>
<div class="paragraph">
<p>　3.7.10で作成した <code>ScoringService</code> を <code>predictor.py</code> に書き込み、Zip形式で圧縮します。今回はシンプルな特徴量を使用してポートフォリオを作成しているため、学習済みのモデルファイルは存在しません。ただし、modelディレクトリは必須であるため、zipファイルには該当のディレクトリを含める必要があります。そのためには、modelファイルには何らかのダミーファイルを作成してzipファイルを作成すると良いでしょう。</p>
</div>
<div class="paragraph">
<p>以下、Zipファイル作成例になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ mkdir model src
$ touch model/dummy.txt
$ ls
model src
$ zip -v submit.zip src/predictor.py model/dummy.txt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 提出用パッケージ名</span>
package_file = <span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-model.zip</span><span class="delimiter">&quot;</span></span>
<span class="comment"># パッケージファイルパス</span>
package_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{working_dir}/{package_file}</span><span class="delimiter">&quot;</span></span>

<span class="comment"># zipファイルを作成</span>
<span class="keyword">with</span> zipfile.ZipFile(package_path, <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
    <span class="comment"># model/dummy.txtを追加</span>
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {package_dir}/model/dummy.txt to model/dummy.txt</span><span class="delimiter">&quot;</span></span>)
    f.write(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{package_dir}/model/dummy.txt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">model/dummy.txt</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># src/predictor.py を追加</span>
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {package_dir}/src/predictor.py to src/predictor.py</span><span class="delimiter">&quot;</span></span>)
    f.write(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{package_dir}/src/predictor.py</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">src/predictor.py</span><span class="delimiter">&quot;</span></span>)

print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] please check {package_path}</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　以上で投稿用のモデルパッケージは完成です。`chapter03-model.zip` ファイルをコンペティションページから投稿してリーダーボードに掲載されることを確認しましょう。</p>
</div>
<div class="paragraph">
<p>　リーダーボードに掲載されたことを確認したら、例えば、特徴量を変更してみたり、複数の特徴量それぞれから10銘柄ずつ選択するロジックを実装してみるのはどうでしょうか。いくつかの特徴量については「<a href="#anchor-2.7">2.7. 特徴量の生成</a>」で説明していますのでご参照ください。特に、「2.7.2. 定常性を意識した特徴量設計」は重要な概念ですのでご一読ください。</p>
</div>
<div class="paragraph">
<p>次章では、2章で作成した機械学習モデルを使用してポートフォリオを組成する方法について記載しています。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ファンダメンタルズ分析チャレンジで作成したモデルを使用してポートフォリオを構築しよう">4. 「ファンダメンタルズ分析チャレンジ」で作成したモデルを使用してポートフォリオを構築しよう</h2>
<div class="sectionbody">
<div class="paragraph">
<p>　4章では、2章の「ファンダメンタルズ分析チャレンジ」で作成したモデルを利用してポートフォリオを構築していきます。</p>
</div>
<div class="paragraph">
<p>　2章で作成した最高値・最安値予測モデルが、各銘柄の株価の最高値・最安値だけではなく先行きもある程度予測できていたとしたら、ポートフォリオの組成のためのスコアとして利用しても、ある程度の効果が期待できるかもしれません。特に最安値予測はある種の最大リスクの推定であるため、リスクが最も低い銘柄に投資するという戦略は十分に収益を産み出す可能性があります。</p>
</div>
<div class="paragraph">
<p>　3章ではリターン・リバーサル (逆張り) 戦略とトレンドフォロー (順張り) 戦略を採用し、その実装を行いましたが、3章は機械学習のアプローチというよりはむしろ、予測モデルを作成せずに戦略をそのまま実装しています。4章の狙いは予測モデルを利用したポートフォリオの組成方法を学ぶことです。本章は主に以下のステップで進めていきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>1. 環境設定
2. ライブラリのロード
3. データセットの読み込み
4. 2章で作成したモデルの配置
5. 2章のpredictor.pyの変更
  5.1 get_inputsの変更 (stock_fin_priceを読み込む)
  5.2 get_datasetの変更 (必要なデータのみ読み込む)
  5.3 get_codesの変更 (ユニバースの変更)
  5.4 get_features_for_predict の変更 (stock_fin_priceを使用する)
  5.5 predictの変更 (銘柄選択、出力を変更)
6. バックテストの実行
7. バックテストの評価
8. 適時開示情報を使用して特別損失銘柄を除外
9. パッケージの作成</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_環境設定">4.1. 環境設定</h3>
<div class="paragraph">
<p>　基本的に4章の環境設定方法は、3章に準拠しています。本章のnotebookは<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/Chapter04/20210224-chapter04-tutorial.ipynb">こちら</a>からダウンロードしてご利用ください。なお、2章のnotebookを実行した際に最後に保存されるモデルを配置したディレクトリを <code>ScoringService.get_model</code> のパラメーターとして設定する必要があります。本チュートリアルの2章をそのまま実行した際の学習済みのモデルは、<a href="https://signate.jp/competitions/443/data">こちら</a>からダウンロード可能です。</p>
</div>
<div class="paragraph">
<p>　Google Colaboratoryの環境で本チュートリアルを実行する場合、最初に以下のコードを実行して Google Colaboratory 上の notebook から Google Drive にアクセスできるようにしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Google Colab環境ではGoogle Driveをマウントしてアクセスできるようにします。</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    <span class="comment"># Google Drive をマウントします</span>
    <span class="keyword">from</span> <span class="include">google.colab</span> <span class="keyword">import</span> <span class="include">drive</span>
    mount_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/content/drive</span><span class="delimiter">&quot;</span></span>
    drive.mount(mount_dir)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_必要なライブラリの読み込み_2">4.2. 必要なライブラリの読み込み</h3>
<div class="paragraph">
<p>　ランタイム環境とGoogle Colaboratory環境の両者で共通のライブラリを使用するためにバージョンを調整します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="error">!</span>pip install --no-cache-<span class="predefined">dir</span> joblib==<span class="float">1.0</span><span class="float">.1</span> numpy==<span class="float">1.19</span><span class="float">.5</span> pandas==<span class="float">1.1</span><span class="float">.5</span> scikit-learn==<span class="float">0.20</span><span class="float">.3</span> scipy==<span class="float">1.2</span><span class="float">.1</span> seaborn==<span class="float">0.9</span><span class="float">.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　次に、以下のライブラリを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">io</span>
<span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">pickle</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">zipfile</span>

<span class="keyword">import</span> <span class="include">matplotlib</span>
<span class="keyword">import</span> <span class="include">matplotlib.pyplot</span> <span class="keyword">as</span> plt
<span class="keyword">import</span> <span class="include">numpy</span> <span class="keyword">as</span> np
<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd
<span class="keyword">import</span> <span class="include">seaborn</span> <span class="keyword">as</span> sns
<span class="keyword">from</span> <span class="include">scipy</span> <span class="keyword">import</span> <span class="include">stats</span>
<span class="keyword">from</span> <span class="include">sklearn.ensemble</span> <span class="keyword">import</span> <span class="include">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="include">tqdm.auto</span> <span class="keyword">import</span> <span class="include">tqdm</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　次に、本コンペティションの評価検証用のバックテストモジュールを読み込みます。バックテストモジュールの使用方法については「3.6. バックテスト環境の構築」をご参照ください。インポート時にエラーが出た場合は、sys.path に backtest.py ファイルを配置したディレクトリを追加してから再度インポートしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># インポート時にエラーが出た場合は、以下のmodule_dirをbacktest.pyを配置したディレクトリに変更してください。</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
  <span class="comment"># Backtestを配置したディレクトリへのフルパスを指定します</span>
  module_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter03/backtest</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
  <span class="comment"># Backtestを配置したディレクトリへのフルパスを指定します</span>
  module_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/Chapter03/backtest</span><span class="delimiter">&quot;</span></span>
sys.path.append(module_dir)

<span class="keyword">from</span> <span class="include">backtest</span> <span class="keyword">import</span> <span class="include">Backtest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　Pandasのデータを表示する際に省略されないように設定を変更します</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 表示用の設定を変更します</span>
%matplotlib inline
pd.options.display.max_rows = <span class="integer">100</span>
pd.options.display.max_columns = <span class="integer">100</span>
pd.options.display.width = <span class="integer">120</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセット及び2章のモデル準備">4.3. データセット及び2章のモデル準備</h3>
<div class="sect3">
<h4 id="_データセットの読み込み_3">4.3.1. データセットの読み込み</h4>
<div class="paragraph">
<p>　データセットを配置したディレクトリのパスを設定します。Google Colabをご使用の場合は Google Drive にデータセットをアップロードし、そのディレクトリを指定してください。なお、データセットの取得方法および内容については「3.4. データセットの説明」をご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データセットを配置したディレクトリのパスを設定</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    dataset_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
    dataset_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/data_dir_comp2</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　本コンペティションのランタイム環境におけるデータセットへのアクセスは、 <code>ScoringService.predict()</code> メソッドに渡されるinputsパラメーターを通して行う必要があります。そのため、以下のように本notebook環境でもランタイム環境と共通の方法でデータセットにアクセスすることで、コードが複雑になったり投稿用にコードを編集したりしなくても済むようにしています。なお、ランタイム環境では <code>purchase_date.csv</code> に評価対象週の初日の日付が指定されます。以下ではランタイム環境でも適切に動作するように <code>purchase_date.csv</code> の日付をポートフォリオの組成対象とするコードを記載します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 入力パラメーターを設定します。ランタイム環境での実行時と同一フォーマットにします</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># ニュースデータ</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/tdnet.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/disclosureItems.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">nikkei_article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/nikkei_article.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/article.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">industry</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/industry.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">industry2</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/industry2.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/region.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">theme</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/theme.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># 目的変数データ</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_labels.csv.gz</span><span class="delimiter">&quot;</span></span>,
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_2章で作成したモデルの配置">4.3.2. 2章で作成したモデルの配置</h4>
<div class="paragraph">
<p>　2章で作成したモデルである <code>my_label_high_20.pkl</code> と <code>my_label_low_20.pkl</code> をarchive/modelディレクトリに配置します。これらのモデルは<a href="https://signate.jp/competitions/443/data">こちら</a>からダウンロードすることができます。</p>
</div>
<div class="paragraph">
<p>　モデルを配置したディレクトリを変数に設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># モデル配置ディレクトリのパスを設定</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    model_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter04/archive/model</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
    model_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">archive/model</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>モデルが正しく配置されていることを以下のコードで確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">!ls -lh $model_dir/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2章で作成した_predictor_py_の変更">4.4. 2章で作成した <code>predictor.py</code> の変更</h3>
<div class="paragraph">
<p>　ここからは2章で作成した <code>predictor.py</code> をベースに変更していきます。なお、2章の <code>predictor.py</code> は<a href="https://raw.githubusercontent.com/JapanExchangeGroup/J-Quants-Tutorial/main/handson/Chapter02/archive/src/predictor.py">こちら</a>から取得可能です。</p>
</div>
<div class="paragraph">
<p>　ここでは、predictor.pyに以下の変更を実施します。ある程度規模の大きな変更となりますが、ポートフォリオを組成するために必要な変更です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>get_datasetの変更 (必要なデータのみ読み込む)</p>
</li>
<li>
<p>get_codesの変更 (ユニバースの変更)</p>
</li>
<li>
<p>get_features_for_predict の変更 (stock_fin_priceを使用する)</p>
</li>
<li>
<p>get_exclude の追加 (適時開示情報を使用した銘柄選択)</p>
</li>
<li>
<p>strategy の追加 (銘柄選択)</p>
</li>
<li>
<p>predict の変更 (銘柄選択、出力を変更)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_get_datasetの変更_必要なデータのみ読み込む">4.4.1. get_datasetの変更 (必要なデータのみ読み込む)</h4>
<div class="paragraph">
<p>　まずは、load_dataパラメータを追加して必要なファイルのみをロードするように変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_dataset</span>(cls, inputs, load_data):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            inputs (list[str]): path to dataset files</span><span class="content">
</span><span class="content">            load_data (list[str]): specify loading data</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            dict[pd.DataFrame]: loaded data</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="keyword">if</span> cls.dfs <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            cls.dfs = {}
        <span class="keyword">for</span> k, v <span class="keyword">in</span> inputs.items():
            <span class="comment"># 必要なデータのみ読み込みます</span>
            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> load_data:
                <span class="keyword">continue</span>
            cls.dfs[k] = pd.read_csv(v)
            <span class="comment"># DataFrameのindexを設定します。</span>
            <span class="keyword">if</span> k == <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>:
                cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
                    cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>]
                )
                cls.dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
            <span class="keyword">elif</span> k <span class="keyword">in</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>]:
                cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(
                    cls.dfs[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>]
                )
                cls.dfs[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
        <span class="keyword">return</span> cls.dfs</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_get_codesの変更_ユニバースの変更">4.4.2. get_codesの変更 (ユニバースの変更)</h4>
<div class="paragraph">
<p>　次に、ユニバースを取得するためにuniverse_comp2がTrueのコードを取得するように変更 (prediction_targetから変更)します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_codes</span>(cls, dfs):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict[pd.DataFrame]): loaded data</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            array: list of stock codes</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        stock_list = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>].copy()
        <span class="comment"># 予測対象の銘柄コードを取得</span>
        cls.codes = stock_list[stock_list[<span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>][
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
        ].values
        <span class="keyword">return</span> cls.codes</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_get_features_for_predict_の変更_stock_fin_priceを使用する">4.4.3. get_features_for_predict の変更 (stock_fin_priceを使用する)</h4>
<div class="paragraph">
<p>　stock_fin_priceを使用するように変更し、さらに本コンペでは週末である金曜日までのデータを利用して出力をだすため、3章でも行ったリサンプル・前方補完の処理を行った上で、金曜日のレコードのみを使用するように変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_features_for_predict2</span>(cls, dfs, code, fin_columns, start_dt=TEST_START):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            dfs (dict)  : dict of pd.DataFrame include stock_fin, stock_price</span><span class="content">
</span><span class="content">            code (int)  : A local code for a listed company</span><span class="content">
</span><span class="content">            fin_columns(list[str]): list of columns</span><span class="content">
</span><span class="content">            start_dt (str): specify date range</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            feature DataFrame (pd.DataFrame)</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="comment"># stock_fin_priceデータを読み込み</span>
        stock_fin_price = dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>]

        <span class="comment"># 特定の銘柄コードのデータに絞る</span>
        feats = stock_fin_price[stock_fin_price[<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>] == code]
        <span class="comment"># 2章で作成したモデルの特徴量では過去60営業日のデータを使用しているため、</span>
        <span class="comment"># 予測対象日からバッファ含めて土日を除く過去90日遡った時点から特徴量を生成します。</span>
        n = <span class="integer">90</span>
        <span class="comment"># 特徴量の生成対象期間を指定</span>
        feats = feats.loc[pd.Timestamp(start_dt) - pd.offsets.BDay(n) :]
        <span class="comment"># 指定されたカラムおよびExchangeOfficialCloseに絞り込み</span>
        feats = feats.loc[
            :, fin_columns + [<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]
        ].copy()
        <span class="comment"># 欠損値処理</span>
        feats = feats.fillna(<span class="integer">0</span>)

        <span class="comment"># 終値の20営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_1month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">20</span>)
        <span class="comment"># 終値の40営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_2month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">40</span>)
        <span class="comment"># 終値の60営業日リターン</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">return_3month</span><span class="delimiter">&quot;</span></span>] = feats[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>
        ].pct_change(<span class="integer">60</span>)
        <span class="comment"># 終値の20営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_1month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">20</span>)
            .std()
        )
        <span class="comment"># 終値の40営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_2month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">40</span>)
            .std()
        )
        <span class="comment"># 終値の60営業日ボラティリティ</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">volatility_3month</span><span class="delimiter">&quot;</span></span>] = (
            np.log(feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>])
            .diff()
            .rolling(<span class="integer">60</span>)
            .std()
        )
        <span class="comment"># 終値と20営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_1month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">20</span>).mean()
        )
        <span class="comment"># 終値と40営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_2month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">40</span>).mean()
        )
        <span class="comment"># 終値と60営業日の単純移動平均線の乖離</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">MA_gap_3month</span><span class="delimiter">&quot;</span></span>] = feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>] / (
            feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>].rolling(<span class="integer">60</span>).mean()
        )
        <span class="comment"># 欠損値処理</span>
        feats = feats.fillna(<span class="integer">0</span>)
        <span class="comment"># 元データのカラムを削除</span>
        feats = feats.drop([<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>], axis=<span class="integer">1</span>)

        <span class="comment"># 1B resample + ffill で金曜日に必ずレコードが存在するようにする</span>
        feats = feats.resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>).ffill()
        <span class="comment"># 特徴量を金曜日日付のみに絞り込む</span>
        FRIDAY = <span class="integer">4</span>
        feats = feats.loc[feats.index.dayofweek == FRIDAY]

        <span class="comment"># 欠損値処理を行います。</span>
        feats = feats.replace([np.inf, -np.inf], <span class="integer">0</span>)

        <span class="comment"># 銘柄コードを設定</span>
        feats[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = code

        <span class="comment"># 生成対象日以降の特徴量に絞る</span>
        feats = feats.loc[pd.Timestamp(start_dt) :]

        <span class="keyword">return</span> feats</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_get_exclude_の追加_適時開示情報を使用した銘柄選択">4.4.4. get_exclude の追加 (適時開示情報を使用した銘柄選択)</h4>
<div class="paragraph">
<p>本コンペティションでは適時開示情報がデータとして提供されています。適時開示情報には様々な種類があり disclosureItems.csv.gz の中には適時開示資料の公開項目コードが記載されています。公開項目のなかには株価に大きな影響を与えるものもあります。<br>
ここでは例として特別損失を開示した銘柄をその週およびその翌週にはポートフォリオに組み入れないことを試してみます。特別損失とは災害など企業の通常の業務外で発生した一過性の損失のことをいいます。市場が想定していなかった一過性の損失が発表された場合、その銘柄の株価は下がるため除外することで損失を回避できるとの仮説を設定しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get_exclude</span>(
        cls,
        df_tdnet,  <span class="comment"># tdnetのデータ</span>
        start_dt=<span class="predefined-constant">None</span>,  <span class="comment"># データ取得対象の開始日、Noneの場合は制限なし</span>
        end_dt=<span class="predefined-constant">None</span>,  <span class="comment"># データ取得対象の終了日、Noneの場合は制限なし</span>
        lookback=<span class="integer">7</span>,  <span class="comment"># 除外考慮期間 (days)</span>
        target_day_of_week=<span class="integer">4</span>,  <span class="comment"># 起点となる曜日</span>
    ):
        <span class="comment"># 特別損失のレコードを取得</span>
        special_loss = df_tdnet[df_tdnet[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="content">201&quot;</span><span class="delimiter">'</span></span>)].copy()
        <span class="comment"># 日付型を調整</span>
        special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] = pd.to_datetime(special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosedDate</span><span class="delimiter">&quot;</span></span>])
        <span class="comment"># 処理対象開始日が設定されていない場合はデータの最初の日付を取得</span>
        <span class="keyword">if</span> start_dt <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            start_dt = special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>].iloc[<span class="integer">0</span>]
        <span class="comment"># 処理対象終了日が設定されていない場合はデータの最後の日付を取得</span>
        <span class="keyword">if</span> end_dt <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            end_dt = special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>].iloc[-<span class="integer">1</span>]
        <span class="comment">#  処理対象日で絞り込み</span>
        special_loss = special_loss[
            (start_dt &lt;= special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>]) &amp; (special_loss[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] &lt;= end_dt)
        ]
        <span class="comment"># 出力用にカラムを調整</span>
        res = special_loss[[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosedDate</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>]].copy()
        <span class="comment"># 銘柄コードを4桁にする</span>
        res[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = res[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].astype(<span class="predefined">str</span>).str[:-<span class="integer">1</span>]
        <span class="comment"># 予測の基準となる金曜日の日付にするために調整</span>
        res[<span class="string"><span class="delimiter">&quot;</span><span class="content">remain</span><span class="delimiter">&quot;</span></span>] = (target_day_of_week - res[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>].dt.dayofweek) % <span class="integer">7</span>
        res[<span class="string"><span class="delimiter">&quot;</span><span class="content">start_dt</span><span class="delimiter">&quot;</span></span>] = res[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] + pd.to_timedelta(res[<span class="string"><span class="delimiter">&quot;</span><span class="content">remain</span><span class="delimiter">&quot;</span></span>], unit=<span class="string"><span class="delimiter">&quot;</span><span class="content">d</span><span class="delimiter">&quot;</span></span>)
        res[<span class="string"><span class="delimiter">&quot;</span><span class="content">end_dt</span><span class="delimiter">&quot;</span></span>] = res[<span class="string"><span class="delimiter">&quot;</span><span class="content">start_dt</span><span class="delimiter">&quot;</span></span>] + pd.Timedelta(days=lookback)
        columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">start_dt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">end_dt</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">return</span> res[columns].reset_index(drop=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_strategy_の追加_銘柄選択">4.4.5. strategy の追加 (銘柄選択)</h4>
<div class="paragraph">
<p>　銘柄の選択には2章で作成した最高値・最安値モデルで予測したpred列（最高値・最安値への変化率）の値が大きい（最安値モデルの場合は小さい）上位25銘柄を採用しています。そのため、以下のようにstrategyメソッドでpred列を作成する方法により選択される銘柄を調整しています。</p>
</div>
<div class="paragraph">
<p>　ここでは、以下の6種類の銘柄選択方法を実装します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>最高値モデル出力に最安値モデル出力を足して使用</p>
</li>
<li>
<p>最高値モデルの出力を使用</p>
</li>
<li>
<p>最安値モデルの出力を使用</p>
</li>
<li>
<p>最高値モデル出力に最安値モデル出力を足して使用し、特別損失について開示された銘柄を除外</p>
</li>
<li>
<p>最高値モデルの出力を使用し、特別損失について開示された銘柄銘柄を除外</p>
</li>
<li>
<p>最安値モデルの出力を使用し、特別損失について開示された銘柄を除外</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　最高値モデルは潜在的な収益性を、最安値モデルは潜在的なリスクを推定していると想定した場合、1はシンプルにそれを足し合わせることで潜在的なリスクを抑えつつ、高い収益性を持つ銘柄を探しています。もし最高値・最安値の予測が上手く働いていたら、この方法が大きな収益を達成できるはずです。2は最大の収益性を持つ銘柄、3は最もリスクが低い銘柄が採用されると想定され、それぞれのモデルの収益性を確認することができます。</p>
</div>
<div class="paragraph">
<p>　4,5,6は1,2,3のそれぞれの戦略から特別損失を開示した銘柄をポートフォリオの組成対象から除外することで、特別損失開示による株価の下落を回避しポートフォリオの利益を向上できるとの仮説を検証しています。後ほど、これらの仮説の検証を簡単なバックテストを通して実施します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">strategy</span>(cls, strategy_id, df, df_tdnet):
        df = df.copy()
        <span class="comment"># 銘柄選択方法選択</span>
        <span class="keyword">if</span> strategy_id <span class="keyword">in</span> [<span class="integer">1</span>, <span class="integer">4</span>]:
            <span class="comment"># 最高値モデル +　最安値モデル</span>
            df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">pred</span><span class="delimiter">&quot;</span></span>] = df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>] + df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">elif</span> strategy_id <span class="keyword">in</span> [<span class="integer">2</span>, <span class="integer">5</span>]:
            <span class="comment"># 最高値モデル</span>
            df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">pred</span><span class="delimiter">&quot;</span></span>] = df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">elif</span> strategy_id <span class="keyword">in</span> [<span class="integer">3</span>, <span class="integer">6</span>]:
            <span class="comment"># 最高値モデル</span>
            df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">pred</span><span class="delimiter">&quot;</span></span>] = df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">else</span>:
            <span class="keyword">raise</span> <span class="exception">ValueError</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">no strategy_id selected</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># 特別損失を除外する場合</span>
        <span class="keyword">if</span> strategy_id <span class="keyword">in</span> [<span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>]:
            <span class="comment"># 特別損失が発生した銘柄一覧を取得</span>
            df_exclude = cls.get_exclude(df_tdnet)
            <span class="comment"># 除外用にユニークな列を作成します。</span>
            df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_lastweek</span><span class="delimiter">&quot;</span></span>] = df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">start_dt</span><span class="delimiter">&quot;</span></span>].dt.strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d-</span><span class="delimiter">&quot;</span></span>) + df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]
            df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_thisweek</span><span class="delimiter">&quot;</span></span>] = df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">end_dt</span><span class="delimiter">&quot;</span></span>].dt.strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d-</span><span class="delimiter">&quot;</span></span>) + df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]
            df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_lastweek</span><span class="delimiter">&quot;</span></span>] = (df.index - pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">7D</span><span class="delimiter">&quot;</span></span>)).strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d-</span><span class="delimiter">&quot;</span></span>) + df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].astype(<span class="predefined">str</span>)
            df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_thisweek</span><span class="delimiter">&quot;</span></span>] = df.index.strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Y-%m-%d-</span><span class="delimiter">&quot;</span></span>) + df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>].astype(<span class="predefined">str</span>)
            <span class="comment"># 特別損失銘柄を除外</span>
            df = df.loc[~df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_lastweek</span><span class="delimiter">&quot;</span></span>].isin(df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_lastweek</span><span class="delimiter">&quot;</span></span>])]
            df = df.loc[~df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_thisweek</span><span class="delimiter">&quot;</span></span>].isin(df_exclude.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">date-code_thisweek</span><span class="delimiter">&quot;</span></span>])]

        <span class="comment"># 予測出力を降順に並び替え</span>
        df = df.sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">pred</span><span class="delimiter">&quot;</span></span>, ascending=<span class="predefined-constant">False</span>)
        <span class="comment"># 予測出力の大きいものを取得</span>
        df = df.groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>).head(<span class="integer">30</span>)

        <span class="keyword">return</span> df</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_predictの変更_銘柄選択出力を変更">4.4.6. predictの変更 (銘柄選択、出力を変更)</h4>
<div class="paragraph">
<p>以下では、 <code>predictor.py</code> の <code>predict</code> メソッド出力についてポートフォリオを出力するように変更し、予測出力から銘柄を選択するロジックを追加しています。ランタイム環境では <code>purchase_date</code> で指定された日付のポートフォリオを作成するように変更しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">predict</span>(
        cls,
        inputs,
        labels=<span class="predefined-constant">None</span>,
        codes=<span class="predefined-constant">None</span>,
        start_dt=TEST_START,
        load_data=[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>],
        fin_columns=<span class="predefined-constant">None</span>,
        strategy_id=<span class="integer">1</span>,
    ):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">Predict method</span><span class="content">
</span><span class="content">
</span><span class="content">        Args:</span><span class="content">
</span><span class="content">            inputs (dict[str]): paths to the dataset files</span><span class="content">
</span><span class="content">            labels (list[str]): target label names</span><span class="content">
</span><span class="content">            codes (list[int]): traget codes</span><span class="content">
</span><span class="content">            start_dt (str): specify date range</span><span class="content">
</span><span class="content">            load_data (list[str]): specify loading data</span><span class="content">
</span><span class="content">            fin_columns (list[str]): specify feature columns</span><span class="content">
</span><span class="content">            strategy_id (int): specify strategy</span><span class="content">
</span><span class="content">        Returns:</span><span class="content">
</span><span class="content">            str: Inference for the given input.</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        <span class="keyword">if</span> fin_columns <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            fin_columns = [
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement FiscalYear</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OrdinaryIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement TotalAssets</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetAssets</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromOperatingActivities</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromFinancingActivities</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromInvestingActivities</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_FinancialStatement FiscalYear</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_FinancialStatement OrdinaryIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_Dividend FiscalYear</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_Dividend QuarterlyDividendPerShare</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Result_Dividend AnnualDividendPerShare</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_Dividend FiscalYear</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_Dividend QuarterlyDividendPerShare</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Forecast_Dividend AnnualDividendPerShare</span><span class="delimiter">&quot;</span></span>,
            ]

        <span class="comment"># データ読み込み</span>
        <span class="keyword">if</span> cls.dfs <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] load data</span><span class="delimiter">&quot;</span></span>)
            cls.get_dataset(inputs, load_data)
            cls.get_codes(cls.dfs)

        <span class="comment"># 予測対象の銘柄コードと目的変数を設定</span>
        <span class="keyword">if</span> codes <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            codes = cls.codes
        <span class="keyword">if</span> labels <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            labels = cls.TARGET_LABELS

        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> inputs.keys():
            <span class="comment"># ランタイム環境では指定された投資対象日付を使用します</span>
            <span class="comment"># purchase_dateを読み込み</span>
            df_purchase_date = pd.read_csv(inputs[<span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span>])
            <span class="comment"># purchase_dateの最も古い日付を設定</span>
            start_dt = pd.Timestamp(
                df_purchase_date.sort_values(<span class="string"><span class="delimiter">&quot;</span><span class="content">Purchase Date</span><span class="delimiter">&quot;</span></span>).iloc[<span class="integer">0</span>, <span class="integer">0</span>]
            )

        <span class="comment"># 予測対象日を調整</span>
        <span class="comment"># start_dtにはポートフォリオの購入日を指定しているため、</span>
        <span class="comment"># 予測に使用する前週の金曜日を指定します。</span>
        start_dt = pd.Timestamp(start_dt) - pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># 特徴量を作成</span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] generate feature</span><span class="delimiter">&quot;</span></span>)
        buff = []
        <span class="keyword">for</span> code <span class="keyword">in</span> tqdm(codes):
            buff.append(
                cls.get_features_for_predict2(cls.dfs, code, fin_columns, start_dt)
            )
        feats = pd.concat(buff)

        <span class="comment"># 結果を以下のcsv形式で出力する</span>
        <span class="comment"># 1列目:date</span>
        <span class="comment"># 2列目:Local Code</span>
        <span class="comment"># 3列目:budget</span>
        <span class="comment"># headerあり、2列目3列目はint64</span>

        <span class="comment"># 日付と銘柄コードに絞り込み</span>
        df = feats.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>]].copy()
        <span class="comment"># 購入金額を設定 (ここでは一律50000とする)</span>
        df.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>] = <span class="integer">50000</span>

        <span class="comment"># 特徴量カラムを指定</span>
        feature_columns = ScoringService.get_feature_columns(cls.dfs, feats)

        <span class="comment"># 目的変数毎に予測</span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] predict</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">for</span> label <span class="keyword">in</span> tqdm(labels):
            <span class="comment"># 予測実施</span>
            df[label] = ScoringService.models[label].predict(feats[feature_columns])
            <span class="comment"># 出力対象列に追加</span>

        <span class="comment"># 銘柄選択方法選択</span>
        df = cls.strategy(strategy_id, df, cls.dfs[<span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>])

        <span class="comment"># 日付順に並び替え</span>
        df.sort_index(kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">mergesort</span><span class="delimiter">&quot;</span></span>, inplace=<span class="predefined-constant">True</span>)
        <span class="comment"># 月曜日日付に変更</span>
        df.index = df.index + pd.Timedelta(<span class="string"><span class="delimiter">&quot;</span><span class="content">3D</span><span class="delimiter">&quot;</span></span>)
        <span class="comment"># 出力用に調整</span>
        df.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>
        df.rename(columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>}, inplace=<span class="predefined-constant">True</span>)
        df.reset_index(inplace=<span class="predefined-constant">True</span>)

        <span class="comment"># 出力対象列を定義</span>
        output_columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">budget</span><span class="delimiter">&quot;</span></span>]

        out = io.StringIO()
        df.to_csv(out, header=<span class="predefined-constant">True</span>, index=<span class="predefined-constant">False</span>, columns=output_columns)

        <span class="keyword">return</span> out.getvalue()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_予測の実行">4.4.7. 予測の実行</h4>
<div class="paragraph">
<p>　ここまででソースコードの変更が完了したら、いよいよモデルを実行します。まず、対象期間を設定します。2020-01-01を指定していますが、予測の出力される日はここまでの実装により月曜日の日付のみになるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 対象期間を設定</span>
start_dt = pd.Timestamp(<span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># 学習済みモデルを読み込みます</span>
ScoringService.get_model(<span class="string"><span class="delimiter">&quot;</span><span class="content">archive/model</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># 予測を実行します</span>
str_ret = ScoringService.predict(inputs, start_dt=start_dt, strategy_id=<span class="integer">1</span>)

<span class="comment"># 出力を確認</span>
print(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.join(str_ret.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)[:<span class="integer">10</span>]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力を確認すると、月曜日の日付である2020-01-06で出力されていることがわかります。またbudgetが一律50000円となっていることも確認できまます。想定通りの結果です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>date,Local Code,budget
2020-01-06,4482,50000
2020-01-06,7679,50000
2020-01-06,2980,50000
2020-01-06,3966,50000
2020-01-06,4479,50000
2020-01-06,6049,50000
2020-01-06,4369,50000
2020-01-06,4488,50000
2020-01-06,3793,50000</code></pre>
</div>
</div>
<div class="paragraph">
<p>次で実施するバックテストのために結果をCSVファイルに保存しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 出力を保存</span>
<span class="keyword">with</span> <span class="predefined">open</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-1.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
    f.write(str_ret)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_バックテスト">4.5. バックテスト</h3>
<div class="sect3">
<h4 id="_バックテストの実行_2">4.5.1. バックテストの実行</h4>
<div class="paragraph">
<p>　本コンペティションの Public LB および Private LB と同等の評価ロジックを実装したバックテスト用の <code>backtest.py</code> ファイルを使用して、作成したポートフォリオを評価します。バックテストの使用法などの詳細は「3.6. バックテスト」をご参照ください。</p>
</div>
<div class="paragraph">
<p>　初めにバックテストを使用する際に必要なデータを準備します。バックテストの実行には以下の3つのデータが必要になります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ユニバース (stock_list.csv.gz)</p>
</li>
<li>
<p>株価 (stock_price.csv.gz)</p>
</li>
<li>
<p>テスト対象のポートフォリオ</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　Backtest.prepare_data に1および2のデータを保存しているディレクトリへのパスを指定して、必要なデータをロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># データを保存しているディレクトリを指定します。</span>
backtest_dataset_dir = dataset_dir
<span class="comment"># バックテストに必要なデータを読み込みます。</span>
backtest_codes, backtest_price = Backtest.prepare_data(backtest_dataset_dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　Backtest.load_submit にバックテスト対象のポートフォリオを保存したファイルへのパスを指定して読み込みます。`load_submit` ではデータを読み込み時にフォーマットのチェックをしたり、レコード順を付与する等、バックテスト実行のための前処理を実施しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 先ほど出力したポートフィリオデータを読み込みます</span>
df_submit = Backtest.load_submit(<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-1.csv</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　3つのデータを指定してバックテストを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># バックテスト結果保存用</span>
results = {}
stocks = {}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">results[<span class="integer">1</span>], stocks[<span class="integer">1</span>] = Backtest.run(df_submit.loc[start_dt:], backtest_codes, backtest_price)</code></pre>
</div>
</div>
<div class="paragraph">
<p>結果を確認します。うまく結果が取得できていることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># バックテスト結果のサマリー</span>
results[<span class="integer">1</span>].head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf.png" alt="処理結果" width="100%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 銘柄毎の情報</span>
stocks[<span class="integer">1</span>].head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf1.png" alt="処理結果" width="80%">
</div>
</div>
<div class="paragraph">
<p>　次に、銘柄選択の方法を変えてポートフォリオを組成します。1はすでに取得できていますので2、3も取得します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>最高値モデル出力に最安値モデル出力を足して使用</p>
</li>
<li>
<p>最高値モデルの出力を使用</p>
</li>
<li>
<p>最安値モデルの出力を使用</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> strategy_id <span class="keyword">in</span> tqdm([<span class="integer">2</span>, <span class="integer">3</span>]):
    <span class="comment"># ポートフォリオ組成</span>
    str_ret = ScoringService.predict(inputs, start_dt=start_dt, strategy_id=strategy_id)
    <span class="comment"># ポートフォリオを保存</span>
    <span class="keyword">with</span> <span class="predefined">open</span>(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-{strategy_id}.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
        f.write(str_ret)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> strategy_id <span class="keyword">in</span> tqdm([<span class="integer">2</span>, <span class="integer">3</span>]):
    <span class="comment"># ポートフォリオを読み込み</span>
    df_submit = Backtest.load_submit(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-{strategy_id}.csv</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># バックテスト実行</span>
    results[strategy_id], stocks[strategy_id] = Backtest.run(df_submit.loc[start_dt:], backtest_codes, backtest_price)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_バックテストの評価_2">4.5.2. バックテストの評価</h4>
<div class="paragraph">
<p>　上記のバックテストを実行して取得した、週毎のリターン情報と各銘柄毎の購入結果数の情報を評価します。各項目の定義については「3.6.4. バックテストの評価軸と取引戦略」をご参照ください。</p>
</div>
<div class="paragraph">
<p>以下では、結果の評価として以下を実施します。</p>
</div>
<div class="sect4">
<h5 id="_週毎のリターンデータ">週毎のリターンデータ</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>週毎の運用実績の分布をプロット (本コンペティションの評価項目)</p>
</li>
<li>
<p>週毎の運用実績の統計量</p>
</li>
<li>
<p>週毎の勝率・ペイオフレシオ・シャープレシオ</p>
</li>
<li>
<p>週毎に曜日別のリターンをプロット</p>
</li>
<li>
<p>週毎のリターンの累積プロット</p>
</li>
<li>
<p>ユニバースとの散布図</p>
</li>
<li>
<p>ユニバースに対するベータを計算</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_各銘柄毎のデータ">各銘柄毎のデータ</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>銘柄毎の運用実績の分布をプロット</p>
</li>
<li>
<p>銘柄毎のreturnの分布をプロット</p>
</li>
<li>
<p>週毎の勝ち銘柄率をプロット</p>
</li>
<li>
<p>週毎の勝ち銘柄率の統計量</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_週毎の運用実績の分布をプロット">週毎の運用実績の分布をプロット</h5>
<div class="paragraph">
<p>　まず、週毎の運用実績の分布をヒストグラムで確認します。ここから先の解析は、「1.最高値モデル出力に最安値モデル出力を足して使用」、「2.最高値モデルの出力を使用」、「3.最安値モデルの出力を使用」の3種類を解析しており、特別損失銘柄を除外したポートフォリオ（4〜6）の解析は最後に実施します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="predefined">len</span>(results), figsize=(<span class="integer">8</span> * <span class="predefined">len</span>(results), <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(results.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># 分布をプロット</span>
    results[k].week_pl.hist(bins=<span class="integer">25</span>, ax=ax)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week pl distribution</span><span class="delimiter">&quot;</span></span>)
<span class="comment">#　描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf2.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　1及び2の戦略は似たような分布をしていることが確認できます。最安値モデルを利用している3は、1や2とは大きく分布が異なっており、分布が狭く運用実績が0近辺に集中していることがわかります。すなわち、3の戦略では、ボラティリティが低い銘柄を中心に採用している可能性があります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_週毎の運用実績の統計量を算出">週毎の運用実績の統計量を算出</h5>
<div class="paragraph">
<p>　次に、週毎の運用実績の統計量を算出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># week_plの分布の統計量</span>

<span class="comment"># 結合用データ保存</span>
buff = []
<span class="comment"># ストラテジー毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># week_plの統計量を取得します。</span>
    df = results[k].loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>]].describe().T
    <span class="comment"># インデックスを編集してストラテジーのIDにする</span>
    df.index = [k]
    <span class="comment"># インデックス名変更</span>
    df.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 結合用に保存</span>
    buff.append(df)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf3.png" alt="処理結果" width="80%"">
</div>
</div>
<div class="paragraph">
<p>　分布情報を数値で確認すると、先程と同様に1及び2の分布情報が似ていることが確認できます。異なる点として25%分位点を比較すると、1の戦略は2の戦略よりも負けを若干抑えることができている可能性が示唆されます。2の戦略では、1の戦略よりも平均が大きくなっています。結果として、1の戦略は2の戦略よりも収益性は劣るものの、リスクコントロールができている可能性が示唆されています。また、3の戦略の結果は平均が1及び2の戦略より低く、25%及び75%分位点も1及び2の戦略よりも狭い分布となっていることがわかります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_週毎の勝率ペイオフレシオシャープレシオを算出">週毎の勝率、ペイオフレシオ、シャープレシオを算出</h5>
<div class="paragraph">
<p>　他のメトリクスも確認していきましょう。週毎の勝率、ペイオフレシオ、シャープレシオを算出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結合用データ保存</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    df_return = results[k]
    <span class="comment"># 計算結果保存用</span>
    d = {}
    <span class="comment"># 件数</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>] = df_return.shape[<span class="integer">0</span>]
    <span class="comment"># 勝率</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">win_ratio</span><span class="delimiter">&quot;</span></span>] = (
        df_return.loc[df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &gt; <span class="integer">0</span>].shape[<span class="integer">0</span>] / d[<span class="string"><span class="delimiter">&quot;</span><span class="content">count</span><span class="delimiter">&quot;</span></span>]
    )
    <span class="comment"># ペイオフレシオ</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">payoff_ratio</span><span class="delimiter">&quot;</span></span>] = df_return.loc[
        df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &gt; <span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>
    ].mean() / (
        -<span class="integer">1</span> * df_return.loc[df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>] &lt;= <span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].mean()
    )
    <span class="comment"># シャープレシオ</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">sharp</span><span class="delimiter">&quot;</span></span>] = (
        df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].mean() / df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>].std()
    )
    <span class="comment"># 平均PL</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">avgPL</span><span class="delimiter">&quot;</span></span>] = df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>].mean()
    <span class="comment"># week_plの合計</span>
    d[<span class="string"><span class="delimiter">&quot;</span><span class="content">PL</span><span class="delimiter">&quot;</span></span>] = df_return.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_pl</span><span class="delimiter">&quot;</span></span>].sum()
    <span class="comment"># strategy_idを設定</span>
    df = pd.DataFrame([d], index=[k])
    <span class="comment"># インデックス名を指定</span>
    df.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">strategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 結合用に保存</span>
    buff.append(df)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf4.png" alt="処理結果" width="80%">
</div>
</div>
<div class="paragraph">
<p>　1及び2の戦略の結果はこちらでも似通っています。3の戦略は勝率も低く、運用実績も低いため、今のところ最安値を単体で利用する手法が機能しているようには見えません。</p>
</div>
</div>
<div class="sect4">
<h5 id="_週毎に曜日別のリターンをプロット">週毎に曜日別のリターンをプロット</h5>
<div class="paragraph">
<p>　週毎の1日目から5日目までのリターンの推移をプロットし、曜日毎に勝ち負けの分布に差異が無いかを確認しています。3章と同じようにseabornのバイオリンプロット(<a href="https://seaborn.pydata.org/generated/seaborn.violinplot.html">リンク</a>)を利用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="predefined">len</span>(results), <span class="integer">1</span>, figsize=(<span class="integer">15</span>, <span class="integer">4</span> * <span class="predefined">len</span>(results)), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(results.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># 箱が見やすいように横方向を指定してプロット</span>
    sns.violinplot(x=<span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>, y=<span class="string"><span class="delimiter">&quot;</span><span class="content">level_1</span><span class="delimiter">&quot;</span></span>, data=dfs_plot[k], ax=ax, orient=<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: daily return</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># グリッドを表示</span>
    ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 文字が重なって読みにくいので間隔調整</span>
fig.tight_layout(pad=<span class="float">2.0</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf6.png" alt="処理結果" width="80%">
</div>
</div>
<div class="paragraph">
<p>　この結果から1及び2の戦略は、木曜日・金曜日の負けが大きそうなことがわかります。予測モデルを利用する場合、週の後半に負けているのはその予測モデルの効果が後半で薄れている可能性を示唆していることもあるので注意が必要です。このグラフにも若干その傾向が観測されるため、何らかの改善を実施した場合に、この結果がどうなっているかを確認する価値があります。3の戦略は1及び2の戦略と比較すると分布が狭いことが確認できます。</p>
</div>
</div>
<div class="sect4">
<h5 id="_収益率の時系列を累積プロット">収益率の時系列を累積プロット</h5>
<div class="paragraph">
<p>　次に、取得した収益率の時系列を累積プロットします。まず、比較対象であるベンチマークとして取引対象の全銘柄の平均週次リターンを計算します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 変数名を調整します。</span>
<span class="comment"># backtest_priceはユニバースで絞り込み済みです</span>
df_price = backtest_price</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 週毎に始値と終値を取得</span>
df_wp = (
    <span class="comment"># start_dt以降の日付のみ計算</span>
    df_price.loc[df_price.index &gt;= start_dt].sort_values([<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># 銘柄コード毎に処理</span>
    .groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># 月曜日スタートで週にリサンプル</span>
    .resample(<span class="string"><span class="delimiter">&quot;</span><span class="content">W-MON</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>, closed=<span class="string"><span class="delimiter">&quot;</span><span class="content">left</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># 始値は最初のレコード、終値は最後のレコードを取得</span>
    .agg({<span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">first</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">last</span><span class="delimiter">&quot;</span></span>})
    <span class="comment"># マルチインデックスを解除</span>
    .reset_index(level=[<span class="integer">0</span>])
)
<span class="comment"># Open が 0.0 の銘柄は値段が付かなかった銘柄で、バックテストでは購入対象外であるため除外する</span>
df_wp = df_wp.loc[df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>] != <span class="float">0.0</span>]
<span class="comment"># 銘柄毎の週次リターンを計算</span>
df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>] = (
    (
        (
            df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]
            / df_wp.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>]
        )
        - <span class="integer">1</span>
    )
    * <span class="integer">100</span>
)
<span class="comment"># ユニバースの週毎のリターンを計算します。</span>
df_universe_return = df_wp.groupby(df_wp.index)[<span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>].mean().to_frame()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ベンチマークとして取引対象の全銘柄の平均週次リターンが準備できたら、今回の取引戦略の結果と一緒にプロットしてみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># 描画位置を指定</span>
    ax = axes
    <span class="comment"># 戦略別の累積リターンを描画</span>
    results[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>).loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>]].rename(
        columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week_return</span><span class="delimiter">&quot;</span></span>}
    ).cumsum().plot(ax=ax)

<span class="comment"># ユニバースの週次リターンの累積をプロット</span>
df_universe_return.cumsum().plot(ax=ax, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># 表示を調整</span>
ax.set_title(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cumulative week_return</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># グリッドを表示</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf7.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　このプロットからは複数の事がわかります。まず1及び2の戦略は想定通り、極めて似通った結果となっています。1の戦略は最安値モデルの結果も足しているため、2の最高値モデルのみを用いたポートフォリオよりもドローダウンが小さいことを期待していましたが、3月の暴落時の結果を見る限り、その効果は観測されていません。これは、3の最安値モデルでも暴落時に下落低減効果が観測できないため、3の戦略では残念ながら3月の暴落の対処にはならなかったようです。</p>
</div>
<div class="paragraph">
<p>　1及び2の戦略は3月以降の反発で大きく収益を上げています。特にユニバースがほぼフラットになった6月以降も1及び2の戦略は高い収益をあげており、マーケットがフラットな状況でも銘柄選択により収益を上げる力がある可能性が示唆されます。</p>
</div>
<div class="paragraph">
<p>　また、3の戦略は一見するとユニバースとほぼ同じ収益に見えますが、3月以降ほぼドローダウンが発生しないことは注目に値します。これは低いボラティリティの銘柄を優先的に採用したときなどに見られる現象で、実際に収益曲線が安定していることからも、3の戦略自体もアンサンブルなどのデータとしては有望な可能性があります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_ユニバースとリターンの散布図をプロット">ユニバースとリターンの散布図をプロット</h5>
<div class="paragraph">
<p>　ユニバースとリターンの散布図をチェックします。ユニバースとリターンの散布図は、マーケットの動きに対してポートフォリオの運用実績がどのように分布するかを確認するために利用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># 散布図をプロット</span>
    p = sns.jointplot(
        x=df_universe_return.iloc[:, <span class="integer">0</span>],
        y=results[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>],
        kind=<span class="string"><span class="delimiter">&quot;</span><span class="content">reg</span><span class="delimiter">&quot;</span></span>,
        height=<span class="integer">5</span>,
        stat_func=stats.pearsonr,
    )
    <span class="comment"># タイトルを設定</span>
    p.fig.suptitle(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week_return vs universe</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># タイトル表示用に位置を調整</span>
    p.fig.subplots_adjust(top=<span class="float">0.95</span>)
    <span class="comment"># 描画</span>
    plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf8.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　1の戦略からはユニバースが0のときも収益を上げる力がある傾向が観測できます。2の戦略の分布は1よりも広く、これは高いボラティリティの銘柄を利用している可能性が示唆されます。3の戦略はユニバースの下落のときは一緒に負けていることが観測できます。もしユニバースが下落しても、下落を抑えることができていれば、3の戦略はリスク回避用のモデルとして理想的な結果でしたが、そのような効果までは観測できませんでした。</p>
</div>
</div>
<div class="sect4">
<h5 id="_ベータ値の算出">ベータ値の算出</h5>
<div class="paragraph">
<p>　最後にベータを計算しましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 結合用に保存</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># ベータを計算</span>
    res = stats.linregress(df_universe_return.iloc[:,<span class="integer">0</span>], results[k].loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># 一覧表示用にデータフレームを作成</span>
    df_beta = pd.DataFrame([res.slope], index=[k], columns=[<span class="string"><span class="delimiter">&quot;</span><span class="content">beta</span><span class="delimiter">&quot;</span></span>])
    <span class="comment"># インデックス名を設定</span>
    df_beta.index.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">storategy_id</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 保存</span>
    buff.append(df_beta)
<span class="comment"># 結合して表示</span>
pd.concat(buff)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf11.png" alt="処理結果" width="20%">
</div>
</div>
<div class="paragraph">
<p>　1及び2の戦略は、1.2近辺の高ベータなストラテジーであることがわかります。3の戦略は低いボラティリティの銘柄をポートフォリオに採用するストラテジー特有の傾向である低いベータ値が観測できています。</p>
</div>
</div>
<div class="sect4">
<h5 id="_銘柄毎に分析するための準備_2">銘柄毎に分析するための準備</h5>
<div class="paragraph">
<p>　次に、銘柄毎のデータを使用して分析します。ここでは、銘柄毎のデータを使用して分析するために必要な計算を実施しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 分析用データ保存用</span>
dfs_analyze = {}
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i <span class="keyword">in</span> stocks.keys():
    <span class="comment"># 分析用にデータをコピー</span>
    df_analyze = stocks[i].copy()
    <span class="comment"># day5に必ず値が存在するように調整します</span>
    df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">day_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]] = (
        df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">day_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]]
        .replace(<span class="float">0.0</span>, np.nan)
        .ffill(axis=<span class="integer">1</span>)
    )
    <span class="comment"># 終値とエントリーの差分を計算</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">diff</span><span class="delimiter">&quot;</span></span>] = df_analyze.loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">entry</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>]].diff(axis=<span class="integer">1</span>)[
        <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>
    ]
    <span class="comment"># 損益を計算します</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">pl</span><span class="delimiter">&quot;</span></span>] = df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">diff</span><span class="delimiter">&quot;</span></span>] * df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">actual</span><span class="delimiter">&quot;</span></span>]
    <span class="comment"># リターンを計算します</span>
    df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>] = (
        (df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">day_5</span><span class="delimiter">&quot;</span></span>] / df_analyze.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">entry</span><span class="delimiter">&quot;</span></span>]) - <span class="integer">1</span>
    ) * <span class="integer">100</span>
    <span class="comment"># infを0.0に変換</span>
    df_analyze = df_analyze.replace(np.inf, <span class="float">0.0</span>)
    <span class="comment"># 処理結果を保存</span>
    dfs_analyze[i] = df_analyze</code></pre>
</div>
</div>
<div class="paragraph">
<p>　分析用データを表示して、うまく計算ができているかを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">dfs_analyze[<span class="integer">1</span>].head(<span class="integer">2</span>)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf12.png" alt="処理結果" width="80%">
</div>
</div>
<div class="paragraph">
<p>　問題なく計算ができているようです。</p>
</div>
</div>
<div class="sect4">
<h5 id="_銘柄毎のリターンの分布をヒストグラムでプロット">銘柄毎のリターンの分布をヒストグラムでプロット</h5>
<div class="paragraph">
<p>　銘柄ごとのリターンの分布をヒストグラムでプロットします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="predefined">len</span>(dfs_analyze), figsize=(<span class="integer">8</span> * <span class="predefined">len</span>(dfs_analyze), <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="predefined">enumerate</span>(dfs_analyze.keys()):
    <span class="comment"># 描画位置を指定</span>
    ax = axes[i]
    <span class="comment"># ヒストグラムをプロット</span>
    dfs_analyze[k].groupby([<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>])[<span class="string"><span class="delimiter">&quot;</span><span class="content">return</span><span class="delimiter">&quot;</span></span>].sum().hist(bins=<span class="integer">50</span>, log=<span class="predefined-constant">True</span>, ax=ax)
    <span class="comment"># タイトルを設定</span>
    ax.set_title(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: Weekly PL distribution</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf13.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　ここからはあまりはっきりとした傾向はわかりませんが、1の戦略の分布が若干右側に広く大勝ちした銘柄を選択できている可能性が示唆されます。3の戦略はやはり銘柄個別で見ても分布が狭く、ボラティリティが低い銘柄を採用しているようです。</p>
</div>
</div>
<div class="sect4">
<h5 id="_週毎に勝ち銘柄率を算出">週毎に勝ち銘柄率を算出</h5>
<div class="paragraph">
<p>　最後に週毎の銘柄の勝率を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, ax = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 統計量表示用</span>
buff = []
<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> dfs_analyze.keys():
    <span class="comment"># 週毎の勝ち銘柄率を計算</span>
    win_ratio = (
        dfs_analyze[k]
        .set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)
        .groupby(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)
        .apply(<span class="keyword">lambda</span> x: (x.pl &gt; <span class="integer">0</span>).sum() / x.shape[<span class="integer">0</span>])
        .to_frame()
        .rename(columns={<span class="integer">0</span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: win_ratio</span><span class="delimiter">&quot;</span></span>})
    )
    <span class="comment"># プロット</span>
    win_ratio.plot(ax=ax)
    <span class="comment"># 統計量を保存</span>
    buff.append(win_ratio.describe().T)
<span class="comment"># ユニバースの勝ち銘柄率をプロット</span>
df_wp.groupby(df_wp.index).apply(<span class="keyword">lambda</span> x: (x.universe &gt; <span class="integer">0</span>).sum() / x.shape[<span class="integer">0</span>]).rename(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>
).to_frame().plot(ax=ax, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># タイトルを設定</span>
ax.set_title(<span class="string"><span class="delimiter">&quot;</span><span class="content">win ratio of selected stocks</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># グリッド表示</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 0.5に基準線を描画</span>
ax.axhline(y=<span class="float">0.5</span>, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
<span class="comment">#  描画</span>
plt.show()
<span class="comment"># 週毎の勝ち銘柄率の統計量</span>
display(pd.concat(buff))</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf14.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　このプロットからいくつかおもしろいことがわかります。まず、1/2のストラテジーは6月から10月にかけて収益を上げていましたが、この時期に勝率がユニバースよりも高かったわけではないことがわかります。むしろ銘柄単位で見ると勝率はユニバースの平均よりも若干低い事がわかります。つまり、この期間に1/2のストラテジーは勝率で稼いだわけではなく、銘柄ごとのリターンが大きかったことが推測されます。<br>
これはどのような銘柄を選択していたかを調査することによって、どのあたりに収益性の厳選があるかを考えるヒントになります。このような傾向が観測されたらファクター分析などを利用して収益の厳選を確認する作業を実施するなどの発展が考えられます。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_適時開示情報を使用して特別損失銘柄を除外">4.6. 適時開示情報を使用して特別損失銘柄を除外</h3>
<div class="paragraph">
<p>　strategy_idの4/5/6にtdnet.csv.gzを使用して特別損失を発表した銘柄を除外する戦略を実装しています。strategy_idに4/5/6を指定してバックテストを実施し、設定した仮説（特別損失開示による株価の下落を回避し、ポートフォリオの利益を向上できるとの仮説）が有効なのかどうかを検証します。</p>
</div>
<div class="paragraph">
<p>　特別損失を発表した銘柄を除外してポートフォリオを組成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> strategy_id <span class="keyword">in</span> tqdm([<span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>]):
    <span class="comment"># ポートフォリオ組成</span>
    str_ret = ScoringService.predict(inputs, start_dt=start_dt, strategy_id=strategy_id)
    <span class="comment"># ポートフォリオを保存</span>
    <span class="keyword">with</span> <span class="predefined">open</span>(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-{strategy_id}.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
        f.write(str_ret)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　バックテストを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> strategy_id <span class="keyword">in</span> tqdm([<span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>]):
    <span class="comment"># ポートフォリオを読み込み</span>
    df_submit = Backtest.load_submit(f<span class="string"><span class="delimiter">&quot;</span><span class="content">chapter03-tutorial-02-backtest-{strategy_id}.csv</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># バックテスト実行</span>
    results[strategy_id], stocks[strategy_id] = Backtest.run(df_submit.loc[start_dt:], backtest_codes, backtest_price)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_改善を試みたバックテスト結果の考察">4.6.1. 改善を試みたバックテスト結果の考察</h4>
<div class="paragraph">
<p>　ここではまずweek_returnの累積をプロットして効果が出ているかを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 描画領域を定義</span>
fig, axes = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">20</span>, <span class="integer">8</span>), sharex=<span class="predefined-constant">True</span>, sharey=<span class="predefined-constant">True</span>)

<span class="comment"># 戦略毎に処理</span>
<span class="keyword">for</span> k <span class="keyword">in</span> results.keys():
    <span class="comment"># 描画位置を指定</span>
    ax = axes
    <span class="comment"># 戦略別の累積リターンを描画</span>
    results[k].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>).loc[:, [<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>]].rename(
        columns={<span class="string"><span class="delimiter">&quot;</span><span class="content">week_return</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{k}: week_return</span><span class="delimiter">&quot;</span></span>}
    ).cumsum().plot(ax=ax)

<span class="comment"># ユニバースの週次リターンの累積をプロット</span>
df_universe_return.cumsum().plot(ax=ax, color=<span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>, label=<span class="string"><span class="delimiter">&quot;</span><span class="content">universe</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># 表示を調整</span>
ax.set_title(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cumulative week_return</span><span class="delimiter">&quot;</span></span>)
<span class="comment"># グリッドを表示</span>
ax.grid(<span class="predefined-constant">True</span>)
<span class="comment"># 描画</span>
plt.show()</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter04/images/rf/rf18.png" alt="処理結果" width="100%">
</div>
</div>
<div class="paragraph">
<p>　2及び5の戦略に注目すると、特別損失を発表した銘柄を除外するとポートフォリオの利益が上昇することもあることがわかります。ここでは、勝率やシャープレシオ等これまで実施してきた詳細な分析については実施していませんが、実際の戦略の決定には一つの評価指標のみを使用するのではなく、複数の評価指標を使用して総合的に判断することが重要です。前述の評価方法などを参考に各自で実施してみてください。</p>
</div>
<div class="paragraph">
<p>　また、今回は適時開示情報の特別損失のみを使用していますが、それ以外にも株価に影響を与える開示項目があるかもしれません、上記のように仮説を立てて一つずつ効果を比較しながら検証することが重要になります。</p>
</div>
</div>
<div class="sect3">
<h4 id="_バックテストの総括">4.6.2. バックテストの総括</h4>
<div class="paragraph">
<p>　まず、1及び2の戦略はユニバースと比較して高い収益性を実現できていました。最高値モデルと最安値モデルを足し合わせた1の戦略が、より安定的な収益を上げることを期待していましたが、シャープレシオなどを比較しても2の戦略の方が優れているため、最高値モデルと最安値モデルを足すよりも、現時点では最高値モデルを単体で利用するほうが良い結果が期待できそうです。</p>
</div>
<div class="paragraph">
<p>　ただし、最高値モデルと最安値モデルの組み合わせ方が悪かった可能性もあります。というのも、2章で作成した予測モデルはあくまでスピアマンの順位相関を意識して作られたため、予測値の幅よりも順位を当てることを意識して設計されています。この場合、予測の幅が必ずしも実際の幅と一致する必要はありませんので、単純に足すよりもscikit-learnライブラリのStandardScaler( <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html" class="bare">https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html</a> )による標準化などを通して、一旦正規化を実施してから足すのがよいのではないかと考えられます。</p>
</div>
<div class="paragraph">
<p>このようにモデルの構築と利用方法の組み合わせによって銘柄選択の戦略は決まりますので、是非様々な試行錯誤を実施してください。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_投稿用パッケージの作成_2">4.7. 投稿用パッケージの作成</h3>
<div class="sect3">
<h4 id="_投稿用パッケージのディレクトリの作成_2">4.7.1. 投稿用パッケージのディレクトリの作成</h4>
<div class="paragraph">
<p>　ここまで、モデルの作成及び評価をしてきました。ここからは、投稿用のパッケージを作成します。ランタイム環境用のモデルは以下の構成である必要がありますので、まずは必要なディレクトリを作成していきます。また、適宜「3.8. 投稿用パッケージの作成」についてもご参照ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>.
├── model                  必須 学習済モデルを置くディレクトリ
│   └── ...
├── src                    必須 Python のプログラムを置くディレクトリ
│   ├── predictor.py       必須 最初のプログラムが呼び出すファイル
│   └── ...                その他のファイル (ディレクトリ作成可能)
└── requirements.txt       任意</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ライブラリバージョン調整">4.7.2. ライブラリバージョン調整</h4>
<div class="paragraph">
<p>　本章で利用したモジュールのバージョンを調整するために、requirements.txtに以下を記載して保存します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>joblib==1.0.1
numpy==1.19.5
pandas==1.1.5
scikit-learn==0.20.3
scipy==1.2.1
seaborn==0.9.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ランタイム実行用クラス及び提出ファイルの作成">4.7.3. ランタイム実行用クラス及び提出ファイルの作成</h4>
<div class="paragraph">
<p>　最後に作成したScoringServiceクラスをpredictor.pyに書き込み、Zip形式で圧縮することで提出可能なzipファイルが作成されます。</p>
</div>
<div class="paragraph">
<p>Zipファイル作成例</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ls
model  requirements.txt  src
$ zip -v submit.zip requirements.txt src/*.py model/*.pkl
updating: requirements.txt        (in=0) (out=0) (stored 0%)
updating: src/predictor.py        (in=11408) (out=2417) (deflated 79%)
updating: model/my_model_label_high_20.pkl .        (in=18919345) (out=5071005) (deflated 73%)
updating: model/my_model_label_low_20.pkl .        (in=18704305) (out=5006613) (deflated 73%)
total bytes=37635058, compressed=10080035 -&gt; 73% savings</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ニュースデータから特徴量を抽出しよう">5. ニュースデータから特徴量を抽出しよう</h2>
<div class="sectionbody">
<div class="paragraph">
<p>　本章では、本コンペの大きな特徴であるニュースデータに注目し、ニュースデータから特徴量抽出を行う手法を紹介します。特徴量抽出を行うことでテキスト情報がスコア化されるため、予測モデルやポートフォリオに活用することが可能となります。</p>
</div>
<div class="paragraph">
<p>　本章ではニュースデータから特徴量抽出を行う手法として、BERT(Bidirectional Encoder Representations from Transformers)を採用しています。BERTはGoogleによって開発された、自然言語処理（NLP）の事前学習のためのTransformerベースの機械学習手法であり(引用:<a href="https://ja.wikipedia.org/wiki/BERT_(%E8%A8%80%E8%AA%9E%E3%83%A2%E3%83%87%E3%83%AB)">Wikipedia: BERT (言語モデル)</a>)、近年様々な分野で高い性能を発揮しているニューラルネットを基盤とする言語モデルの一種です。</p>
</div>
<div class="paragraph">
<p>　本チュートリアルでは、東北大学の乾・鈴木研究室が公開した訓練済み日本語BERTモデルを利用します(<a href="https://github.com/cl-tohoku/bert-japanese">こちら</a>)。なお、BERTモデルへの入力であるコーパス(言語の標本を抽出した集合。テキストの集合を示します)は、そのBERTモデルが学習された時と同様の前処理を行う必要があることに注意が必要です。</p>
</div>
<div class="paragraph">
<p>今回使用する"cl-tohoku/bert-base-japanese-whole-word-masking"モデルは、mecab-ipadic-NEologdによりトークナイズされ、その後Wordpiece subword encoderよりsubword化していますので、本チュートリアルでもその流れに沿った処理を実施しています。トークナイズとは、テキストを決めた基準のトークンに区切ることです(5.2に詳細記載)。他のBERTモデルを利用することも可能ですが、その場合は、そのBERTモデルの入力とするコーパスがどのように前処理が行われたかを確認し適切な前処理を実施するようにしてください。<br>
また、本コンペティションでは、以下のように外部データの利用を制限しております。こちらも合わせてご確認ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>・提供するデータ以外の外部データ（為替や金利データ等）や、提供するデータの期間外のヒストリカルデータを用いてモデルを学習することは禁止。（例として、2015年以前の株価等）

・ただし、言語資源の外部データについては、第三者の権利を侵害しない、無償で誰でも利用可能なオープンなものに限り利用可能。（例として、形態素解析辞書や、BERTモデル）</pre>
</div>
</div>
<div class="sect2">
<h3 id="_テキストからの特徴量抽出方法の紹介">5.1. テキストからの特徴量抽出方法の紹介</h3>
<div class="paragraph">
<p>　テキストデータに内在する情報を特徴量として抽出する方法としては、単語の頻度ベース、単語の分散表現ベース、言語モデルベース等の方法が存在します。下記では、それぞれについていくつかの方法を紹介します。</p>
</div>
<div class="paragraph">
<p><strong>単語の頻度ベース</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>テキストに登場する各単語の頻度を行列化した単語文書行列を用いる方法 （例）TF-IDF(Term Frequency–Inverse Document Frequency)</p>
</li>
<li>
<p>テキストの潜在意味を抽出するトピックモデリングの方法 （例）LSA(Latent Semantic Analysis), LDA(Latent Dirichlet Allocation)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　これらの方法は、単語の頻度行列の使用を基盤としているため、コーパス内に単語が増えれば増えるほど高い計算リソースが要求されます。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデリング名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">説明</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">引用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LSA(Latent Semantic Analysis)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LSAはベクトル空間モデルを利用した自然言語処理の技法の1つで、文書群とそこに含まれる用語群について、それらに関連した概念の集合を生成することで、その関係を分析する技術である。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ja.wikipedia.org/wiki/%E6%BD%9C%E5%9C%A8%E6%84%8F%E5%91%B3%E8%A7%A3%E6%9E%90#:~:text=%E6%BD%9C%E5%9C%A8%E6%84%8F%E5%91%B3%E8%A7%A3%E6%9E%90%EF%BC%88%E8%8B%B1%3A%20Latent,%E6%BD%9C%E5%9C%A8%E7%9A%84%E6%84%8F%E5%91%B3%E8%A7%A3%E6%9E%90%E3%81%A8%E3%82%82%E3%80%82">Wikipedia:潜在意味解析</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDA(Latent Dirichlet Allocation)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAは文章中の潜在的なトピックを推定し、文章分類や、文章ベクトルの次元削減等に用いられる技術です。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://spjai.com/topic-model/">【入門】トピックモデルとは？トピック分析の３つの手法を解説</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>単語の分散表現ベース</strong></p>
</div>
<div class="paragraph">
<p>　単語の分散表現（あるいは単語埋め込み）とは、単語を高次元の実数ベクトルで表現する技術です(引用:<a href="https://sites.google.com/site/iwanamidatascience/vol2/word-embedding">岩波データサイエンス: 分散表現(単語埋め込み)</a>)。次に挙げる方法は、単語を分散表現化する方法の一部です。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">手法</th>
<th class="tableblock halign-left valign-top">説明</th>
<th class="tableblock halign-left valign-top">論文例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Word2Vec(CBOW)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">中心単語から周辺単語を予測し、前後単語との関係性を用いて分散表現を構築</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://arxiv.org/abs/1301.3781">Tomas Mikolov, Kai Chen, Greg Corrado, Jeffrey Dean, 2013, Efficient Estimation of Word Representations in Vector Space</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Glove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単語の頻度ベースのLSAと単語の分散表現ベースのWord2Vecを用いて分散表現を構築</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://arxiv.org/abs/1411.5595">Tianze Shi, Zhiyuan Liu, 2014, Linking GloVe with word2vec</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FastText</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単語をSubword化することで、Out-Of-Vocabularyに頑健な分散表現を構築</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://arxiv.org/abs/1607.04606">Piotr Bojanowski, Edouard Grave, Armand Joulin, Tomas Mikolov, 2017, Enriching Word Vectors with Subword Information</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elmo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RNNベースの言語モデルであるbiLMを用いて、文脈を反映する分散表現を構築</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://arxiv.org/abs/1802.05365">Matthew E. Peters, Mark Neumann, Mohit Iyyer, Matt Gardner, Christopher Clark, Kenton Lee, Luke Zettlemoyer, 2018, Deep contextualized word representations</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>言語モデルベース(ニューラルネット基盤の言語モデルのみを説明)</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>RNN基盤(LSTM, GRU, LMを含む)の内部状態を特徴量として抽出</p>
</li>
<li>
<p>Transformer(BERT等Attention機構を用いたモデルを含む)基盤の内部状態を特徴量として抽出</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　これらの方法は、膨大なパラメータを持つモデルを膨大なデータを用いて学習させるため、テキストデータについてより高次元の潜在表現を学習できることが知られています。また、このようなモデルから抽出した特徴量は多様なタスクにおいて適用でき、高いパフォーマンスを表すことが知られています。</p>
</div>
<div class="paragraph">
<p>　本チュートリアルでは、上記観点からも最も汎用性が高いと思われるBERTモデルを利用した特徴量抽出に取り組みます。</p>
</div>
</div>
<div class="sect2">
<h3 id="anchor-5.2">5.2. 実行環境</h3>
<div class="paragraph">
<p>　本チュートリアルでは、CPUとGPUどちらの環境でも実行可能なモデルを使用しています。しかし、本チュートリアルで紹介するBERTの特徴量抽出の処理は、CPU環境ではかなりの時間がかかります。そのため、GPU環境をお持ちでない方は、多少の制限はあるものの実行環境として無料でGPU環境が使えるGoogle Colaboratoryを利用することを強くお勧めします。また、本章を実行しなくても問題なく特徴量をご利用いただけるように、本章で抽出したBERT特徴量はpklファイルとして <a href="http://signate.jp/competitions/443/data">こちら</a> でも提供しています。</p>
</div>
<div class="sect3">
<h4 id="_google_colaboratoryの環境設定">5.2.1. Google Colaboratoryの環境設定</h4>
<div class="paragraph">
<p>　本コンペの5章、6章のチュートリアルをGoogle Colaboratory上で動かすためには、まず以下の手順でGoogle Drive上にファイルを設置します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Google DriveのMy Driveに<code>JPX_competition</code>というフォルダーを作成します。</p>
</li>
<li>
<p>1で作成した<code>JPX_competition</code>フォルダーにデータを保存するための<code>data_dir_comp2</code>フォルダーを作成します。</p>
</li>
<li>
<p>SIGNATEのコンペティションサイトよりダウンロードした各種データを2で作成した<code>data_dir_comp2</code>フォルダーにアップロードします。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>　次にGoogle Colaboratory上でチュートリアルのnotebookを展開します。本チュートリアルのnotebookはGoogle Colaboratory上でも実行可能となっております。各章のnotebookは以下のそれぞれのリンク先を開き、開いたページでRawを右クリックし、「リンク先を名前をつけて保存」を選択することでダウンロード可能です。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter05/20210226_chapter05_tutorial.ipynb">5章のnotebook</a><br>
<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter06/20210226_chapter06_tutorial.ipynb">6章のnotebook</a><br>
<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter06/20210224_chapter06_tutorial_test_predictor.ipynb">6章の投稿ファイル実装例用notebook</a><br></p>
</div>
<div class="paragraph">
<p>　以下、5章を例にGoogle Colaboratoryでチュートリアルのnoteboookを使用する方法を説明します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Google Drive の My Drive 内に作成した<code>JPX_competition</code>フォルダーに3章用のnotebookを保存するための<code>Chapter05</code>フォルダーを作成します。</p>
</li>
<li>
<p>上記のリンク先から5章のnotebookをダウンロードして、先程作成した<code>Chapter05</code>フォルダーに<code>20210226_chapter05_tutorial.ipyn</code>というファイル名で保存してください。</p>
</li>
<li>
<p>Google Driveにアップロードした <code>20210226_chapter05_tutorial.ipynb</code> ファイルをダブルクリックして Google Colaboratory で開きます。</p>
</li>
<li>
<p>Google Colaboratoryの環境で本チュートリアルを実行する場合、最初に以下のコードを実行して Google Colaboratory 上の notebook から Google Drive にアクセスできるようにしてください。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Google Colab環境ではGoogle Driveをマウントしてアクセスできるようにします。</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    <span class="comment"># Google Drive をマウントします</span>
    <span class="keyword">from</span> <span class="include">google.colab</span> <span class="keyword">import</span> <span class="include">drive</span>
    mount_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/content/drive</span><span class="delimiter">&quot;</span></span>
    drive.mount(mount_dir)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_必要なライブラリのインストール_2">5.2.2. 必要なライブラリのインストール</h4>
<div class="paragraph">
<p>　本チュートリアル内では、上記の実行環境には含まれていないライブラリを使用するため、以下のコマンドを使用して個別にインストールします。Notebookに記載がある通り、Google Colaboratory上においても実行できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># テキスト解析用にmecabをインストールします。
# 日本語表記を含む可視化のため、フォントもインストールしています。
apt-get update
apt-get install -y build-essential sudo mecab libmecab-dev mecab-ipadic-utf8 fonts-ipafont-gothic file

# 必要なライブラリをインストールします。
pip install --no-cache-dir pandas==1.1.5 numpy==1.19.5 scattertext==0.1.0.0 wordcloud==1.8.1 torch==1.7.1 torchvision==0.8.2 transformers==4.2.2 mecab-python3==0.996.6rc1 ipadic==1.0.0 neologdn==0.4 fugashi==1.0.5 japanize-matplotlib==1.1.3 gensim==3.8.3 pyLDAvis==2.1.2
# mecab用のipadic-neologd辞書をインストールします。
# ipadic-neologd辞書は非常に頻繁に更新されるため、同様の解析結果が得られるようにバージョンを指定します。そのため、git clone時にバージョン(--branch v0.0.7 --single-branch)を指定します。
# git cloneよりインストールファイルが入っているレポジトリをローカル環境に落とします。
git clone https://github.com/neologd/mecab-ipadic-neologd.git --branch v0.0.7 --single-branch

# インストールの途中、yesのコマンドを叩かないとインストールが実行されません。yesコマンドを使うことで、渡された引数を常に叩くようになります。
yes yes | mecab-ipadic-neologd/bin/install-mecab-ipadic-neologd</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ライブラリの読み込み_2">5.2.3. ライブラリの読み込み</h4>
<div class="paragraph">
<p>　本チュートリアルで利用するライブラリを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 基本ライブラリ</span>
<span class="keyword">import</span> <span class="include">re</span>
<span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">math</span>
<span class="keyword">import</span> <span class="include">random</span>
<span class="keyword">import</span> <span class="include">json</span>
<span class="keyword">import</span> <span class="include">joblib</span>
<span class="keyword">import</span> <span class="include">numpy</span> <span class="keyword">as</span> np
<span class="keyword">import</span> <span class="include">pandas</span> <span class="keyword">as</span> pd
<span class="keyword">from</span> <span class="include">scipy</span> <span class="keyword">import</span> <span class="include">stats</span>
<span class="keyword">import</span> <span class="include">string</span>
<span class="keyword">from</span> <span class="include">copy</span> <span class="keyword">import</span> <span class="include">copy</span>
<span class="keyword">from</span> <span class="include">glob</span> <span class="keyword">import</span> <span class="include">glob</span>
<span class="keyword">from</span> <span class="include">itertools</span> <span class="keyword">import</span> <span class="include">chain</span>
<span class="keyword">import</span> <span class="include">gc</span>

<span class="comment"># テキスト解析関連</span>
<span class="keyword">import</span> <span class="include">MeCab</span>
<span class="keyword">import</span> <span class="include">unicodedata</span>
<span class="keyword">import</span> <span class="include">neologdn</span>

<span class="comment"># 可視化関連</span>
<span class="keyword">from</span> <span class="include">tqdm.auto</span> <span class="keyword">import</span> <span class="include">tqdm</span>
<span class="keyword">from</span> <span class="include">IPython.display</span> <span class="keyword">import</span> <span class="include">display</span>, <span class="include">display_markdown</span>, <span class="include">IFrame</span>
<span class="keyword">import</span> <span class="include">scattertext</span> <span class="keyword">as</span> st
<span class="keyword">from</span> <span class="include">wordcloud</span> <span class="keyword">import</span> <span class="include">WordCloud</span>
<span class="keyword">import</span> <span class="include">matplotlib.pyplot</span> <span class="keyword">as</span> plt
<span class="keyword">import</span> <span class="include">japanize_matplotlib</span>
<span class="keyword">import</span> <span class="include">seaborn</span> <span class="keyword">as</span> sns
<span class="keyword">import</span> <span class="include">gensim</span>
<span class="keyword">import</span> <span class="include">pyLDAvis</span>
<span class="keyword">import</span> <span class="include">pyLDAvis.gensim</span>

<span class="comment">#PCA関連</span>
<span class="keyword">from</span> <span class="include">sklearn.decomposition</span> <span class="keyword">import</span> <span class="include">PCA</span>, <span class="include">KernelPCA</span>

<span class="comment"># ニューラルネット関連</span>
<span class="keyword">import</span> <span class="include">torch</span>
<span class="keyword">from</span> <span class="include">torch</span> <span class="keyword">import</span> <span class="include">nn</span>
<span class="keyword">import</span> <span class="include">torch.nn.functional</span> <span class="keyword">as</span> F
<span class="keyword">import</span> <span class="include">transformers</span>
<span class="keyword">from</span> <span class="include">transformers</span> <span class="keyword">import</span> <span class="include">BertJapaneseTokenizer</span>
<span class="keyword">from</span> <span class="include">torch.utils.data</span> <span class="keyword">import</span> <span class="include">DataLoader</span>, <span class="include">Dataset</span> <span class="keyword">as</span> _Dataset

<span class="comment"># notebook上でpyLDAvisより可視化を行う場合の設定</span>
pyLDAvis.enable_notebook()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ライブラリ解説_2">5.2.4. ライブラリ解説</h4>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>ライブラリ名</strong></th>
<th class="tableblock halign-left valign-top"><strong>目的</strong></th>
<th class="tableblock halign-left valign-top"><strong>公式ドキュメント</strong></th>
<th class="tableblock halign-left valign-top"><strong>入門解説</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">re</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.python.org/3/library/re.html">Regular expression operations</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://note.nkmk.me/python-re-match-search-findall-etc/">Pythonの正規表現モジュールreの使い方</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">numpy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://numpy.org/doc/stable/user/tutorials_index.html">NumPy Tutorials</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/jyori112/items/a15658d1dd17c421e1e2">Qiita:numpyの使い方</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pandas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの処理</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://pandas.pydata.org/docs/">pandas documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/ysdyt/items/9ccca82fc5b504e7913a">Qiita:データ分析で頻出のPandas基本操作</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scipy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">統計用のライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.scipy.org/doc/scipy/reference/tutorial/index.html">SciPy Tutorial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://amorphous.tf.chiba-u.jp/lecture.files/chem_computer/11_scipy%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%81%A8%E5%BF%9C%E7%94%A8/11.html">千葉大: コンピュータ処理 ドキュメント 11. scipyの基本と応用</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">glob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイルの検知</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.python.org/3/library/glob.html">glob — Unix style pathname pattern expansion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/HirosuguTakeshita/items/0e0850362c7eb3b10ea1">Qiita:【備忘録】globの使い方</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MeCab</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テキスト解析</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://taku910.github.io/mecab/">MeCab: Yet Another Part-of-Speech and Morphological Analyzer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/KROYO/items/931805e5f499753b546f">Qiita:初めての自然言語処理 入門 1 ~MeCabを動かしてみよう ~</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unicodedata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unicode正規化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.python.org/3/library/unicodedata.html">Unicode Database</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/fury00812/items/b98a7f9428d1395fc230">Qiita:Unicode正規化</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">neologdn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">テキスト正規化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/neologd/mecab-ipadic-neologd/wiki/Regexp.ja">neologdn</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://diatonic.codes/blog/neologdn/">【ライブラリ紹介】テキスト正規化ライブラリ neologdn</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tqdm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">計算の進捗確認</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://tqdm.github.io/">tqdm</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/pontyo4/items/76145cb10e030ad8186a">Qiita:tqdmでプログレスバーを表示させる</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPython.display</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データ可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ipython.readthedocs.io/en/stable/api/generated/IPython.display.html">Module: display — IPython 7.20.0 documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/alchemist/items/54b5768c964fd1eb6b54">Qiita:Jupyter Notebookでセルの途中でも値を出力するには</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scattertext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コーパス可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/JasonKessler/scattertext">scattertext</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ichi.pro/scattertext-no-kaishaku-tekisuto-o-purottosuru-tame-no-miwakuteki-na-tsu-ru-51217040558168">Scattertextの解釈：テキストをプロットするための魅惑的なツール</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wordcloud</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コーパス可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://amueller.github.io/word_cloud/">WordCloud for Python documentation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/str32/items/4539e417a9cb333abd52">Qiita:wordcloudで遊んでみた！</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matplotlib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://matplotlib.org/tutorials/index.html">matplotlib tutorials</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/skotaro/items/08dc0b8c5704c94eafb9">Qiita:早く知っておきたかったmatplotlibの基礎知識、あるいは見た目の調整が捗るArtistの話</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">japanize_matplotlib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/uehara1414/japanize-matplotlib">japanize-matplotlib</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/uehara1414/items/6286590d2e1ffbf68f6c">pip install して import するだけで matplotlib を日本語表示対応させる</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">seaborn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">データの可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://seaborn.pydata.org/tutorial.html">User guide and tutorial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/hik0107/items/3dc541158fceb3156ee0">Qiita:pythonで美しいグラフ描画 -seabornを使えばデータ分析と可視化が捗る その1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gensim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コーパス解析</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://radimrehurek.com/gensim/auto_examples/index.html">Gensim topic modelling for humans</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openbook4.me/projects/193/sections/1154">openbook:データ解析: LDAの実装(gensim)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pyLDAvis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">コーパス可視化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://pyldavis.readthedocs.io/en/latest/">Welcome to pyLDAvis’s documentation!</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.ie110704.net/2018/12/29/wordcloudとpyldavisによるldaの可視化について">WordCloudとpyLDAvisによるLDAの可視化について</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">torch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ニューラルネットモデリング</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://pytorch.org/docs/stable/index.html">PYTORCH DOCUMENTATION</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/north_redwing/items/30f9619f0ee727875250">Qiita:PyTorch入門 [公式Tutorial:DEEP LEARNING WITH PYTORCH: A 60 MINUTE BLITZを読む</a>]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transformers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">事前学習言語処理モデル利用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://huggingface.co/transformers/">Transformers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://note.com/npaka/n/n5bb043191cc9">note:Huggingface Transformers 入門 (1) - 事始め</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_notebook環境の構築">5.2.5. notebook環境の構築</h4>
<div class="paragraph">
<p><strong>ファイルパスの設定</strong></p>
</div>
<div class="paragraph">
<p>　notebook実行時に使用するファイルパスを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># colab環境で実行する場合</span>
<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    CONFIG = {
        <span class="string"><span class="delimiter">'</span><span class="content">base_path</span><span class="delimiter">'</span></span>: f<span class="string"><span class="delimiter">'</span><span class="content">{mount_dir}/MyDrive/JPX_competition/workspace</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">article_path</span><span class="delimiter">'</span></span>: f<span class="string"><span class="delimiter">'</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2/nikkei_article.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">stock_price_path</span><span class="delimiter">'</span></span>: f<span class="string"><span class="delimiter">'</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2/stock_price.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">stock_list_path</span><span class="delimiter">'</span></span>: f<span class="string"><span class="delimiter">'</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2/stock_list.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">dict_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">font_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/usr/share/fonts/truetype/fonts-japanese-gothic.ttf</span><span class="delimiter">'</span></span>,
    }
<span class="keyword">else</span>:
    CONFIG = {
        <span class="string"><span class="delimiter">'</span><span class="content">base_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/notebook/workspace</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">article_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/notebook/data_dir_comp2/nikkei_article.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">stock_price_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/notebook/data_dir_comp2/stock_price.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">stock_list_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/notebook/data_dir_comp2/stock_list.csv.gz</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">dict_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">font_path</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">/usr/share/fonts/truetype/fonts-japanese-gothic.ttf</span><span class="delimiter">'</span></span>,
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>ディレクトリ作成</strong></p>
</div>
<div class="paragraph">
<p>　アウトプットされた実行結果ファイルを保存するためのディレクトリを作成しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> store_dir <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">visualizations</span><span class="delimiter">'</span></span>]:
    os.makedirs(os.path.join(CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">base_path</span><span class="delimiter">&quot;</span></span>], store_dir), exist_ok=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anchor-5.2.6">5.3. テキスト解析について</h3>
<div class="sect3">
<h4 id="_形態素解析トークナイズ">5.3.1. 形態素解析・トークナイズ</h4>
<div class="paragraph">
<p>　自然言語処理において、コーパスが前処理されていない状態である場合、該当するデータを使用するに当たって用途に合わせたトークナイズを行います。トークンとは意味を持つ文字列であり、主に、単語や単語より小さい単位を持つ形態素というものが該当します。また、テキストデータを予め決めた基準のトークンに区切ることをトークナイズと言います。英語においては、スペースを単語と単語の区切りとみなすことでトークナイズは簡単に行えます。また、句読点を用いることで文章と文章を区切ることもできます。</p>
</div>
<div class="paragraph">
<p>　しかし、英語と異なり日本語はスペースや句読点だけでトークナイズを行うことは困難ですが、pythonではMeCabというライブラリを用いることで、日本語におけるトークナイズ処理を簡単に行うことができます。MeCabの動作原理に関して興味がある方は <a href="https://techlife.cookpad.com/entry/2016/05/11/170000">こちら</a> をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_テキスト解析に用いるtaggerの構築">5.3.2. テキスト解析に用いるtaggerの構築</h4>
<div class="paragraph">
<p>　MeCabでトークナイズを行うクラス（トークナイザ）をtaggerと呼びます。MeCabのtaggerを構築する時は、その出力形式をオプションとして渡すことができます。オプションには、以下の４つがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-Ochasen：ChaSen互換形式</p>
</li>
<li>
<p>-Owakati：分かち書きのみを出力</p>
</li>
<li>
<p>-Oyomi：読みのみ（振り仮名）を出力</p>
</li>
<li>
<p>-Odump：単語の全情報を出力</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>その中でも、OwakatiとOchasenの2つがよく使用されています。Owakatiはテキストをトークナイズし、空白でテキストをトークン単位に区切ります。Ochasenはトークナイズを行うと共に、トークンの品詞情報や原型、活用型などを共に返します。以降の解析では、これらのtaggerを使用しますので、各々のtaggerに出力形式オプションを引数として設定しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">owakati = MeCab.Tagger(f<span class="string"><span class="delimiter">&quot;</span><span class="content">-Owakati -d {CONFIG['dict_path']}</span><span class="delimiter">&quot;</span></span>)
ochasen = MeCab.Tagger(f<span class="string"><span class="delimiter">&quot;</span><span class="content">-Ochasen -d {CONFIG['dict_path']}</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># taggerのparseを使うことで、各々の機能を確認することができます。</span>
text = <span class="string"><span class="delimiter">'</span><span class="content">taggerの役割を確認してみます。</span><span class="delimiter">'</span></span>
print(<span class="string"><span class="delimiter">'</span><span class="content">owakati:</span><span class="char">\n</span><span class="delimiter">'</span></span> + owakati.parse(text))
print(<span class="string"><span class="delimiter">'</span><span class="content">ochasen:</span><span class="char">\n</span><span class="delimiter">'</span></span> + ochasen.parse(text))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。テキストのトークナイズ、品詞情報の取得に成功していることが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">owakati:
tagger の 役割 を 確認 し て み ます <span class="error">。</span>

ochasen:
tagger        タガー        tagger        名詞-固有名詞-一般
の        ノ        の        助詞-連体化
役割        ヤクワリ        役割        名詞-一般
を        ヲ        を        助詞-格助詞-一般
確認        カクニン        確認        名詞-サ変接続
し        シ        する        動詞-自立        サ変<span class="error">・</span>スル        連用形
て        テ        て        助詞-接続助詞
み        ミ        みる        動詞-非自立        一段        連用形
ます        マス        ます        助動詞        特殊<span class="error">・</span>マス        基本形
<span class="error">。</span>        <span class="error">。</span>        <span class="error">。</span>        記号-句点
EOS</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラス作成方法について">5.3.3. 本番提出用のクラス作成方法について</h4>
<div class="paragraph">
<p>　本章で構築するモデルは記述がとても長いため、3章及び4章のように最後に一気にモデル提出用のクラスを作成するのではなく、以下のように段階的にモデル提出用のクラスを作成していきます。まずは、ベースとなる基底クラス <code>SentimentGenerator</code> を定義しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">SentimentGenerator</span>(<span class="predefined">object</span>):
    <span class="comment"># 各々の変数に関しては、後述のチュートリアル内で説明します。</span>
    article_columns = <span class="predefined-constant">None</span>
    punctuation_replace_dict = <span class="predefined-constant">None</span>
    punctuation_remove_list = <span class="predefined-constant">None</span>
    device = <span class="predefined-constant">None</span>
    feature_extractor = <span class="predefined-constant">None</span>
    headline_feature_combiner_handler = <span class="predefined-constant">None</span>
    keywords_feature_combiner_handler = <span class="predefined-constant">None</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ニュースデータ処理の流れ">5.4. ニュースデータ処理の流れ</h3>
<div class="paragraph">
<p>本チュートリアルでは、5章及び6章でニュースデータを以下のように処理していきます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/chapter03_flow_chart.shapex.png" alt="chapter03_flow_chart.shapex" width="60%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_利用するテキストデータについて">5.5. 利用するテキストデータについて</h3>
<div class="paragraph">
<p>　本節では、使用するテキストデータについてのデータの読み込みや内容について概観します。</p>
</div>
<div class="sect3">
<h4 id="_テキストデータの読み込み">5.5.1. テキストデータの読み込み</h4>
<div class="paragraph">
<p>　本チュートリアルで用いるテキストデータを読み込み、確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">articles = pd.read_csv(CONFIG[<span class="string"><span class="delimiter">'</span><span class="content">article_path</span><span class="delimiter">'</span></span>])
display(articles.head(<span class="integer">3</span>))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_テキストデータの内容を概観">5.5.2. テキストデータの内容を概観</h4>
<div class="paragraph">
<p>　テキストデータの構成を把握するため、各columnのユニークなデータの件数やデータの形等を確認します。読み込んだデータに関して細かくそのデータ数や形式を確認する作業はデータの理解を助けます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># key: column, value: 重複を排除したデータ件数のdict型宣言</span>
n_unique = {}
<span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
    <span class="comment"># column毎の重複を排除したデータ件数をn_uniqueに追加する。</span>
    n_unique[column] = <span class="predefined">len</span>(articles[column].unique())

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">Number of unique data</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)

<span class="comment"># n_uniqueをpd.Series形式に変換する。articles.dtypesよりcolumnごとのdtypeを取得</span>
<span class="comment"># これらをpd.concatによってテーブル形式に変換し、表示</span>
display(pd.concat([pd.Series(n_unique).rename(<span class="string"><span class="delimiter">'</span><span class="content">n_unique</span><span class="delimiter">'</span></span>), articles.dtypes.rename(<span class="string"><span class="delimiter">'</span><span class="content">dtype</span><span class="delimiter">'</span></span>)], axis=<span class="integer">1</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_4_unique_data.png" alt="1_4_unique_data" width="40%">
</div>
</div>
<div class="paragraph">
<p>　テキストを解析する際、そのテキストが持つ意味を考慮するためには、テキストを単なる文字列の集合と見なすのではなく、より踏み込んだ前処理が必要となります。そのため、テキストを単なる文字コード（intの離散値）の集合と見做し、これを数値的な特徴量として用いたとしても、テキストの意味的な解析は不可能です。このような場合、文字列長の分布や各漢字の出現頻度といった表層的な解析しかできなくなると推察されます。そのため、本チュートリアルでは、テキスト解析には別途の前処理を実行し、モデリングに適した特徴量を抽出します。（詳細は5.7.6節にて説明）</p>
</div>
<div class="paragraph">
<p>　各columnを見ると、テキストの単純なid番号を含む`article_id` と時刻情報を含む`publish_datetime` を除けば、データセット内で利用できそうなデータは <code>headline</code>, <code>keywords</code>, <code>classifications</code>, <code>company_g.stock_code</code> になりそうです。以下にこれらのデータサンプルを表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 表示するcolumnを定義する。</span>
columns = [<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">classifications</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">company_g.stock_code</span><span class="delimiter">'</span></span>]
<span class="keyword">for</span> column <span class="keyword">in</span> columns:
    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">#### {column}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)

    <span class="comment"># 欠損値が含まれることがあるため、どちらかに欠損値が存在するデータを除去する。</span>
    <span class="comment"># 同様のindexを持つ5個のサンプルデータを表示。</span>
    display(articles[columns].dropna()[column].head(<span class="integer">5</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下のとおりです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">headline
<span class="integer">10</span>                             ゴーン元会長<span class="error">、</span>周到な不意打ち出国<span class="error">　</span>司法批判の声明
<span class="integer">19</span>                                地銀が変わる<span class="error">、</span>始まったマニュアルなき大競争
<span class="integer">20</span>                                ＪＸＴＧ<span class="error">・</span>国際帝石<span class="error">、</span>ＵＡＥ新取引所に出資へ
<span class="integer">22</span>    元日付のこういうコラムは<span class="error">、</span>ふつうなら来し方行く末に思いをはせ<span class="error">、</span>まずは新年をことほぐものである...
<span class="integer">26</span>             Googleの最新AI<span class="error">、</span>読解力も人間超え<span class="error">　</span>驚異の学習法<span class="error">\</span>n超人間<span class="error">・</span>万能AI<span class="error">（</span>上<span class="error">）</span>
Name: headline, dtype: <span class="predefined">object</span>

keywords
<span class="integer">10</span>    カルロス<span class="error">・</span>ゴーン<span class="error">\</span>n日産自動車<span class="error">\</span>nグレッグ<span class="error">・</span>ケリー<span class="error">\</span>n弘中惇一郎<span class="error">\</span>nＭｕｓｉｃＴｅｌｅｖｉｓ...
<span class="integer">19</span>    金融検査マニュアル<span class="error">\</span>nマニュアル<span class="error">\</span>n笹原晶博<span class="error">\</span>n安田光春<span class="error">\</span>n金融機関<span class="error">\</span>n銀行<span class="error">\</span>n地方銀行<span class="error">\</span>n...
<span class="integer">20</span>    国際石油開発帝石<span class="error">\</span>nＩＣＥフューチャーズ<span class="error">・</span>アブダビ<span class="error">\</span>nＪＸＴＧホールディングス<span class="error">\</span>nアラブ首長...
<span class="integer">22</span>                春秋<span class="error">\</span>nカルロス<span class="error">・</span>ゴーン<span class="error">\</span>nコラム<span class="error">\</span>n来し方行く末<span class="error">\</span>n思い<span class="error">\</span>n日付<span class="error">\</span>n新年
<span class="integer">26</span>    中田敦<span class="error">\</span>nストックマーク<span class="error">\</span>nグーグル<span class="error">\</span>nＢＥＲＴ<span class="error">\</span>nＡＩ<span class="error">\</span>nＮＩＩ<span class="error">\</span>nロボット<span class="error">\</span>n言語モデル...
Name: keywords, dtype: <span class="predefined">object</span>

classifications
<span class="integer">10</span>    <span class="error">＄</span>絵写表記事<span class="error">\</span>nＴ<span class="error">７</span><span class="error">２</span><span class="error">０</span><span class="error">１</span><span class="error">\</span>nＰＤ<span class="error">２</span><span class="error">７</span><span class="error">１</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">０</span><span class="error">１</span><span class="error">３</span><span class="error">５</span><span class="error">１</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">４</span><span class="error">４</span><span class="error">３</span><span class="error">７</span><span class="error">１</span><span class="error">\</span>n<span class="error">＃</span>Ｗ<span class="error">５</span><span class="error">０</span>...
<span class="integer">19</span>    <span class="error">＄</span>絵写表記事<span class="error">\</span>nＴ<span class="error">８</span><span class="error">５</span><span class="error">２</span><span class="error">４</span><span class="error">\</span>nＰＤ<span class="error">４</span><span class="error">７</span><span class="error">３</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">７</span><span class="error">０</span><span class="error">０</span><span class="error">１</span><span class="error">７</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">７</span><span class="error">０</span><span class="error">０</span><span class="error">８</span><span class="error">７</span><span class="error">\</span>n<span class="error">＃</span>Ｗ<span class="error">２</span><span class="error">０</span>...
<span class="integer">20</span>    <span class="error">＄</span>絵写表記事<span class="error">\</span>nＴ<span class="error">１</span><span class="error">６</span><span class="error">０</span><span class="error">５</span><span class="error">\</span>nＴ<span class="error">５</span><span class="error">０</span><span class="error">２</span><span class="error">０</span><span class="error">\</span>nＰＤ<span class="error">３</span><span class="error">７</span><span class="error">２</span><span class="error">\</span>nＰＤ<span class="error">１</span><span class="error">１</span><span class="error">１</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">３</span><span class="error">１</span><span class="error">２</span><span class="error">１</span><span class="error">７</span><span class="error">\</span>n...
<span class="integer">22</span>    <span class="error">「</span>春秋<span class="error">」</span><span class="error">\</span>n<span class="error">＊</span>春秋<span class="error">\</span>nＴ<span class="error">７</span><span class="error">２</span><span class="error">０</span><span class="error">１</span><span class="error">\</span>nＰＤ<span class="error">２</span><span class="error">７</span><span class="error">１</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">０</span><span class="error">１</span><span class="error">３</span><span class="error">５</span><span class="error">１</span><span class="error">\</span>n<span class="error">＃</span>Ｗ<span class="error">５</span><span class="error">０</span><span class="error">３</span><span class="error">０</span><span class="error">５</span><span class="error">\</span>n<span class="error">＃</span>Ｗ...
<span class="integer">26</span>                       <span class="error">＄</span>絵写表記事<span class="error">\</span>nＴ<span class="error">９</span><span class="error">４</span><span class="error">３</span><span class="error">２</span><span class="error">\</span>nＰＤ<span class="error">６</span><span class="error">５</span><span class="error">１</span><span class="error">\</span>nＮ<span class="error">０</span><span class="error">０</span><span class="error">１</span><span class="error">５</span><span class="error">０</span><span class="error">０</span><span class="error">６</span>
Name: classifications, dtype: <span class="predefined">object</span>

company_g.stock_code
<span class="integer">10</span>          <span class="integer">7201</span>
<span class="integer">19</span>          <span class="integer">8524</span>
<span class="integer">20</span>    <span class="integer">1605</span><span class="error">\</span>n5020
<span class="integer">22</span>          <span class="integer">7201</span>
<span class="integer">26</span>          <span class="integer">9432</span>
Name: company_g.stock_code, dtype: <span class="predefined">object</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　本チュートリアルでは、ニュースのデータセットを用いて、そのニュースがマーケットに対して持っている潜在表現を特徴量として取得することを目的としています。</p>
</div>
<div class="paragraph">
<p>　上記で表示したcolumnごとのサンプルを見ると、`headline` のデータはニュースの要約内容であり、この中から潜在表現を抽出できそうです。また、`keywords` もニュースが持つ特性がキーワード化されたものであり、この中からも潜在表現を抽出できそうです。一方で、`classifications` は`keywords` と同様に、ニュースがもつ特性を表していますが、このままの状態では扱いにくく、`keywords` と重複する情報であるため、解析からは省きます。また、ニュースと株式銘柄を紐付ける`company_g.stock_code` は有力そうな情報ではありますが、あくまで数値でありテキスト解析の観点では適していません。よって、`headline` と`keywords` 及びニュースが公開された時刻を表す`publish_datetime` を保持し、他のデータは以下の手順で取り除いておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">articles = articles[[<span class="string"><span class="delimiter">'</span><span class="content">publish_datetime</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>]]

<span class="comment"># ニュース時刻をindexとしてセット</span>
articles = articles.set_index(<span class="string"><span class="delimiter">'</span><span class="content">publish_datetime</span><span class="delimiter">'</span></span>)

<span class="comment"># str形式のdatetimeをpd.Timestamp形式に変換</span>
articles.index = pd.to_datetime(articles.index)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み">5.5.3. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>　ここまでの処理を<code>load_articles</code>関数として <code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 生データから使用するコラムを設定する</span>
SentimentGenerator.article_columns = [<span class="string"><span class="delimiter">'</span><span class="content">publish_datetime</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>]

<span class="comment"># 上記のコードを用いて、本番提出用のクラスにclassmethodを追加</span>
<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">load_articles</span>(cls, path, start_dt=<span class="predefined-constant">None</span>, end_dt=<span class="predefined-constant">None</span>):
    <span class="comment"># csvをロードする</span>
    <span class="comment"># headline、keywordsをcolumnとして使用。publish_datetimeをindexとして使用。</span>
    articles =  pd.read_csv(path)[cls.article_columns].set_index(<span class="string"><span class="delimiter">'</span><span class="content">publish_datetime</span><span class="delimiter">'</span></span>)

    <span class="comment"># str形式のdatetimeをpd.Timestamp形式に変換</span>
    articles.index = pd.to_datetime(articles.index)

    <span class="comment"># 必要な場合、使用するデータの範囲を指定する</span>
    <span class="keyword">return</span> articles[start_dt:end_dt]


<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.load_articles = load_articles

<span class="comment"># SentimentGenerator使用する全体流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_データセットの前処理_2">5.6. データセットの前処理</h3>
<div class="paragraph">
<p>　多用な文字、記号が存在する日本語のテキスト解析において、データセットの前処理は非常に重要な処理です。例えば、日本語のテキストは、半角文字と全角文字が混在して使われる場合があります。同じテキスト内であっても、同じ単語が半角文字と全角文字で混在して使われる場合、人はそれらが単語が同じであることを認識できますが、モデルにおいては、異なる別の単語として認識されてしまいます。</p>
</div>
<div class="paragraph">
<p>　さらに、半角文字と全角文字が混在する単語が、学習時に観察していない単語(未知語, Out-of-Vocabulary等)である場合には、その意味は失われてしまい、結果としてテキスト全体の意味が崩れる可能性もあります。このような問題を防止するため、データセットの前処理として <strong>「テキストデータの正規化」</strong> が用いられます。</p>
</div>
<div class="paragraph">
<p>　本節では、使用するテキストデータがどのよう文字や記号で構成されていて、どのような期待していない文字や記号などを含んでいるかを確認します。更に、それらの期待していない情報に対して、置換処理や除去処理を実施する正規化方法を説明します。</p>
</div>
<div class="paragraph">
<p>　また、前処理の一つとして欠損値に対する処理があります。欠損値の確認は、そのデータを理解するための基本的な作業です。連続する数値データにおいて欠損値が存在する場合は補正や補完を行うことも可能ですが、ニュースデータは各々の記事が連続せず、独立した内容を含んでいることから、このような方法は適していません。本チュートリアルではheadline及びkeywords両方の特徴量を同時に用いるため、どちらか片方に欠損値が存在する場合は利用しないデータとみなし除去しています。</p>
</div>
<div class="sect3">
<h4 id="_欠損値除去">5.6.1. 欠損値除去</h4>
<div class="paragraph">
<p>まずは、欠損値があるかを確認します。確認する手順は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">articles.isnull().any()</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">headline    <span class="predefined-constant">False</span>
keywords     <span class="predefined-constant">True</span>
dtype: <span class="predefined">bool</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　どちらかに欠損値がある場合、そのデータを除去する処理を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 欠損値を取り除く</span>
articles = articles.dropna()
articles.isnull().any()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。欠損値が除去されていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">headline    <span class="predefined-constant">False</span>
keywords    <span class="predefined-constant">False</span>
dtype: <span class="predefined">bool</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_テキストデータの正規化">5.6.2. テキストデータの正規化</h4>
<div class="paragraph">
<p>　次に、本節で行うテキストデータの正規化についての概略を記載しています。それぞれ以下のとおり neologdn正規化、unicode正規化、マニュアル処理の3つに分けています。</p>
</div>
<div class="sect4">
<h5 id="_neologdn正規化">neologdn正規化</h5>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化前</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化後</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角英字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">半角英字</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角数字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">半角数字</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角スペース</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">半角スペース</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数回スペース</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一スペース</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">正しくないスペース</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">除去</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">半角カナ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角カナ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数回長音記号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一長音記号</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一部全角記号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">半角記号</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一部半角記号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">全角記号</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_unicode正規化">unicode正規化</h5>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化前</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化後</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">丸囲みの数字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">数字</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ローマ数字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アルファベット形式</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">単位</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アルファベットや日本語形式</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">省略文字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">記号及び日本語形式</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_マニュアル処理">マニュアル処理</h5>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化前</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>正規化後</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一部第一水準、第二水準漢字</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JISx0208に存在する漢字(<a href="https://ja.wikipedia.org/wiki/JIS_X_0208">Wikipedia: JIS X 0208</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一部不必要な記号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">除去</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">一部乱用記号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">置換</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>neologdn正規化及び、unicode正規化に関しては、実際のコードでは上記で記入していないパターンに関しても正規化を行っています。それぞれの詳細や関連リンクは後述します。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_全角文字の確認">5.6.3. 全角文字の確認</h4>
<div class="paragraph">
<p>　まずは全角スペース、全角アルファベット、全角数字が含まれているかを確認します。なお、"\u3000"は全角スペース、r"[Ａ-Ｚａ-ｚ]"は全角アルファベットの正規表現、r"[０-９]は全角数字の正規表現を表します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
    <span class="keyword">for</span> check_target <span class="keyword">in</span> [<span class="string"><span class="delimiter">&quot;</span><span class="char">\u3000</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[Ａ-Ｚａ-ｚ]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[０-９]</span><span class="delimiter">&quot;</span></span>]:
        display(f<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: {column}, Contains {check_target}: {articles[column].str.contains(check_target).any()}</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">Coulmn: headline, Contains </span><span class="char">\u3000</span><span class="content">: True</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: headline, Contains [Ａ-Ｚａ-ｚ]: True</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: headline, Contains [０-９]: True</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: keywords, Contains </span><span class="char">\u3000</span><span class="content">: True</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: keywords, Contains [Ａ-Ｚａ-ｚ]: True</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">Coulmn: keywords, Contains [０-９]: True</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　全角スペース、全角アルファベット、全角数字全てがテキストデータのコーパス内に含まれていることがわかります。それぞれの文字・記号を含む例を出力してみます。</p>
</div>
<div class="sect4">
<h5 id="_全角スペースを持つケース">全角スペースを持つケース</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">display(articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="char">\u3000</span><span class="delimiter">'</span></span>)][<span class="integer">0</span>])
display(articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="char">\u3000</span><span class="delimiter">'</span></span>)][<span class="integer">0</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">日米貿易協定が発効</span><span class="char">\u3000</span><span class="content">TPP土台に自由貿易圏拡大</span><span class="char">\n</span><span class="content">日本、RCEPに波及期待</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">米ツアー</span><span class="char">\u3000</span><span class="content">ズームアップ</span><span class="char">\n</span><span class="content">アダム・スコット</span><span class="char">\n</span><span class="content">グレッグ・ノーマン</span><span class="char">\n</span><span class="content">コリン・モリカワ</span><span class="char">\n</span><span class="content">コリン・モンゴメリー</span><span class="char">\n</span><span class="content">ゴルファー</span><span class="char">\n</span><span class="content">ゴルフジャーナリスト</span><span class="char">\n</span><span class="content">ジム・マッケイブ</span><span class="char">\n</span><span class="content">ジャスティン・ローズ</span><span class="char">\n</span><span class="content">スティーブ・エルキントン</span><span class="char">\n</span><span class="content">スティーブ・ジョーンズ</span><span class="char">\n</span><span class="content">スティーブ・ストリッカー</span><span class="char">\n</span><span class="content">セルヒオ・ガルシア</span><span class="char">\n</span><span class="content">タイガー・ウッズ</span><span class="char">\n</span><span class="content">ダスティン・ジョンソン</span><span class="char">\n</span><span class="content">デービス・ラブ３世</span><span class="char">\n</span><span class="content">トム・リーマン</span><span class="char">\n</span><span class="content">トム・ワトソン</span><span class="char">\n</span><span class="content">ニック・ファルド</span><span class="char">\n</span><span class="content">バッバ・ワトソン</span><span class="char">\n</span><span class="content">ビクトル・ホブラン</span><span class="char">\n</span><span class="content">ビジェイ・シン</span><span class="char">\n</span><span class="content">フィル・ミケルソン</span><span class="char">\n</span><span class="content">フレッド・カプルス</span><span class="char">\n</span><span class="content">ブラッド・ファクソン</span><span class="char">\n</span><span class="content">ベルンハルト・ランガー</span><span class="char">\n</span><span class="content">ポール・ケーシー</span><span class="char">\n</span><span class="content">マシュー・ウォルフ</span><span class="char">\n</span><span class="content">マスターズ・トーナメント</span><span class="char">\n</span><span class="content">マット・クーチャー</span><span class="char">\n</span><span class="content">マーク・オメーラ</span><span class="char">\n</span><span class="content">マーク・マクナルティ</span><span class="char">\n</span><span class="content">世界トップ</span><span class="char">\n</span><span class="content">主流</span><span class="char">\n</span><span class="content">尾崎将司</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_全角アルファベットを持つケース">全角アルファベットを持つケース</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">display(articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[Ａ-Ｚａ-ｚ]</span><span class="delimiter">&quot;</span></span>)][<span class="integer">0</span>])
display(articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[Ａ-Ｚａ-ｚ]</span><span class="delimiter">&quot;</span></span>)][<span class="integer">0</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">ＪＸＴＧ・国際帝石、ＵＡＥ新取引所に出資へ</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">政府</span><span class="char">\n</span><span class="content">米国政府</span><span class="char">\n</span><span class="content">東アジア地域包括的経済連携</span><span class="char">\n</span><span class="content">ＴＰＰ</span><span class="char">\n</span><span class="content">安倍晋三</span><span class="char">\n</span><span class="content">貿易協定</span><span class="char">\n</span><span class="content">自由貿易</span><span class="char">\n</span><span class="content">貿易</span><span class="char">\n</span><span class="content">関税</span><span class="char">\n</span><span class="content">発効</span><span class="char">\n</span><span class="content">日米</span><span class="char">\n</span><span class="content">撤廃</span><span class="char">\n</span><span class="content">波及</span><span class="char">\n</span><span class="content">双方</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_全角数字を持つケース">全角数字を持つケース</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">display(articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[０-９]</span><span class="delimiter">&quot;</span></span>)][<span class="integer">0</span>])
display(articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[０-９]</span><span class="delimiter">&quot;</span></span>)][<span class="integer">0</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">「雇用制度全般の見直しを」中西経団連会長</span><span class="char">\n</span><span class="content">経済３団体トップの年頭所感</span><span class="delimiter">'</span></span>
<span class="string"><span class="delimiter">'</span><span class="content">政府統計</span><span class="char">\n</span><span class="content">ダウ</span><span class="char">\n</span><span class="content">小幅高</span><span class="char">\n</span><span class="content">ダウ工業株３０種平均</span><span class="char">\n</span><span class="content">貿易協議</span><span class="char">\n</span><span class="content">株式市場</span><span class="char">\n</span><span class="content">米中</span><span class="char">\n</span><span class="content">米国株</span><span class="char">\n</span><span class="content">進展</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_neologdnを用いたテキストの正規化の挙動確認">5.6.4. neologdnを用いたテキストの正規化の挙動確認</h4>
<div class="paragraph">
<p>　ここでは、neologdnを用いて、先程確認した全角アルファベットや全角数字、また、その他の半角カタカナや一部の全角記号等に対して正規化を行います。neologdnの正規化規則に関して詳しい情報が必要な場合は <a href="https://github.com/neologd/mecab-ipadic-neologd/wiki/Regexp.ja">こちら</a> を参照して下さい。</p>
</div>
<div class="paragraph">
<p>　neologdnを用いたテキスト正規化の挙動を確認するため、以下のサンプルテキストを用意しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">text = <span class="string"><span class="delimiter">'</span><span class="content">全角アルファベット:Ａ, 全角数字:０, 全角スペース:　, 半角カナ:ｱ</span><span class="delimiter">'</span></span>

<span class="comment"># 正規化前のテキストを確認</span>
display(text)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　正規化前の出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">全角アルファベット:Ａ, 全角数字:０, 全角スペース:</span><span class="char">\u3000</span><span class="content">, 半角カナ:ｱ</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　neologdn.normalize関数を用いてよりテキストの正規化を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 正規化後を確認</span>
display(neologdn.normalize(text))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。全角アルファベットが半角アルファベットに、全角数字が半角数字に、全角スペースが半角スペースに、半角カタカナが全角カタカナになったことが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">全角アルファベット:A,全角数字:0,全角スペース: ,半角カナ:ア</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_neologdnを用いたテキストの正規化">5.6.5. neologdnを用いたテキストの正規化</h4>
<div class="paragraph">
<p>　neologdnの挙動が確認できましたので、neologdnを用いて本チュートリアルで用いるテキストデータ全体について正規化します。なお、正規化にあたって一つ注意すべきところがあります。今回使用している`keywords` のデータは、名詞で構成されている単語が半角スペースで区切られています。この場合、neologdnの仕様により正規化を行うことで、半角スペースが全て除去されてしまい、各keywordsが一つの大きなkeywordsとなってしまい、MeCabによる正しいトークナイズが不可能となってしまいます。そのため、半角スペースの情報が失われないように、一度半角スペースを全て改行コードに書き換え、正規化した後に当該改行コードを半角スペースに再変換する処理を行うことで、半角スペースの情報を維持するように正規化を行っています。MeCabによるトークナイズの際には、半角スペースが残っている状態であっても、半角スペースの情報は除去されるため問題ありません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
    articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>.join(x.split()))

    <span class="comment"># neologdnを使って正規化を行う。</span>
    articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: neologdn.normalize(x))

    <span class="comment"># 改行をスペースに置換する。</span>
    articles[column] = articles[column].str.replace(<span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>)

<span class="comment"># 変換後を確認する。</span>
display(articles.head(<span class="integer">5</span>))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_2">5.6.6. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>　ここまでの処理を<code>normalize_articles</code>関数として <code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 上記のコードを用いて、本番提出用のクラスにclassmethodを追加</span>
<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">normalize_articles</span>(cls, articles):
    articles = articles.copy()

    <span class="comment"># 欠損値を取り除く</span>
    articles = articles.dropna()

    <span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
        <span class="comment"># スペース(全角スペースを含む)はneologdn正規化時に全て除去される。</span>
        <span class="comment"># ここでは、スペースの情報が失われないように、スペースを全て改行に書き換え、正規化後スペースに再変換する。</span>
        articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>.join(x.split()))

        <span class="comment"># neologdnを使って正規化を行う。</span>
        articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: neologdn.normalize(x))

        <span class="comment"># 改行をスペースに置換する。</span>
        articles[column] = articles[column].str.replace(<span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>)

    <span class="keyword">return</span> articles

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.normalize_articles = normalize_articles

<span class="comment"># SentimentGenerator使用する全体流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])
articles = SentimentGenerator.normalize_articles(articles)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_テキスト内の記号情報について">5.6.7. テキスト内の記号情報について</h4>
<div class="paragraph">
<p>　テキスト内で記号が使われる場合がありますが、希少な記号や正しくない記号の使い方は、モデルがテキストを理解する上でノイズとなります。本節では、コーパス全体に含まれる記号を取得し、それらの記号がどのように使われているかを確認します。また、意味が薄いと思われる希少な記号は取り除きます。</p>
</div>
<div class="paragraph">
<p>　まず、記号の情報を取得するため、ochasenを用いてテキストから品詞情報を取得してみます。返り値は各々以下を表します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>表層形: 単語そのもの</p>
</li>
<li>
<p>発音: 単語の発音</p>
</li>
<li>
<p>原型: 同士であれば変化する前の原形, 他の品詞の場合は表層形と同様</p>
</li>
<li>
<p>形態素の品詞型: 形態素は言語学の用語で意味をもつ表現要素の最小単位であり、その形態素を文法的な働きごとに分けたもの</p>
</li>
<li>
<p>活用形: 単語が活用するときの形</p>
</li>
<li>
<p>活用型: 助動詞の活用をいくつかの型に分類したもの</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">parse_by_ochasen</span>(tagger, text):
    <span class="comment"># Ochasenでmecab-ipadic-neologdの辞書を使ったときの、返り値のデータ順は以下となる。</span>
    columns = [<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">発音</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">原型</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">活用形</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">活用型</span><span class="delimiter">'</span></span>]

    <span class="comment"># Ochasenよりコーパスタグ付けを行う。</span>
    parsed = [item.split(<span class="string"><span class="delimiter">'</span><span class="char">\t</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> item <span class="keyword">in</span> tagger.parse(text).split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>) <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string"><span class="delimiter">'</span><span class="content">EOS</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)]
    <span class="keyword">return</span> pd.DataFrame(parsed, columns=columns)

text = <span class="string"><span class="delimiter">'</span><span class="content">テストテキストです。「記号を探してみます!」</span><span class="delimiter">'</span></span>
parsed = parse_by_ochasen(tagger=ochasen, text=text)
display(parsed)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りとなります。形態素の品詞型における品詞情報を確認すると、記号が記号として正しく認識されていることがわかります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_5_wordclasses.png" alt="1_5_wordclasses" width="50%">
</div>
</div>
<div class="paragraph">
<p>　次に、品詞情報が記号である全ての記号を取得します。注意すべき点としては、MeCabでは記号の一部を「サ変接続」と認識してしまうことがあります。事例: <a href="https://blanktar.jp/blog/2013/06/mecab-misunderstand-symbol">MeCabさんが記号を「サ変接続」と認識してしまう</a></p>
</div>
<div class="paragraph">
<p>　今回の環境において、実際にこれらの挙動は確認できていませんが、念の為「サ変接続」の中で、「漢字、ひらがな、カタカナ、アルファベット」を含まないものを記号として扱うこととします。以下のコードを実行し取得した記号を変数`punctuation` として扱います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 記号として扱う品詞型を定義し、以下のflagに該当する品詞型を持つものだけを取得する。</span>
flags = [<span class="string"><span class="delimiter">&quot;</span><span class="content">記号</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">サ変接続</span><span class="delimiter">&quot;</span></span>]

<span class="comment"># ひらがな、カタカナ、漢字、アルファベットを含まない、記号を全て取得。</span>
punctuation_candidate = parsed[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>][parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: <span class="predefined">any</span>([flag <span class="keyword">in</span> x <span class="keyword">for</span> flag <span class="keyword">in</span> flags]))]

<span class="comment"># r&quot;[一-龯ぁ-んァ-ンA-Za-z々ゝゞヽヾヴヵヶ]は正規表現であり、「漢字、ひらがな、カタカナ、大文字アルファベット、小文字アルファベット、々ゝゞヽヾヴヵヶのいずれか」を表す。</span>
<span class="comment"># これらを含まないものを記号として扱う。</span>
punctuations = punctuation_candidate[~punctuation_candidate.str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[一-龯ぁ-んァ-ンA-Za-z々ゝゞヽヾヴヵヶ]</span><span class="delimiter">&quot;</span></span>)]
punctuations = <span class="predefined">set</span>(punctuations)

display(punctuations)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">!」</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">。</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">「</span><span class="delimiter">'</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　複合記号から単一記号を抽出し、集合に追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> punctuation <span class="keyword">in</span> punctuations:
    punctuations = punctuations | <span class="predefined">set</span>(punctuation)

display(<span class="predefined">set</span>(punctuations))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">!</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">!」</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">。</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">「</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">」</span><span class="delimiter">'</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　最終的に上記のコードをまとめ、コーパス全体から記号を取得する関数を作成し、記号を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">build_punctuations</span>(tagger, texts, flags = [<span class="string"><span class="delimiter">&quot;</span><span class="content">記号</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">サ変接続</span><span class="delimiter">&quot;</span></span>]):
    gc.collect()
    <span class="comment"># textsがpd.Seriesでない時に、pd.Seriesに変換</span>
    <span class="keyword">if</span> <span class="predefined">isinstance</span>(texts, pd.Series) <span class="keyword">is</span> <span class="predefined-constant">False</span>:
        texts = pd.Series(texts)

    punctuations = <span class="predefined">set</span>()

    <span class="keyword">for</span> text <span class="keyword">in</span> tqdm(texts):
        <span class="comment"># Ochasenより単語の品詞情報を取得</span>
        parsed = parse_by_ochasen(tagger=tagger, text=text)

        <span class="comment"># ひらがな、カタカナ、漢字、アルファベットを含まない、記号を全て取得</span>
        punctuation_candidate = parsed[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>][parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: <span class="predefined">any</span>([flag <span class="keyword">in</span> x.split(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> flag <span class="keyword">in</span> flags]))]
        punctuation_candidate = punctuation_candidate[~punctuation_candidate.str.contains(<span class="string"><span class="modifier">r</span><span class="delimiter">&quot;</span><span class="content">[一-龯ぁ-んァ-ンA-Za-z々ゝゞヽヾヴヵヶ]</span><span class="delimiter">&quot;</span></span>)]
        punctuations = punctuations | <span class="predefined">set</span>(punctuation_candidate.tolist())

    <span class="comment"># 複合記号から単一記号を抽出</span>
    <span class="keyword">for</span> punctuation <span class="keyword">in</span> punctuations:
        punctuations = punctuations | <span class="predefined">set</span>(punctuation)

    <span class="keyword">return</span> punctuations

headline_punctuations = build_punctuations(tagger=ochasen, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>])
keywords_punctuations = build_punctuations(tagger=ochasen, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　記号を含むテキストの例を表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># headlineから、これら記号を含むテキストを表示</span>
<span class="keyword">for</span> punctuation <span class="keyword">in</span> <span class="predefined">sorted</span>(headline_punctuations, key=<span class="keyword">lambda</span> x: <span class="predefined">len</span>(x)):
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">punctuation: {punctuation}</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: punctuation <span class="keyword">in</span> x)][<span class="integer">0</span>], <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)

<span class="comment"># keywordsから、これら記号を含むテキストを表示</span>
<span class="keyword">for</span> punctuation <span class="keyword">in</span> <span class="predefined">sorted</span>(keywords_punctuations, key=<span class="keyword">lambda</span> x: <span class="predefined">len</span>(x)):
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">punctuation: {punctuation}</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>][articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: punctuation <span class="keyword">in</span> x)][<span class="integer">0</span>], <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　記号や漢字の中には、パソコンの種類や環境に依存し、異なる環境で表示させた場合に、文字化けや表示できなくなる可能性のある文字「機種依存文字」が含まれます。これらの機種依存文字の中で記号の多くは、unicode正規化ライブラリを用いることで正規化することができます。また、星や音符などのあまり意味を持たない記号は取り除きます。一部の括弧は、見栄えのため用いられているだけであるため置換します。</p>
</div>
<div class="paragraph">
<p>　以下では、置換するターゲットと除去するターゲットを定義しています。機種依存文字の第一水準、第二水準漢字に関しては、その数が膨大であることから、名前などに多く使われる一部の漢字を以下で定義し、置換を行います(第一水準漢字・第二水準漢字は、日本語の情報処理を標準化する目的にJISが定めた定義であり、平仮名、片仮名、漢字などの日本語の文字コードを定義したものです)。置換する漢字のリストは、 <a href="https://qiita.com/mindwood/items/3cc4fbf76caa38aa743c">コチラ</a> から取得しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 機種依存文字の第一水準、第二水準漢字に関しては一部の漢字を以下で定義し、置換を行う。</span>
JISx0208_replace_dict = {
    <span class="string"><span class="delimiter">'</span><span class="content">髙</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">高</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">﨑</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">崎</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">濵</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">浜</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">賴</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">頼</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">瀨</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">瀬</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">德</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">徳</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">蓜</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">配</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">昻</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">昂</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">桒</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">桑</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">栁</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">柳</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">犾</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">犹</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">琪</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">棋</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">裵</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">裴</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">魲</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">鱸</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">羽</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">羽</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">焏</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">丞</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">祥</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">祥</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">曻</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">昇</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">敎</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">教</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">澈</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">徹</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">曺</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">曹</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">黑</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">黒</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">塚</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">塚</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">閒</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">間</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">彅</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">薙</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">匤</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">匡</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">冝</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">宜</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">埇</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">甬</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">鮏</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">鮭</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">伹</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">但</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">杦</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">杉</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">罇</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">樽</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">柀</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">披</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">﨤</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">返</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">寬</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">寛</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">神</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">神</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">福</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">福</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">礼</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">礼</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">贒</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">賢</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">逸</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">逸</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">隆</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">隆</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">靑</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">青</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">飯</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">飯</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">飼</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">飼</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">緖</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">緒</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">埈</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">峻</span><span class="delimiter">&quot;</span></span>,
}

<span class="comment"># 取得したpunctuationの観察から、置換すべき記号のdictionaryを作成する。</span>
punctuation_replace_dict = {
    **JISx0208_replace_dict,
    <span class="string"><span class="delimiter">'</span><span class="content">《</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">〈</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">》</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">〉</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">『</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">「</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">』</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">」</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">“</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">!!</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">!</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">〔</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">[</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">〕</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">]</span><span class="delimiter">'</span></span>,
     <span class="string"><span class="delimiter">'</span><span class="content">χ</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">x</span><span class="delimiter">'</span></span>
}

<span class="comment"># 取得したpunctuationの観察から、あまり意味を持たない記号のリストを作成し、これらを下記のコードで取り除く。</span>
punctuation_remove_list = [<span class="string"><span class="delimiter">'</span><span class="content">|</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">■</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">◆</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">●</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">★</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">☆</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">♪</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">〃</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">△</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">○</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">□</span><span class="delimiter">'</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　置換するために定義した機種依存文字の第一水準、第二水準漢字がデータの中に含まれている確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 観測された漢字をstoreするためのsetを定義</span>
catched_replace_targets = <span class="predefined">set</span>()
<span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">column: {column}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)

    <span class="comment"># 定義した置換すべき漢字がデータに含まれているかをチェック</span>
    <span class="keyword">for</span> key <span class="keyword">in</span> JISx0208_replace_dict.keys():

        <span class="comment"># articles[column]にその漢字が含まれている場合、catched_replace_targetsに追加する。</span>
        <span class="keyword">if</span> articles[column].str.contains(key).any():
            catched_replace_targets.update(key)

    <span class="comment"># 観測された漢字のsetを表示する</span>
    display(catched_replace_targets)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力は以下となります。機種依存文字の第一水準、第二水準漢字がデータの中に含まれていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">column: headline
{<span class="string"><span class="delimiter">'</span><span class="content">塚</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">彅</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">曺</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">礼</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">神</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">祥</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">福</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">羽</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">逸</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">隆</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">飯</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">飼</span><span class="delimiter">'</span></span>}

column: keywords
{<span class="string"><span class="delimiter">'</span><span class="content">塚</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">彅</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">德</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">曺</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">礼</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">神</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">祥</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">福</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">羽</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">逸</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">隆</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">飯</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">飼</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">髙</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">﨑</span><span class="delimiter">'</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　機種依存文字の丸囲みの数字、ローマ数字、単位、省略文字などは、unicodedataライブラリを用いたunicode正規化より置換を行います。正規化形式に関してはNFKC(Normalization Form Compatibility Composition)を用いています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># unicodedata.normalize関数より、unicode正規化を行う。</span>
text = <span class="string"><span class="delimiter">'</span><span class="content">丸囲みの数字:①, ローマ数字:Ⅷ, 単位:㎜㍉, 省略文字:㈱</span><span class="delimiter">'</span></span>
unicodedata.normalize(<span class="string"><span class="delimiter">'</span><span class="content">NFKC</span><span class="delimiter">'</span></span>, text)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りとなり、正規化が行われていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="string"><span class="delimiter">'</span><span class="content">丸囲みの数字:1, ローマ数字:VIII, 単位:mmミリ, 省略文字:(株)</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　コーパス全体のテキストから記号の置換及び除去を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
    <span class="comment"># punctuation_remove_listに含まれる記号を除去する</span>
    articles[column] = articles[column].str.replace(fr<span class="string"><span class="delimiter">&quot;</span><span class="content">[{''.join(punctuation_remove_list)}]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)

    <span class="comment"># punctuation_replace_dictに含まれる記号を置換する</span>
    <span class="keyword">for</span> replace_base, replace_target <span class="keyword">in</span> punctuation_replace_dict.items():
        articles[column] = articles[column].str.replace(replace_base, replace_target)

    <span class="comment"># unicode正規化を行う</span>
    articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: unicodedata.normalize(<span class="string"><span class="delimiter">'</span><span class="content">NFKC</span><span class="delimiter">'</span></span>, x))

<span class="comment"># 精製後確認</span>
articles.head(<span class="integer">10</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_3">5.6.8. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>　ここまでの処理を<code>handle_punctuations_in_articles</code>関数として <code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 作成した記号置換用のdictと記号削除用のリストをhandle_punctuations_in_articles関数内で使用するため、SentimentGeneratorに追加</span>
SentimentGenerator.punctuation_remove_list = punctuation_remove_list
SentimentGenerator.punctuation_replace_dict = punctuation_replace_dict

<span class="comment"># 上記のコードを用いて、本番提出用のクラスにclassmethodを追加</span>
<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">handle_punctuations_in_articles</span>(cls, articles):
    articles = articles.copy()

    <span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
        <span class="comment"># punctuation_remove_listに含まれる記号を除去する</span>
        articles[column] = articles[column].str.replace(fr<span class="string"><span class="delimiter">&quot;</span><span class="content">[{''.join(cls.punctuation_remove_list)}]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)

        <span class="comment"># punctuation_replace_dictに含まれる記号を置換する</span>
        <span class="keyword">for</span> replace_base, replace_target <span class="keyword">in</span> cls.punctuation_replace_dict.items():
            articles[column] = articles[column].str.replace(replace_base, replace_target)

        <span class="comment"># unicode正規化を行う</span>
        articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: unicodedata.normalize(<span class="string"><span class="delimiter">'</span><span class="content">NFKC</span><span class="delimiter">'</span></span>, x))

    <span class="keyword">return</span> articles

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.handle_punctuations_in_articles = handle_punctuations_in_articles

<span class="comment"># SentimentGenerator使用する全体流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])
articles = SentimentGenerator.normalize_articles(articles)
articles = SentimentGenerator.handle_punctuations_in_articles(articles)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_テキストデータの可視化">5.7. テキストデータの可視化</h3>
<div class="paragraph">
<p>　データセットの解析及び可視化は、データ自体の特性を理解する上で役に立つだけでなく、期待していない情報も含んでいるかどうかを確認する上でも役立ちます。本節では、扱うテキストデータががどのような特性を持っているのかを、品詞情報や単語の頻度により解析及び可視化し確認します。また、その結果に応じた前処理をデータセットに実施していきます。</p>
</div>
<div class="sect3">
<h4 id="_品詞情報取得">5.7.1. 品詞情報取得</h4>
<div class="paragraph">
<p>　ここからの解析や可視化処理は品詞情報を必要とします。品詞情報の取得処理には時間がかかるため、あらかじめコーパス全体において品詞情報を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># コーパス全体をochasenによってparseする。</span>
<span class="comment"># メモリー節約のため、解析で使用する['表層形', '形態素の品詞型']の情報のみを残す。</span>
parsed_headline_by_ochasen = articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: parse_by_ochasen(tagger=ochasen, text=x)[[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>]])
parsed_keywords_by_ochasen = articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: parse_by_ochasen(tagger=ochasen, text=x)[[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>]])

<span class="comment"># parseされたテキストデータを確認します。</span>
display(parsed_headline_by_ochasen.head())
display(parsed_keywords_by_ochasen.head())</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">publish_datetime
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>         表層形       形態素の品詞型
<span class="integer">0</span>      日  名詞-固有名詞-地域-国
...
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>      表層形     形態素の品詞型
<span class="integer">0</span>  人事       名詞-一般
<span class="integer">1</span>   <span class="error">、</span>     ...
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>       表層形     形態素の品詞型
<span class="integer">0</span>   人事       名詞-一般
<span class="integer">1</span>    <span class="error">、</span>  ...
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>         表層形     形態素の品詞型
<span class="integer">0</span>     人事       名詞-一般
<span class="integer">1</span>   ...
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>          表層形       形態素の品詞型
<span class="integer">0</span>       <span class="error">「</span>        記号-括弧...
Name: headline, dtype: <span class="predefined">object</span>

publish_datetime
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>                  表層形       形態素の品詞型
<span class="integer">0</span>             ...
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>                   表層形     形態素の品詞型
<span class="integer">0</span>  衆議院  名詞-固有名詞-組織
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>                   表層形     形態素の品詞型
<span class="integer">0</span>  外務省  名詞-固有名詞-組織
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>                 表層形     形態素の品詞型
<span class="integer">0</span>  厚生労働省  名詞-固有名詞-組織
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>              表層形        形態素の品詞型
<span class="integer">0</span>        中西宏明  名詞...
Name: keywords, dtype: <span class="predefined">object</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_品詞情報解析">5.7.2. 品詞情報解析</h4>
<div class="paragraph">
<p>　まずは、コーパス全体における品詞の分布を解析します。コーパス全体の品詞分布を調べる前に、単一テキストから品詞分布を取得してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">text = <span class="string"><span class="delimiter">'</span><span class="content">テストテキスト。コーパスの品詞情報を取得します。</span><span class="delimiter">'</span></span>

<span class="comment"># 品詞情報を取得するため、ochasenを用いる</span>
parsed = parse_by_ochasen(tagger=ochasen, text=text)
parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="integer">0</span>       名詞-サ変接続
<span class="integer">1</span>         名詞-一般
<span class="integer">2</span>         記号-句点
<span class="integer">3</span>         名詞-一般
<span class="integer">4</span>        助詞-連体化
<span class="integer">5</span>         名詞-一般
<span class="integer">6</span>         名詞-一般
<span class="integer">7</span>     助詞-格助詞-一般
<span class="integer">8</span>       名詞-サ変接続
<span class="integer">9</span>         動詞-自立
<span class="integer">10</span>          助動詞
<span class="integer">11</span>        記号-句点
Name: 形態素の品詞型, dtype: <span class="predefined">object</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　形態素の品詞型は、「名詞 サ変接続」などのように多重のクラスとして成り立っています。全体を掴むため、最上位の品詞型のみ（この場合名詞のみ）を取得するようにします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">word_classes = parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)[<span class="integer">0</span>])
word_classes</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="integer">0</span>      名詞
<span class="integer">1</span>      名詞
<span class="integer">2</span>      記号
<span class="integer">3</span>      名詞
<span class="integer">4</span>      助詞
<span class="integer">5</span>      名詞
<span class="integer">6</span>      名詞
<span class="integer">7</span>      助詞
<span class="integer">8</span>      名詞
<span class="integer">9</span>      動詞
<span class="integer">10</span>    助動詞
<span class="integer">11</span>     記号
Name: 形態素の品詞型, dtype: <span class="predefined">object</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　上で観察された品詞リストから、品詞ごとの数をカウントします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">word_classes.groupby(word_classes).count().to_dict()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">助動詞</span><span class="delimiter">'</span></span>: <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">助詞</span><span class="delimiter">'</span></span>: <span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">動詞</span><span class="delimiter">'</span></span>: <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">名詞</span><span class="delimiter">'</span></span>: <span class="integer">6</span>, <span class="string"><span class="delimiter">'</span><span class="content">記号</span><span class="delimiter">'</span></span>: <span class="integer">2</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　テキストごとに品詞の出現数を累積するため、出現数を品詞ごとにdict型で管理します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">count_of_word_classes = {}
<span class="comment"># key: 品詞型, value: カウント数</span>
<span class="keyword">for</span> key, value <span class="keyword">in</span> word_classes.groupby(word_classes).count().to_dict().items():
    <span class="comment"># 品詞が存在しない場合、新しく追加する。</span>
    <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> count_of_word_classes:
        count_of_word_classes[key] = value

    <span class="comment"># 品詞が存在する場合、既存のカウントに観察されたカウントを足す。</span>
    <span class="keyword">else</span>:
        count_of_word_classes[key] += value

<span class="comment"># 確認する</span>
count_of_word_classes</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">助動詞</span><span class="delimiter">'</span></span>: <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">助詞</span><span class="delimiter">'</span></span>: <span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">動詞</span><span class="delimiter">'</span></span>: <span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">名詞</span><span class="delimiter">'</span></span>: <span class="integer">6</span>, <span class="string"><span class="delimiter">'</span><span class="content">記号</span><span class="delimiter">'</span></span>: <span class="integer">2</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記で作成したコードをまとめて、コーパス全体から品詞情報を累積し取得する関数を作成しています。この関数は実行時間短縮のため、すでにochasenよりparseされた情報を入力としています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_count_of_word_classes</span>(parsed_by_ochasen):
    gc.collect()

    count_of_word_classes = {}

    <span class="keyword">for</span> parsed <span class="keyword">in</span> tqdm(parsed_by_ochasen):
        <span class="comment"># 一番大きいくくりの品詞型だけを取得する。</span>
        word_classes = parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)[<span class="integer">0</span>])

        <span class="comment"># 単一テキストの品詞カウントをdictionaryにアップデート</span>
        <span class="comment"># key: 品詞型, value: カウント数</span>
        <span class="keyword">for</span> key, value <span class="keyword">in</span> word_classes.groupby(word_classes).count().to_dict().items():
            <span class="comment"># dictionaryに品詞が存在しない場合、新しく追加する。</span>
            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> count_of_word_classes:
                count_of_word_classes[key] = value

            <span class="comment"># dictionaryに品詞が存在する場合、既存のカウントに観察されたカウントを足す。</span>
            <span class="keyword">else</span>:
                count_of_word_classes[key] += value

    <span class="keyword">return</span> pd.Series(count_of_word_classes).sort_values()

<span class="comment"># headline, keywords各々のコーパスから品詞情報を取得する。</span>
headline_count_of_word_classes = get_count_of_word_classes(parsed_by_ochasen=parsed_headline_by_ochasen)
keywords_count_of_word_classes = get_count_of_word_classes(parsed_by_ochasen=parsed_keywords_by_ochasen)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　それでは、2つのテキストデータ集合（<code>headline</code> 及び <code>keywords</code> ）について品詞型の分布を比較してみましょう。2つのテキストデータの品詞ごとの累計をpd.concatを用いて重ね、一つのテーブルにしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">count_of_word_classes_df = pd.concat([headline_count_of_word_classes.rename(<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>), keywords_count_of_word_classes.rename(<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>)], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>)

<span class="comment"># 確認する</span>
count_of_word_classes_df</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_wordclass_counts.png" alt="1_6_wordclass_counts" width="30%">
</div>
</div>
<div class="paragraph">
<p>　二つのテキストデータの品詞情報の分布を比較するため、それぞれのテキストデータ全体の単語数で各々を割り、品詞の割合情報を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">normalized_count_of_word_classes_df = count_of_word_classes_df / count_of_word_classes_df.sum()

<span class="comment"># 小数点6桁までで表示します。</span>
display(normalized_count_of_word_classes_df.applymap(<span class="string"><span class="delimiter">'</span><span class="content">{:,.6f}</span><span class="delimiter">'</span></span>.format))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_wordclass_distributions.png" alt="1_6_wordclass_distributions" width="30%">
</div>
</div>
<div class="paragraph">
<p>　<code>headline</code> と <code>keywords</code> の品詞情報の分布から、それぞれの特性を理解することができます。まず、keywordsは、名詞の割合が高いことがわかります。keywordsの名前の通り、各ニュースに関連するトピックの名詞情報が含まれていると想定されますが、その他の品詞情報も含まれていることから、少からず文章構造に近いキーワードも入っていることが想定されます。</p>
</div>
<div class="paragraph">
<p>　また、`headline` は、名詞以外にも助詞、動詞の割合も高く、テキストデータが文章構造を持っていると想定されます。また、正規化した上でも記号がかなり多く含まれているため、必要に応じてさらに記号に対する正規化や除去を行う必要があります。その際は、有意味な情報を持つ記号を除去しないように注意が必要です。</p>
</div>
<div class="paragraph">
<p>　次に、上で表示したテーブルからさらに細かく品詞分布の違いを理解するため可視化してみます。品詞毎の出現数がかなり不均等であるため、そのような場合に有用なtruncated barplotを用いて可視化しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 上下切断表示のため、縦二つのaxesを用意する。</span>
fig, ax = plt.subplots(<span class="integer">2</span>, <span class="integer">1</span>, sharex=<span class="predefined-constant">True</span>, figsize=(<span class="integer">12</span>, <span class="integer">5</span>))

<span class="comment"># 上下両方のaxesに同様のプロットを行う。</span>
normalized_count_of_word_classes_df.sort_values(<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>).plot(kind=<span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>, ax=ax[<span class="integer">0</span>])
normalized_count_of_word_classes_df.sort_values(<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>).plot(kind=<span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>, ax=ax[<span class="integer">1</span>])

<span class="comment"># 上下両方のy軸範囲を設定する。</span>
ax[<span class="integer">0</span>].set_ylim((normalized_count_of_word_classes_df).max().max() - <span class="float">0.9</span>, <span class="integer">1</span>)
ax[<span class="integer">1</span>].set_ylim(<span class="integer">0</span>, <span class="float">0.03</span>)

<span class="comment"># 上のaxesでは、bottom部分表示(ticker, labelなど)、下のaxesでは、top部分表示を除去する。</span>
ax[<span class="integer">0</span>].spines[<span class="string"><span class="delimiter">'</span><span class="content">bottom</span><span class="delimiter">'</span></span>].set_visible(<span class="predefined-constant">False</span>)
ax[<span class="integer">1</span>].spines[<span class="string"><span class="delimiter">'</span><span class="content">top</span><span class="delimiter">'</span></span>].set_visible(<span class="predefined-constant">False</span>)

ax[<span class="integer">0</span>].xaxis.tick_top()
ax[<span class="integer">0</span>].tick_params(labeltop=<span class="predefined-constant">False</span>)
ax[<span class="integer">1</span>].xaxis.tick_bottom()

<span class="comment"># プロット切断部に点線表示を行う。</span>
d = <span class="float">0.01</span>
kwargs = <span class="predefined">dict</span>(transform=ax[<span class="integer">0</span>].transAxes, color=<span class="string"><span class="delimiter">'</span><span class="content">k</span><span class="delimiter">'</span></span>,linestyle=<span class="string"><span class="delimiter">'</span><span class="content">:</span><span class="delimiter">'</span></span>, lw=<span class="integer">1</span>, clip_on=<span class="predefined-constant">False</span>)
ax[<span class="integer">0</span>].plot((-d, <span class="integer">1</span>+d), (<span class="integer">0</span>, <span class="integer">0</span>), **kwargs)

kwargs.update(transform=ax[<span class="integer">1</span>].transAxes)
ax[<span class="integer">1</span>].plot((-d, <span class="integer">1</span>+d), (<span class="integer">1</span>, <span class="integer">1</span>), **kwargs)

<span class="comment"># 上のaxesだけにlegendを表示するため、下のaxesではlegendを除去する。</span>
ax[<span class="integer">1</span>].legend().remove()

plt.tight_layout()
plt.xticks(rotation=<span class="integer">0</span>)
plt.show()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。`keywords` は、名詞の割合が高いことや、`headline` には助詞と同じ割合で記号が含まれていることがわかります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_wordclass_visualization.png" alt="1_6_wordclass_visualization">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wordcloudによる可視化">5.7.3. wordcloudによる可視化</h4>
<div class="paragraph">
<p>　単一テキスト、もしくはコーパス全体を可視化する主な手法として、そのコーパスに含まれる単語や形態素の頻度を可視化する方法があります。 ここではその代表的な手法であるwordcloudを用いたコーパス全体における単語の頻度情報の可視化を実施します。</p>
</div>
<div class="paragraph">
<p>　単語の可視化を行う前に、分析のノイズとなる*stopwords*(どのテキストにおいても多く登場し、特に重要な意味を持たないもの)を取得し、それらを排除します。本解析では、名詞、動詞、形容詞、副詞以外をstopwordsとしています。なお、名詞でも数値の情報を含む場合はstopwordsとしています。</p>
</div>
<div class="paragraph">
<p>　前節で記号情報を取得するため用いた、build_punctuations関数を少し変更し、stopwordsを取得するコードを作成します。おおよそのコードは同様ですが、大きな違いは、skip_flagsで取得する品詞型を定義するだけでなく、non_skip_flagsにより取得しない品詞型（数値）を定義する処理を追加しています。これは、名詞の品詞型を持つものの中で、数値の品詞型を持つものを取り除くために追加しています。なお、こちらのコードに関しても、実行時間短縮のためにすでにochasenよりparseされた情報を用いています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">build_stopwords</span>(parsed_by_ochasen, non_skip_flags=[<span class="string"><span class="delimiter">&quot;</span><span class="content">数</span><span class="delimiter">&quot;</span></span>], skip_flags = [<span class="string"><span class="delimiter">&quot;</span><span class="content">名詞</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">動詞</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">形容詞</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">副詞</span><span class="delimiter">&quot;</span></span>]):
    gc.collect()
    stopwords = <span class="predefined">set</span>()

    <span class="keyword">for</span> parsed <span class="keyword">in</span> tqdm(parsed_by_ochasen):
        <span class="comment"># non_skip_flagsが入っているものは全てstopwordsとして扱う</span>
        <span class="comment"># それ以外において、skip_flagsをひとつでも含んでいないものをstopwordsとして扱う</span>
        mask_include_non_skip_flags = parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: <span class="predefined">any</span>([non_skip_flag <span class="keyword">in</span> x.split(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> non_skip_flag <span class="keyword">in</span> non_skip_flags]))
        mask_exclude_skip_flags = parsed[<span class="string"><span class="delimiter">'</span><span class="content">形態素の品詞型</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: <span class="keyword">not</span> <span class="predefined">any</span>([skip_flag <span class="keyword">in</span> x.split(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>) <span class="keyword">for</span> skip_flag <span class="keyword">in</span> skip_flags]))

        <span class="comment">#日、月、年度のようなユニット情報を含むものは全てstopwordsとして扱う</span>
        mask_include_unit_info = parsed[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: <span class="predefined-constant">False</span> <span class="keyword">if</span> re.fullmatch(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">\d</span><span class="content">+(秒|分|時|日|月|カ月|年|人|ドル|円)</span><span class="delimiter">'</span></span>, x) <span class="keyword">is</span> <span class="predefined-constant">None</span> <span class="keyword">else</span> <span class="predefined-constant">True</span>)

        stopword_candidate = parsed[<span class="string"><span class="delimiter">'</span><span class="content">表層形</span><span class="delimiter">'</span></span>][mask_include_non_skip_flags | mask_exclude_skip_flags | mask_include_unit_info]

        <span class="comment"># stopwordsセットにアップデートする。</span>
        stopwords = stopwords | <span class="predefined">set</span>(stopword_candidate.tolist())

    <span class="comment"># 追加的に単一アルファベットをstopwordsとして追加する</span>
    stopwords = stopwords | <span class="predefined">set</span>(string.ascii_lowercase) | <span class="predefined">set</span>(string.ascii_uppercase)

    <span class="comment"># 追加的に単一数字をstopwordsとして追加する</span>
    stopwords = stopwords | <span class="predefined">set</span>([<span class="predefined">str</span>(idx) <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">10</span>)])

    <span class="keyword">return</span> stopwords

<span class="comment"># headline, keywords各々のコーパスからsubwordsを取得する。</span>
headline_stopwords = build_stopwords(parsed_by_ochasen=parsed_headline_by_ochasen)
keywords_stopwords = build_stopwords(parsed_by_ochasen=parsed_keywords_by_ochasen)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>headline</code> , <code>keywords</code> の各々から取得したstopwordsの集合を組み合わせています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">stopwords = headline_stopwords | keywords_stopwords

<span class="comment"># 表示するためにリストに変換する。</span>
stopwords_list = <span class="predefined">sorted</span>(stopwords)

<span class="comment"># 異なる特性を持つ色んなstopwordsを表示するためランダムにシャッフルする。</span>
random.Random(<span class="integer">0</span>).shuffle(stopwords_list)
print(stopwords_list[:<span class="integer">50</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[<span class="string"><span class="delimiter">'</span><span class="content">9302</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">243</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">456ドル</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">あれ</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">2678</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">259人</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">182ドル</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">3395円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">554</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">9985</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1775</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">100200</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">510円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">2430円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">4918</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1114</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1日</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">7038</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">向</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">963</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">9771円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">450ドル</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">39日</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">7068</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">5カ月</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">5168</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1001</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">11分</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">18年</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1931</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">123</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1834</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">4925円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">8分</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">454ドル</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">4788</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">181人</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">3097</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">280</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">3580円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">259円</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">6156</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">138ドル</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">4347</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">m</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">402</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">8240</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">417</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">6600</span><span class="delimiter">'</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　単語の頻度可視化方法の1つとしてwordcloudというものがあります。この方法は、頻度順に字の大きさが異なる等、全体の傾向を直感的に把握しやすい長所がありますが、逆にそれ以上の知見をなかなか得られないという短所もあります。</p>
</div>
<div class="paragraph">
<p>　wordcouldへの入力は、単語がスペースで区切られているテキストデータです。テキストデータ全体を入力とするには、テキストデータ全体が各々単語にスペースで区切られている必要があります。そのため文と文を区切る改行等を削除しスペースで区切るようにしています。具体的には、owakatiを用いてテキストデータをparseし、単語をスペースで区切り、その後テキスト毎にスペースで繋げています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tagger = owakati

words_with_space = articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: tagger.parse(x).strip(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>).rstrip())
words_with_space = <span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>.join(words_with_space)

<span class="comment"># 確認する</span>
print(words_with_space[:<span class="integer">200</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。期待通りの結果になっていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">日 米 貿易協定 が 発効 TPP 土台 に 自由貿易 圏 拡大 日本 <span class="error">、</span> RCEP に 波及 期待 人事 <span class="error">、</span> 衆院 人事 <span class="error">、</span> 外務省 人事 <span class="error">、</span> 厚生労働省 <span class="error">「</span> 雇用 制度 全般 の 見直し を <span class="error">」</span> 中西 経団連会長 経済3団体 トップ の 年頭 所感 首相 <span class="error">「</span> 全世代 安心 の 社会保障 へ 改革 <span class="error">」</span> 年頭 所感 天皇陛下 の 年頭 所感 全文 <span class="error">「</span> 災害 が ない <span class="integer">1</span>年 に <span class="error">」</span> 陛下 <span class="error">、</span> 新年</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記のコードをまとめ、wordcloudを可視化するための関数を定義しています。stopwordsに含まれる単語は表示対象から除外されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">display_wordcloud</span>(tagger, texts, stopwords, collocations):
    <span class="comment"># textsがpd.Seriesでない時に、pd.Seriesに変換</span>
    <span class="keyword">if</span> <span class="predefined">isinstance</span>(texts, pd.Series) <span class="keyword">is</span> <span class="predefined-constant">False</span>:
        texts = pd.Series(texts)

    <span class="comment"># テキストは単語別にスペースで区切りされ、テキストごとはスペースでつながっていることが期待値</span>
    words_with_space = texts.apply(<span class="keyword">lambda</span> x: tagger.parse(x).strip(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>).rstrip())
    words_with_space = <span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>.join(words_with_space)

    <span class="comment"># wordcloudを表示するため、パラメータを渡しインスタンス化する。</span>
    <span class="comment"># collocations=Falseの場合、連語による重複単語が表示されない。</span>
    wordcloud = WordCloud(
        background_color=<span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>,
        font_path=CONFIG[<span class="string"><span class="delimiter">'</span><span class="content">font_path</span><span class="delimiter">'</span></span>],
        stopwords=stopwords,
        width=<span class="integer">2000</span>,
        height=<span class="integer">1000</span>,
        collocations=collocations,
        random_state=<span class="integer">0</span>,
    ).generate(words_with_space)

    <span class="comment"># 表示サイズを設定し、表示する。</span>
    fig, ax = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">16</span>, <span class="integer">8</span>))
    ax.imshow(wordcloud, interpolation=<span class="string"><span class="delimiter">&quot;</span><span class="content">bilinear</span><span class="delimiter">&quot;</span></span>)
    plt.axis(<span class="string"><span class="delimiter">&quot;</span><span class="content">off</span><span class="delimiter">&quot;</span></span>)
    plt.show()</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記関数を用いて <code>headline</code> 及び <code>keywords</code> の各々のコーパスの頻度を可視化します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># headlineのwordcloud表示</span>
display_wordcloud(tagger=owakati, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>], stopwords=stopwords, collocations=<span class="predefined-constant">False</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　headlineのwordcloudは以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_headline_wordcloud.png" alt="1_6_headline_wordcloud">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># keywordsのwordcloud表示</span>
display_wordcloud(tagger=owakati, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>], stopwords=stopwords, collocations=<span class="predefined-constant">False</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　keywordsのwordcloudは以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_keywords_wordcloud.png" alt="1_6_keywords_wordcloud">
</div>
</div>
<div class="paragraph">
<p>　以上の結果から、以下のことが観察されます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>headlineに「人事」や「発売」、「コロナ」、「米」という単語が多く含まれていることがわかります。</p>
</li>
<li>
<p>keywordsには「新型」や「日」、「発表」という単語が多く含まれていることがわかります。</p>
</li>
<li>
<p>「東証」や「株式市場」などマーケット関連の単語が双方に多く含まれています。</p>
</li>
<li>
<p>「コロナ」や「コロナウィルス」などの新型コロナウィルスに関連する単語が双方に多く含まれています。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　これらの観察結果に注意して、次のscatter textの解析を実施します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_scatter_textによる可視化">5.7.4. scatter textによる可視化</h4>
<div class="paragraph">
<p>　頻度の可視化方法の一つに、頻度の情報だけでなく、その単語の一般性を表す使用分布も共に可視化できるscatter textというものがあります。</p>
</div>
<div class="paragraph">
<p>　scatter textをプロットするにあたり、wordcloudと同様に各々の単語がスペースで区切られている必要があります。しかし、こちらはwordcloudとは違い、コーパス全体を一つとして繋げる必要はありません。まず、wordcloudの時と同様にowakatiより、テキストをparseし、単語をスペースより区切ります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tokenized = articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].apply(<span class="keyword">lambda</span> x: tagger.parse(x).strip(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>).rstrip())

<span class="comment"># 確認する</span>
tokenized.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>続き、whitespace_nlp_with_sentences関数をテキスト毎に適用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">parsed = tokenized.apply(st.whitespace_nlp_with_sentences)

<span class="comment"># 確認する</span>
parsed.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　可視化のため、corpusインスタンスを作る必要があります。get_unigram_corpus関数を用いてbigramsをcorpusから取り除き、remove_terms関数よりstopwordsを取り除いています。また、remove_infrequent_words関数を用いて、出現頻度が100回以下の単語は除去しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">corpus = st.CorpusWithoutCategoriesFromParsedDocuments(
    parsed.rename(<span class="string"><span class="delimiter">'</span><span class="content">parse</span><span class="delimiter">'</span></span>).to_frame(), parsed_col=<span class="string"><span class="delimiter">'</span><span class="content">parse</span><span class="delimiter">'</span></span>
).build().get_unigram_corpus().remove_terms(stopwords, ignore_absences=<span class="predefined-constant">True</span>).remove_infrequent_words(minimum_term_count=<span class="integer">100</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　Dispersion関数を用いて、単語ごとの頻度情報及び使用分布情報を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">dispersion = st.Dispersion(corpus)
dispersion_df = dispersion.get_df()

<span class="comment"># ビルドされた頻度情報及び使用分布情報から、どの基準を用いてプロットするかをX, Xpos, Y, Yposのcolumnsにセットする。</span>
dispersion_df = dispersion_df.assign(
    X=<span class="keyword">lambda</span> df: df.Frequency,
    Xpos=<span class="keyword">lambda</span> df: st.Scalers.log_scale(df.X),
    Y=<span class="keyword">lambda</span> df: df[<span class="string"><span class="delimiter">&quot;</span><span class="content">Rosengren's S</span><span class="delimiter">&quot;</span></span>],
    Ypos=<span class="keyword">lambda</span> df: st.Scalers.scale(df.Y),
)

<span class="comment"># 確認する</span>
dispersion_df.head(<span class="integer">5</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_scattertext_prepare.png" alt="1_6_scattertext_prepare">
</div>
</div>
<div class="paragraph">
<p>　これまでと同様に上記で作成したコードをまとめて、scatter text可視化を行う関数を作成しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">display_scatter_text</span>(tagger, texts, stopwords, filename=<span class="string"><span class="delimiter">'</span><span class="content">out</span><span class="delimiter">'</span></span>):
    gc.collect()
    <span class="comment"># textsがpd.Seriesでない時に、pd.Seriesに変換。</span>
    <span class="keyword">if</span> <span class="predefined">isinstance</span>(texts, pd.Series) <span class="keyword">is</span> <span class="predefined-constant">False</span>:
        texts = pd.Series(texts)

    <span class="comment"># owakatiより、テキストをparseし、単語をスペースで区切り、whitespace_nlp_with_sentencesを適用。</span>
    tokenized = texts.apply(<span class="keyword">lambda</span> x: tagger.parse(x).strip(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>).rstrip())
    parsed = tokenized.apply(st.whitespace_nlp_with_sentences)

    <span class="comment"># bigrams及びstopwordsをcorpusから取り除き、出現頻度が100回以下の単語を除去する。</span>
    corpus = st.CorpusWithoutCategoriesFromParsedDocuments(
        parsed.rename(<span class="string"><span class="delimiter">'</span><span class="content">parse</span><span class="delimiter">'</span></span>).to_frame(), parsed_col=<span class="string"><span class="delimiter">'</span><span class="content">parse</span><span class="delimiter">'</span></span>
    ).build().get_unigram_corpus().remove_terms(stopwords, ignore_absences=<span class="predefined-constant">True</span>).remove_infrequent_words(minimum_term_count=<span class="integer">100</span>)

    <span class="comment"># Dispersion関数をより、単語ごとの頻度情報及び使用分布情報を取得。</span>
    dispersion = st.Dispersion(corpus)
    dispersion_df = dispersion.get_df()
    dispersion_df = dispersion_df.assign(
        X=<span class="keyword">lambda</span> df: df.Frequency,
        Xpos=<span class="keyword">lambda</span> df: st.Scalers.log_scale(df.X),
        Y=<span class="keyword">lambda</span> df: df[<span class="string"><span class="delimiter">&quot;</span><span class="content">Rosengren's S</span><span class="delimiter">&quot;</span></span>],
        Ypos=<span class="keyword">lambda</span> df: st.Scalers.scale(df.Y),
    )

    <span class="comment"># dataframe_scattertext関数より、可視化したhtmlをビルドできる。</span>
    html = st.dataframe_scattertext(
        corpus,
        plot_df=dispersion_df,
        ignore_categories=<span class="predefined-constant">True</span>,
        x_label=<span class="string"><span class="delimiter">'</span><span class="content">Log Frequency</span><span class="delimiter">'</span></span>,
        y_label=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rosengren's S</span><span class="delimiter">&quot;</span></span>,
        y_axis_labels=[<span class="string"><span class="delimiter">'</span><span class="content">More Dispersion</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Medium</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Less Dispersion</span><span class="delimiter">'</span></span>],
    )

    <span class="comment"># htmlを書き出します。Google Driveの該当箇所に出力されるため、出力されたhtmlファイルをダウンロードし、ブラウザで開いて御覧ください。</span>
    <span class="predefined">open</span>(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/visualizations/vis_{filename}_scatter.html</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span>).write(html)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここまで準備ができたら、まずは <code>headline</code> のテキストデータを用いてscatter text可視化を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 以下のコードを実行するとvisualizations配下にhtmlファイルが作成されます。作成されたファイルをブラウザで開いて確認ください。</span>
display_scatter_text(tagger=owakati, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>], stopwords=stopwords, filename=<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="Chapter05/images/1_6_scattertext_headline.png" alt="1_6_scattertext_headline"></span></p>
</div>
<div class="paragraph">
<p>　縦軸（y軸）は使用分布(Dispersion)を表します。y軸のDispersionは特定の単語がコーパス内でどれだけ均等に分布しているかを表す数値で、1 (Less Dispersion)に近いほどどのコーパスにも均等に現れる単語であり、0 (More Dispersion) に近いほど特定の分野でのみ現れていることを示しています。横軸（x軸）はコーパス全体における単語の使用頻度の対数スケールで表示しています。カーソルを単語に重ねると各単語の数値が表示されます。</p>
</div>
<div class="paragraph">
<p>　この図からも「米」、「コロナ」、「株式市場」、「人事」などの単語が多く使用されていることが分かります。これはwordcloudで観察した結果と似ています。さらに注目すべき点は、「人事」は使用頻度が高いにもかかわらず、使用分布が狭く、特定の分野でのみ使用されていることが分かります。この結果から、この単語を含むテキストはコーパス全体と性質が異なると想定できます。この単語が有意味な情報を含むかを判断し、追加的な前処理を実施する必要があるかを後ほど検討します。</p>
</div>
<div class="paragraph">
<p>　引き続き、 <code>keywords</code> のコーパスを用いてscatter text可視化を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">display_scatter_text(tagger=owakati, texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>], stopwords=stopwords, filename=<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="Chapter05/images/1_6_scattertext_keywords.png" alt="1_6_scattertext_keywords"></span></p>
</div>
<div class="paragraph">
<p>　<code>keywords</code> に関しても、「コロナウイルス」や、「株式市場」などが高頻度単語として観察されています。headlineにおける「人事」のような使用頻度と使用分布に著しい違いがある単語は観測できません。さらに追加的に解析を行いたい場合、品詞ごとにこれらの頻度や使用分布を可視化して解析することができます。品詞毎に、どのような単語が多く使われ、どのように分布しているかを観察し、コーパスの特性をさらに深く理解してみましょう。</p>
</div>
</div>
<div class="sect3">
<h4 id="_トピック解析">5.7.5. トピック解析</h4>
<div class="paragraph">
<p>　コーパス全体の特性を理解するために、そのコーパス全体がどのようなトピックで構成されているかを解析するトピックモデリングの手法があります。潜在ディリクレ配分法(Latent Dirichlet Allocation, LDA)は、その中でもトピックモデリングの代表的アルゴリズムです。</p>
</div>
<div class="paragraph">
<p>　LDAはコーパスがトピックの混合で成り立っていて、そのトピックが確率分布に従って単語を生成していると仮定し、その生成過程を逆に辿ることより、コーパス全体を構成するトピック情報を推定しています。LDAの学習時には、単語の頻度情報を持つメトリクスが用いられます。単語数が多くなり、メトリクスが大きくなるほど計算リソースが要求されます。ここでは現実的な処理時間で完了させるため、名詞以外の単語は全て取り除き解析しています。</p>
</div>
<div class="paragraph">
<p>　build_stopwords関数を用いて、品詞情報が名詞以外のものを全てinvalid_tokensとして扱っています。また、名詞の中でも数を品詞型として含む場合も同様にinvalid_tokensとして扱っています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">build_invalid_tokens</span>(parsed_by_ochasen, non_skip_flags=[<span class="string"><span class="delimiter">'</span><span class="content">数</span><span class="delimiter">'</span></span>], skip_flags = [<span class="string"><span class="delimiter">&quot;</span><span class="content">名詞</span><span class="delimiter">&quot;</span></span>]):
    <span class="keyword">return</span> build_stopwords(parsed_by_ochasen=parsed_by_ochasen, non_skip_flags=non_skip_flags, skip_flags=skip_flags)</code></pre>
</div>
</div>
<div class="paragraph">
<p>LDAの学習のために、owakatiを用いてトークナイズし、上記で定義したinvalid_tokensに含まれない名詞のみの単語にしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">tokenize_for_lda</span>(tagger, texts, invalid_tokens):
    <span class="comment"># textsがpd.Seriesでない時に、pd.Seriesに変換</span>
    <span class="keyword">if</span> <span class="predefined">isinstance</span>(texts, pd.Series) <span class="keyword">is</span> <span class="predefined-constant">False</span>:
        texts = pd.Series(texts)

    <span class="comment"># owakatiを用いてトークナイズする</span>
    tokenized = texts.apply(<span class="keyword">lambda</span> x: tagger.parse(x).split())

    <span class="comment"># 上記で定義したinvalid_tokensに含まれないトークンに精製する。</span>
    tokenized = tokenized.apply(<span class="keyword">lambda</span> x: [token <span class="keyword">for</span> token <span class="keyword">in</span> x <span class="keyword">if</span> token <span class="keyword">not</span> <span class="keyword">in</span> invalid_tokens])

    <span class="keyword">return</span> tokenized</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のtokenize_for_lda関数を用いてトークナイズし、その後単語のid、頻度をもつdictionaryを作り、gensim.models.ldamodel.LdaModelを用いてLDAを学習します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">build_ldamodel</span>(tagger, texts, invalid_tokens, num_topics=<span class="integer">10</span>):
    tokenized = tokenize_for_lda(tagger=tagger, texts=texts, invalid_tokens=invalid_tokens)

    <span class="comment"># 頻度情報をもつ単語辞書を作る</span>
    dictionary = gensim.corpora.Dictionary(tokenized)

    <span class="comment"># 生成されたcorpusは(word_id, word_frequency)の情報を持つ</span>
    corpus = [dictionary.doc2bow(text) <span class="keyword">for</span> text <span class="keyword">in</span> tokenized]

    ldamodel = gensim.models.ldamodel.LdaModel(corpus, num_topics=num_topics, id2word=dictionary, chunksize=<span class="integer">5000</span>, passes=<span class="integer">10</span>, random_state=<span class="integer">0</span>)

    <span class="keyword">return</span> ldamodel, corpus</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記で作成したコードを用いて可視化を行います。以下のトピック解析コードは高い計算リソースが要求され、長い実行時間が必要ですので、そのことに留意し実行しましょう。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ここでは二つの可視化を行います。まず、LDAモデルより推定されたトピックがどのような単語と関連が深いかを表示します。これにより、コーパス全体をクラスター化でき、それぞれのクラスターがどのような特性や性質を持つか理解することができます。その後、トピック(クラスター)ごとの分布を可視化します。これにより、トピックのコーパスに対する寄与度(周辺確率分布)やトピック間の距離などを確認できます。</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># headline, keywords両方において可視化を行う。</span>
<span class="keyword">for</span> column <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>]:
    parsed_by_ochasen = {
        <span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>: parsed_headline_by_ochasen,
        <span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>: parsed_keywords_by_ochasen,
    }[column]

    invalid_tokens = build_invalid_tokens(parsed_by_ochasen=parsed_by_ochasen)
    ldamodel, corpus = build_ldamodel(tagger=owakati, texts=articles[column], invalid_tokens=invalid_tokens)

    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">#### column: {column}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)

    <span class="comment"># 推定されたtopicと関連深い上位5つの単語をプリントする</span>
    <span class="keyword">for</span> topic <span class="keyword">in</span> ldamodel.print_topics(num_words=<span class="integer">5</span>):
        print(topic)

    <span class="comment"># トピック可視化</span>
    <span class="comment"># 可視化したトピックのidが0ではなく1から始まることに注意しましょう。</span>
    <span class="comment"># 左方の円は、各々の10個のトピックを表す。</span>
    <span class="comment"># 各円との距離は、それぞれトピックがどれだけ離れているかを表す。</span>
    vis = pyLDAvis.gensim.prepare(ldamodel, corpus, ldamodel.id2word, sort_topics=<span class="predefined-constant">False</span>)
    <span class="comment"># htmlを書き出します。出力されたhtmlファイルをダウンロードし、ブラウザで開いて御覧ください。</span>
    pyLDAvis.save_html(vis, f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/visualizations/vis_{column}_lda.html</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>headline</code> のトピックと関連する上位5つの単語の出力は以下の通りです。「米」と「中国」が同一のトピックに登場しやすいこと、「新型コロナ」、「感染」、「対策」が同一のトピックに登場しやすいことなど、直感に反しない結果が取得できていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">column: headline
(<span class="integer">0</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.035*&quot;減&quot; + 0.030*&quot;月&quot; + 0.025*&quot;期&quot; + 0.024*&quot;増&quot; + 0.018*&quot;東証&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.022*&quot;新型コロナ&quot; + 0.019*&quot;感染&quot; + 0.009*&quot;対策&quot; + 0.009*&quot;発行&quot; + 0.008*&quot;知事&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.014*&quot;政府&quot; + 0.013*&quot;バイデン&quot; + 0.013*&quot;オンライン&quot; + 0.012*&quot;欧州&quot; + 0.011*&quot;米&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">3</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.048*&quot;発売&quot; + 0.011*&quot;用&quot; + 0.011*&quot;型&quot; + 0.007*&quot;発表&quot; + 0.006*&quot;シリーズ&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">4</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.056*&quot;コロナ&quot; + 0.030*&quot;株&quot; + 0.026*&quot;米&quot; + 0.021*&quot;ぶり&quot; + 0.017*&quot;上昇&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">5</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.014*&quot;支援&quot; + 0.013*&quot;開始&quot; + 0.012*&quot;連携&quot; + 0.010*&quot;サービス&quot; + 0.008*&quot;活用&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">6</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.060*&quot;氏&quot; + 0.023*&quot;社長&quot; + 0.016*&quot;中国&quot; + 0.012*&quot;生産&quot; + 0.010*&quot;米&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">7</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.015*&quot;米国&quot; + 0.012*&quot;ロンドン&quot; + 0.011*&quot;発表&quot; + 0.009*&quot;市場&quot; + 0.009*&quot;年末年始&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">8</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.112*&quot;人事&quot; + 0.014*&quot;AI&quot; + 0.014*&quot;開発&quot; + 0.009*&quot;DX&quot; + 0.007*&quot;技術&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">9</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.016*&quot;発表&quot; + 0.013*&quot;調査&quot; + 0.009*&quot;機能&quot; + 0.009*&quot;県&quot; + 0.009*&quot;推進&quot;</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　各単語の前にある数値は、該当するトピックへの寄与度を表しています。コーパスを10個のトピックに分類した時に、それぞれのトピックの特性を寄与する単語から理解することができます。次に、pyLDAvisを用いて <code>headline</code> のトピックを可視化しています。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_lda_headline.png" alt="1_6_lda_headline">
</div>
</div>
<div class="paragraph">
<p>　ここからさらに細かな分析を行うことができます。上の左図の円はそれぞれのトピックを表しています。可視化におけるトピックの番号は1から始まることにご注意ください。各円間の距離は、トピックがそれぞれどれほど異なるかを表し、近いほど似ているトピックであることを表します。</p>
</div>
<div class="paragraph">
<p>　<code>keywords</code> のトピックとそれに関連する上位5つの単語の出力は以下の通りです。こちらもコロナウィルス関連や株式市場関連など、直感に反しない結果となっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">column: keywords
(<span class="integer">0</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.019*&quot;大学&quot; + 0.014*&quot;教授&quot; + 0.010*&quot;検査&quot; + 0.009*&quot;医療&quot; + 0.008*&quot;ポイント&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.050*&quot;コロナ&quot; + 0.019*&quot;社長&quot; + 0.011*&quot;生産&quot; + 0.011*&quot;工場&quot; + 0.010*&quot;中国&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.059*&quot;日&quot; + 0.057*&quot;発表&quot; + 0.032*&quot;新製品&quot; + 0.020*&quot;株式会社&quot; + 0.011*&quot;販売&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">3</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.029*&quot;連結決算&quot; + 0.028*&quot;売上高&quot; + 0.025*&quot;純利益&quot; + 0.024*&quot;減益&quot; + 0.024*&quot;決算&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">4</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.025*&quot;政府&quot; + 0.019*&quot;首相&quot; + 0.019*&quot;米国政府&quot; + 0.016*&quot;大統領&quot; + 0.013*&quot;米国&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">5</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.014*&quot;コロナ禍&quot; + 0.011*&quot;オンライン&quot; + 0.008*&quot;イベント&quot; + 0.007*&quot;時代&quot; + 0.006*&quot;サッカー&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">6</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.019*&quot;動向&quot; + 0.017*&quot;民間&quot; + 0.015*&quot;市場&quot; + 0.015*&quot;統計&quot; + 0.013*&quot;政府統計&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">7</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.046*&quot;新型&quot; + 0.042*&quot;ウイルス&quot; + 0.039*&quot;コロナウイルス&quot; + 0.026*&quot;感染&quot; + 0.024*&quot;株式市場&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">8</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.018*&quot;株&quot; + 0.017*&quot;ロンドン&quot; + 0.013*&quot;投資&quot; + 0.013*&quot;外為市場&quot; + 0.012*&quot;ドル&quot;</span><span class="delimiter">'</span></span>)
(<span class="integer">9</span>, <span class="string"><span class="delimiter">'</span><span class="content">0.009*&quot;事業&quot; + 0.009*&quot;連携&quot; + 0.008*&quot;AI&quot; + 0.007*&quot;業務提携&quot; + 0.007*&quot;GoTo&quot;</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、pyLDAvisを用いた <code>keywords</code> のトピックを可視化しています。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_lda_keywords.png" alt="1_6_lda_keywords">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_解析結果を活用した追加的なデータの前処理">5.7.6. 解析結果を活用した追加的なデータの前処理</h4>
<div class="paragraph">
<p>　ここまでの解析によって得られた知見から、追加的なデータの前処理を検討します。テキスト内にノイズとなり得る単語の規則性が確認できた場合や、テキスト自体が無意味であるかノイズとなり得る場合がないかを考察しましょう。</p>
</div>
<div class="paragraph">
<p>　前章での可視化及び解析を通じて、コーパス全体において、「人事」という単語が非常に高い頻度で観測されていました。しかし、CEO等の交代がプラスの効果を持つか、マイナスの効果を持つかはケースバイケースと思われるため、各社の人事情報をマーケットの予測に役立てる難易度は非常に高いと想定されます。このような仮説を基に、本チュートリアルでは人事の内容を含むニュースを除去しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># owakatiを用いて、'人事'の単語を含む記事を除去する方法もあるが、本番環境でのリソースを軽減させるため、単純に文字列から人事を含む全てのニュースの除去を行う。</span>
<span class="comment"># headlineもしくは、keywordsどちらかで人事を含むニュース記事のindexマスクを作成。</span>
drop_mask = articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="content">人事</span><span class="delimiter">'</span></span>) | articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="content">人事</span><span class="delimiter">'</span></span>)

<span class="comment"># '人事'を含む例を表示する</span>
articles[drop_mask].head()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter05/images/1_6_with_jinji.png" alt="1_6_with_jinji" width="50%">
</div>
</div>
<div class="paragraph">
<p>　'人事'という単語を含むニュースを取り除きます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">articles = articles[~drop_mask]

<span class="comment"># '人事'を含むニュースが存在するか確認する。</span>
(articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="content">人事</span><span class="delimiter">'</span></span>) | articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>].str.contains(<span class="string"><span class="delimiter">'</span><span class="content">人事</span><span class="delimiter">'</span></span>)).any()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。人事を含むニュースが存在しないことが分かり、正しく取り除くことができています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="predefined-constant">False</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_4">5.7.7. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>　ここまでの処理を<code>drop_remove_list_words</code>関数として <code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#上記のコードを用いて、本番提出用のクラスにclassmethodを追加</span>

<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">drop_remove_list_words</span>(cls, articles, remove_list_words=[<span class="string"><span class="delimiter">&quot;</span><span class="content">人事</span><span class="delimiter">&quot;</span></span>]):
    articles = articles.copy()

    <span class="keyword">for</span> remove_list_word <span class="keyword">in</span> remove_list_words:
        <span class="comment"># headlineもしくは、keywordsどちらかでremove_list_wordを含むニュース記事のindexマスクを作成</span>
        drop_mask = articles[<span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>].str.contains(remove_list_word) | articles[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>
        ].str.contains(remove_list_word)

        <span class="comment"># remove_list_wordを含まないニュースだけに精製する。</span>
        articles = articles[~drop_mask]

    <span class="keyword">return</span> articles

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.drop_remove_list_words = drop_remove_list_words

<span class="comment"># SentimentGeneratorに使用する全体の流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])
articles = SentimentGenerator.normalize_articles(articles)
articles = SentimentGenerator.handle_punctuations_in_articles(articles)
articles = SentimentGenerator.drop_remove_list_words(articles)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_特徴量抽出機前処理機の定義">5.8. 特徴量抽出機、前処理機の定義</h3>
<div class="paragraph">
<p>　ここまでの前処理等を踏まえ、BERTへテキストデータを投入する準備が整いました。ここからはBERTモデルを扱う上で必要な特徴量抽出時に使うデバイス（GPU）の定義、特徴量抽出のためのBERTモデルの定義、BERTモデルに係る前処理の定義等を行っていきます。</p>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_5">5.8.1. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p><code>SentimentGenerator</code> クラスに複数の関数を追加していきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">_set_device</span>(cls):
    <span class="comment"># 使用可能なgpuがある場合、そちらを利用し特徴量抽出を行う</span>
    <span class="keyword">if</span> torch.cuda.device_count() &gt;= <span class="integer">1</span>:
        cls.device = <span class="string"><span class="delimiter">'</span><span class="content">cuda</span><span class="delimiter">'</span></span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: GPU</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">else</span>:
        cls.device = <span class="string"><span class="delimiter">'</span><span class="content">cpu</span><span class="delimiter">'</span></span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: CPU</span><span class="delimiter">&quot;</span></span>)

<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">_build_feature_extractor</span>(cls):
    <span class="comment"># 特徴量抽出のため事前学習済みBERTモデルを用いる。</span>
    <span class="comment"># ここでは、&quot;cl-tohoku/bert-base-japanese-whole-word-masking&quot;モデルを使用しているが、異なる日本語BERTモデルを用いても良い。</span>
    cls.feature_extractor = (
        transformers.BertModel.from_pretrained(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">cl-tohoku/bert-base-japanese-whole-word-masking</span><span class="delimiter">&quot;</span></span>,
            return_dict=<span class="predefined-constant">True</span>,
            output_hidden_states=<span class="predefined-constant">True</span>,
        )
    )

    <span class="comment"># 使用するdeviceを指定</span>
    cls.feature_extractor = cls.feature_extractor.to(cls.device)

    <span class="comment"># 今回は特徴量抽出を行うのみであり、この事前モデル学習は行わないため、評価モードにセットする。</span>
    cls.feature_extractor.eval()

    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Built feature extractor</span><span class="delimiter">&quot;</span></span>)

<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">_build_tokenizer</span>(cls):
    <span class="comment"># BERTモデルの入力とするコーパスはそのBERTモデルが学習された時と同様の前処理を行う必要がある。</span>
    <span class="comment"># 今回使用する&quot;cl-tohoku/bert-base-japanese-whole-word-masking&quot;モデルは、mecab-ipadic-NEologdによりトークナイズされ、その後Wordpiece subword encoderよりsubword化している。</span>
    <span class="comment"># Subwordとは形態素に類似な概念として、単語をより小さい意味のある単位に変換したものである。</span>
    <span class="comment"># transformersのBertJapaneseTokenizerを用いることで、その事前学習モデルの学習時と同様の前処理を簡単に使用することができる。</span>
    <span class="comment"># そのため、ここではBertJapaneseTokenizerを利用し、トークナイズ及びsubword化を行う。</span>
    cls.bert_tokenizer = BertJapaneseTokenizer.from_pretrained(<span class="string"><span class="delimiter">&quot;</span><span class="content">cl-tohoku/bert-base-japanese-whole-word-masking</span><span class="delimiter">&quot;</span></span>)
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Built bert tokenizer</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator._set_device = _set_device
SentimentGenerator._build_feature_extractor = _build_feature_extractor
SentimentGenerator._build_tokenizer = _build_tokenizer

<span class="comment"># SentimentGenerator使用する全体流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])
articles = SentimentGenerator.normalize_articles(articles)
articles = SentimentGenerator.handle_punctuations_in_articles(articles)
articles = SentimentGenerator.drop_remove_list_words(articles)

SentimentGenerator._set_device()
SentimentGenerator._build_feature_extractor()
SentimentGenerator._build_tokenizer()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bertモデルを使用するための前処理">5.8.2. BERTモデルを使用するための前処理</h4>
<div class="paragraph">
<p>　本節では以下の2つの異なるトークナイザを用いてトークナイズした結果を比較し、それぞれの前処理の違いを確認してみます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SentimentGenerator.bert_tokenizer: mecab-ipadic-NEologd + Wordpiece</p>
</li>
<li>
<p>owakati: mecab-ipadic-NEologd</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">text = <span class="string"><span class="delimiter">'</span><span class="content">我らは走り出す。</span><span class="delimiter">'</span></span>
display(SentimentGenerator.bert_tokenizer.tokenize(text))
display(owakati.parse(text).split())</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。Subword化を行うbert_tokenizerの方がより小さい単位でトークン化されていることがわかります。このようなsubwordを用いると、学習時に出現していない単語(Out-of-Vocabulary)に関する問題を緩和させることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[<span class="string"><span class="delimiter">'</span><span class="content">我</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">##ら</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">は</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">走り</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">##出す</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">。</span><span class="delimiter">'</span></span>]
[<span class="string"><span class="delimiter">'</span><span class="content">我ら</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">は</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">走り出す</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">。</span><span class="delimiter">'</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　基本的にどのような言語モデルもトークナイズ後のトークンをそのまま受け取ることはできません。トークンを数字に対応させるためのid化が必要となります。事前学習モデルを用いる場合、各々のトークンはすでにidが付与されているため、モデルに入力するトークンデータをそのidに変換した上で、モデルの入力とする必要があります。BertJapaneseTokenizerのencodeメソッドはこのようなid化を行ってくれます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">display(SentimentGenerator.bert_tokenizer.encode(text))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[<span class="integer">2</span>, <span class="integer">3706</span>, <span class="integer">28469</span>, <span class="integer">9</span>, <span class="integer">7498</span>, <span class="integer">2813</span>, <span class="integer">8</span>, <span class="integer">3</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　以下のコードよりid化したトークンを、再びトークンに変換してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> <span class="predefined">id</span> <span class="keyword">in</span> SentimentGenerator.bert_tokenizer.encode(text):
    print(f<span class="string"><span class="delimiter">'</span><span class="content">{id}: {SentimentGenerator.bert_tokenizer.decode(id)}</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="integer">2</span>: [ C L S ]
<span class="integer">3706</span>: 我
<span class="integer">28469</span>: <span class="comment"># # ら</span>
<span class="integer">9</span>: は
<span class="integer">7498</span>: 走 り
<span class="integer">2813</span>: <span class="comment"># # 出 す</span>
<span class="integer">8</span>: <span class="error">。</span>
<span class="integer">3</span>: [ S E P ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　idをトークンに再び戻した時、元のデータには存在していなかった[CLS]と[SEP]が現れていることがわかります。この二つは `special tokens `と呼ばれ、[CLS]は全ての文章の先頭に位置し、文章の分類タスクを行う際に用いられるものです。また、[SEP]は複数の文章を区切るために用いられます。BERTへの入力は、必ずこのフォーマットに従う必要があります。</p>
</div>
<div class="paragraph">
<p>　BERTの入力値は上記で生成したtokenのids以外に, <code>token_type_ids</code> , <code>attention_mask</code> のベクトルを入力として受け取ります。 <code>token_type_ids</code> は複数の文章を区切るため用いられ、 <code>attention mask</code> は実際にトークンが存在する部分とzero paddingされた部分を区切るため用いられます。SentimentGenerator.bert_tokenizer.encode_plusメソッドによりこれらのベクトルを作ることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">encoded = SentimentGenerator.bert_tokenizer.encode_plus(
    text,
    <span class="predefined-constant">None</span>,
    add_special_tokens=<span class="predefined-constant">True</span>,
    return_token_type_ids=<span class="predefined-constant">True</span>,
    truncation=<span class="predefined-constant">True</span>,
)

<span class="comment"># 確認する</span>
encoded</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>: [<span class="integer">2</span>, <span class="integer">3706</span>, <span class="integer">28469</span>, <span class="integer">9</span>, <span class="integer">7498</span>, <span class="integer">2813</span>, <span class="integer">8</span>, <span class="integer">3</span>], <span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>: [<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>], <span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>: [<span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　これらはtorchモデルに入力するためにtensor形式に変換し、deviceを指定する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">input_ids = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)
token_type_ids = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)
attention_mask = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)

<span class="comment"># 確認する</span>
display(input_ids)
display(token_type_ids)
display(attention_mask)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tensor([[    <span class="integer">2</span>,  <span class="integer">3706</span>, <span class="integer">28469</span>,     <span class="integer">9</span>,  <span class="integer">7498</span>,  <span class="integer">2813</span>,     <span class="integer">8</span>,     <span class="integer">3</span>]])
tensor([[<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>]])
tensor([[<span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>]])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_特徴量抽出">5.8.3. 特徴量抽出</h4>
<div class="paragraph">
<p>　前処理の最後で取得した三つのベクトル[input_ids, token_type_ids, attention_mask]をBERTモデルへ入力し、そのoutputを取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">output = SentimentGenerator.feature_extractor(input_ids=input_ids, token_type_ids=token_type_ids, attention_mask=attention_mask)

<span class="comment"># outputをdictionary形式に変換し、その中からどのようなkeyが存在するかをみてみる。</span>
output.__dict__.keys()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　存在しているkeyは以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">dict_keys([<span class="string"><span class="delimiter">'</span><span class="content">last_hidden_state</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">pooler_output</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">hidden_states</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">past_key_values</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">attentions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">cross_attentions</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　各keyから取得できる情報は以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>last_hidden_state</code> にはモデルの最終層のhidden stateが格納されています。</p>
</li>
<li>
<p><code>pooler_output</code> にはモデル最終層出力の最初のトークンのhidden stateが格納されています。</p>
</li>
<li>
<p><code>hidden_states</code> にはモデル各層の出力全てのhidden stateが格納されています。</p>
</li>
<li>
<p><code>attentions</code> はattention softmax以降のattentions weightsが格納されています。</p>
</li>
<li>
<p><code>cross_attentions</code> はdecoderのcross-attention層における、attention softmax以降のattentions weightsが格納されています。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　一般的にBERTの特徴量とは、最終層の一つ前のhidden stateを指します。本チュートリアルでも、最終層の一つ前のhidden stateを抽出し、特徴量として用いています。</p>
</div>
<div class="paragraph">
<p>　hidden stateについて、最終層ではなく最終層の手前の情報を利用する理由は、最終層は個々の学習タスクに強く関連情報を持つことから、特徴量抽出には一般的により豊富な情報を持つ最終層の手前を使用します。この内容に関してより詳しく知りたい場合は<a href="https://bert-as-service.readthedocs.io/en/latest/section/faq.html#why-not-the-last-hidden-layer-why-second-to-last">こちら</a>をご参照下さい。</p>
</div>
<div class="paragraph">
<p>　以下のコードより特徴量を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">features = output[<span class="string"><span class="delimiter">'</span><span class="content">hidden_states</span><span class="delimiter">'</span></span>][-<span class="integer">2</span>]

<span class="comment"># 確認する。</span>
display(features)
display(features.size())</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tensor([[[-<span class="float">0.4128</span>, -<span class="float">0.1108</span>, -<span class="float">0.6859</span>,  ...,  <span class="float">0.5316</span>,  <span class="float">0.3867</span>,  <span class="float">0.4347</span>],
         [ <span class="float">0.7700</span>,  <span class="float">0.0892</span>,  <span class="float">0.7817</span>,  ..., -<span class="float">1.0288</span>,  <span class="float">0.4230</span>, -<span class="float">0.8906</span>],
         [ <span class="float">1.2572</span>,  <span class="float">0.3211</span>, -<span class="float">0.6861</span>,  ...,  <span class="float">0.0815</span>,  <span class="float">0.7084</span>, -<span class="float">1.0055</span>],
         ...,
         [ <span class="float">1.0648</span>, -<span class="float">1.3369</span>, -<span class="float">0.2810</span>,  ...,  <span class="float">0.5657</span>,  <span class="float">0.7713</span>, -<span class="float">0.6337</span>],
         [-<span class="float">0.3294</span>, -<span class="float">0.3912</span>,  <span class="float">0.2754</span>,  ..., -<span class="float">0.0620</span>,  <span class="float">1.1760</span>, -<span class="float">0.9139</span>],
         [ <span class="float">0.0639</span>,  <span class="float">0.2225</span>,  <span class="float">0.0474</span>,  ...,  <span class="float">0.1486</span>,  <span class="float">0.0587</span>,  <span class="float">0.0557</span>]]],
       grad_fn=&lt;NativeLayerNormBackward&gt;)

torch.Size([<span class="integer">1</span>, <span class="integer">8</span>, <span class="integer">768</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　<code>features</code> の次元を見ると、[1, 8, 768]の次元を持つことがわかります。これらは各々順番に[データ数、シーケンスサイズ、hidden stateのサイズ]を表しています。一つ注意すべきところは、長さの異なるsequenceを入力すると、以下のようにベクトルのサイズが変わってくることです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">text = <span class="string"><span class="delimiter">'</span><span class="content">こちらでは、より長い文章を用いて特徴量を抽出してみましょう。</span><span class="delimiter">'</span></span>
encoded = SentimentGenerator.bert_tokenizer.encode_plus(
    text,
    <span class="predefined-constant">None</span>,
    add_special_tokens=<span class="predefined-constant">True</span>,
    return_token_type_ids=<span class="predefined-constant">True</span>,
    truncation=<span class="predefined-constant">True</span>,
)

input_ids = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)
token_type_ids = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)
attention_mask = torch.tensor([encoded[<span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>]], dtype=torch.long).to(SentimentGenerator.device)

output = SentimentGenerator.feature_extractor(input_ids=input_ids, token_type_ids=token_type_ids, attention_mask=attention_mask)
features = output[<span class="string"><span class="delimiter">'</span><span class="content">hidden_states</span><span class="delimiter">'</span></span>][-<span class="integer">2</span>]

<span class="comment"># 確認する</span>
features.size()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。dimension1のシーケンスサイズの箇所の次元が変わっていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">torch.Size([<span class="integer">1</span>, <span class="integer">22</span>, <span class="integer">768</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　本チュートリアルではdimension1の次元を平均化し特徴量として扱うため、シークエンスの違いはそれほど問題とはなりませんが、並列化する上では問題となります。シーケンスの異なるベクトルを重ねることができないからです。このような問題を扱うため、subwordsのシーケンスのmax_lengthを決め、それより短い場合はmax_lengthの長さとなるように、ベクトルの末端を0で埋めるzero paddingがよく使われます。前処理を行う際にmax_lengthのパラメータを渡し、padding='max_legnth'を指定すると、max_lengthの長さがなるようにzero paddingすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">text = <span class="string"><span class="delimiter">'</span><span class="content">こちらでは、より長い文章を用いて特徴量を抽出してみましょう。</span><span class="delimiter">'</span></span>
encoded = SentimentGenerator.bert_tokenizer.encode_plus(
    text,
    <span class="predefined-constant">None</span>,
    max_length=<span class="integer">512</span>,
    padding=<span class="string"><span class="delimiter">'</span><span class="content">max_length</span><span class="delimiter">'</span></span>,
    add_special_tokens=<span class="predefined-constant">True</span>,
    return_token_type_ids=<span class="predefined-constant">True</span>,
    truncation=<span class="predefined-constant">True</span>,
)

<span class="comment"># 確認する</span>
encoded</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。zero paddingされていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>: [<span class="integer">2</span>, <span class="integer">4871</span>, <span class="integer">12</span>, <span class="integer">9</span>, <span class="integer">6</span>, <span class="integer">221</span>, <span class="integer">2894</span>, <span class="integer">7204</span>, <span class="integer">11</span>, <span class="integer">585</span>, <span class="integer">16</span>, <span class="integer">1427</span>, <span class="integer">1073</span>, <span class="integer">11</span>, <span class="integer">11674</span>, <span class="integer">15</span>, <span class="integer">16</span>, <span class="integer">546</span>, <span class="integer">17015</span>, <span class="integer">205</span>, <span class="integer">8</span>, <span class="integer">3</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>], <span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>: [<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>], <span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>: [<span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>　それでは、異なる長さを持つ複数の文章を用いて、paddingされたinputをモデルに同時に入力し並列に処理されるか確認してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">texts = [<span class="string"><span class="delimiter">'</span><span class="content">短いテキスト</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">少し長いテキストです</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">長い長い長い長いテキストです</span><span class="delimiter">'</span></span>]

input_ids = []
token_type_ids = []
attention_mask = []
<span class="keyword">for</span> text <span class="keyword">in</span> texts:
    encoded = SentimentGenerator.bert_tokenizer.encode_plus(
        text,
        <span class="predefined-constant">None</span>,
        add_special_tokens=<span class="predefined-constant">True</span>,
        max_length=<span class="integer">512</span>,
        padding=<span class="string"><span class="delimiter">&quot;</span><span class="content">max_length</span><span class="delimiter">&quot;</span></span>,
        return_token_type_ids=<span class="predefined-constant">True</span>,
        truncation=<span class="predefined-constant">True</span>,
    )

    input_ids.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>])
    token_type_ids.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>])
    attention_mask.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>])

input_ids = torch.tensor(input_ids, dtype=torch.long).to(SentimentGenerator.device)
token_type_ids = torch.tensor(token_type_ids, dtype=torch.long).to(SentimentGenerator.device)
attention_mask = torch.tensor(attention_mask, dtype=torch.long).to(SentimentGenerator.device)

output = SentimentGenerator.feature_extractor(input_ids=input_ids, token_type_ids=token_type_ids, attention_mask=attention_mask)
features = output[<span class="string"><span class="delimiter">'</span><span class="content">hidden_states</span><span class="delimiter">'</span></span>][-<span class="integer">2</span>]

<span class="comment"># 確認する</span>
features.size()</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。[3つの文章、シーケンスの長さ、hidden state]の次元の特徴量を取得でき、dimention1は指定したmax_lengthである512に一致していることがわかリます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">torch.Size([<span class="integer">3</span>, <span class="integer">512</span>, <span class="integer">768</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　本チュートリアルでは最終的に、dimension1を平均化して、各テキストごとに768次元のベクトルを特徴量として抽出します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">features = features.mean(dim=<span class="integer">1</span>)

<span class="comment"># 確認する</span>
features.size()</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">torch.Size([<span class="integer">3</span>, <span class="integer">768</span>])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_6">5.8.4. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>上記のコードを纏め、テキストから前処理を行い、モデル入力に必要な各々のベクトルを返す関数を <code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">build_inputs</span>(cls, texts, max_length=<span class="integer">512</span>):
    input_ids = []
    token_type_ids = []
    attention_mask = []
    <span class="keyword">for</span> text <span class="keyword">in</span> texts:
        encoded = cls.bert_tokenizer.encode_plus(
            text,
            <span class="predefined-constant">None</span>,
            add_special_tokens=<span class="predefined-constant">True</span>,
            max_length=max_length,
            padding=<span class="string"><span class="delimiter">&quot;</span><span class="content">max_length</span><span class="delimiter">&quot;</span></span>,
            return_token_type_ids=<span class="predefined-constant">True</span>,
            truncation=<span class="predefined-constant">True</span>,
        )

        input_ids.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">input_ids</span><span class="delimiter">'</span></span>])
        token_type_ids.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">token_type_ids</span><span class="delimiter">'</span></span>])
        attention_mask.append(encoded[<span class="string"><span class="delimiter">'</span><span class="content">attention_mask</span><span class="delimiter">'</span></span>])

    <span class="comment"># torchモデルに入力するためにはtensor形式に変え、deviceを指定する必要がある。</span>
    input_ids = torch.tensor(input_ids, dtype=torch.long).to(cls.device)
    token_type_ids = torch.tensor(token_type_ids, dtype=torch.long).to(cls.device)
    attention_mask = torch.tensor(attention_mask, dtype=torch.long).to(cls.device)

    <span class="keyword">return</span> input_ids, token_type_ids, attention_mask

<span class="comment"># 上記のコードでビルドしたベクトルをモデルに入力し、特徴量を抽出するコードを作成</span>
<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">generate_features</span>(cls, input_ids, token_type_ids, attention_mask):
    output = cls.feature_extractor(input_ids=input_ids, token_type_ids=token_type_ids, attention_mask=attention_mask)
    features = output[<span class="string"><span class="delimiter">'</span><span class="content">hidden_states</span><span class="delimiter">'</span></span>][-<span class="integer">2</span>].mean(dim=<span class="integer">1</span>).cpu().detach().numpy()

    <span class="keyword">return</span> features


<span class="comment"># コーパス全体から特徴量を抽出するため、コーパス全体を同時にモデルへ入力することはメモリーの上限を遥かに超えてしまうので不可能に近い。</span>
<span class="comment"># 入力するコーパスを数回に分割し、上記で作成したコードbuild_inputsとgenerate_featuresを用いて並列化処理を行うため、以下のコードを作成する。</span>
<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">generate_features_by_texts</span>(cls, texts, batch_size=<span class="integer">2</span>, max_length=<span class="integer">512</span>):
    n_batch = math.ceil(<span class="predefined">len</span>(texts) / batch_size)

    features = []
    <span class="keyword">for</span> idx <span class="keyword">in</span> tqdm(<span class="predefined">range</span>(n_batch)):
        input_ids, token_type_ids, attention_mask = cls.build_inputs(texts=texts[batch_size*idx:batch_size*(idx+<span class="integer">1</span>)], max_length=max_length)

        features.append(cls.generate_features(input_ids=input_ids, token_type_ids=token_type_ids, attention_mask=attention_mask))

    features = np.concatenate(features, axis=<span class="integer">0</span>)

    <span class="comment"># 抽出した特徴量はnp.ndarray形式となっており、これらは、日付の情報を失っているため、pd.DataFrame形式に変換する。</span>
    <span class="keyword">return</span> pd.DataFrame(features, index=texts.index)

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.build_inputs = build_inputs
SentimentGenerator.generate_features = generate_features
SentimentGenerator.generate_features_by_texts = generate_features_by_texts

<span class="comment"># SentimentGenerator使用する全体流れを記述</span>
articles = SentimentGenerator.load_articles(path=CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">article_path</span><span class="delimiter">&quot;</span></span>])
articles = SentimentGenerator.normalize_articles(articles)
articles = SentimentGenerator.handle_punctuations_in_articles(articles)
articles = SentimentGenerator.drop_remove_list_words(articles)

SentimentGenerator._set_device()
SentimentGenerator._build_feature_extractor()
SentimentGenerator._build_tokenizer()

<span class="comment"># 以下のコードでコーパス全体の特徴量を抽出できる。しかし、抽出には長い時間が要求されるため、注意。</span>
headline_features = SentimentGenerator.generate_features_by_texts(texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">headline</span><span class="delimiter">'</span></span>])
keywords_features = SentimentGenerator.generate_features_by_texts(texts=articles[<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　それでは上記のコードを実行し特徴量を抽出してみましょう。この処理は非常に時間がかかる(GPUがある環境で数時間、GPUがないと数十時間必要)ため、実行結果はPKLファイルで別途提供致します。詳細は<a href="#anchor-5.2">5.2. 実行環境</a>をご参照ください。もし、ご自分の環境で特徴量抽出を実行した場合は、その結果を以下のようにPKLファイルで保存しておくことをおすすめします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># pklファイルとして保存しておく。</span>
headline_features.to_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/headline_features/headline_features.pkl</span><span class="delimiter">'</span></span>)
keywords_features.to_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/keywords_features/keywords_features.pkl</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pcaによるスコア化">5.8.5. PCAによるスコア化</h4>
<div class="paragraph">
<p>　BERTで作成した特徴量は高次元の特徴量であり、機械学習モデルで利用する場合には、なんらかの単一のスコアに変換する必要があります。</p>
</div>
<div class="paragraph">
<p>　データの次元圧縮テクニックの一つとして主成分分析(PCA:principal component analysis)があります。主成分分析とは、多変量解析手法のうち次元削減手法としてよく用いられる手法の一種で、相関のある多変数から、相関のない少数で全体のばらつきを最もよく表す変数を合成するものです。(引用:<a href="https://qiita.com/maskot1977/items/082557fcda78c4cdb41f">Qiita:主成分分析を Python で理解する</a>)。PCAには通常のPCAとカーネルPCAがあり、２つの挙動はそれぞれ異なるので、用途などを考慮して使うものを決めます。 ( 引用: <a href="https://qiita.com/NoriakiOshita/items/138c10eada03938fcd79">カーネル主成分分析とは</a> )。</p>
</div>
<div class="paragraph">
<p>　例えば、以下のようなコードでPCAを用いて次元圧縮をすることで、BERTで作成した特徴量は単一のスコアになり、機械学習モデルの特徴量として扱いやすくなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 次元圧縮関数(PCA/KPCA)の定義</span>
<span class="keyword">def</span> <span class="function">_build_compressor</span>(compress_method):
    <span class="keyword">assert</span> compress_method <span class="keyword">in</span> (<span class="string"><span class="delimiter">'</span><span class="content">pca</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">kpca</span><span class="delimiter">'</span></span>)
    <span class="keyword">if</span> compress_method == <span class="string"><span class="delimiter">'</span><span class="content">pca</span><span class="delimiter">'</span></span>:
        <span class="keyword">return</span> PCA(n_components=<span class="integer">1</span>)

    <span class="keyword">if</span> compress_method == <span class="string"><span class="delimiter">'</span><span class="content">kpca</span><span class="delimiter">'</span></span>:
        <span class="keyword">return</span> KernelPCA(kernel=<span class="string"><span class="delimiter">'</span><span class="content">rbf</span><span class="delimiter">'</span></span>, n_components=<span class="integer">1</span>)

<span class="comment"># 次元圧縮処理を実施する関数</span>
<span class="keyword">def</span> <span class="function">compress_feature_n_samples</span>(features, compress_method, max_samples=<span class="integer">500</span>):
    feature_compressor = _build_compressor(compress_method=compress_method)
    compressed_features = pd.Series(feature_compressor.fit_transform(features).reshape(-<span class="integer">1</span>), index=features.index)

    sample_compressor = _build_compressor(compress_method=compress_method)

    weekly_group = pd.Series(<span class="predefined">zip</span>(compressed_features.index.year, compressed_features.index.week), index=compressed_features.index)
    grouped_compressed_features = compressed_features.groupby(weekly_group).apply(<span class="keyword">lambda</span> x: x[-max_samples:].reset_index(drop=<span class="predefined-constant">True</span>)).unstack()

    <span class="keyword">return</span> pd.Series(sample_compressor.fit_transform(grouped_compressed_features).reshape(-<span class="integer">1</span>), index=grouped_compressed_features.index)

<span class="comment"># 上記関数を用いてスコアを生成しPKLファイルに保存しています。モデルやバックテストに利用可能です。</span>
<span class="keyword">for</span> features, feature_type <span class="keyword">in</span> [(headline_features, <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>), (keywords_features, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>)]:
    <span class="keyword">for</span> compress_method <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">pca</span><span class="delimiter">'</span></span>]:
        compress_feature_n_samples(features=features, compress_method=compress_method).to_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{feature_type}_{compress_method}.pkl</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここで取得したPCAのスコアは、何か目的をもって学習させたものではないため、単体でポートフォリオに利用するのは難しいと思われますが、機械学習モデルの特徴量として、例えばrandom forestのモデルなどにはそのままPCAスコアを投入することが可能です。よりシンプルな利用方法として、例えばPCAのスコアと連動しやすい銘柄について相関係数などを利用して解析し、PCAスコアに合わせて次週の取引対象銘柄を限定するようなアプローチも考えられます。</p>
</div>
<div class="paragraph">
<p>　本章ではBERTを用いてニュースデータから特徴量抽出を行ってきました。本章の最後に紹介したPCAによる次元圧縮では、圧縮時に目的関数を設定することはできないために、特定の目的のためのスコアとは言えません。そこで次章では、リカレントニューラルネットワークであるLSTMを用いて、週毎の可変な特徴量を統合し単一のスコアにする手法を紹介し、このスコアを活用する方法を紹介していきます。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bert特徴量を用いてポートフォリオを構築しよう">6. BERT特徴量を用いてポートフォリオを構築しよう</h2>
<div class="sectionbody">
<div class="paragraph">
<p>　5章ではBERTを用いた特徴量抽出および簡単なPCAによるスコア化の手法を紹介しました。PCAは次元圧縮の代表的な手法ですが、次元圧縮時に目的関数を設定することができないために、特定の目的に合わせたスコアではありません。</p>
</div>
<div class="paragraph">
<p>　そのため，本章ではLSTMを用いて、週毎の可変な特徴量を統合し単一のスコアにする手法を紹介します。この手法を紹介する理由は、LSTMは目的関数を設定することができ、BERT特徴量から特定の目的に合致したスコアを構築することが可能となるためです。実際に特徴量を活用する場合は、その特徴量を用いて何かを予測したいと考えることが多く、目的変数を設定できるレイヤーを構築して、用途に特化したスコアを活用することがを可能となり、応用可能性が広がります。</p>
</div>
<div class="paragraph">
<p>　なお、本章はLSTMのようなディープニューラルネットワークを活用することに習熟している方を対象としており、アドバンスな知識を前提とした章となります。そのため、ディープニューラルネットワーク自体の説明はありません。5章で抽出した特徴量でも様々な活用が可能ですので、本章は発展的な内容としてご活用ください。</p>
</div>
<div class="paragraph">
<p>　本章の最後では、5章および6章のコードを使用したポートフォリオ構築モデルの実装例と動作確認方法を記載しているため、ご自身のモデルを実装される際に参考としてご活用ください。</p>
</div>
<div class="sect2">
<h3 id="_予測対象の検討">6.1. 予測対象の検討</h3>
<div class="paragraph">
<p>　5章でBERT特徴量の抽出を行いましたが、特徴量はニュース毎に取得できますので、毎週数千のニュースに対してそれぞれ特徴量が出力されることになります。まずは、この特徴量を活用して何を予測するか目的を決めます。</p>
</div>
<div class="paragraph">
<p>　シンプルに次の週にどの銘柄が値上がりするかを予測できれば、手っ取り早く収益を上げることができそうです。ただし、各週の数千個のニュースを利用して、次の週に値上がりする銘柄を予測するには、ニュース数と銘柄数のバランスを考えても少し難しい課題になりそうです。また、本コンペティションの課題においては、購入原資産全てを銘柄購入に利用する必要はなく、一部は現金で保持できることに着目します。</p>
</div>
<div class="paragraph">
<p>　マーケット全体が値下がりするときにすべての現金を銘柄購入に利用すると収益が低下する可能性があります。つまり、次の週にマーケットが下落することがわかれば、現金比率を高めることによって、マーケット全体の下落の影響を低減することができるはずです。実際に、マーケットの状況に応じて現金比率を操作する運用を実施するファンドも存在しています。</p>
</div>
<div class="paragraph">
<p>　以上の考察から、ニュースから抽出した特徴量を利用する予測モデルの予測対象としては、投資対象のユニバースの週次の平均リターンとし、BERT特徴量から下落の予兆を検知した場合は、現金比率を上げるという手法を採用することにします。他にもセクター（33業種分類など）のリターンを予測し、値上がりが予想されるセクターの代表的な銘柄を購入するなど様々な手法が考えられます。</p>
</div>
<div class="sect3">
<h4 id="_可変な特徴量を扱う方法">6.1.1. 可変な特徴量を扱う方法</h4>
<div class="paragraph">
<p>　各週で公表されるニュースの数は可変であるため、ニュースデータから毎週抽出できる特徴量の次元数も可変となります。一般的にモデル構築するときは投入する特徴量の次元数は固定化する必要がありますので、可変な特徴量を用いてモデルを設計する場合には工夫が必要です。例えば、以下のような方法が考えられます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>予測時点から直近X個のニュースを解析対象にすることで、特徴量の次元数を固定化する</p>
</li>
<li>
<p>特徴量をPCAなどの次元圧縮手法を用いて一つのスコアにする(5章で紹介した方法)</p>
</li>
<li>
<p>LSTMのような可変長の入力が可能なレイヤーを作る</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　本章では、学習時に目的関数を設定でき、特定の目的に特化したスコアを設計することができるLSTMを可変長入力が可能なレイヤーとして活用する方法を紹介します。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lstmによる可変特徴量の統合処理">6.2. LSTMによる可変特徴量の統合処理</h3>
<div class="paragraph">
<p>　この節では、LSTMのモデル作成及び、学習の方法を説明し、最終的にBERT特徴量を単一な特徴量として抽出する方法を説明します。</p>
</div>
<div class="sect3">
<h4 id="_bert特徴量ロード">6.2.1. BERT特徴量ロード</h4>
<div class="paragraph">
<p>　まずはBERT特徴量をロードします。BERT特徴量は5章でご自分で保存したもの、もしくは、 <a href="https://signate.jp/competitions/443/data">こちら</a> からダウンロードしたものをご利用ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">headline_features = pd.read_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/headline_features/headline_features.pkl</span><span class="delimiter">'</span></span>)
keywords_features = pd.read_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/keywords_features/keywords_features.pkl</span><span class="delimiter">'</span></span>)

<span class="comment"># 確認する。</span>
headline_features.head(<span class="integer">3</span>)
keywords_features.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_データのロード">6.2.2. データのロード</h4>
<div class="paragraph">
<p>　LSTMの学習時に用いるラベル(投資対象のユニバースの平均の週次リターン)を作成するため、株の価格情報と銘柄情報をロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># stock_priceとstock_listをロードします。</span>
stock_price = pd.read_csv(CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price_path</span><span class="delimiter">&quot;</span></span>])
stock_list = pd.read_csv(CONFIG[<span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list_path</span><span class="delimiter">&quot;</span></span>])

<span class="comment"># 確認する</span>
stock_price.head(<span class="integer">3</span>)
stock_list.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　stock_listから投資対象銘柄を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">codes = stock_list[stock_list[<span class="string"><span class="delimiter">&quot;</span><span class="content">universe_comp2</span><span class="delimiter">&quot;</span></span>] == <span class="predefined-constant">True</span>][
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>
].values</code></pre>
</div>
</div>
<div class="paragraph">
<p>　投資対象銘柄を使用してstock_priceの銘柄を絞り込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">stock_price = stock_price.loc[stock_price.loc[:, <span class="string"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>].isin(codes)]</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ロードしたデータの生成を行います。まず、stock_priceを扱いやすい形に変換します。データのうち ['EndOfDayQuote Date', 'Local Code', "EndOfDayQuote Open", "EndOfDayQuote ExchangeOfficialClose"] のcolumnをラベル作成のために使用します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EndOfDayQuote Date: データの日付</p>
</li>
<li>
<p>Local Code: 銘柄コード</p>
</li>
<li>
<p>EndOfDayQuote Open: 始値</p>
</li>
<li>
<p>EndOfDayQuote ExchangeOfficialClose: 終値</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">stock_price = stock_price[[<span class="string"><span class="delimiter">'</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Local Code</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>]]

<span class="comment"># それぞれのcolumn名をわかりやすく変更する</span>
stock_price = stock_price.rename(columns={
    <span class="string"><span class="delimiter">'</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">Local Code</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">asset</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">open</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">close</span><span class="delimiter">'</span></span>,
})

<span class="comment"># データごとにindex形式が異なると大変扱いにくい。下記のコードより特徴量と同様のindexの形式を変更する。</span>
<span class="comment"># pd.to_datetimeより、string形式の日付をpd.Timestamp形式に変換する</span>
<span class="comment"># pd.Timestamp形式をpd.DatetimeIndex形式に変更し、time zoneをheadline_featuresと同様に設定する。</span>
<span class="comment"># この際、headline_featuresとkeywords_featuresはarticlesのindexを使用しているため、timezoneが一致している。どちらを用いても良い。</span>
stock_price[<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>] = pd.to_datetime(stock_price[<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>])
stock_price[<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>] = pd.DatetimeIndex(stock_price[<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>]).tz_localize(headline_features.index.tz)

<span class="comment"># indexを['date', 'asset']順のpd.MultiIndex形式として設定する。</span>
stock_price = stock_price.set_index([<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">asset</span><span class="delimiter">'</span></span>]).sort_index()

<span class="comment"># unstack()より銘柄情報をcolumnに移動させる。</span>
stock_price = stock_price.unstack()

<span class="comment"># 今回使用するデータは2020年以降のデータであるので、2020年以前のデータを切り捨てる。</span>
stock_price = stock_price[<span class="string"><span class="delimiter">'</span><span class="content">2020-01-01</span><span class="delimiter">'</span></span>:]

<span class="comment"># 確認する</span>
display(stock_price.head())</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。stock_priceを以下のような形式を持つように変更しました。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_9_stock_price.png" alt="1_9_stock_price">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_週ごとにグループされた特徴量とラベルの作成">6.2.3. 週ごとにグループされた特徴量とラベルの作成</h4>
<div class="paragraph">
<p>　各週ごとの特徴量を統合するためには、週ごとの全ての特徴量をグループ化すると扱いやすくなります。ここでは、週ごとに特徴量と価格情報をグループ化する方法を説明します。また、週ごとの価格情報をグループ化し、週次の平均リターンを計算し、ラベルを作成する方法を説明します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_7">6.2.4. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p><code>SentimentGenerator</code>クラスに ""_build_weekly_group"" 関数を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">_build_weekly_group</span>(cls, df):
    <span class="comment"># index情報から、(year, week)の情報を得る。</span>
    <span class="keyword">return</span> pd.Series(<span class="predefined">list</span>(<span class="predefined">zip</span>(df.index.year, df.index.week)), index=df.index)

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator._build_weekly_group = _build_weekly_group

<span class="comment"># 特徴量に適用してみる</span>
display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### features</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
features = headline_features
weekly_group = SentimentGenerator._build_weekly_group(df=features)
display(weekly_group.head(<span class="integer">3</span>))
display(weekly_group.tail(<span class="integer">3</span>))

<span class="comment"># プライスに適用してみる。</span>
<span class="comment"># stock priceの2020年の1週目は、データが存在しないため、2020年の２週目から存在することがわかる。</span>
<span class="comment"># これらのindexをマッチさせる方法は後ほど説明する。</span>
display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### stock price</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
weekly_group = SentimentGenerator._build_weekly_group(stock_price)
display(weekly_group.head(<span class="integer">3</span>))
display(weekly_group.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">features
publish_datetime
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">1</span>)
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">1</span>)
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">01</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">1</span>)
dtype: <span class="predefined">object</span>
publish_datetime
<span class="integer">2020</span>-<span class="integer">12</span>-<span class="integer">31</span> <span class="integer">23</span>:<span class="octal">00</span>:<span class="octal">00</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">53</span>)
<span class="integer">2020</span>-<span class="integer">12</span>-<span class="integer">31</span> <span class="integer">23</span>:<span class="integer">12</span>:<span class="integer">31</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">53</span>)
<span class="integer">2020</span>-<span class="integer">12</span>-<span class="integer">31</span> <span class="integer">23</span>:<span class="integer">26</span>:<span class="integer">35</span>+<span class="integer">09</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">53</span>)
dtype: <span class="predefined">object</span>

labels
index
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">06</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">2</span>)
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="octal">07</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">2</span>)
<span class="integer">2020</span>-<span class="octal">01</span>-<span class="integer">08</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2020</span>, <span class="integer">2</span>)
dtype: <span class="predefined">object</span>
index
<span class="integer">2021</span>-<span class="octal">01</span>-<span class="integer">27</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2021</span>, <span class="integer">4</span>)
<span class="integer">2021</span>-<span class="octal">01</span>-<span class="integer">28</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2021</span>, <span class="integer">4</span>)
<span class="integer">2021</span>-<span class="octal">01</span>-<span class="integer">29</span> <span class="octal">00</span>:<span class="octal">00</span>:<span class="octal">00</span>-<span class="octal">05</span>:<span class="octal">00</span>    (<span class="integer">2021</span>, <span class="integer">4</span>)
dtype: <span class="predefined">object</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　特徴量を週ごとにグループ化してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">weekly_group = SentimentGenerator._build_weekly_group(df=features)
features = features.groupby(weekly_group).apply(<span class="keyword">lambda</span> x: x[:])

<span class="comment"># 確認する</span>
features.head(<span class="integer">3</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。週の情報がindexのlevel0に付与され、グループ化されていることが分かります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_grouped_features.png" alt="1_7_grouped_features">
</div>
</div>
<div class="paragraph">
<p>　続いて、trainとtestを区切る週をboundary_weekとして設定し、train用に用いられる特徴量と、test用に用いられる特徴量を区切ります。boundry_weekは26とし、trainとtestを52週の半分、つまり、2020年前半のニュースを訓練用データ、2020年後半のニュースをテストデータとしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">boundary_week = (<span class="integer">2020</span>, <span class="integer">26</span>)
train_features = features[features.index.get_level_values(<span class="integer">0</span>) &lt;= boundary_week]
test_features = features[features.index.get_level_values(<span class="integer">0</span>) &gt; boundary_week]

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### train_features</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(train_features.head(<span class="integer">3</span>))
display(train_features.tail(<span class="integer">3</span>))

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### test_features</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(test_features.head(<span class="integer">3</span>))
display(test_features.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_grouped_train_features.png" alt="1_7_grouped_train_features">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_grouped_test_features.png" alt="1_7_grouped_test_features">
</div>
</div>
<div class="paragraph">
<p>　ここでは、LSTMの学習に係るのラベルデータを作成するために、stock priceを週ごとにグループ化し、翌週の週初営業日の始値から週末営業日の終値にかけての平均リターンを作成する方法を説明します。まずは、当週の週初営業日の始値から週末営業日の終値にかけての平均リターンを作成してみましょう。週次の平均リターンを作成する関数を<code>_compute_weekly_return</code>として定義します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_compute_weekly_return</span>(x):
    <span class="comment"># その週の初営業日のopenから最終営業日のcloseまでのリターンを計算する。</span>
    weekly_return = ((x[<span class="string"><span class="delimiter">'</span><span class="content">close</span><span class="delimiter">'</span></span>].iloc[-<span class="integer">1</span>] - x[<span class="string"><span class="delimiter">'</span><span class="content">open</span><span class="delimiter">'</span></span>].iloc[<span class="integer">0</span>]) / x[<span class="string"><span class="delimiter">'</span><span class="content">open</span><span class="delimiter">'</span></span>].iloc[<span class="integer">0</span>])

    <span class="comment"># その日のvolumneが0であるデータは、openが0となっている。</span>
    <span class="comment"># openが0の場合、np.infの値となっているため、np.nanに変換し除去する。</span>
    <span class="comment"># 銘柄ごとのリターンを単純平均し、marketのweekly_returnを計算する。</span>
    <span class="keyword">return</span> weekly_return.replace([np.inf, -np.inf], np.nan).dropna().mean()

weekly_group = SentimentGenerator._build_weekly_group(df=stock_price)
weekly_return = stock_price.groupby(weekly_group).apply(_compute_weekly_return)

display(weekly_return.head(<span class="integer">3</span>))
display(weekly_return.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">(<span class="integer">2020</span>, <span class="integer">2</span>)    <span class="float">0.017291</span>
(<span class="integer">2020</span>, <span class="integer">3</span>)   -<span class="float">0.007994</span>
(<span class="integer">2020</span>, <span class="integer">4</span>)   -<span class="float">0.005600</span>
dtype: float64

(<span class="integer">2020</span>, <span class="integer">51</span>)    <span class="float">0.001516</span>
(<span class="integer">2020</span>, <span class="integer">52</span>)   -<span class="float">0.009117</span>
(<span class="integer">2020</span>, <span class="integer">53</span>)    <span class="float">0.005004</span>
dtype: float64</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここで、weekly_returnをshift(-1)することにより、翌週のreturn情報が現在のindexに入るようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">weekly_fwd_return = weekly_return.shift(-<span class="integer">1</span>).dropna()

<span class="comment"># 確認する</span>
display(weekly_fwd_return.head(<span class="integer">3</span>))
display(weekly_fwd_return.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">(<span class="integer">2020</span>, <span class="integer">2</span>)   -<span class="float">0.007994</span>
(<span class="integer">2020</span>, <span class="integer">3</span>)   -<span class="float">0.005600</span>
(<span class="integer">2020</span>, <span class="integer">4</span>)   -<span class="float">0.015110</span>
dtype: float64

(<span class="integer">2020</span>, <span class="integer">50</span>)    <span class="float">0.001516</span>
(<span class="integer">2020</span>, <span class="integer">51</span>)   -<span class="float">0.009117</span>
(<span class="integer">2020</span>, <span class="integer">52</span>)    <span class="float">0.005004</span>
dtype: float64</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここで、ラベルデータを訓練期間/テスト期間に分割します。現在のデータは、2020年の第1週から第52週まであり、前半の第1週から第26週までを訓練期間、第27週から52週までをテスト期間とします。具体的には、訓練期間とテスト期間を区切る週を`boundary_week`として、訓練用に用いられる特徴量と、テスト用に用いられる特徴量を区切ります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">boundary_week = (<span class="integer">2020</span>, <span class="integer">26</span>)
train_labels = weekly_fwd_return[weekly_fwd_return.index &lt;= boundary_week]
test_labels = weekly_fwd_return[weekly_fwd_return.index &gt; boundary_week]

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### train_labels</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(train_labels.head(<span class="integer">3</span>))
display(train_labels.tail(<span class="integer">3</span>))

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### test_labels</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(test_labels.head(<span class="integer">3</span>))
display(test_labels.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">train_labels
(<span class="integer">2020</span>, <span class="integer">2</span>)   -<span class="float">0.007994</span>
(<span class="integer">2020</span>, <span class="integer">3</span>)   -<span class="float">0.005600</span>
(<span class="integer">2020</span>, <span class="integer">4</span>)   -<span class="float">0.015110</span>
dtype: float64
(<span class="integer">2020</span>, <span class="integer">24</span>)    <span class="float">0.016623</span>
(<span class="integer">2020</span>, <span class="integer">25</span>)    <span class="float">0.001732</span>
(<span class="integer">2020</span>, <span class="integer">26</span>)   -<span class="float">0.019522</span>
dtype: float64

test_labels
(<span class="integer">2020</span>, <span class="integer">27</span>)   -<span class="float">0.017781</span>
(<span class="integer">2020</span>, <span class="integer">28</span>)    <span class="float">0.016613</span>
(<span class="integer">2020</span>, <span class="integer">29</span>)    <span class="float">0.001590</span>
dtype: float64
(<span class="integer">2020</span>, <span class="integer">50</span>)    <span class="float">0.001516</span>
(<span class="integer">2020</span>, <span class="integer">51</span>)   -<span class="float">0.009117</span>
(<span class="integer">2020</span>, <span class="integer">52</span>)    <span class="float">0.005004</span>
dtype: float64</code></pre>
</div>
</div>
<div class="paragraph">
<p>　fwd_returnの上げ下げの情報のみをラベルとして用いるため、上げを1.0, 下げを0.0に変換します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">train_labels = (train_labels &gt;= <span class="integer">0</span>) * <span class="float">1.0</span>
test_labels = (test_labels &gt;= <span class="integer">0</span>) * <span class="float">1.0</span>

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### train_labels</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(train_labels.head(<span class="integer">3</span>))
display(train_labels.tail(<span class="integer">3</span>))

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### test_labels</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(test_labels.head(<span class="integer">3</span>))
display(test_labels.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。うまく0.0と1.0に変換されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">train_labels
(<span class="integer">2020</span>, <span class="integer">2</span>)    <span class="float">0.0</span>
(<span class="integer">2020</span>, <span class="integer">3</span>)    <span class="float">0.0</span>
(<span class="integer">2020</span>, <span class="integer">4</span>)    <span class="float">0.0</span>
dtype: float64
(<span class="integer">2020</span>, <span class="integer">24</span>)    <span class="float">1.0</span>
(<span class="integer">2020</span>, <span class="integer">25</span>)    <span class="float">1.0</span>
(<span class="integer">2020</span>, <span class="integer">26</span>)    <span class="float">0.0</span>
dtype: float64

test_labels
(<span class="integer">2020</span>, <span class="integer">27</span>)    <span class="float">0.0</span>
(<span class="integer">2020</span>, <span class="integer">28</span>)    <span class="float">1.0</span>
(<span class="integer">2020</span>, <span class="integer">29</span>)    <span class="float">1.0</span>
dtype: float64
(<span class="integer">2020</span>, <span class="integer">50</span>)    <span class="float">1.0</span>
(<span class="integer">2020</span>, <span class="integer">51</span>)    <span class="float">0.0</span>
(<span class="integer">2020</span>, <span class="integer">52</span>)    <span class="float">1.0</span>
dtype: float64</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラスへ組み込み_8">6.2.5. 本番提出用のクラスへ組み込み</h4>
<div class="paragraph">
<p>上記のコードを関数として、<code>SentimentGenerator</code> クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">build_weekly_features</span>(cls, features, boundary_week):
    <span class="keyword">assert</span> <span class="predefined">isinstance</span>(boundary_week, <span class="predefined">tuple</span>)

    weekly_group = cls._build_weekly_group(df=features)
    features = features.groupby(weekly_group).apply(<span class="keyword">lambda</span> x: x[:])

    train_features = features[features.index.get_level_values(<span class="integer">0</span>) &lt;= boundary_week]
    test_features = features[features.index.get_level_values(<span class="integer">0</span>) &gt; boundary_week]

    <span class="keyword">return</span> {<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>: train_features, <span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>: test_features}

<span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">build_weekly_labels</span>(cls, stock_price, boundary_week):
    <span class="keyword">def</span> <span class="function">_compute_weekly_return</span>(x):
        <span class="comment"># その週の初営業日のopenから最終営業日のcloseまでのリターンを計算する。</span>
        weekly_return = ((x[<span class="string"><span class="delimiter">'</span><span class="content">close</span><span class="delimiter">'</span></span>].iloc[-<span class="integer">1</span>] - x[<span class="string"><span class="delimiter">'</span><span class="content">open</span><span class="delimiter">'</span></span>].iloc[<span class="integer">0</span>]) / x[<span class="string"><span class="delimiter">'</span><span class="content">open</span><span class="delimiter">'</span></span>].iloc[<span class="integer">0</span>])

        <span class="comment"># その日のvolumneが0であるデータは、openが0となっている。</span>
        <span class="comment"># openが0の場合、np.infの値となっているため、np.nanに変換し除去する。</span>
        <span class="comment"># 銘柄ごとのリターンを単純平均し、marketのweekly_returnを計算する。</span>
        <span class="keyword">return</span> weekly_return.replace([np.inf, -np.inf], np.nan).dropna().mean()

    <span class="keyword">assert</span> <span class="predefined">isinstance</span>(boundary_week, <span class="predefined">tuple</span>)

    weekly_group = cls._build_weekly_group(df=stock_price)
    weekly_fwd_return = stock_price.groupby(weekly_group).apply(_compute_weekly_return).shift(-<span class="integer">1</span>).dropna()

    train_labels = weekly_fwd_return[weekly_fwd_return.index &lt;= boundary_week]
    test_labels = weekly_fwd_return[weekly_fwd_return.index &gt; boundary_week]

    train_labels = (train_labels &gt;= <span class="integer">0</span>) * <span class="float">1.0</span>
    test_labels = (test_labels &gt;= <span class="integer">0</span>) * <span class="float">1.0</span>

    <span class="keyword">return</span> {<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>: train_labels, <span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>: test_labels}

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.build_weekly_features = build_weekly_features
SentimentGenerator.build_weekly_labels = build_weekly_labels

<span class="comment"># SentimentGeneratorに定義したclassmethodを追加する</span>
SentimentGenerator.build_weekly_features = build_weekly_features
SentimentGenerator.build_weekly_labels = build_weekly_labels</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pytorch_dataset作成">6.2.6. Pytorch Dataset作成</h4>
<div class="paragraph">
<p>　pytorchを用いたモデルを効率よく学習させるためには、custom Datasetクラスと、それを用いたDataloaderを定義する必要があります。ここでは、学習で用いるDatasetを定義する方法を説明します。Datasetの__getitem__は、Dataloaderを介してデータを取得するときに呼ばれます。具体的には、__init__で事前に定義したデータをidを用いて取得する仕組みになっています。そのため、idが与えられたら、そのidからfeatureとlabelを取得するような構造で__init__でデータを事前に定義しておく必要があります。以下にPytorchのDataset及びDataLoaderに関する参考記事を少し紹介しています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pytorch関連記事</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/mathlive/items/2a512831878b8018db02">Qiita:pyTorchのtransforms,Datasets,Dataloaderの説明と自作Datasetの作成と使用</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://qiita.com/takurooo/items/e4c91c5d78059f92e76d">Qiita:PyTorch transforms/Dataset/DataLoaderの基本動作を確認する</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>　ここでは、例としてtrainデータのみを用いて、Datasetを作っています。任意に特徴量としては、headlineを使い、boundary_weekに2020年の26週目を設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">features = headline_features
boundary_week = (<span class="integer">2020</span>, <span class="integer">26</span>)

<span class="comment"># 上記で作成したコードを用いて週次の特徴量とラベルを作成</span>
weekly_features = SentimentGenerator.build_weekly_features(features=features, boundary_week=boundary_week)[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>]
weekly_labels = SentimentGenerator.build_weekly_labels(stock_price=stock_price, boundary_week=boundary_week)[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>]

<span class="comment"># 共通する週のみのデータを使うため、共通するindex情報を取得する。</span>
mask_index = weekly_features.index.get_level_values(<span class="integer">0</span>).unique() &amp; weekly_labels.index
display(mask_index)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">Index([ (<span class="integer">2020</span>, <span class="integer">2</span>),  (<span class="integer">2020</span>, <span class="integer">3</span>),  (<span class="integer">2020</span>, <span class="integer">4</span>),  (<span class="integer">2020</span>, <span class="integer">5</span>),  (<span class="integer">2020</span>, <span class="integer">6</span>),  (<span class="integer">2020</span>, <span class="integer">7</span>),
        (<span class="integer">2020</span>, <span class="integer">8</span>),  (<span class="integer">2020</span>, <span class="integer">9</span>), (<span class="integer">2020</span>, <span class="integer">10</span>), (<span class="integer">2020</span>, <span class="integer">11</span>), (<span class="integer">2020</span>, <span class="integer">12</span>), (<span class="integer">2020</span>, <span class="integer">13</span>),
       (<span class="integer">2020</span>, <span class="integer">14</span>), (<span class="integer">2020</span>, <span class="integer">15</span>), (<span class="integer">2020</span>, <span class="integer">16</span>), (<span class="integer">2020</span>, <span class="integer">17</span>), (<span class="integer">2020</span>, <span class="integer">18</span>), (<span class="integer">2020</span>, <span class="integer">19</span>),
       (<span class="integer">2020</span>, <span class="integer">20</span>), (<span class="integer">2020</span>, <span class="integer">21</span>), (<span class="integer">2020</span>, <span class="integer">22</span>), (<span class="integer">2020</span>, <span class="integer">23</span>), (<span class="integer">2020</span>, <span class="integer">24</span>), (<span class="integer">2020</span>, <span class="integer">25</span>),
       (<span class="integer">2020</span>, <span class="integer">26</span>)],
      dtype=<span class="string"><span class="delimiter">'</span><span class="content">object</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　共通するindexのみのデータだけでreindexします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">weekly_features = weekly_features[weekly_features.index.get_level_values(<span class="integer">0</span>).isin(mask_index)]
weekly_labels = weekly_labels.reindex(mask_index)

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### weekly_features</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(weekly_features.head(<span class="integer">3</span>))
display(weekly_features.tail(<span class="integer">3</span>))

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### weekly_labels</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(weekly_labels.head(<span class="integer">3</span>))
display(weekly_labels.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_pytorch_dataset_reindex.png" alt="1_7_pytorch_dataset_reindex">
</div>
</div>
<div class="paragraph">
<p>　idからweekの情報を取得できるよう、id_to_weekを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">id_to_week = {<span class="predefined">id</span>: week <span class="keyword">for</span> <span class="predefined">id</span>, week <span class="keyword">in</span> <span class="predefined">enumerate</span>(<span class="predefined">sorted</span>(weekly_labels.index))}
id_to_week</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">{<span class="integer">0</span>: (<span class="integer">2020</span>, <span class="integer">2</span>),
 <span class="integer">1</span>: (<span class="integer">2020</span>, <span class="integer">3</span>),
 <span class="integer">2</span>: (<span class="integer">2020</span>, <span class="integer">4</span>),
 <span class="integer">3</span>: (<span class="integer">2020</span>, <span class="integer">5</span>),
 <span class="integer">4</span>: (<span class="integer">2020</span>, <span class="integer">6</span>),
 <span class="integer">5</span>: (<span class="integer">2020</span>, <span class="integer">7</span>),
 <span class="integer">6</span>: (<span class="integer">2020</span>, <span class="integer">8</span>),
 <span class="integer">7</span>: (<span class="integer">2020</span>, <span class="integer">9</span>),
 <span class="integer">8</span>: (<span class="integer">2020</span>, <span class="integer">10</span>),
 <span class="integer">9</span>: (<span class="integer">2020</span>, <span class="integer">11</span>),
 <span class="integer">10</span>: (<span class="integer">2020</span>, <span class="integer">12</span>),
 <span class="integer">11</span>: (<span class="integer">2020</span>, <span class="integer">13</span>),
 <span class="integer">12</span>: (<span class="integer">2020</span>, <span class="integer">14</span>),
 <span class="integer">13</span>: (<span class="integer">2020</span>, <span class="integer">15</span>),
 <span class="integer">14</span>: (<span class="integer">2020</span>, <span class="integer">16</span>),
 <span class="integer">15</span>: (<span class="integer">2020</span>, <span class="integer">17</span>),
 <span class="integer">16</span>: (<span class="integer">2020</span>, <span class="integer">18</span>),
 <span class="integer">17</span>: (<span class="integer">2020</span>, <span class="integer">19</span>),
 <span class="integer">18</span>: (<span class="integer">2020</span>, <span class="integer">20</span>),
 <span class="integer">19</span>: (<span class="integer">2020</span>, <span class="integer">21</span>),
 <span class="integer">20</span>: (<span class="integer">2020</span>, <span class="integer">22</span>),
 <span class="integer">21</span>: (<span class="integer">2020</span>, <span class="integer">23</span>),
 <span class="integer">22</span>: (<span class="integer">2020</span>, <span class="integer">24</span>),
 <span class="integer">23</span>: (<span class="integer">2020</span>, <span class="integer">25</span>),
 <span class="integer">24</span>: (<span class="integer">2020</span>, <span class="integer">26</span>)}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>_getitem_</em>で付与されたidから、データを取得するロジックを説明します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 例として、任意的にid = 10を用いる。</span>
id = <span class="integer">10</span>

<span class="comment"># idからweekの情報を取得する。</span>
week = id_to_week[<span class="predefined">id</span>]

<span class="comment"># 学習時のリソース軽減のため、全ての特徴量を入力とするわけではなく、直近n個を入力とする。ここでは1000個として定義する。</span>
max_sequence_length = <span class="integer">1000</span>

x = weekly_features.xs(week, axis=<span class="integer">0</span>, level=<span class="integer">0</span>)[-max_sequence_length:]
y = weekly_labels[week]

<span class="comment"># 上記のコードよりidが付与されたとき、idから週の情報を取得し、その週の情報から、特徴量とラベルを手にすることができた。</span>
display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### 特徴量</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(x.head(<span class="integer">3</span>))
print(<span class="string"><span class="delimiter">'</span><span class="content">shape:</span><span class="delimiter">'</span></span>, x.shape)

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### ラベル</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(y)</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_pytorch_dataset_get_item.png" alt="1_7_pytorch_dataset_get_item">
</div>
</div>
<div class="paragraph">
<p>　pytorchを用いた学習・推論では、データをtorch.Tensorタイプとして扱うことが要求されます。以下で、np.ndarrayをtensor形式に変換することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">x = torch.tensor(x.values, dtype=torch.float)
y = torch.tensor(y, dtype=torch.float)

display(x)
display(y)</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tensor([[-<span class="float">0.2525</span>,  <span class="float">0.3046</span>, -<span class="float">0.2245</span>,  ..., -<span class="float">0.4402</span>, -<span class="float">0.2707</span>,  <span class="float">0.2823</span>],
        [ <span class="float">0.0670</span>,  <span class="float">0.1914</span>, -<span class="float">0.1088</span>,  ..., -<span class="float">0.0879</span>, -<span class="float">0.2142</span>,  <span class="float">0.1802</span>],
        [-<span class="float">0.2898</span>, -<span class="float">0.3260</span>, -<span class="float">0.1711</span>,  ..., -<span class="float">0.1327</span>, -<span class="float">0.2654</span>,  <span class="float">0.1255</span>],
        ...,
        [-<span class="float">0.2813</span>, -<span class="float">0.0425</span>,  <span class="float">0.0015</span>,  ..., -<span class="float">0.7122</span>,  <span class="float">0.1824</span>, -<span class="float">0.0727</span>],
        [-<span class="float">0.7515</span>,  <span class="float">0.1514</span>, -<span class="float">0.0536</span>,  ..., -<span class="float">0.5100</span>, -<span class="float">0.3639</span>, -<span class="float">0.2901</span>],
        [ <span class="float">0.0920</span>,  <span class="float">0.0485</span>, -<span class="float">0.2583</span>,  ..., -<span class="float">0.3228</span>,  <span class="float">0.3854</span>,  <span class="float">0.0924</span>]])
tensor(<span class="float">1.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　今回、学習に用いる週次のデータセットにおいて、LSTMの学習には週毎のニュースの件数が若干不足している傾向にあることから、過学習防止のため、少し工夫をしています。具体的には、全体的な特徴量(ニュースの情報)の順序は維持しつつ複数に分割し、その分割の中でシャッフルを行う方法を取ります。この方法を用いることで、モデルに入力するデータを増やすことでき、過学習を防止に繋がる効果が期待できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_shuffle_by_local_split</span>(x, split_size=<span class="integer">50</span>):
    <span class="keyword">return</span> torch.cat([splitted[torch.randperm(splitted.size()[<span class="integer">0</span>])] <span class="keyword">for</span> splitted <span class="keyword">in</span> x.split(split_size, dim=<span class="integer">0</span>)], dim=<span class="integer">0</span>)

x = _shuffle_by_local_split(x=x)
display(x)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">tensor([[-<span class="float">0.1477</span>,  <span class="float">0.1549</span>, -<span class="float">0.0650</span>,  ...,  <span class="float">0.0304</span>,  <span class="float">0.0071</span>,  <span class="float">0.3565</span>],
        [-<span class="float">0.2660</span>,  <span class="float">0.6258</span>, -<span class="float">0.1581</span>,  ..., -<span class="float">0.2906</span>, -<span class="float">0.3727</span>,  <span class="float">0.0437</span>],
        [-<span class="float">0.2384</span>, -<span class="float">0.1165</span>, -<span class="float">0.2715</span>,  ..., -<span class="float">0.3553</span>, -<span class="float">0.6599</span>, -<span class="float">0.1545</span>],
        ...,
        [-<span class="float">0.7515</span>,  <span class="float">0.1514</span>, -<span class="float">0.0536</span>,  ..., -<span class="float">0.5100</span>, -<span class="float">0.3639</span>, -<span class="float">0.2901</span>],
        [-<span class="float">0.1901</span>,  <span class="float">0.2114</span>, -<span class="float">0.2073</span>,  ..., -<span class="float">0.3650</span>, -<span class="float">0.3166</span>,  <span class="float">0.2325</span>],
        [-<span class="float">0.4610</span>,  <span class="float">0.4689</span>, -<span class="float">0.0572</span>,  ..., -<span class="float">0.2271</span>, -<span class="float">0.2781</span>, -<span class="float">0.1097</span>]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　学習中においては、データを1つずつ読み込んで学習を行うより、複数個を同時に並列演算を行う方(mini batch)が時間短縮に繋がります。そのためには、データ行列を重ねる必要があり、データのsequenceが同一である必要があります。本節では、このようなシークエンスの異なるデータを扱うため、max_sequence_lengthを決め、最大のsequenceに合わせます。また、sequenceがmax_sequence_lengthに達しない場合は、前から0を埋め(zero padding)、sequenceを合わせています。なお、本節ではmax_sequence_lengthは1000と定義してあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># sequenceがmax_sequence_lengthに達しないrandomのtensorをxとして、定義し、以下のコードでzero paddingを行ってみる。</span>
x = torch.randn(<span class="integer">100</span>, <span class="integer">768</span>)
display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### Padding前</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(x)
display(x.shape)

<span class="keyword">if</span> x.size()[<span class="integer">0</span>] &lt; max_sequence_length:
    x = F.pad(x, pad=(<span class="integer">0</span>, <span class="integer">0</span>, max_sequence_length - x.size()[<span class="integer">0</span>], <span class="integer">0</span>))

display_markdown(<span class="string"><span class="delimiter">'</span><span class="content">#### Padding後</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
display(x)
display(x.shape)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">Padding前
tensor([[-<span class="float">0.0767</span>,  <span class="float">1.8950</span>, -<span class="float">0.9323</span>,  ...,  <span class="float">0.1885</span>, -<span class="float">1.3335</span>,  <span class="float">0.3923</span>],
        [-<span class="float">0.5709</span>,  <span class="float">0.4231</span>,  <span class="float">0.4268</span>,  ..., -<span class="float">0.8555</span>, -<span class="float">0.6662</span>, -<span class="float">0.0097</span>],
        [ <span class="float">0.3191</span>, -<span class="float">0.3961</span>, -<span class="float">0.9253</span>,  ..., -<span class="float">1.0401</span>,  <span class="float">0.4225</span>, -<span class="float">0.2478</span>],
        ...,
        [-<span class="float">0.0769</span>, -<span class="float">0.0747</span>, -<span class="float">0.2437</span>,  ...,  <span class="float">0.3740</span>,  <span class="float">0.0970</span>,  <span class="float">0.6437</span>],
        [ <span class="float">1.1534</span>,  <span class="float">0.8583</span>,  <span class="float">1.2623</span>,  ...,  <span class="float">0.0882</span>,  <span class="float">0.5125</span>, -<span class="float">0.1485</span>],
        [ <span class="float">2.1272</span>,  <span class="float">0.8173</span>,  <span class="float">0.8997</span>,  ..., -<span class="float">0.5132</span>,  <span class="float">0.5023</span>,  <span class="float">0.3106</span>]])
torch.Size([<span class="integer">100</span>, <span class="integer">768</span>])

Padding後
tensor([[ <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  ...,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>],
        [ <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  ...,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>],
        [ <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  ...,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>,  <span class="float">0.0000</span>],
        ...,
        [-<span class="float">0.0769</span>, -<span class="float">0.0747</span>, -<span class="float">0.2437</span>,  ...,  <span class="float">0.3740</span>,  <span class="float">0.0970</span>,  <span class="float">0.6437</span>],
        [ <span class="float">1.1534</span>,  <span class="float">0.8583</span>,  <span class="float">1.2623</span>,  ...,  <span class="float">0.0882</span>,  <span class="float">0.5125</span>, -<span class="float">0.1485</span>],
        [ <span class="float">2.1272</span>,  <span class="float">0.8173</span>,  <span class="float">0.8997</span>,  ..., -<span class="float">0.5132</span>,  <span class="float">0.5023</span>,  <span class="float">0.3106</span>]])
torch.Size([<span class="integer">1000</span>, <span class="integer">768</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記のコードをまとめて、pytorchのDatasetクラスを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">Dataset</span>(_Dataset):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, weekly_features, weekly_labels, max_sequence_length):
        <span class="comment"># 共通する週のみを使うため、共通するindex情報を取得する</span>
        mask_index = (
            weekly_features.index.get_level_values(<span class="integer">0</span>).unique() &amp; weekly_labels.index
        )

        <span class="comment"># 共通するindexのみのデータだけでreindexを行う。</span>
        <span class="predefined-constant">self</span>.weekly_features = weekly_features[
            weekly_features.index.get_level_values(<span class="integer">0</span>).isin(mask_index)
        ]
        <span class="predefined-constant">self</span>.weekly_labels = weekly_labels.reindex(mask_index)

        <span class="comment"># idからweekの情報を取得できるよう、id_to_weekをビルドする</span>
        <span class="predefined-constant">self</span>.id_to_week = {
            <span class="predefined">id</span>: week <span class="keyword">for</span> <span class="predefined">id</span>, week <span class="keyword">in</span> <span class="predefined">enumerate</span>(<span class="predefined">sorted</span>(weekly_labels.index))
        }

        <span class="predefined-constant">self</span>.max_sequence_length = max_sequence_length

    <span class="keyword">def</span> <span class="function">_shuffle_by_local_split</span>(<span class="predefined-constant">self</span>, x, split_size=<span class="integer">50</span>):
        <span class="keyword">return</span> torch.cat(
            [
                splitted[torch.randperm(splitted.size()[<span class="integer">0</span>])]
                <span class="keyword">for</span> splitted <span class="keyword">in</span> x.split(split_size, dim=<span class="integer">0</span>)
            ],
            dim=<span class="integer">0</span>,
        )

    <span class="keyword">def</span> <span class="function">__len__</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined">len</span>(<span class="predefined-constant">self</span>.weekly_labels)

    <span class="keyword">def</span> <span class="function">__getitem__</span>(<span class="predefined-constant">self</span>, <span class="predefined">id</span>):
        <span class="comment"># 付与されたidから週の情報を取得し、その週の情報から、特徴量とラベルを取得する。</span>
        week = <span class="predefined-constant">self</span>.id_to_week[<span class="predefined">id</span>]
        x = <span class="predefined-constant">self</span>.weekly_features.xs(week, axis=<span class="integer">0</span>, level=<span class="integer">0</span>)[-<span class="predefined-constant">self</span>.max_sequence_length :]
        y = <span class="predefined-constant">self</span>.weekly_labels[week]

        <span class="comment"># pytorchでは、データをtorch.Tensorタイプとして扱うことが要求される。</span>
        <span class="comment"># 全体的な特徴量(ニュースの情報)の順序は維持しつつ、入力とする特徴量を数分割し、その分割の中でシャッフルを行う。</span>
        x = <span class="predefined-constant">self</span>._shuffle_by_local_split(torch.tensor(x.values, dtype=torch.float))
        y = torch.tensor(y, dtype=torch.float)

        <span class="comment"># max_sequence_lengthに最大のsequenceを合わせ、sequenceがmax_sequence_lengthに達しない場合は、前から0を埋め、sequenceを合わせる</span>
        <span class="keyword">if</span> x.size()[<span class="integer">0</span>] &lt; <span class="predefined-constant">self</span>.max_sequence_length:
            x = F.pad(x, pad=(<span class="integer">0</span>, <span class="integer">0</span>, <span class="predefined-constant">self</span>.max_sequence_length - x.size()[<span class="integer">0</span>], <span class="integer">0</span>))

        <span class="keyword">return</span> x, y</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lstmによる特徴量合成モデル作成">6.2.7. LSTMによる特徴量合成モデル作成</h4>
<div class="paragraph">
<p>　LSTMを用いて上げ下げの確率を出力とするモデルを定義し、binary_cross_entropyを損失関数として学習を行います。モデルへの入力Sequenceがかなり長いため、入力の最初の方の情報の消失が激しいと想定されます。そのため今回は、LSTMにおいて <code>bidirectional</code> を利用しています。具体的なLSTMの定義は以下のソースコードを確認してください。出力層でのsentiment score（上げ下げの情報）及び出力の直前の層の高次元の情報を抽出し、特徴量として用いることを想定しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">FeatureCombiner</span>(nn.Module):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, input_size, hidden_size, compress_dim=<span class="integer">4</span>, num_layers=<span class="integer">2</span>):
        <span class="predefined">super</span>().__init__()
        <span class="predefined-constant">self</span>.input_size = input_size
        <span class="predefined-constant">self</span>.hidden_size = hidden_size

        <span class="comment"># LSTMの定義</span>
        <span class="comment"># batch_firstより、出力次元の最初がbatchとなる。</span>
        <span class="comment"># dropoutを用いて、内部状態のconnectionをdropすることより過学習を防ぐ。</span>
        <span class="comment"># Sequenceがかなり長く、入力の始めの方の情報の消失を防ぐため、bidirectionalのモデルを使う。</span>
        <span class="predefined-constant">self</span>.cell = nn.LSTM(
            input_size=input_size,
            hidden_size=hidden_size,
            num_layers=num_layers,
            batch_first=<span class="predefined-constant">True</span>,
            dropout=<span class="float">0.5</span>,
            bidirectional=<span class="predefined-constant">True</span>,
        )

        <span class="comment"># より高次元の特徴量を抽出できるようにするため、classifierの手前で、compress_dim次元への線形圧縮を行う。</span>
        <span class="predefined-constant">self</span>.compressor = nn.Linear(hidden_size * <span class="integer">2</span>, compress_dim)

        <span class="comment"># sentiment probabilityの出力層。</span>
        <span class="predefined-constant">self</span>.classifier = nn.Linear(compress_dim, <span class="integer">1</span>)

        <span class="comment"># outputの範囲を[0, 1]とする。</span>
        <span class="predefined-constant">self</span>.sigmoid = nn.Sigmoid()

    <span class="keyword">def</span> <span class="function">forward</span>(<span class="predefined-constant">self</span>, x):
        <span class="comment"># 入力値xから出力までの流れを定義する。</span>
        output, _ = <span class="predefined-constant">self</span>.cell(x)
        output = <span class="predefined-constant">self</span>.sigmoid(<span class="predefined-constant">self</span>.classifier(<span class="predefined-constant">self</span>.compressor(output[:, -<span class="integer">1</span>, :])))
        <span class="keyword">return</span> output

    <span class="keyword">def</span> <span class="function">extract_feature</span>(<span class="predefined-constant">self</span>, x):
        <span class="comment"># 入力値xから特徴量抽出までの流れを定義する。</span>
        output, _ = <span class="predefined-constant">self</span>.cell(x)
        output = <span class="predefined-constant">self</span>.compressor(output[:, -<span class="integer">1</span>, :])
        <span class="keyword">return</span> output</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_特徴量合成モデルのハンドラー作成">6.2.8. 特徴量合成モデルのハンドラー作成</h4>
<div class="paragraph">
<p>　前節において、データのインデクシングロジックや、特徴量合成モデルは作成しました。しかし、これらだけではモデル学習は行えません。学習のロジックや、学習されたモデルのセーブ及びロード、推定、特徴量抽出を実装する必要があります。本節では、これらを実装するためにFeatureCombinerHandlerのクラスを定義しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">FeatureCombinerHandler</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, feature_combiner_params, store_dir):
        <span class="comment"># モデル学習及び推論に用いるデバイスを定義する</span>
        <span class="keyword">if</span> torch.cuda.device_count() &gt;= <span class="integer">1</span>:
            <span class="predefined-constant">self</span>.device = <span class="string"><span class="delimiter">'</span><span class="content">cuda</span><span class="delimiter">'</span></span>
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: GPU</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">else</span>:
            <span class="predefined-constant">self</span>.device = <span class="string"><span class="delimiter">'</span><span class="content">cpu</span><span class="delimiter">'</span></span>
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: CPU</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># モデルのcheckpointや抽出した特徴量及びsentimentをstoreする場所を定義する。</span>
        <span class="predefined-constant">self</span>.store_dir = store_dir
        os.makedirs(store_dir, exist_ok=<span class="predefined-constant">True</span>)

        <span class="comment"># 上記で作成したfeaturecombinerを定義する。</span>
        <span class="predefined-constant">self</span>.feature_combiner = FeatureCombiner(**feature_combiner_params).to(
            <span class="predefined-constant">self</span>.device
        )

        <span class="comment"># 学習に用いるoptimizerを定義する。</span>
        <span class="predefined-constant">self</span>.optimizer = torch.optim.Adam(
            params=<span class="predefined-constant">self</span>.feature_combiner.parameters(), lr=<span class="float">0.001</span>,
        )

        <span class="comment"># ロス関数の定義</span>
        <span class="predefined-constant">self</span>.criterion = nn.BCELoss().to(<span class="predefined-constant">self</span>.device)

        <span class="comment"># モデルのcheck pointが存在する場合、モデルをロードする</span>
        <span class="predefined-constant">self</span>._load_model()

    <span class="comment"># 学習に必要なデータ(並列のためbatch化されたもの)をサンプルする。</span>
    <span class="keyword">def</span> <span class="function">_sample_xy</span>(<span class="predefined-constant">self</span>, data_type):
        <span class="keyword">assert</span> data_type <span class="keyword">in</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">train</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">val</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># data_typeより、data_typeに合致したデータを取得するようにしている。</span>
        <span class="keyword">if</span> data_type == <span class="string"><span class="delimiter">&quot;</span><span class="content">train</span><span class="delimiter">&quot;</span></span>:
            <span class="comment"># dataloaderをiteratorとして定義し、next関数として毎時のデータをサンプルすることができる。</span>
            <span class="comment"># Iteratorは全てのデータがサンプルされると、StopIterationのエラーを発するが、そのようなエラーが出たとき、</span>
            <span class="comment"># Iteratorを再定義し、データをサンプルするようにしている。</span>
            <span class="keyword">try</span>:
                x, y = <span class="predefined">next</span>(<span class="predefined-constant">self</span>.iterable_train_dataloader)
            <span class="keyword">except</span> <span class="exception">StopIteration</span>:
                <span class="predefined-constant">self</span>.iterable_train_dataloader = <span class="predefined">iter</span>(<span class="predefined-constant">self</span>.train_dataloader)
                x, y = <span class="predefined">next</span>(<span class="predefined-constant">self</span>.iterable_train_dataloader)

        <span class="keyword">elif</span> data_type == <span class="string"><span class="delimiter">&quot;</span><span class="content">val</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">try</span>:
                x, y = <span class="predefined">next</span>(<span class="predefined-constant">self</span>.iterable_val_dataloader)
            <span class="keyword">except</span> <span class="exception">StopIteration</span>:
                <span class="predefined-constant">self</span>.iterable_val_dataloader = <span class="predefined">iter</span>(<span class="predefined-constant">self</span>.val_dataloader)
                x, y = <span class="predefined">next</span>(<span class="predefined-constant">self</span>.iterable_val_dataloader)

        <span class="keyword">return</span> x.to(<span class="predefined-constant">self</span>.device), y.to(<span class="predefined-constant">self</span>.device)

    <span class="comment"># モデルのパラメータをアップデートするロジック</span>
    <span class="keyword">def</span> <span class="function">_update_params</span>(<span class="predefined-constant">self</span>, loss):
        <span class="comment"># ロスから、gradientを逆伝播し、パラメータをアップデートする</span>
        loss.backward()
        <span class="predefined-constant">self</span>.optimizer.step()

    <span class="comment"># 学習されたfeature_combinerのパラメータをcheck_pointとしてstoreするロジック</span>
    <span class="keyword">def</span> <span class="function">_save_model</span>(<span class="predefined-constant">self</span>, epoch):
        torch.save(
            <span class="predefined-constant">self</span>.feature_combiner.state_dict(),
            os.path.join(<span class="predefined-constant">self</span>.store_dir, f<span class="string"><span class="delimiter">&quot;</span><span class="content">{epoch}.ckpt</span><span class="delimiter">&quot;</span></span>),
        )
        print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Epoch: {epoch}, Model is saved.</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># 学習されたcheckpointが存在す場合、feature_combinerにそのパラメータをロードするロジック</span>
    <span class="keyword">def</span> <span class="function">_load_model</span>(<span class="predefined-constant">self</span>):
        <span class="comment"># cudaで学習されたモデルなどを、cpu環境下でロードするときはこのパラメータが必要となる。</span>
        params_to_load = {}
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.device == <span class="string"><span class="delimiter">&quot;</span><span class="content">cpu</span><span class="delimiter">&quot;</span></span>:
            params_to_load[<span class="string"><span class="delimiter">&quot;</span><span class="content">map_location</span><span class="delimiter">&quot;</span></span>] = torch.device(<span class="string"><span class="delimiter">&quot;</span><span class="content">cpu</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># .ckptファイルを探し、古い順から新しい順にソートする。</span>
        check_points = glob(os.path.join(<span class="predefined-constant">self</span>.store_dir, <span class="string"><span class="delimiter">&quot;</span><span class="content">*.ckpt</span><span class="delimiter">&quot;</span></span>))
        check_points = <span class="predefined">sorted</span>(
            check_points, key=<span class="keyword">lambda</span> x: <span class="predefined">int</span>(x.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)[-<span class="integer">1</span>].replace(<span class="string"><span class="delimiter">&quot;</span><span class="content">.ckpt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)),
        )

        <span class="comment"># check_pointが存在しない場合は、スキップする。</span>
        <span class="keyword">if</span> <span class="predefined">len</span>(check_points) == <span class="integer">0</span>:
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[!] No exists checkpoint</span><span class="delimiter">&quot;</span></span>)
            <span class="keyword">return</span>

        <span class="comment"># 複数個のchieck_pointが存在する場合、一番最新のものを使い、モデルのパラメータをロードする</span>
        check_point = check_points[-<span class="integer">1</span>]
        <span class="predefined-constant">self</span>.feature_combiner.load_state_dict(torch.load(check_point, **params_to_load))
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Model is loaded</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># Datasetからdataloaderを定義するロジック</span>
    <span class="keyword">def</span> <span class="function">_build_dataloader</span>(
        <span class="predefined-constant">self</span>, dataloader_params, weekly_features, weekly_labels, max_sequence_length
    ):
        <span class="comment"># 上記3で作成したしたdatasetを定義する</span>
        dataset = Dataset(
            weekly_features=weekly_features,
            weekly_labels=weekly_labels,
            max_sequence_length=max_sequence_length,
        )

        <span class="comment"># datasetのdataをiterableにロードできるよう、dataloaderを定義する、このとき、shuffle=Trueを渡すことで、データはランダムにサンプルされるようになる。</span>
        <span class="keyword">return</span> DataLoader(dataset=dataset, shuffle=<span class="predefined-constant">True</span>, **dataloader_params)

    <span class="comment"># train用に、featuresとlabelsを渡し、datasetを定義し、dataloaderを定義するロジック</span>
    <span class="keyword">def</span> <span class="function">set_train_dataloader</span>(
        <span class="predefined-constant">self</span>, dataloader_params, weekly_features, weekly_labels, max_sequence_length
    ):
        <span class="predefined-constant">self</span>.train_dataloader = <span class="predefined-constant">self</span>._build_dataloader(
            dataloader_params=dataloader_params,
            weekly_features=weekly_features,
            weekly_labels=weekly_labels,
            max_sequence_length=max_sequence_length,
        )

        <span class="comment"># dataloaderからiteratorを定義する</span>
        <span class="comment"># iteratorはnext関数よりデータをサンプルすることが可能となる。</span>
        <span class="predefined-constant">self</span>.iterable_train_dataloader = <span class="predefined">iter</span>(<span class="predefined-constant">self</span>.train_dataloader)

    <span class="comment"># validation用に、featuresとlabelsを渡し、datasetを定義し、dataloaderを定義するロジック</span>
    <span class="keyword">def</span> <span class="function">set_val_dataloader</span>(
        <span class="predefined-constant">self</span>, dataloader_params, weekly_features, weekly_labels, max_sequence_length
    ):
        <span class="predefined-constant">self</span>.val_dataloader = <span class="predefined-constant">self</span>._build_dataloader(
            dataloader_params=dataloader_params,
            weekly_features=weekly_features,
            weekly_labels=weekly_labels,
            max_sequence_length=max_sequence_length,
        )

        <span class="comment"># dataloaderからiteratorを定義する</span>
        <span class="comment"># iteratorはnext関数よりデータをサンプルすることが可能となる。</span>
        <span class="predefined-constant">self</span>.iterable_val_dataloader = <span class="predefined">iter</span>(<span class="predefined-constant">self</span>.val_dataloader)

    <span class="comment"># 学習ロジック</span>
    <span class="keyword">def</span> <span class="function">train</span>(<span class="predefined-constant">self</span>, n_epoch):
        <span class="comment"># n_epochの回数分、全学習データを複数回用いて学習する。</span>
        <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="predefined">range</span>(n_epoch):

            <span class="comment"># 各々のepochごとのaverage lossを表示するため、lossをstoreするリストを定義する。</span>
            train_losses = []
            test_losses = []

            <span class="comment"># train_dataloaderの長さは、全ての学習データを一度用いるときの長さと同様である。</span>
            <span class="comment"># batchを組むと、その分train_dataloaderの長さは可変し、ちょうど一度全てのデータで学習できる長さを返す。</span>
            <span class="keyword">for</span> iter_ <span class="keyword">in</span> tqdm(<span class="predefined">range</span>(<span class="predefined">len</span>(<span class="predefined-constant">self</span>.train_dataloader))):
                <span class="comment"># パラメータをtrainableにするため、feature_combinerをtrainモードにする。</span>
                <span class="predefined-constant">self</span>.feature_combiner.train()

                <span class="comment"># trainデータをサンプルする。</span>
                x, y = <span class="predefined-constant">self</span>._sample_xy(data_type=<span class="string"><span class="delimiter">&quot;</span><span class="content">train</span><span class="delimiter">&quot;</span></span>)

                <span class="comment"># feature_combinerに特徴量を入力し、sentiment scoreを取得する。</span>
                preds = <span class="predefined-constant">self</span>.feature_combiner(x=x)

                <span class="comment"># sentiment scoreとラベルとのロスを計算する。</span>
                train_loss = <span class="predefined-constant">self</span>.criterion(preds, y.view(-<span class="integer">1</span>, <span class="integer">1</span>))

                <span class="comment"># 計算されたロスは、後ほどepochごとのdisplayに使用するため、storeしておく。</span>
                train_losses.append(train_loss.detach().cpu())

                <span class="comment"># lossから、gradientを逆伝播させ、パラメータをupdateする。</span>
                <span class="predefined-constant">self</span>._update_params(loss=train_loss)

                <span class="comment"># validation用のロースを計算する。</span>
                <span class="comment"># 毎回計算を行うとコストがかかってくるので、iter_毎5回ごとに計算を行う。</span>
                <span class="keyword">if</span> iter_ % <span class="integer">5</span> == <span class="integer">0</span>:

                    <span class="comment"># 学習を行わないため、feature_combinerをevalモードにしておく。</span>
                    <span class="comment"># evalモードでは、dropoutの影響を受けない。</span>
                    <span class="predefined-constant">self</span>.feature_combiner.eval()

                    <span class="comment"># 各パラメータごとのgradientを計算するとリソースが高まる。</span>
                    <span class="comment"># evaluationの時には、gradient情報を持たせないことで、メモリーの節約に繋がる。</span>
                    <span class="keyword">with</span> torch.no_grad():
                        <span class="comment"># validationデータをサンプルする</span>
                        x, y = <span class="predefined-constant">self</span>._sample_xy(data_type=<span class="string"><span class="delimiter">&quot;</span><span class="content">val</span><span class="delimiter">&quot;</span></span>)

                        <span class="comment"># feature_combinerに特徴量を入力し、sentiment scoreを取得する。</span>
                        preds = <span class="predefined-constant">self</span>.feature_combiner(x=x)

                        <span class="comment"># sentiment scoreとラベルとのロスを計算する。</span>
                        test_loss = <span class="predefined-constant">self</span>.criterion(preds, y.view(-<span class="integer">1</span>, <span class="integer">1</span>))

                        <span class="comment"># 計算されたロスは、後ほどepochごとのdisplayに使用するため、storeしておく。</span>
                        test_losses.append(test_loss.detach().cpu())

            <span class="comment"># 毎epoch終了後、平均のロスをプリントする。</span>
            print(
                f<span class="string"><span class="delimiter">&quot;</span><span class="content">epoch: {epoch}, train_loss: {np.mean(train_losses):.4f}, val_loss: {np.mean(test_losses):.4f}</span><span class="delimiter">&quot;</span></span>
            )

            <span class="comment"># 毎epoch終了後、モデルのパラメータをstoreする。</span>
            <span class="predefined-constant">self</span>._save_model(epoch=epoch)

    <span class="comment"># 特徴量から、合成特徴量を抽出するロジック</span>
    <span class="keyword">def</span> <span class="function">combine_features</span>(<span class="predefined-constant">self</span>, features):
        <span class="comment"># 学習を行わないため、feature_combinerをevalモードにしておく。</span>
        <span class="predefined-constant">self</span>.feature_combiner.eval()

        <span class="comment"># gradient情報を持たせないことで、メモリーの節約する。</span>
        <span class="keyword">with</span> torch.no_grad():

            <span class="comment"># 特徴量をfeature_combinerのextract_feature関数に入力し、出力層手前の特徴量を抽出する。</span>
            <span class="comment"># 抽出するとき、tensorをcpu上に落とし、np.ndarray形式に変換する。</span>
            <span class="keyword">return</span> (
                <span class="predefined-constant">self</span>.feature_combiner.extract_feature(
                    x=torch.tensor(features, dtype=torch.float).to(<span class="predefined-constant">self</span>.device)
                )
                .cpu()
                .numpy()
            )

    <span class="comment"># 特徴量から、翌週のsentimentを予測するロジック</span>
    <span class="keyword">def</span> <span class="function">predict_sentiment</span>(<span class="predefined-constant">self</span>, features):
        <span class="comment"># 学習を行わないため、feature_combinerをevalモードにしておく。</span>
        <span class="predefined-constant">self</span>.feature_combiner.eval()

        <span class="comment"># gradient情報を持たせないことで、メモリーの節約する。</span>
        <span class="keyword">with</span> torch.no_grad():

            <span class="comment"># 特徴量をfeature_combinerに入力し、sentiment scoreを抽出する。</span>
            <span class="comment"># 抽出するとき、tensorをcpu上に落とし、np.ndarray形式に変換する。</span>
            <span class="keyword">return</span> (
                <span class="predefined-constant">self</span>.feature_combiner(x=torch.tensor(features, dtype=torch.float).to(<span class="predefined-constant">self</span>.device))
                .cpu()
                .numpy()
            )

    <span class="comment"># weeklyグループされた特徴量を入力に、合成特徴量もしくは、sentiment scoreを抽出するロジック</span>
    <span class="keyword">def</span> <span class="function">generate_by_weekly_features</span>(
        <span class="predefined-constant">self</span>, weekly_features, generate_target, max_sequence_length
    ):
        <span class="keyword">assert</span> generate_target <span class="keyword">in</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">features</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sentiment</span><span class="delimiter">&quot;</span></span>)
        generate_func = <span class="predefined">getattr</span>(
            <span class="predefined-constant">self</span>,
            {<span class="string"><span class="delimiter">&quot;</span><span class="content">features</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">combine_features</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sentiment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">predict_sentiment</span><span class="delimiter">&quot;</span></span>}[
                generate_target
            ],
        )

        <span class="comment"># グループごとに特徴量もしくは、sentiment scoreを抽出し、最終的に重ねて返すため、リストを作成する。</span>
        outputs = []

        <span class="comment"># ユニークな週indexを取得する。</span>
        weeks = <span class="predefined">sorted</span>(weekly_features.index.get_level_values(<span class="integer">0</span>).unique())

        <span class="keyword">for</span> week <span class="keyword">in</span> tqdm(weeks):
            <span class="comment"># 各週ごとの特徴量を取得し、直近から、max_sequence_length分切る。</span>
            features = weekly_features.xs(week, axis=<span class="integer">0</span>, level=<span class="integer">0</span>)[-max_sequence_length:]

            <span class="comment"># 特徴量をモデルに入力し、合成特徴量もしくは、sentiment scoreを抽出し、outputsにappendする。</span>
            <span class="comment"># np.expand_dims(features, axis=0)を用いる理由は、特徴量合成機の入力期待値は、dimention0がbatchであるが、</span>
            <span class="comment"># featuresは、[1000, 768]の次元をもち、これらをunsqueezeし、[1, 1000, 768]に変換する必要がある。</span>
            outputs.append(generate_func(features=np.expand_dims(features, axis=<span class="integer">0</span>)))

        <span class="comment"># outputsを重ね、indexの情報とともにpd.DataFrame形式として返す。</span>
        <span class="keyword">return</span> pd.DataFrame(np.concatenate(outputs, axis=<span class="integer">0</span>), index=weeks)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_特徴量合成モデルの学習及び特徴量合成">6.2.9. 特徴量合成モデルの学習及び特徴量合成</h4>
<div class="paragraph">
<p>　本節では、実際作成したコードを元に、特徴量合成機の学習を行います。さらに、学習されたモデルを用いて、特徴量とsentiment scoreを抽出します。本実装では、モデルの過学習を防止するため、二つのランダム性を与えています。これは、学習のたびに異なるランダム性を与えられ、学習の再現は不可能となります。</p>
</div>
<div class="paragraph">
<p>　学習における再現可能性を重要視する場合、ランダム性を固定する必要があります。しかし、本実装においては二つのランダム性を同時に固定しないといけないことから、そのための実装を実施するとコードの難易度が高まってしまいます。以上のことから、本チュートリアルではランダム性の固定を省略しています。学習の実行毎に少し異なるモデルが構築されることに留意しましょう。ただし、推論処理においてはここで固定化しなかったランダム性の影響はありませんので、同一のモデルを利用する限りは同一の予測結果が取得されます。推論処理の再現可能性はバックテスト評価において重要です。</p>
</div>
<div class="paragraph">
<p>　まずは、上記で作成したFeatureCombinerHandlerをインスタンス化します。そのとき、feature_combiner_paramsに{"input_size": 768, "hidden_size": 128}を渡していますが、これはBERTから抽出した特徴量のサイズが768であるためです。LSTMが持つ内部状態のパラメータの次元においては、適切な値を設定しましょう。ここでは、128次元と設置しているのですが、過学習の恐れが高いときやパラメータを減らしても十分学習可能な時には、より低い値をセットしてみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">feature_combiner_handler = FeatureCombinerHandler(feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>}, store_dir=f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/test</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　続いて、学習用とvalidation用のデータを構築します。一般的に、データは学習に用いられるTrainデータと、パラメータなどの調整のため用いられるvalidationデータ、学習後のモデルを評価するためのtestデータに分けることが多いですが、本チュートリアルでは、LSTMを十分に学習するにはデータ数が少ないため、TrainとTestデータに分割し、validation lossの算出時にもtestデータを用います。まずは、上記で作成したbuild_weekly_featuresとbuild_weekly_labelsを用いて、データセットを生成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">boundary_week = (<span class="integer">2020</span>, <span class="integer">26</span>)
weekly_features = SentimentGenerator.build_weekly_features(features, boundary_week)
weekly_labels = SentimentGenerator.build_weekly_labels(stock_price, boundary_week)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　学習を行う前に、データのサンプル及び、batch処理を行ってくれるDataloaderをビルドする必要があります。このとき、batch_sizeを4にすることで、4つのデータを並列に学習し、num_workersを2にすることでdataloaderはcpu 2coreを用いて、並列的に読み込まれます。max_sequence_lengthを1,000にすることで、学習中には1,000個のsequenceをmaxとして入力します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># train dataloaderをsetする。</span>
feature_combiner_handler.set_train_dataloader(
    dataloader_params={
        <span class="string"><span class="delimiter">&quot;</span><span class="content">batch_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">num_workers</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
    },
    weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>],
    weekly_labels=weekly_labels[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>],
    max_sequence_length=<span class="integer">1000</span>
)

<span class="comment"># validation dataloaderをsetする。</span>
feature_combiner_handler.set_val_dataloader(
    dataloader_params={
        <span class="string"><span class="delimiter">&quot;</span><span class="content">batch_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">num_workers</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
    },
    weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>],
    weekly_labels=weekly_labels[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>],
    max_sequence_length=<span class="integer">1000</span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　学習を行ってみましょう。n_epochは全てのデータを一度用いた学習回数を表し、ここでは、テストであるため1と設定しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">feature_combiner_handler.train(n_epoch=<span class="integer">1</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">epoch: <span class="integer">0</span>, train_loss: <span class="float">0.7934</span>, val_loss: <span class="float">0.6816</span>
[+] Epoch: <span class="integer">0</span>, Model <span class="keyword">is</span> saved.</code></pre>
</div>
</div>
<div class="paragraph">
<p>　学習後、特徴量抽出機から、特徴量やsentiment scoreを抽出することができます。今回は、一度学習されたモデルをロードし、特徴量とsentiment scoreを抽出してみます。上で定義した、feature_combiner_handlerを同様に定義すると、check_pointを探し、モデルがロードされます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">feature_combiner_handler = FeatureCombinerHandler(feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>}, store_dir=f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/test</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　sentiment scoreは以下のように取得できます。max_sequence_lengthは学習時と同様に、直近から利用する特徴量の最大の数を決めることができますが、評価時には、十分長い(全部かほぼ全部)の特徴量を合成するため、10,000を与えます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">sentiment_score = feature_combiner_handler.generate_by_weekly_features(weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>], generate_target=<span class="string"><span class="delimiter">'</span><span class="content">sentiment</span><span class="delimiter">'</span></span>, max_sequence_length=<span class="integer">10000</span>)

display(sentiment_score.head(<span class="integer">3</span>))
display(sentiment_score.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_lstm_test_sentiment_score.png" alt="1_7_lstm_test_sentiment_score" width="20%">
</div>
</div>
<div class="paragraph">
<p>また、より高次元の特徴量は以下のように取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">combined_features = feature_combiner_handler.generate_by_weekly_features(weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>], generate_target=<span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>, max_sequence_length=<span class="integer">10000</span>)

display(combined_features.head(<span class="integer">3</span>))
display(combined_features.tail(<span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_lstm_test_features.png" alt="1_7_lstm_test_features" width="50%">
</div>
</div>
<div class="paragraph">
<p>上で作成したFeatureCombinerHandlerは、本番環境においても特徴量の合成時に用います。<code>SentimentGenerator</code> クラスに、インスタンスとしてビルドしておきましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">SentimentGenerator.headline_feature_combiner_handler = FeatureCombinerHandler(feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>}, store_dir=f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/headline_features</span><span class="delimiter">'</span></span>)
SentimentGenerator.keywords_feature_combiner_handler = FeatureCombinerHandler(feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>}, store_dir=f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/keywords_features</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のコードをまとめ、headlineとkeywordsそれぞれにおいて、特徴量合成機を学習し、特徴量を抽出するコードを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">boundary_week = (<span class="integer">2020</span>, <span class="integer">26</span>)
<span class="keyword">for</span> features, feature_type <span class="keyword">in</span> [(headline_features, <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>), (keywords_features, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>)]:
    <span class="comment"># feature_typeに合致するfeature_combiner_handlerをSentimentGeneratorから取得する。</span>
    feature_combiner_handler = {
        <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>: SentimentGenerator.headline_feature_combiner_handler,
        <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>: SentimentGenerator.keywords_feature_combiner_handler,
    }[feature_type]

    <span class="comment"># 学習及び、validationに用いる、データをビルドする</span>
    weekly_features = SentimentGenerator.build_weekly_features(features, boundary_week)
    weekly_labels = SentimentGenerator.build_weekly_labels(stock_price, boundary_week)

    <span class="comment"># train dataloaderをsetする。</span>
    <span class="comment"># このとき、batch_sizeを4にすることで、4つのデータを並列に学習し、</span>
    <span class="comment"># num_workersを2にすることでdataloaderはcpu 2coreを用いて、並列的にロードされる。</span>
    feature_combiner_handler.set_train_dataloader(
        dataloader_params={
            <span class="string"><span class="delimiter">&quot;</span><span class="content">batch_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">num_workers</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
        },
        weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>],
        weekly_labels=weekly_labels[<span class="string"><span class="delimiter">'</span><span class="content">train</span><span class="delimiter">'</span></span>],
        max_sequence_length=<span class="integer">1000</span>
    )

    <span class="comment"># validation dataloaderをsetする。</span>
    feature_combiner_handler.set_val_dataloader(
        dataloader_params={
            <span class="string"><span class="delimiter">&quot;</span><span class="content">batch_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">num_workers</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
        },
        weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>],
        weekly_labels=weekly_labels[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>],
        max_sequence_length=<span class="integer">1000</span>
    )

    <span class="comment"># 学習</span>
    feature_combiner_handler.train(n_epoch=<span class="integer">20</span>)

    <span class="comment"># 特徴量及びsentiment scoreを抽出し、pickleとしてstoreする。</span>
    feature_combiner_handler.generate_by_weekly_features(weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>], generate_target=<span class="string"><span class="delimiter">'</span><span class="content">sentiment</span><span class="delimiter">'</span></span>, max_sequence_length=<span class="integer">10000</span>).to_pickle(os.path.join(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/{feature_type}</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">LSTM_sentiment.pkl</span><span class="delimiter">'</span></span>))
    feature_combiner_handler.generate_by_weekly_features(weekly_features=weekly_features[<span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>], generate_target=<span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>, max_sequence_length=<span class="integer">10000</span>).to_pickle(os.path.join(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/{feature_type}</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">LSTM_features.pkl</span><span class="delimiter">'</span></span>))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_本番提出用のクラス作成">6.2.10. 本番提出用のクラス作成</h4>
<div class="paragraph">
<p>　ここまでの、ニュースデータの読み込み、前処理、BERT特徴量、LSTMによる特徴量合成までの一連の処理を <code>generate_lstm_features</code> 関数として、<code>SentimentGenerator</code>クラスに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@classmethod</span>
<span class="keyword">def</span> <span class="function">generate_lstm_features</span>(
    cls,
    article_path,
    start_dt=<span class="predefined-constant">None</span>,
    boundary_week=(<span class="integer">2020</span>, <span class="integer">26</span>),
    target_feature_types=<span class="predefined-constant">None</span>,
):
    <span class="comment"># target_feature_typesが指定されなかったらデフォルト値設定</span>
    dfault_target_feature_types = [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>,
    ]
    <span class="keyword">if</span> target_feature_types <span class="keyword">is</span> <span class="predefined-constant">None</span>:
        target_feature_types = dfault_target_feature_types
    <span class="comment"># feature typeが想定通りであることを確認</span>
    <span class="keyword">assert</span> <span class="predefined">set</span>(target_feature_types).issubset(dfault_target_feature_types)

    <span class="comment"># ニュースデータをロードする。</span>
    articles = cls.load_articles(start_dt=start_dt, path=article_path)

    <span class="comment"># 前処理を行う。</span>
    articles = cls.normalize_articles(articles)
    articles = cls.handle_punctuations_in_articles(articles)
    articles = cls.drop_remove_list_words(articles)

    <span class="comment"># headlineとkeywordsの特徴量をdict型で返す。</span>
    lstm_features = {}

    <span class="keyword">for</span> feature_type <span class="keyword">in</span> target_feature_types:
        <span class="comment"># コーパス全体のBERT特徴量を抽出する。</span>
        features = cls.generate_features_by_texts(texts=articles[feature_type])

        <span class="comment"># feature_typeに合致するfeature_combiner_handlerをclsから取得する。</span>
        feature_combiner_handler = {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>: cls.headline_feature_combiner_handler,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>: cls.keywords_feature_combiner_handler,
        }[feature_type]

        <span class="comment"># 特徴量を週毎のグループ化する。</span>
        weekly_features = cls.build_weekly_features(features, boundary_week)[<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>]

        <span class="comment"># Sentiment scoreを抽出する。</span>
        lstm_features[
            f<span class="string"><span class="delimiter">&quot;</span><span class="content">{feature_type}_features</span><span class="delimiter">&quot;</span></span>
        ] = feature_combiner_handler.generate_by_weekly_features(
            weekly_features=weekly_features,
            generate_target=<span class="string"><span class="delimiter">&quot;</span><span class="content">sentiment</span><span class="delimiter">&quot;</span></span>,
            max_sequence_length=<span class="integer">10000</span>,
        )

    <span class="keyword">return</span> lstm_features</code></pre>
</div>
</div>
<div class="paragraph">
<p>　ここまで<code>SentimentGenerator</code>に追加したclass methodをまとめ、<code>SentimentGenerator</code>クラスを仕上げます。5章で実装した処理も一部利用してることに注意してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">SentimentGenerator</span>(<span class="predefined">object</span>):
    article_columns = <span class="predefined-constant">None</span>
    device = <span class="predefined-constant">None</span>
    feature_extractor = <span class="predefined-constant">None</span>
    headline_feature_combiner_handler = <span class="predefined-constant">None</span>
    keywords_feature_combiner_handler = <span class="predefined-constant">None</span>
    punctuation_replace_dict = <span class="predefined-constant">None</span>
    punctuation_remove_list = <span class="predefined-constant">None</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">initialize</span>(cls, base_dir=<span class="string"><span class="delimiter">&quot;</span><span class="content">../model</span><span class="delimiter">&quot;</span></span>):
        <span class="comment"># 使用するcolumnをセットする。</span>
        cls.article_columns = [<span class="string"><span class="delimiter">&quot;</span><span class="content">publish_datetime</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>]

        <span class="comment"># BERT特徴量抽出機をセットする。</span>
        cls._set_device()
        cls._build_feature_extractor()
        cls._build_tokenizer()

        <span class="comment"># LSTM特徴量合成機をセットする。</span>
        cls.headline_feature_combiner_handler = FeatureCombinerHandler(
            feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>},
            store_dir=f<span class="string"><span class="delimiter">&quot;</span><span class="content">{base_dir}/headline_features</span><span class="delimiter">&quot;</span></span>,
        )
        cls.keywords_feature_combiner_handler = FeatureCombinerHandler(
            feature_combiner_params={<span class="string"><span class="delimiter">&quot;</span><span class="content">input_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">768</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_size</span><span class="delimiter">&quot;</span></span>: <span class="integer">128</span>},
            store_dir=f<span class="string"><span class="delimiter">&quot;</span><span class="content">{base_dir}/keywords_features</span><span class="delimiter">&quot;</span></span>,
        )

        <span class="comment"># 置換すべき記号のdictionaryを作成する。</span>
        JISx0208_replace_dict = {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">髙</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">高</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">﨑</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">崎</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">濵</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">浜</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">賴</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">頼</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">瀨</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">瀬</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">德</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">徳</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">蓜</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">配</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">昻</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">昂</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">桒</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">桑</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">栁</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">柳</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">犾</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">犹</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">琪</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">棋</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">裵</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">裴</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">魲</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">鱸</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">羽</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">羽</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">焏</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">丞</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">祥</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">祥</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">曻</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">昇</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">敎</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">教</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">澈</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">徹</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">曺</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">曹</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">黑</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">黒</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">塚</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">塚</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">閒</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">間</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">彅</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">薙</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">匤</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">匡</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">冝</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">宜</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">埇</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">甬</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">鮏</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">鮭</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">伹</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">但</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">杦</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">杉</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">罇</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">樽</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">柀</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">披</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">﨤</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">返</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">寬</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">寛</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">神</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">神</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">福</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">福</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">礼</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">礼</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">贒</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">賢</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">逸</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">逸</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">隆</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">隆</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">靑</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">青</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">飯</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">飯</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">飼</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">飼</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">緖</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">緒</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">埈</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">峻</span><span class="delimiter">&quot;</span></span>,
        }

        cls.punctuation_replace_dict = {
            **JISx0208_replace_dict,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">《</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">〈</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">》</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">〉</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">『</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">「</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">』</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">」</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">“</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">!!</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">!</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">〔</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">〕</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">χ</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>,
        }

        <span class="comment"># 取り除く記号リスト。</span>
        cls.punctuation_remove_list = [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">|</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">■</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">◆</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">●</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">★</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">☆</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">♪</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">〃</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">△</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">○</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">□</span><span class="delimiter">&quot;</span></span>,
        ]

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">_set_device</span>(cls):
        <span class="comment"># 使用可能なgpuがある場合、そちらを利用し特徴量抽出を行う</span>
        <span class="keyword">if</span> torch.cuda.device_count() &gt;= <span class="integer">1</span>:
            cls.device = <span class="string"><span class="delimiter">&quot;</span><span class="content">cuda</span><span class="delimiter">&quot;</span></span>
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: GPU</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">else</span>:
            cls.device = <span class="string"><span class="delimiter">&quot;</span><span class="content">cpu</span><span class="delimiter">&quot;</span></span>
            print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Set Device: CPU</span><span class="delimiter">&quot;</span></span>)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">_build_feature_extractor</span>(cls):
        <span class="comment"># 特徴量抽出のため事前学習済みBERTモデルを用いる。</span>
        <span class="comment"># ここでは、&quot;cl-tohoku/bert-base-japanese-whole-word-masking&quot;モデルを使用しているが、異なる日本語BERTモデルを用いても良い。</span>
        cls.feature_extractor = transformers.BertModel.from_pretrained(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">cl-tohoku/bert-base-japanese-whole-word-masking</span><span class="delimiter">&quot;</span></span>,
            return_dict=<span class="predefined-constant">True</span>,
            output_hidden_states=<span class="predefined-constant">True</span>,
        )

        <span class="comment"># 使用するdeviceを指定</span>
        cls.feature_extractor = cls.feature_extractor.to(cls.device)

        <span class="comment"># 今回、学習は行わない。特徴量抽出のためなので、評価モードにセットする。</span>
        cls.feature_extractor.eval()

        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Built feature extractor</span><span class="delimiter">&quot;</span></span>)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">_build_tokenizer</span>(cls):
        <span class="comment"># BERTモデルの入力とするコーパスはそのBERTモデルが学習された時と同様の前処理を行う必要がある。</span>
        <span class="comment"># 今回使用する&quot;cl-tohoku/bert-base-japanese-whole-word-masking&quot;モデルは、mecab-ipadic-NEologdによりトークナイズされ、その後Wordpiece subword encoderよりsubword化している。</span>
        <span class="comment"># Subwordとは形態素の類似な概念として、単語をより小さい意味のある単位に変換したものである。</span>
        <span class="comment"># transformersのBertJapaneseTokenizerは、その事前学習モデルの学習時と同様の前処理を簡単に使用することができる。</span>
        <span class="comment"># この章ではBertJapaneseTokenizerを利用し、トークナイズ及びsubword化を行う。</span>
        cls.bert_tokenizer = BertJapaneseTokenizer.from_pretrained(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">cl-tohoku/bert-base-japanese-whole-word-masking</span><span class="delimiter">&quot;</span></span>
        )
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] Built bert tokenizer</span><span class="delimiter">&quot;</span></span>)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">load_articles</span>(cls, path, start_dt=<span class="predefined-constant">None</span>, end_dt=<span class="predefined-constant">None</span>):
        <span class="comment"># csvをロードする</span>
        <span class="comment"># headline、keywordsをcolumnとして使用。publish_datetimeをindexとして使用。</span>
        articles = pd.read_csv(path)[cls.article_columns].set_index(<span class="string"><span class="delimiter">&quot;</span><span class="content">publish_datetime</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># str形式のdatetimeをpd.Timestamp形式に変換</span>
        articles.index = pd.to_datetime(articles.index)

        <span class="comment"># NaN値を取り除く</span>
        articles = articles.dropna()

        <span class="comment"># 必要な場合、使用するデータの範囲を指定する</span>
        <span class="keyword">return</span> articles[start_dt:end_dt]

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">normalize_articles</span>(cls, articles):
        articles = articles.copy()

        <span class="comment"># 欠損値を取り除く</span>
        articles = articles.dropna()

        <span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
            <span class="comment"># スペース(全角スペースを含む)はneologdn正規化時に全て除去される。</span>
            <span class="comment"># ここでは、スペースの情報が失われないように、スペースを全て改行に書き換え、正規化後スペースに再変換する。</span>
            articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.join(x.split()))

            <span class="comment"># neologdnを使って正規化を行う。</span>
            articles[column] = articles[column].apply(<span class="keyword">lambda</span> x: neologdn.normalize(x))

            <span class="comment"># 改行をスペースに置換する。</span>
            articles[column] = articles[column].str.replace(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>)

        <span class="keyword">return</span> articles

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">handle_punctuations_in_articles</span>(cls, articles):
        articles = articles.copy()

        <span class="keyword">for</span> column <span class="keyword">in</span> articles.columns:
            <span class="comment"># punctuation_remove_listに含まれる記号を除去する</span>
            articles[column] = articles[column].str.replace(
                fr<span class="string"><span class="delimiter">&quot;</span><span class="content">[{''.join(cls.punctuation_remove_list)}]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
            )

            <span class="comment"># punctuation_replace_dictに含まれる記号を置換する</span>
            <span class="keyword">for</span> replace_base, replace_target <span class="keyword">in</span> cls.punctuation_replace_dict.items():
                articles[column] = articles[column].str.replace(
                    replace_base, replace_target
                )

            <span class="comment"># unicode正規化を行う</span>
            articles[column] = articles[column].apply(
                <span class="keyword">lambda</span> x: unicodedata.normalize(<span class="string"><span class="delimiter">&quot;</span><span class="content">NFKC</span><span class="delimiter">&quot;</span></span>, x)
            )

        <span class="keyword">return</span> articles

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">drop_remove_list_words</span>(cls, articles, remove_list_words=[<span class="string"><span class="delimiter">&quot;</span><span class="content">人事</span><span class="delimiter">&quot;</span></span>]):
        articles = articles.copy()

        <span class="keyword">for</span> remove_list_word <span class="keyword">in</span> remove_list_words:
            <span class="comment"># headlineもしくは、keywordsどちらかでremove_list_wordを含むニュース記事のindexマスクを作成。</span>
            drop_mask = articles[<span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>].str.contains(remove_list_word) | articles[
                <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>
            ].str.contains(remove_list_word)

            <span class="comment"># remove_list_wordを含まないニュースだけに精製する。</span>
            articles = articles[~drop_mask]

        <span class="keyword">return</span> articles

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">build_inputs</span>(cls, texts, max_length=<span class="integer">512</span>):
        input_ids = []
        token_type_ids = []
        attention_mask = []
        <span class="keyword">for</span> text <span class="keyword">in</span> texts:
            encoded = cls.bert_tokenizer.encode_plus(
                text,
                <span class="predefined-constant">None</span>,
                add_special_tokens=<span class="predefined-constant">True</span>,
                max_length=max_length,
                padding=<span class="string"><span class="delimiter">&quot;</span><span class="content">max_length</span><span class="delimiter">&quot;</span></span>,
                return_token_type_ids=<span class="predefined-constant">True</span>,
                truncation=<span class="predefined-constant">True</span>,
            )

            input_ids.append(encoded[<span class="string"><span class="delimiter">&quot;</span><span class="content">input_ids</span><span class="delimiter">&quot;</span></span>])
            token_type_ids.append(encoded[<span class="string"><span class="delimiter">&quot;</span><span class="content">token_type_ids</span><span class="delimiter">&quot;</span></span>])
            attention_mask.append(encoded[<span class="string"><span class="delimiter">&quot;</span><span class="content">attention_mask</span><span class="delimiter">&quot;</span></span>])

        <span class="comment"># torchモデルに入力するためにはtensor形式に変え、deviceを指定する必要がある。</span>
        input_ids = torch.tensor(input_ids, dtype=torch.long).to(cls.device)
        token_type_ids = torch.tensor(token_type_ids, dtype=torch.long).to(cls.device)
        attention_mask = torch.tensor(attention_mask, dtype=torch.long).to(cls.device)

        <span class="keyword">return</span> input_ids, token_type_ids, attention_mask

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">generate_features</span>(cls, input_ids, token_type_ids, attention_mask):
        output = cls.feature_extractor(
            input_ids=input_ids,
            token_type_ids=token_type_ids,
            attention_mask=attention_mask,
        )
        features = output[<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden_states</span><span class="delimiter">&quot;</span></span>][-<span class="integer">2</span>].mean(dim=<span class="integer">1</span>).cpu().detach().numpy()

        <span class="keyword">return</span> features

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">generate_features_by_texts</span>(cls, texts, batch_size=<span class="integer">2</span>, max_length=<span class="integer">512</span>):
        n_batch = math.ceil(<span class="predefined">len</span>(texts) / batch_size)

        features = []
        <span class="keyword">for</span> idx <span class="keyword">in</span> tqdm(<span class="predefined">range</span>(n_batch)):
            input_ids, token_type_ids, attention_mask = cls.build_inputs(
                texts=texts[batch_size * idx : batch_size * (idx + <span class="integer">1</span>)],
                max_length=max_length,
            )

            features.append(
                cls.generate_features(
                    input_ids=input_ids,
                    token_type_ids=token_type_ids,
                    attention_mask=attention_mask,
                )
            )

        features = np.concatenate(features, axis=<span class="integer">0</span>)

        <span class="comment"># 抽出した特徴量はnp.ndarray形式となっており、これらは、日付の情報を失っているため、pd.DataFrame形式に変換する。</span>
        <span class="keyword">return</span> pd.DataFrame(features, index=texts.index)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">_build_weekly_group</span>(cls, df):
        <span class="comment"># index情報から、(year, week)の情報を得る。</span>
        <span class="keyword">return</span> pd.Series(<span class="predefined">list</span>(<span class="predefined">zip</span>(df.index.year, df.index.week)), index=df.index)

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">build_weekly_features</span>(cls, features, boundary_week):
        <span class="keyword">assert</span> <span class="predefined">isinstance</span>(boundary_week, <span class="predefined">tuple</span>)

        weekly_group = cls._build_weekly_group(df=features)
        features = features.groupby(weekly_group).apply(<span class="keyword">lambda</span> x: x[:])

        train_features = features[features.index.get_level_values(<span class="integer">0</span>) &lt;= boundary_week]
        test_features = features[features.index.get_level_values(<span class="integer">0</span>) &gt; boundary_week]

        <span class="keyword">return</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">train</span><span class="delimiter">&quot;</span></span>: train_features, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>: test_features}

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">generate_lstm_features</span>(
        cls,
        article_path,
        start_dt=<span class="predefined-constant">None</span>,
        boundary_week=(<span class="integer">2020</span>, <span class="integer">26</span>),
        target_feature_types=<span class="predefined-constant">None</span>,
    ):
        <span class="comment"># target_feature_typesが指定されなかったらデフォルト値設定</span>
        dfault_target_feature_types = [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>,
        ]
        <span class="keyword">if</span> target_feature_types <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            target_feature_types = dfault_target_feature_types
        <span class="comment"># feature typeが想定通りであることを確認</span>
        <span class="keyword">assert</span> <span class="predefined">set</span>(target_feature_types).issubset(dfault_target_feature_types)

        <span class="comment"># ニュースデータをロードする。</span>
        articles = cls.load_articles(start_dt=start_dt, path=article_path)

        <span class="comment"># 前処理を行う。</span>
        articles = cls.normalize_articles(articles)
        articles = cls.handle_punctuations_in_articles(articles)
        articles = cls.drop_remove_list_words(articles)

        <span class="comment"># headlineとkeywordsの特徴量をdict型で返す。</span>
        lstm_features = {}

        <span class="keyword">for</span> feature_type <span class="keyword">in</span> target_feature_types:
            <span class="comment"># コーパス全体のBERT特徴量を抽出する。</span>
            features = cls.generate_features_by_texts(texts=articles[feature_type])

            <span class="comment"># feature_typeに合致するfeature_combiner_handlerをclsから取得する。</span>
            feature_combiner_handler = {
                <span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>: cls.headline_feature_combiner_handler,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>: cls.keywords_feature_combiner_handler,
            }[feature_type]

            <span class="comment"># 特徴量を週毎のグループ化する。</span>
            weekly_features = cls.build_weekly_features(features, boundary_week)[<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>]

            <span class="comment"># Sentiment scoreを抽出する。</span>
            lstm_features[
                f<span class="string"><span class="delimiter">&quot;</span><span class="content">{feature_type}_features</span><span class="delimiter">&quot;</span></span>
            ] = feature_combiner_handler.generate_by_weekly_features(
                weekly_features=weekly_features,
                generate_target=<span class="string"><span class="delimiter">&quot;</span><span class="content">sentiment</span><span class="delimiter">&quot;</span></span>,
                max_sequence_length=<span class="integer">10000</span>,
            )

        <span class="keyword">return</span> lstm_features</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_合成特徴量の解析">6.3. 合成特徴量の解析</h3>
<div class="paragraph">
<p>　前章においてLSTMモデルを作成し、合成特徴量であるfeaturesとsentiment scoreを抽出しました。sentiment scoreは、featuresから線形次元圧縮されたものであり、featuresと比べより低次元の情報を保持しています。しかし、使用時の容易性を考慮し、以降のチュートリアルにおいては、sentiment scoreのみを用いてマーケット予測のモデリングを行います。本節では、sentiment scoreがどのような性質を持っているかを確認するため、予測対象となるマーケットのforward returnとの関係性を解析します。</p>
</div>
<div class="sect3">
<h4 id="_合成特徴量のデータのロード">6.3.1. 合成特徴量のデータのロード</h4>
<div class="paragraph">
<p>　抽出したsentiment scoreを読み込みます。columnは、次元順に付与されたidを表します。sentimentの場合は1次元のみのデータとなっているため、0でインデクシングし、解析ではpd.series形式として扱います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">headline_features = pd.read_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/headline_features/LSTM_sentiment.pkl</span><span class="delimiter">'</span></span>)[<span class="integer">0</span>].rename(<span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>)
keywords_features = pd.read_pickle(f<span class="string"><span class="delimiter">'</span><span class="content">{CONFIG[&quot;base_path&quot;]}/keywords_features/LSTM_sentiment.pkl</span><span class="delimiter">'</span></span>)[<span class="integer">0</span>].rename(<span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>)

display(headline_features.head())
display(keywords_features.head())</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。現在、LSTMの出力値は、値上がりと値下がりの確率となり、値下がり時は０、値上がり時は１に近い値を出力するように学習しています。十分なデータを揃えてモデルの学習を収束することができれば、実際に0に近い値、1に近い値なども出力するようになりますが、今回のように収束するほどのデータ量がない場合、学習時に観察したラベルの平均値や0.5近辺にモデルの出力は近くなります。マーケットデータのような一般的に学習の難しいデータでは、この現象が起きやすいことに注意してください。ただし、出力自体はきちんと入力データに対して変化していることが確認できるので、相対的な出力の強さを計測することでスコア化することもでき、相関係数や順位相関係数を用いてスコアの評価を実施することも可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">(<span class="integer">2020</span>, <span class="integer">27</span>)    <span class="float">0.601928</span>
(<span class="integer">2020</span>, <span class="integer">28</span>)    <span class="float">0.606229</span>
(<span class="integer">2020</span>, <span class="integer">29</span>)    <span class="float">0.603833</span>
(<span class="integer">2020</span>, <span class="integer">30</span>)    <span class="float">0.601890</span>
(<span class="integer">2020</span>, <span class="integer">31</span>)    <span class="float">0.605760</span>
Name: features, dtype: float32

(<span class="integer">2020</span>, <span class="integer">27</span>)    <span class="float">0.506807</span>
(<span class="integer">2020</span>, <span class="integer">28</span>)    <span class="float">0.508067</span>
(<span class="integer">2020</span>, <span class="integer">29</span>)    <span class="float">0.506754</span>
(<span class="integer">2020</span>, <span class="integer">30</span>)    <span class="float">0.506794</span>
(<span class="integer">2020</span>, <span class="integer">31</span>)    <span class="float">0.507054</span>
Name: features, dtype: float32</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_評価用ラベルをビルド">6.3.2. 評価用ラベルをビルド</h4>
<div class="paragraph">
<p>　上記で作成したマーケットのweekly_fwd_returnの作成ロジックと同様に、評価用ラベルである次週のマーケットのリターンを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># boundary_weekを学習時境界と同様に設定し、weekly_fwd_returnsをビルドする。</span>
weekly_group = SentimentGenerator._build_weekly_group(df=stock_price)
weekly_returns = stock_price.groupby(weekly_group).apply(_compute_weekly_return)
weekly_fwd_returns = weekly_returns.shift(-<span class="integer">1</span>).rename(<span class="string"><span class="delimiter">'</span><span class="content">weekly_fwd_returns</span><span class="delimiter">'</span></span>)

<span class="comment"># 特徴量の期間と同様の期間のデータのみを使用する。</span>
weekly_fwd_returns = weekly_fwd_returns.reindex(headline_features.index)

display(weekly_fwd_returns)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">(<span class="integer">2020</span>, <span class="integer">27</span>)   -<span class="float">0.017781</span>
(<span class="integer">2020</span>, <span class="integer">28</span>)    <span class="float">0.016613</span>
(<span class="integer">2020</span>, <span class="integer">29</span>)    <span class="float">0.001590</span>
(<span class="integer">2020</span>, <span class="integer">30</span>)   -<span class="float">0.048742</span>
(<span class="integer">2020</span>, <span class="integer">31</span>)    <span class="float">0.029370</span>
(<span class="integer">2020</span>, <span class="integer">32</span>)    <span class="float">0.039417</span>
(<span class="integer">2020</span>, <span class="integer">33</span>)    <span class="float">0.000009</span>
(<span class="integer">2020</span>, <span class="integer">34</span>)   -<span class="float">0.006018</span>
(<span class="integer">2020</span>, <span class="integer">35</span>)    <span class="float">0.003958</span>
(<span class="integer">2020</span>, <span class="integer">36</span>)    <span class="float">0.023614</span>
(<span class="integer">2020</span>, <span class="integer">37</span>)    <span class="float">0.021705</span>
(<span class="integer">2020</span>, <span class="integer">38</span>)   -<span class="float">0.000459</span>
(<span class="integer">2020</span>, <span class="integer">39</span>)   -<span class="float">0.024606</span>
(<span class="integer">2020</span>, <span class="integer">40</span>)    <span class="float">0.017951</span>
(<span class="integer">2020</span>, <span class="integer">41</span>)   -<span class="float">0.022318</span>
(<span class="integer">2020</span>, <span class="integer">42</span>)    <span class="float">0.000046</span>
(<span class="integer">2020</span>, <span class="integer">43</span>)   -<span class="float">0.033692</span>
(<span class="integer">2020</span>, <span class="integer">44</span>)    <span class="float">0.040975</span>
(<span class="integer">2020</span>, <span class="integer">45</span>)    <span class="float">0.000463</span>
(<span class="integer">2020</span>, <span class="integer">46</span>)   -<span class="float">0.004318</span>
(<span class="integer">2020</span>, <span class="integer">47</span>)    <span class="float">0.008869</span>
(<span class="integer">2020</span>, <span class="integer">48</span>)   -<span class="float">0.002206</span>
(<span class="integer">2020</span>, <span class="integer">49</span>)   -<span class="float">0.003282</span>
(<span class="integer">2020</span>, <span class="integer">50</span>)    <span class="float">0.001516</span>
(<span class="integer">2020</span>, <span class="integer">51</span>)   -<span class="float">0.009117</span>
(<span class="integer">2020</span>, <span class="integer">52</span>)    <span class="float">0.005004</span>
Name: weekly_fwd_returns, dtype: float64</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_合成特徴量とラベル間の相関の確認">6.3.3. 合成特徴量とラベル間の相関の確認</h4>
<div class="paragraph">
<p>　合成特徴量と上で作成したラベル間の相関を調べます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 二つのpd.Seriesをconcatenateする。</span>
<span class="comment"># indexの違いがあるため、片方だけ存在するデータはドロップする。</span>
df = pd.concat([headline_features, weekly_fwd_returns], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>).dropna()

<span class="comment"># 二つのコラムのシークエンス間の相関は、以下のように取得できる。</span>
display(df.corr()[df.columns[<span class="integer">0</span>]][df.columns[-<span class="integer">1</span>]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="float">0.6040216860152573</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、corr関数にmethodを指定して、pearsonの相関係数及びspearmanの順位相関係数を計算します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">display_corr</span>(df):
    display(pd.Series(
        {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">pearson</span><span class="delimiter">&quot;</span></span>: df.corr(method=<span class="string"><span class="delimiter">'</span><span class="content">pearson</span><span class="delimiter">'</span></span>)[df.columns[<span class="integer">0</span>]][df.columns[-<span class="integer">1</span>]],
            <span class="string"><span class="delimiter">&quot;</span><span class="content">spearman</span><span class="delimiter">&quot;</span></span>: df.corr(method=<span class="string"><span class="delimiter">'</span><span class="content">spearman</span><span class="delimiter">'</span></span>)[df.columns[<span class="integer">0</span>]][df.columns[-<span class="integer">1</span>]]
        }
    ))

display_corr(df)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">pearson     <span class="float">0.604022</span>
spearman    <span class="float">0.566496</span>
dtype: float64</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記の関数をheadline, keywords両方に適用し、ラベルとの相関を表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> features, feature_type <span class="keyword">in</span> [(headline_features, <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>), (keywords_features, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>)]:
    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">#### feature_type: {feature_type}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
    df = pd.concat([features, weekly_fwd_returns], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>).dropna()
    display_corr(df)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。headline_featuresはpearson相関係数が0.60、spearmanの相関係数が0.57となっています。keywords_featuresは若干相関係数が下がりますが、それでも十分に高い相関係数を保持しています。</p>
</div>
<div class="paragraph">
<p>　参考までに相関係数0.6というのは株式予測における予測スコアと未来の変化率の相関係数としては高い数値です。通常、株式の予測モデル(高値・安値の予測モデルではないことに注意してください)と未来の変化率の相関係数(情報係数ともよばれます)は、10年程度の十分に長い期間で検定した時は0.1から0.2に到達すれば優秀なモデルといわれています(シストレのススメ 3.5.投資指標の探索要領より引用 <a href="http://we.love-profit.com/entry/2018/04/01/152750" class="bare">http://we.love-profit.com/entry/2018/04/01/152750</a> )。</p>
</div>
<div class="paragraph">
<p>　0.6という今回の結果は、2020年後半という非常に限定された期間のバックテスト結果ですので、この手法によるスコアが未来まで高いパフォーマンスを発揮するかは現時点で判断できません。これは学習に利用した2020年前半のデータ・ラベルの分布と評価に利用した期間のデータ・ラベルの分布が似通っていることが原因だろうと推測されます。5章でコーパスを確認したときも、「コロナウィルス」などが頻出単語として登場しましたが、2020年のように年間を通して一つの「コロナウィルス」という単語がニュースデータで支配的であることは稀であり、この非常に高いパフォーマンスは2020年のデータ・ラベルの分布が原因であろうと考察されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">feature_type: headline_features
pearson     <span class="float">0.604022</span>
spearman    <span class="float">0.566496</span>
dtype: float64

feature_type: keywords_features
pearson     <span class="float">0.565515</span>
spearman    <span class="float">0.474872</span>
dtype: float64</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_結果の可視化">6.4. 結果の可視化</h3>
<div class="paragraph">
<p>　結果の妥当性を検証するため、さらに詳しい可視化を実施していきます。結果の可視化は主に以下の観点のために必要です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>時系列的に予測の方向性などが集中していないか</p>
</li>
<li>
<p>上げ・下げのどちらかにスコアが偏っていないか</p>
</li>
<li>
<p>どの時期に精度が高く、どの時期に精度が低いか</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>　実際に相関係数や精度は単一の評価軸であり、可視化を通して、その結果が本当に妥当性が高いかを検証するのは非常に重要な作業です。</p>
</div>
<div class="sect3">
<h4 id="_回帰分析による可視化">6.4.1. 回帰分析による可視化</h4>
<div class="paragraph">
<p>　回帰分析による可視化を行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 回帰を行うため、xとyとなるコラムを設定する。</span>
x_column = <span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>
y_column = <span class="string"><span class="delimiter">'</span><span class="content">weekly_fwd_returns</span><span class="delimiter">'</span></span>

<span class="comment"># stats.linregressを用いて、単回帰直線の係数とバイアスを取得する。</span>
df = pd.concat([headline_features, weekly_fwd_returns], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>).dropna()

coef, bias, _, _, _ = stats.linregress(x=df[x_column], y=df[y_column])
print(f<span class="string"><span class="delimiter">'</span><span class="content">coef: {coef:.4f}, bias: {bias:.4f}</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">coef: <span class="float">6.6302</span>, bias: -<span class="float">4.0035</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　これらの情報をseabornのregression plotと共に表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">display_regplot</span>(df, x_column=<span class="string"><span class="delimiter">'</span><span class="content">features</span><span class="delimiter">'</span></span>, y_column=<span class="string"><span class="delimiter">'</span><span class="content">weekly_fwd_returns</span><span class="delimiter">'</span></span>):
    <span class="comment"># stats.linregressを用いて、単回帰直線の係数とバイアスを取得する。</span>
    coef, bias, _, _, _ = stats.linregress(x=df[x_column], y=df[y_column])

    <span class="comment"># seabornのregplotを用いて、単回帰直線及び、scatter sampleを表示する。</span>
    _, ax = plt.subplots(<span class="integer">1</span>, <span class="integer">1</span>, figsize=(<span class="integer">6</span>, <span class="integer">4</span>))
    sns.regplot(
        x=x_column,
        y=y_column,
        data=df,
        ax=ax,
        line_kws={
            <span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">y={0:.4f}x+{1:.4f}</span><span class="delimiter">&quot;</span></span>.format(coef, bias), <span class="comment"># 取得した係数とバイアスを用いて単項式を表示する。</span>
        },
    )
    plt.legend()
    plt.show()

<span class="keyword">for</span> features, feature_type <span class="keyword">in</span> [(headline_features, <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>), (keywords_features, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>)]:
    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">#### feature_type: {feature_type}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
    df = pd.concat([features, weekly_fwd_returns], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>).dropna()
    display_regplot(df=df)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。headline_featuresは、x軸のfeaturesがkeywords_featuresより若干ですが幅広に分布しており、keywords_featuresよりも上手く学習が出来た可能性を示しています。また。スコアが低い時にy軸の次の週の投資対象のユニバースの平均変化率が低く、スコアが高い時に平均変化率が高い傾向がはっきりと確認できます。また、スコアが中間の場合は平均変化率も0近辺に集中しており、全体的に信頼性の高い結果となっていることがわかります。keywords_featuresの結果も良いものですが、headline_featuresほどは優れていません。お互いの相関が低ければ、アンサンブルを考慮する価値はありそうですので、時系列の可視化を実施してみます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_vis_regplot.png" alt="1_7_vis_regplot" width="50%">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_時系列的な関係の可視化">6.4.2. 時系列的な関係の可視化</h4>
<div class="paragraph">
<p>　barplotにより、特徴量とラベル間での時系列的な関係を確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">df.plot(kind=<span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>, figsize=(<span class="integer">16</span>, <span class="integer">3</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_vis_barplot_without_norm.png" alt="1_7_vis_barplot_without_norm">
</div>
</div>
<div class="paragraph">
<p>　二つのデータを一つの軸上で単純にプロットすると値のノルム、平均、分散の違いから、相互的な動きを確認しにくいです。ここでは、手元にあるデータを平均と分散を用いてノーマライズしたzscore標準化( <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.zscore.html" class="bare">https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.zscore.html</a> )を使って相互の関係を可視化してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">normalize</span>(df):
    <span class="comment"># zscore normalizeする。</span>
    <span class="keyword">return</span> pd.DataFrame(stats.zscore(df), index=df.index, columns=[f<span class="string"><span class="delimiter">'</span><span class="content">Z({column})</span><span class="delimiter">'</span></span> <span class="keyword">for</span> column <span class="keyword">in</span> df.columns])


<span class="keyword">def</span> <span class="function">display_bar_plot</span>(df):
    <span class="comment"># zscore normalizeしたデータを用いてbarplotする。</span>
    normalize(df).plot(kind=<span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>, figsize=(<span class="integer">16</span>, <span class="integer">3</span>))
    plt.show()


<span class="keyword">for</span> features, feature_type <span class="keyword">in</span> [(headline_features, <span class="string"><span class="delimiter">'</span><span class="content">headline_features</span><span class="delimiter">'</span></span>), (keywords_features, <span class="string"><span class="delimiter">'</span><span class="content">keywords_features</span><span class="delimiter">'</span></span>)]:
    display_markdown(f<span class="string"><span class="delimiter">'</span><span class="content">#### feature_type: {feature_type}</span><span class="delimiter">'</span></span>, raw=<span class="predefined-constant">True</span>)
    df = pd.concat([features, weekly_fwd_returns], axis=<span class="integer">1</span>, sort=<span class="predefined-constant">True</span>).dropna()
    display_bar_plot(df=df)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　出力結果は以下の通りです。headline_featuresは時系列的に上下の予測が固まっておらず、安定的に分布しており次の週のマーケットのセンチメントを的確に捉えている可能性が高そうです。headline_featuresとkeywords_featuresの予測スコアは時系列的に似通っているため、無理にアンサンブルなどは実施せず、以降はシンプルにheadline_featuresを活用するものとします。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Chapter06/images/1_7_vis_barplot_with_norm.png" alt="1_7_vis_barplot_with_norm">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ストラテジーへの適用の実装例">6.5. ストラテジーへの適用の実装例</h3>
<div class="paragraph">
<p>　ここでは、予測スコアを利用して現金比率を操作するサンプルコードを示します。本章はLSTMにより目的関数を設定したスコアをニュースデータから取得することが目的であり、バックテストコードを紹介することが目的ではないため、ここではサンプル実装を示す程度にとどめます。以下の実装例では、データを扱いやすくするためにzscore標準化を実施し、その分布に応じて現金比率を操作するロジックを実装しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_cash_ratio</span>(cls, df_sentiment):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    headline_m2_sentimentの値が低い時はリスクとみなし</span><span class="content">
</span><span class="content">    現金保有量を多くする。</span><span class="content">
</span><span class="content">
</span><span class="content">    入力:</span><span class="content">
</span><span class="content">      センチメント (DataFrame): センチメント情報</span><span class="content">
</span><span class="content">    出力:</span><span class="content">
</span><span class="content">      現金比率 (Dataframe): 入力値に現金比率を追加したもの</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    <span class="comment"># リスク値マッピング用の分布取得期間</span>
    DIST_START_DT = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-06-29</span><span class="delimiter">&quot;</span></span>
    DIST_END_DT = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-09-25</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># リスク値を計算する期間</span>
    USE_START_DT = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-10-02</span><span class="delimiter">&quot;</span></span>

    <span class="comment"># 出力用にコピー</span>
    df_sentiment = df_sentiment.copy()
    <span class="comment"># headline_m2_sentiment_0の値が高いほどポジティブなので符号反転させる</span>
    sentiment_dist = <span class="predefined">sorted</span>(df_sentiment.loc[DIST_START_DT:DIST_END_DT, <span class="string"><span class="delimiter">&quot;</span><span class="content">headline_m2_sentiment_0</span><span class="delimiter">&quot;</span></span>].values * -<span class="integer">1</span>)
    sentiment_use = df_sentiment.loc[USE_START_DT:, <span class="string"><span class="delimiter">&quot;</span><span class="content">headline_m2_sentiment_0</span><span class="delimiter">&quot;</span></span>].values * -<span class="integer">1</span>

    display(sentiment_dist)
    display(sentiment_use)

    <span class="comment"># DIST_START_DT:DIST_END_DTの分布を使用してリスク判定する</span>
    z = zscore(sentiment_dist)
    <span class="comment"># 閾値を決定</span>
    p = np.percentile(z, [<span class="integer">25</span>, <span class="integer">50</span>, <span class="integer">75</span>])
    <span class="comment"># リスク値を計算する</span>
    u = zscore(sentiment_use)
    <span class="comment"># 分布から現金比率の割合を決定</span>
    d = np.digitize(u, p)
    <span class="comment"># 出力用に整形して 0, 10, 20, 30 のいずれか返すようにする</span>
    df_sentiment.loc[USE_START_DT:, <span class="string"><span class="delimiter">&quot;</span><span class="content">risk</span><span class="delimiter">&quot;</span></span>] = d * <span class="integer">10</span>
    <span class="keyword">return</span> df_sentiment</code></pre>
</div>
</div>
<div class="paragraph">
<p>　現金比率の操作以外の活用方法としては、LSTMのような学習レイヤーが存在すると、ユニバースの時価総額やROEが高い銘柄と低い銘柄のどちらがより多くのリターンを産み出すかを予測させるようなストラテジーを構築することもできます。是非自由な発想でBERT特徴量を活用してみてください。</p>
</div>
</div>
<div class="sect2">
<h3 id="_投稿用コードの実装例">6.6. 投稿用コードの実装例</h3>
<div class="paragraph">
<p>　5章からここまでで、ニュースデータから現金比率を操作するまでのコードを提示してきました。これまで提示したコードを組み合わせて実装することで、ランタイム環境で動作する投稿用のモデルを作ることができますが、具体的な実装方法に悩まれるかもしれません。本チュートリアルでは実際に投稿してリーダーボードで動作を確認可能な実装例を <code>handson/Chapter06/archive/src</code> 配下に配置しています。本チュートリアル内では実装例の詳細な解説はいたしませんが、実装例のコードをご覧いただくことで独自実装や改良等のヒントとなるかもしれません。</p>
</div>
<div class="paragraph">
<p>　以下では、実装例のコードを実際に動作させるために必要なファイルの配置や投稿のためのパッケージ作成を解説いたします。本作業内容は <code>handson/Chapter06/20210224_chapter06_tutorial_test_predictor.ipynb</code> として nootbook にも記載していますので、実際の動作確認などはそちらをご使用ください。なお、実装例の確認については Google Colab 環境で実施します。</p>
</div>
<div class="paragraph">
<p><strong>実装例の配置場所</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>handson/Chapter06/
|-- 20210224_chapter06_tutorial_test_predictor.ipynb  &lt;= 実装例の動作確認用ノートブック
|-- 20210226_chapter06_tutorial.ipynb  &lt;= 本章の作業用ノートブック
`-- archive
    |-- model
    |   `-- 本ディレクトリ内に事前学習済みのモデルやパラメーターを配置します。
    |-- requirements.txt  &lt;= 実装例を動作させるために必要なモジュールを記載しています。
    `-- src
        |-- module.py  &lt;= 5章/6章のコードをまとめたもの
        `-- predictor.py  &lt;= 4章で作成したScoringServiceクラスに現金比率操作用コード追加した実装例</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_事前準備">6.6.1. 事前準備</h4>
<div class="paragraph">
<p>本ノートブックは Google Colaboratory で実行することを想定しています。実行時には以下の事前準備が必要です。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>コンペティションページから必要なファイルのダウンロード</p>
</li>
<li>
<p>Google Drive に必要ファイルを配置</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_コンペティションページから必要なファイルのダウンロード">6.6.2. コンペティションページから必要なファイルのダウンロード</h4>
<div class="paragraph">
<p>■以下の10個のファイルを本コンペティションのデータタブから取得します。
<a href="https://signate.jp/competitions/443/data" class="bare">https://signate.jp/competitions/443/data</a></p>
</div>
<div class="paragraph">
<p>2章で作成した学習済みモデル</p>
</div>
<div class="ulist">
<ul>
<li>
<p>01 my_model_label_high_20.pkl</p>
</li>
<li>
<p>02 my_model_label_low_20.pkl</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>LSTMモデルの学習済みパラメータ (headline_features)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>03 19.ckpt</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>LSTMモデルの出力 (headline_features)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>04 LSTM_sentiment.pkl</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>動作確認用データ</p>
</div>
<div class="ulist">
<ul>
<li>
<p>05 nikkei_article.csv.gz</p>
</li>
<li>
<p>06 stock_fin.csv.gz</p>
</li>
<li>
<p>07 stock_fin_price.csv.gz</p>
</li>
<li>
<p>08 stock_list.csv.gz</p>
</li>
<li>
<p>09 stock_price.csv.gz</p>
</li>
<li>
<p>10 tdnet.csv.gz</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>■以下の4つのファイルをチュートリアルのリポジトリから取得します。
<a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/Chapter06" class="bare">https://github.com/JapanExchangeGroup/J-Quants-Tutorial/tree/main/handson/Chapter06</a></p>
</div>
<div class="paragraph">
<p>動作確認用ノートブック (本ノートブック)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>11 20210224_chapter06_tutorial_test_predictor.ipynb</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>実装例のrequirements.txt</p>
</div>
<div class="ulist">
<ul>
<li>
<p>12 archive/requirements.txt</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>実装例のコード</p>
</div>
<div class="ulist">
<ul>
<li>
<p>13 archive/src/module.py</p>
</li>
<li>
<p>14 archive/src/predictor.py</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_google_drive_に必要なファイルを配置">6.6.3. Google Drive に必要なファイルを配置</h4>
<div class="paragraph">
<p>　Google Drive の My Drive 配下に以下のフォルダ構造でファイルを配置します。ファイル名の後ろに「download:数字」として、先程のダウンロード時の説明で使用した番号を記載しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>MyDrive/JPX_competition/
├── Chapter06
│   ├── 20210224_chapter06_tutorial_test_predictor.ipynb &lt;= 本ノートブック download:11
│   └── archive  &lt;= 投稿用パッケージの起点となるフォルダ
│       ├── model
│       │   ├── headline_features
│       │   │   ├── 19.ckpt  &lt;= 6章で作成した LSTM モデルの学習済みパラメータ download:03
│       │   │   └── LSTM_sentiment.pkl  &lt;= 6章で作成したセンチメント download:04
│       │   ├── my_model_label_high_20.pkl  &lt;= 2章で作成した最高値予測モデル download:01
│       │   ├── my_model_label_low_20.pkl  &lt;= 2章で作成した最安値予測モデル download:02
│       ├── src
│       │   ├── module.py  &lt;= 5章/6章のコードをまとめたもの download:13
│       │   └── predictor.py  &lt;= 4章のコードに一部追記してニュースデータを使用して現金比率操作を追記したもの download:14
│       └── requirements.txt
└── data_dir_comp2
     ├── nikkei_article.csv.gz  &lt;= download:05
     ├── stock_fin.csv.gz  &lt;= download:06
     ├── stock_fin_price.csv.gz  &lt;= download:07
     ├── stock_list.csv.gz  &lt;= download:08
     ├── stock_price.csv.gz  &lt;= download:09
     └── tdnet.csv.gz  &lt;= download:10</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_実行環境設定">6.6.4. 実行環境設定</h4>
<div class="paragraph">
<p>　本ノートブックを実行するにあたって必要な環境設定を実施します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Google Driveのマウント</p>
</li>
<li>
<p>モジュールをimportするためにsys.pathを追加</p>
</li>
<li>
<p>autoreload 拡張有効化</p>
</li>
<li>
<p>必要なライブラリのインストール</p>
</li>
<li>
<p>使用するディレクトリの設定</p>
</li>
<li>
<p>入力パラメータ作成</p>
</li>
<li>
<p>BERTの事前学習済みモデルをダウンロード</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_google_driveのマウント">Google Driveのマウント</h5>
<div class="paragraph">
<p>　Google Driveをマウントします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    <span class="comment"># Google Drive をマウントします</span>
    <span class="keyword">from</span> <span class="include">google.colab</span> <span class="keyword">import</span> <span class="include">drive</span>
    mount_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/content/drive</span><span class="delimiter">&quot;</span></span>
    drive.mount(mount_dir)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_使用するディレクトリの設定">使用するディレクトリの設定</h5>
<div class="paragraph">
<p>　環境に応じて使用するディレクトリを設定します。配置した.pyファイルをimportできるようにsys.pathに配置先のディレクトリを追加しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">google.colab</span><span class="delimiter">'</span></span> <span class="keyword">in</span> sys.modules:
    <span class="comment"># Google Colab環境では上記に示したディレクトリ設定を使用します。</span>
    <span class="comment"># archiveディレクトリを指定します。</span>
    archive_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter06/archive</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 実装例のコードを配置したディレクトリを指定します。</span>
    src_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter06/archive/src</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># sys.pathを設定</span>
    sys.path.append(src_path)
    <span class="comment"># ダウンロードしてきたデータを配置したディレクトリを設定します。</span>
    dataset_dir = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/data_dir_comp2</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 2章のモデルを配置したディレクトリを設定します。</span>
    <span class="comment"># このディレクトリにBERTの事前学習済みモデルをダウンロードして保存します。</span>
    model_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter06/archive/model</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># テスト用に出力したポートフォリオを保存するディレクトリを設定します</span>
    output_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{mount_dir}/MyDrive/JPX_competition/Chapter06</span><span class="delimiter">&quot;</span></span>
<span class="keyword">else</span>:
    <span class="comment"># archiveディレクトリを指定します。</span>
    archive_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">archive</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 実装例のコードを配置したディレクトリを指定します。</span>
    src_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">archive/src</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># sys.pathを設定</span>
    sys.path.append(src_path)
    <span class="comment"># ダウンロードしてきたデータを配置したディレクトリを設定します。</span>
    dataset_dir = <span class="string"><span class="delimiter">&quot;</span><span class="content">/notebook/data_dir_comp2</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># 2章のモデルを配置したディレクトリを設定します。</span>
    <span class="comment"># このディレクトリにBERTの事前学習済みモデルをダウンロードして保存します。</span>
    model_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">archive/model</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># テスト用に出力したポートフォリオを保存するディレクトリを設定します</span>
    output_path = <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_必要なライブラリのインストール_3">必要なライブラリのインストール</h5>
<div class="paragraph">
<p>　必要なライブラリをインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># neologdnのためにg++をインストール
! apt-get update
! apt-get install -y --no-install-recommends g++</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># 必要なライブラリをインストール
!pip install -r $archive_path/requirements.txt</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_入力パラメータ作成">入力パラメータ作成</h5>
<div class="paragraph">
<p>　ランタイム環境でpredictメソッドが呼ばれるときに渡される inputs パラメーターを実行環境に合わせて作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># predictメソッドへの入力パラメーターを設定します。</span>
<span class="comment"># ランタイム環境での実行時と同一フォーマットにします</span>
inputs = {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_list</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_list.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_fin_price</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_fin_price.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># ニュースデータ</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/tdnet.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/disclosureItems.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">nikkei_article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/nikkei_article.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">article</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/article.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">industry</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/industry.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">industry2</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/industry2.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/region.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">theme</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/theme.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># 目的変数データ</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">stock_labels</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/stock_labels.csv.gz</span><span class="delimiter">&quot;</span></span>,
    <span class="comment"># 購入日指定データ</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">purchase_date</span><span class="delimiter">&quot;</span></span>: f<span class="string"><span class="delimiter">&quot;</span><span class="content">{dataset_dir}/purchase_date.csv</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bertの事前学習済みモデルをダウンロード">6.6.5. BERTの事前学習済みモデルをダウンロード</h4>
<div class="paragraph">
<p>　ランタイム環境ではインターネットにアクセスできないため、BERTの事前学習済みモデルを {model_path}/transformers 配下にダウンロードしておきます。</p>
</div>
<div class="paragraph">
<p>　SentimentGeneratorのload_feature_extractorおよびload_bert_tokenizerメソッドにdownloadおよびsave_localパラメータをTrueとして実行することで、BERTの事前学習済みモデルをダウンロードおよび保存します。次にSentimentGenratorを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">module</span> <span class="keyword">import</span> <span class="include">SentimentGenerator</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>　事前学習済みのBERTモデルをダウンロードして保存します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">SentimentGenerator.load_feature_extractor(model_path, download=<span class="predefined-constant">True</span>, save_local=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　事前学習時に使用したTokenizerも合わせてダウンロードして保存します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">SentimentGenerator.load_bert_tokenizer(model_path, download=<span class="predefined-constant">True</span>, save_local=<span class="predefined-constant">True</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　BERTの事前学習済みモデルが保存されていることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">! ls -lhR $model_path</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/content/drive/MyDrive/JPX_competition/comp2/chapter06/archive/model:
total 71M
drwx------ 2 root root 4.0K Mar 11 07:37 headline_features
-rw------- 1 root root  36M Mar 11 07:37 my_model_label_high_20.pkl
-rw------- 1 root root  36M Mar 11 07:37 my_model_label_low_20.pkl
drwx------ 3 root root 4.0K Mar 11 07:37 transformers_pretrained

/content/drive/MyDrive/JPX_competition/comp2/chapter06/archive/model/headline_features:
total 5.1M
-rw------- 1 root root 5.1M Mar 11 07:37 19.ckpt
-rw------- 1 root root  958 Mar 11 07:37 LSTM_sentiment.pkl

/content/drive/MyDrive/JPX_competition/comp2/chapter06/archive/model/transformers_pretrained:
total 4.0K
drwx------ 3 root root 4.0K Mar 11 07:37 cl-tohoku

/content/drive/MyDrive/JPX_competition/comp2/chapter06/archive/model/transformers_pretrained/cl-tohoku:
total 4.0K
drwx------ 2 root root 4.0K Mar 11 07:37 bert-base-japanese-whole-word-masking

/content/drive/MyDrive/JPX_competition/comp2/chapter06/archive/model/transformers_pretrained/cl-tohoku/bert-base-japanese-whole-word-masking:
total 423M
-rw------- 1 root root  707 Mar 11 07:37 config.json
-rw------- 1 root root 423M Mar 11 07:37 pytorch_model.bin
-rw------- 1 root root  112 Mar 11 07:37 special_tokens_map.json
-rw------- 1 root root  397 Mar 11 07:37 tokenizer_config.json
-rw------- 1 root root 252K Mar 11 07:37 vocab.txt</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ランタイム環境を想定したテスト実行">6.6.6. ランタイム環境を想定したテスト実行</h4>
<div class="paragraph">
<p>ランタイム環境で実行されるのと同等の呼び出し方でテストを行います。まずは、ScoringServiceクラスを読み込みます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">predictor</span> <span class="keyword">import</span> <span class="include">ScoringService</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>get_modelメソッドを呼び出すことで以下を実施します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>BERTの事前学習済みモデルを読み込み</p>
</li>
<li>
<p>BERTの事前学習済みモデルに使用したTokenizerを読み込み</p>
</li>
<li>
<p>事前学習済みの最高値・最安値モデルを読み込み</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">ScoringService.get_model(model_path)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　今回はランタイム環境と同一のデータセットを使用していないため、ダウンロードしたデータを使用して動作確認するために予測出力対象日 (start_dt) を 2020-12-28 と指定したpurchase_dateファイルを作成します。このコードを実行することで既に purchase_date.csv が存在している場合は上書きされることに注意してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">! echo &quot;Purchase Date&quot; &gt; $dataset_dir/purchase_date.csv
! echo &quot;2020-12-28&quot; &gt;&gt; $dataset_dir/purchase_date.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>予測を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">ret = ScoringService.predict(inputs)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_出力の確認">6.6.7. 出力の確認</h4>
<div class="paragraph">
<p>予測出力の実行結果を確認します。確認ポイントは以下になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>出力のフォーマットが規定されているものと一致していること</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">print(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.join(ret.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)[:<span class="integer">10</span>]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>date,Local Code,budget
2020-12-28,4165,20000
2020-12-28,7694,20000
2020-12-28,4167,20000
2020-12-28,3677,20000
2020-12-28,4493,20000
2020-12-28,7358,20000
2020-12-28,8848,20000
2020-12-28,3328,20000
2020-12-28,6050,20000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># 出力を保存</span>
<span class="keyword">with</span> <span class="predefined">open</span>(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{output_path}/chapter06-tutorial-1.csv</span><span class="delimiter">&quot;</span></span>, mode=<span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
    f.write(ret)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_投稿用パッケージを作成">6.6.8. 投稿用パッケージを作成</h4>
<div class="paragraph">
<p>　上記で動作確認したモデルを投稿用にパッケージ化します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">zipfile</span>

<span class="comment"># 提出用パッケージ名</span>
package_file = <span class="string"><span class="delimiter">&quot;</span><span class="content">chapter06-model.zip</span><span class="delimiter">&quot;</span></span>
<span class="comment"># パッケージファイルパス</span>
package_path = f<span class="string"><span class="delimiter">&quot;</span><span class="content">{output_path}/{package_file}</span><span class="delimiter">&quot;</span></span>

<span class="comment"># zipファイルを作成</span>
<span class="keyword">with</span> zipfile.ZipFile(package_path, <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> f:
    <span class="comment"># requirements.txt を追加</span>
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {archive_path}/requirements.txt to requirements.txt</span><span class="delimiter">&quot;</span></span>)
    f.write(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{archive_path}/requirements.txt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">requirements.txt</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># model/配下を追加</span>
    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(model_path):
        <span class="keyword">for</span> <span class="predefined">file</span> <span class="keyword">in</span> files:
            add_path = os.path.join(root, <span class="predefined">file</span>)
            rel_path = os.path.relpath(
                os.path.join(root, <span class="predefined">file</span>),
                os.path.join(model_path, <span class="string"><span class="delimiter">'</span><span class="content">..</span><span class="delimiter">'</span></span>)
            )
            print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {add_path} to {rel_path}</span><span class="delimiter">&quot;</span></span>)
            f.write(add_path, rel_path)

    <span class="comment"># src/module.py を追加</span>
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {src_path}/module.py to src/module.py</span><span class="delimiter">&quot;</span></span>)
    f.write(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{src_path}/module.py</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">src/module.py</span><span class="delimiter">&quot;</span></span>)
    <span class="comment"># src/predictor.py を追加</span>
    print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] add {src_path}/predictor.py to src/predictor.py</span><span class="delimiter">&quot;</span></span>)
    f.write(f<span class="string"><span class="delimiter">&quot;</span><span class="content">{src_path}/predictor.py</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">src/predictor.py</span><span class="delimiter">&quot;</span></span>)

print(f<span class="string"><span class="delimiter">&quot;</span><span class="content">[+] please check {package_path}</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>　上記コードを最後まで実行するとGoogle Drive に投稿用の <code>chapter06-model.zip</code> ファイルが作成されているため、そちらをダウンロードして投稿しましょう。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tips集">7. tips集</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章では、本コンペティションに関連する金融・データ解析一般についてのtipsを紹介します。</p>
</div>
<div class="sect2">
<h3 id="_コンペティションフォーラムの紹介">7.1. コンペティションフォーラムの紹介</h3>
<div class="paragraph">
<p>J-Quantsでは、コンペティションに関連して執筆された記事の投稿やチュートリアルへのご質問をフォーラム（ "https://signate.jp/competitions/423/discussions" ）にて募集しております（コンペの登録が必要）。また、下記内容以外にも有志の方による素晴らしいスレッドがありますので、ぜひご確認ください。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>タイトル</strong></th>
<th class="tableblock halign-left valign-top"><strong>URL</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">参考書籍・記事・知見共有スレッド</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/423/discussions/jpx-1" class="bare">https://signate.jp/competitions/423/discussions/jpx-1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web記事投稿スレッド</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/423/discussions/jpx-web" class="bare">https://signate.jp/competitions/423/discussions/jpx-web</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">チュートリアル質問用スレッド</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/423/discussions/jpx" class="bare">https://signate.jp/competitions/423/discussions/jpx</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_金融用語集">7.2. 金融用語集</h3>
<div class="paragraph">
<p>本コンペティションで必要となる専門用語を解説してくれているサイトをご紹介します。<br>
もし、専門用語で困った場合は、下記リンク先のコンテンツを確認していただければ幸いです。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>タイトル</strong></th>
<th class="tableblock halign-left valign-top"><strong>運営元</strong></th>
<th class="tableblock halign-left valign-top"><strong>URL</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">証券用語解説集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">野村證券</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nomura.co.jp/terms/" class="bare">https://www.nomura.co.jp/terms/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">金融・証券用語解説集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大和証券</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.daiwa.jp/glossary/" class="bare">https://www.daiwa.jp/glossary/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイナンス用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">みずほ証券</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://glossary.mizuho-sc.com/" class="bare">https://glossary.mizuho-sc.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">初めてでもわかりやすい用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ＳＭＢＣ日興証券</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.smbcnikko.co.jp/terms/index.html" class="bare">https://www.smbcnikko.co.jp/terms/index.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用語解説</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">三菱UFJモルガン・スタンレー証券株式会社</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.sc.mufg.jp/learn/terms/index.html" class="bare">https://www.sc.mufg.jp/learn/terms/index.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">金融用語解説(知るぽると)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">金融広報中央委員会</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.shiruporuto.jp/public/document/container/yogo/" class="bare">https://www.shiruporuto.jp/public/document/container/yogo/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">金融・証券用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日本証券業協会</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.jsda.or.jp/jikan/word/" class="bare">https://www.jsda.or.jp/jikan/word/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EY新日本有限責任監査法人</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.shinnihon.or.jp/corporate-accounting/glossary/" class="bare">https://www.shinnihon.or.jp/corporate-accounting/glossary/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">会計監査用語解説集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日本公認会計士協会</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://jicpa.or.jp/cpainfo/introduction/keyword/" class="bare">https://jicpa.or.jp/cpainfo/introduction/keyword/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務諸表等の用語、様式及び作成方法に関する規則</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e-GOV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://elaws.e-gov.go.jp/document?lawid=338M50000040059" class="bare">https://elaws.e-gov.go.jp/document?lawid=338M50000040059</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">野村アセットマネジメント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nomura-am.co.jp/basicknowledge/word/" class="bare">https://www.nomura-am.co.jp/basicknowledge/word/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アセットマネジメントOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.am-one.co.jp/shisankeisei/glossary/" class="bare">http://www.am-one.co.jp/shisankeisei/glossary/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大和アセットマネジメント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.daiwa-am.co.jp/guide/term/" class="bare">https://www.daiwa-am.co.jp/guide/term/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">わかりやすい用語集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">三井住友DSアセットマネジメント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.smd-am.co.jp/learning/glossary/" class="bare">https://www.smd-am.co.jp/learning/glossary/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_東証マネ部">7.3. 東証マネ部</h3>
<div class="paragraph">
<p>「東証 マネ部！」は身近なお金の話から、プロが教える資産運用のノウハウまで 、資産形成についてわかりやすく解説するサイトです。
今回は、コンペに関係がありそうな記事をピックアップしてみました。コンペティションの息抜きにぜひご確認ください。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>タイトル</strong></th>
<th class="tableblock halign-left valign-top"><strong>リンク</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">投資に不可欠な財務三表の見方</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article022723/" class="bare">https://money-bu-jpx.com/news/article022723/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務ニュースを読む</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article028193/" class="bare">https://money-bu-jpx.com/news/article028193/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">長期投資に欠かせない運用コストを意識しよう</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article004555/" class="bare">https://money-bu-jpx.com/news/article004555/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">プロの投資家が注目する指標「ROE」とは？</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article005169/" class="bare">https://money-bu-jpx.com/news/article005169/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ディープラーニングが拓く「AI投資」の可能性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article008127/" class="bare">https://money-bu-jpx.com/news/article008127/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AIが導く金融市場の未来</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article008332/" class="bare">https://money-bu-jpx.com/news/article008332/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">４大投資指標のワナ～解析力の鍛錬～</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article012308/" class="bare">https://money-bu-jpx.com/news/article012308/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AIを使った市場の予測に挑む「AlpacaJapan」</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article015448/" class="bare">https://money-bu-jpx.com/news/article015448/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">「AIと資産運用」</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article016485/" class="bare">https://money-bu-jpx.com/news/article016485/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">投資に役立つ「会社四季報」活用のポイント</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article020860/" class="bare">https://money-bu-jpx.com/news/article020860/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">最低投資金額50万円以下の銘柄特集</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article022924/" class="bare">https://money-bu-jpx.com/news/article022924/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">クチコミで投資を楽しめるアプリ「ferci（フェルシー)」</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article023550/" class="bare">https://money-bu-jpx.com/news/article023550/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">コロナ後の世界</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article024736/" class="bare">https://money-bu-jpx.com/news/article024736/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式場況を読む～専門用語の理解～</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article026712/" class="bare">https://money-bu-jpx.com/news/article026712/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">決算ニュースを読む～会計用語の理解～</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article027285/" class="bare">https://money-bu-jpx.com/news/article027285/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公的統計を補完する「オルタナティブデータ」とは？</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://money-bu-jpx.com/news/article028023/" class="bare">https://money-bu-jpx.com/news/article028023/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_参考になる書籍">7.4. 参考になる書籍</h3>
<div class="paragraph">
<p>本コンペティションに参考になる書籍を紹介致します。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>タイトル</strong></th>
<th class="tableblock halign-left valign-top"><strong>著者</strong>　</th>
<th class="tableblock halign-left valign-top"><strong>概要</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイナンス機械学習―金融市場分析を変える機械学習アルゴリズムの理論と実践</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルコス・ロペス・デ・プラド</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">機械学習を用いて金融データを分析する上での知識を網羅的に学ぶことができる。金融のドメイン知識をデータサイエンティストが学ぶには最適な本。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">アセットマネージャーのためのファイナンス機械学習</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マルコス・ロペス・デ・プラド</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファイナンス機械学習に続き、ノイズ除去、クラスタリング、ラベリング、特徴量の重要度分析などの本コンペでも関連の深いトピックを学ぶことができる。ただし、「ファイナンス機械学習」と比較すると網羅性はないので、2冊目として読むことを推奨。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kaggleで勝つデータ分析の技術</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">門脇 大輔 他</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">モデルのチューニング・アンサンブルなど機械学習のコンペに関連するテクニックを効率的に学ぶことができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">株を買うなら最低限知っておきたい ファンダメンタル投資の教科書 改訂版</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">足立 武志</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ファンダメンタル分析に必要な基礎知識を学ぶことができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">経済・ファイナンスデータの計量時系列分析</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">沖本竜義</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARIMAモデルをベースとした古典的な時系列解析を学ぶことができる。ARIMAモデル自体を予測モデルとして使うことは、コンペではまれだが、金融データに対して時系列分析を実施する上での実務上の課題なども学ぶことができる。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">金融・経済分析のためのテキストマイニング</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">和泉 潔他</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">市場レポートや経済ニュースなどのテキストデータを分析し、資産運用や市場分析に活かす手法を解説している。数式は少なく、金融テキストマイニングの独特な注意点や思考法を中心に整理しており、初めて金融分野のテキストマイニングをする人には助かる一冊。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">統計学入門</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">東京大学教養学部統計学教室 編</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文科と理科両方の学生のために，統計的なものの考え方の基礎がやさしく解説されており、統計学の体系的な知識を与えるように，編集・執筆された一冊。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pythonデータサイエンスハンドブック</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jake VanderPlas 著、菊池 彰 訳</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">本チュートリアルにおいても利用されているJupyter、NumPy、pandas、Matplotlib、scikit-learn等をカバーしている一冊。それぞれのトピックについて、押さえておくべき基本、tips、便利なコマンドなどが紹介されている。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_参考になるコンペティション">7.5. 参考になるコンペティション</h3>
<div class="paragraph">
<p>本コンペティションに関連したコンペティションを紹介いたします。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>タイトル</strong></th>
<th class="tableblock halign-left valign-top"><strong>概要</strong>　</th>
<th class="tableblock halign-left valign-top"><strong>URL</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two Sigma: Using News to Predict Stock Movements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ニュースデータを用いた株価の予測</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.kaggle.com/c/two-sigma-financial-news" class="bare">https://www.kaggle.com/c/two-sigma-financial-news</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fintech Data Championship</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">日本株式のポートフォリオで次の1カ月後に、最も上昇する組み合わせを検討</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://compass.labbase.jp/articles/296" class="bare">https://compass.labbase.jp/articles/296</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Algorithmic Trading Challenge　</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">投資戦略に関する収益率・取引高等のデータから、各戦略への資金の割り当ての重みを最適化</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/146" class="bare">https://signate.jp/competitions/146</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">大手ヘッジファンドX: 金融モデリングチャレンジ　</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">独自に導出した様々な特徴量から将来の動きを予想</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://signate.jp/competitions/53" class="bare">https://signate.jp/competitions/53</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">財務・非財務情報を活用した株主価値予測　</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">会計年度2014-2017年の各企業の財務・非財務情報から、会計年度2018年の期末時価総額を予測</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nishika.com/competitions/4/summary" class="bare">https://www.nishika.com/competitions/4/summary</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Winton Stock Market Challenge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">過去の株価とマスクされた特徴量から将来の株価を予想</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.kaggle.com/c/the-winton-stock-market-challenge" class="bare">https://www.kaggle.com/c/the-winton-stock-market-challenge</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Numerai</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">マスクされた銘柄・特徴量から週次で予測結果を提出</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://numer.ai/" class="bare">https://numer.ai/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quantconnect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">条件を満たしたモデルでリターンを追求</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.quantconnect.com/competitions" class="bare">https://www.quantconnect.com/competitions</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bloomberg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ESG要素を効果的に投資判断に組み込んでいるかなどの評価</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.bloomberg.co.jp/company/stories/investment_contest_2020/" class="bare">https://www.bloomberg.co.jp/company/stories/investment_contest_2020/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jane Street Market Prediction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株の取引戦略を採用するかどうかを予測</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.kaggle.com/c/jane-street-market-prediction/" class="bare">https://www.kaggle.com/c/jane-street-market-prediction/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_ファンダメンタルズ分析の活用方法">7.6. ファンダメンタルズ分析の活用方法</h3>
<div class="paragraph">
<p>ファンダメンタルズ分析とは、企業の成長性、収益性、割安性、安定性、効率性などを分析し、投資判断などに活用する手法です。ここでは成長性、収益性、割安性、安定性、効率性の代表的な指標を紹介します。</p>
</div>
<div class="paragraph">
<p>（<strong>成長性</strong>）<br>
成長性とは、売上や利益の増加が継続しているかを指し、企業価値の増大に直結する指標です。本コンペのデータでは、純資産や営業利益の上昇率に着目することで、その銘柄の成長性を測ることが出来ます。営業利益の上昇率を計算する場合は、季節性を考慮し、前年同期比と比較することが多いです。</p>
</div>
<div class="paragraph">
<p>また、年間を通して同一の指標で評価を行いたいときは、直近の四半期のデータで移動平均などを取る方法があります。成長性について利用される様々な指標として売上高増加率、営業利益増加率、経常利益増加率、総資本増加率、純資本増加率、従業員増加率、一株当たり当期純利益（EPS）(成長性分析で企業の成長度を測る 知っておくべき指標や分析方法 より引用 <a href="https://keiei.freee.co.jp/articles/c0201686" class="bare">https://keiei.freee.co.jp/articles/c0201686</a> )などがあります。</p>
</div>
<div class="paragraph">
<p>なお、過去の成長性を解析することはできますが、その成長性が長期間に渡って継続するかを予測することは、様々な要因が関係するため難しい問題です。また、株価そのものではなく成長性自体をモデルの予測対象にして、その予測に基づき投資を行うスタイルも存在します。</p>
</div>
<div class="paragraph">
<p>（<strong>収益性</strong>）<br>
収益性は、営業利益率や経常利益率等を指し、それぞれ営業利益、経常利益を売上高で割ることで計算されます。営業利益率や経常利益率が高い企業は優れたビジネスモデルを保持していたり、販管費を低く保つオペレーションが徹底されていたりすることが多く、優良企業を判断する上での指標となっています。そして、この収益性の変化率を成長性と扱うこともできます。</p>
</div>
<div class="paragraph">
<p>一般的に投資家が期待する収益性は、業種において大きく異なることに注意が必要です。<br>
例えば、様々ある業種のうち、情報通信と食品に期待される営業利益率は大きく異なることが想定されます。この場合、銘柄情報にはセクター情報が含まれているため、セクター平均の営業利益率を計算し、その差分を計算することで、セクター平均からの上振れや下振れを特徴量にすることができます。</p>
</div>
<div class="paragraph">
<p>（<strong>割安性</strong>）<br>
株式が割安であるとは、その企業の株価が企業価値と比較して安いということです。代表的な指標としてはPBRが挙げられます。この指標は、企業の純資産と発行済み株式数を割って、1株当たりの純資産を計算します。そして、現在の株価をこの1株当たりの純資産で割ってPBRを求めます。この指標が1を割っている場合は、その企業の本来の価値よりも安い値段で株を買えることになるので、割安であると考えることができます。PBRが高い銘柄をグロース銘柄、低い銘柄をバリュー銘柄として扱いそれぞれ異なる特性を持った銘柄として分析することもあり、企業の状態を知る上で重要な指標です。</p>
</div>
<div class="paragraph">
<p>現状の日本マーケットにおいては、PBRが1未満の銘柄が数多くあります(Yahooファイナンス 低PBRランキングより引用 <a href="https://info.finance.yahoo.co.jp/ranking/?kd=12" class="bare">https://info.finance.yahoo.co.jp/ranking/?kd=12</a> )。
これらの極めて割安な銘柄はディープバリュー株と呼ばれています。PBRが低い理由として以下のような理由も考えられますので、PBRをもって一概に割安銘柄とするのではなく、各企業のその他の決算情報を参照するなど、複数の情報を考慮することも重要です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>株式市場全体が調整局面にあるなどの理由により、企業実態より株価が売り込まれている。</p>
</li>
<li>
<p>含み損の実現や業績の悪化による純資産の減少を株価が先取りして織り込んで下落している。</p>
</li>
<li>
<p>不人気のため安値に放置されている。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>（<strong>安定性</strong>）<br>
安定性は、大型株や安定性が重視される金融・銀行のような特定のセクターで重視される指標です。安定性を計算する代表的な指標は「自己資本比率」です。<br>
「自己資本比率」は総資本における自己資本の割合を計算して得られます。自己資本比率が高ければ、自己資本が多い、つまり返済義務のないお金を潤沢に持っているということになるので「中長期的に見て倒産しにくい会社」ということができ、株式の中長期保有を行う上で倒産リスクを減らすための重要なチェックポイントとなっています。(自己資本比率｜会社経営の「安全性」をあらわす指標 より引用 <a href="https://advisors-freee.jp/article/category/cat-big-03/cat-small-08/9011/" class="bare">https://advisors-freee.jp/article/category/cat-big-03/cat-small-08/9011/</a> )</p>
</div>
<div class="paragraph">
<p>なお、以下の効率性に関する記載でも紹介しているROEでは、当期純利益と自己資本の割合を見ますが、自己資本が低い株はROEが高くなるので注意が必要です。つまり、借り入れを増やしリスクを取っている銘柄ではROEが高くなりやすく、安定性が低くなる可能性があります。また、小型株においては安定性よりも成長性を重視することもあるという点に注意が必要です。特定のセクターや特定の領域において重要視される指標をモデルに投入する場合、セクターの情報を特徴量として投入するなど、一緒に銘柄を分類できる情報をモデルに投入することで、それらの特性を学ばせることが可能です。</p>
</div>
<div class="paragraph">
<p>（<strong>効率性</strong>）<br>
効率性は、近年注目されているROEやROAから計算される指標です。<br>
ROEは、当期純利益 ÷ 自己資本 × 100として計算され、自己資本に対してどれだけの利益が生み出されたのかを示します。<br>
ROAは、借り入れなどを含む総資産を使ってどれだけ利益を生み出したかを表す指標です。<br>
ROEやROAは、効率性を示す指標として注目されており、政府が2017年に公表した成長戦略「未来投資戦略2017」において、「《KPI》大企業（TOPIX500）の ROA について、2025 年までに欧米企業に遜色のない水準を目指す。」(未来投資戦略2017 より引用 <a href="https://www.kantei.go.jp/jp/singi/keizaisaisei/pdf/miraitousi2017_sisaku.pdf" class="bare">https://www.kantei.go.jp/jp/singi/keizaisaisei/pdf/miraitousi2017_sisaku.pdf</a> )というKPIが設定され注目を浴びています。</p>
</div>
<div class="paragraph">
<p>ROEが高い銘柄ほど効率性が高いと考えることができ、企業価値を高めるための施策としてROEの向上、または維持を目標とする企業が多く、ROE重視の流れの背景は「投資指標としての ROE」(<a href="https://www.tr.mufg.jp/houjin/jutaku/pdf/u201503_1.pdf" class="bare">https://www.tr.mufg.jp/houjin/jutaku/pdf/u201503_1.pdf</a>) で詳しく解説されています。</p>
</div>
<div class="paragraph">
<p>上記のファンダメンタル情報は、本コンペティションで提供されるデータで計算可能ですので、様々なファンダメンタル情報を勉強することは、特徴量設計の次の一歩に繋がるでしょう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_テクニカル分析の活用方法">7.7. テクニカル分析の活用方法</h3>
<div class="paragraph">
<p>テクニカル分析は、将来の株価の変化を過去に発生した価格や出来高等の時系列パターンから予想・分析しようとする手法であり、メジャーな分析手法の一つです。テクニカル分析にはトレンド分析、オシレーター分析、フォーメーション分析、ローソク足分析(テクニカル指標一覧より引用 <a href="https://info.monex.co.jp/technical-analysis/indicators/" class="bare">https://info.monex.co.jp/technical-analysis/indicators/</a> )があり、2章においてもオシレーターの代表的な分析手法の一つである「移動平均乖離率」を特徴量の一つとして採用しています。</p>
</div>
<div class="paragraph">
<p>ここでは、テクニカル分析を更に活用するための注意事項を説明します。テクニカル分析を特徴量として採用する場合、テクニカル分析により得た新規の情報がすでに投入済みの特徴量と比較して、どの程度新しい情報を保持しているか、という観点から考えることが重要です。</p>
</div>
<div class="paragraph">
<p>例えば、移動平均と移動平均乖離率は、それぞれ似たような情報を保持していることが容易に想像がつきます。これらの情報を特徴量として考えた場合、「20日移動平均乖離率」の方が0平均となるため、定常性を仮定することができ、扱いやすいことから移動平均乖離率を2章では採用しています。<br>
ストキャスティクス(詳細は <a href="https://info.monex.co.jp/technical-analysis/indicators/006.html" class="bare">https://info.monex.co.jp/technical-analysis/indicators/006.html</a> を参照)やRSI(詳細は <a href="https://info.monex.co.jp/technical-analysis/indicators/005.html" class="bare">https://info.monex.co.jp/technical-analysis/indicators/005.html</a> を参照)のようなオシレーター系の分析も、似通った情報を保持していることが推測できます。</p>
</div>
<div class="paragraph">
<p>機械学習のモデル構築において、若干のパラメータを変更したテクニカル分析を複数個特徴量として投入することは、ほとんどの場合良い結果に結びつきません。これは、パラメータ違いのテクニカル分析や同一種類のテクニカル分析は、ほぼ同一の情報を保持していることが多く、複数個特徴量を投入したとしても、パフォーマンスが向上する程の新規の情報を発見することが難しいためです。また、時系列解析はサンプル数が限られていることが多く、特徴量の種類を多くすると学習に必要な十分なデータ量を確保できないため、むやみに特徴量を増やすべきではなく、特徴量自体にパフォーマンス向上に結びつく新しい情報が含まれていることを重視しましょう。</p>
</div>
<div class="paragraph">
<p>例えば、2章にあるような移動平均乖離率と標準偏差の組み合わせは、お互いに直近時系列に対してトレンドとボラティリティという異なる情報を保持しているため、パフォーマンス向上に期待が持てます。テクニカル分析は順張り系、逆張り系のような系統でくくることができる(第1回 数多くあるテクニカル指標を体系的に解説より引用 <a href="https://kabu.com/investment/guide/technical/01.html" class="bare">https://kabu.com/investment/guide/technical/01.html</a> )ので、それらの系統の中から選択したり、異なる系統として時間時系列に対して依存しない手法、例えば、過去の高値圏にどれだけ近づいているかを計算するような方法なども考えられます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_ファクター分析の活用方法">7.8. ファクター分析の活用方法</h3>
<div class="paragraph">
<p>ファクター分析とは、投資が産み出すリターンを説明するファクターを定義し、そのファクターの挙動から分析を行う手法です。</p>
</div>
<div class="paragraph">
<p>例えば、ファーマ-フレンチの3ファクターモデルでは、株式投資が産み出すリターンをリスクプレミアム、時価総額リスクファクター、簿価時価比率リスクファクターの3要素に分解してます。(Wikipedia ファーマ-フレンチの3ファクターモデルより引用 <a href="https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%83%BC%E3%83%9E-%E3%83%95%E3%83%AC%E3%83%B3%E3%83%81%E3%81%AE3%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB" class="bare">https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%83%BC%E3%83%9E-%E3%83%95%E3%83%AC%E3%83%B3%E3%83%81%E3%81%AE3%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB</a> )</p>
</div>
<div class="paragraph">
<p>株式投資におけるファクター分析を知っておくことは、どのような特徴量を設計するかという考察を行うために役立ちます。</p>
</div>
<div class="paragraph">
<p>例えば、主要なファクターである時価総額について考えてみましょう。本コンペで利用できるデータを利用し、株価と発行済株式数から各銘柄の時価総額を計算することができます。一般的にマーケットは小型株が優位なときもあれば、大型株が優位なときもあるため、どちらに投資するべきかを簡単に決めることはできません。しかし、この時価総額が株価のリターンの説明要因の一つであるということを知っていれば、少なくとも特徴量に追加することで何らかの学習を行える可能性があるのではと考える事ができます。時価総額が入力データに含まれていない場合、モデルは時価総額ファクターに関連した相場変動を理解することが難しくなりますので、特徴量として投入したほうが良さそうだということが推測されます。</p>
</div>
<div class="paragraph">
<p>また、近年新たな投資手法として現れたスマートベータ投資も、このファクター分析を利用したアプローチの一つであり、ファクター分析は新しい投資手法を考える上で、基礎知識の一つになっています。スマートベータ投資とは、特定のファクターをベンチマークとして制御する手法です。具体的には、高配当、バリュー、低リスク、最小分散、クオリティ、モメンタム、及びこれらの組み合わせ等が、ベンチマークとして制御するファクターの候補となっています(スマートベータとリターン特性についてより引用 <a href="https://www.mizuho-ir.co.jp/publication/report/2020/fe36.html" class="bare">https://www.mizuho-ir.co.jp/publication/report/2020/fe36.html</a> )。</p>
</div>
<div class="paragraph">
<p>ファクター分析で扱われているファクターは、リターンの要因として定義され、株価にも何らかの影響力があると考えられたものです。様々なファクターについて勉強することが、特徴量設計の次の一歩に繋がるでしょう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_複数個のモデルの出力をアンサンブルするアプローチ">7.9. 複数個のモデルの出力をアンサンブルするアプローチ</h3>
<div class="paragraph">
<p>アンサンブルの活用について説明します。機械学習における「アンサンブル」とは、複数のモデルを組み合わせることでパフォーマンスの高いモデルを作成する手法を意味します。アンサンブルに使うモデルは多様性があればある程基本的には好ましく、多様性のあるモデルを作り、最終的にアンサンブルすることで、単一モデルでは達成できないパフォーマンスを最終的に達成する可能性があります。</p>
</div>
<div class="paragraph">
<p>アンサンブルには、シンプルに複数のモデルの出力の平均を取るモデル平均法、scikit-learnライブラリのStandardScaler( <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html" class="bare">https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html</a> )による標準化を実施して分布をある程度揃えてから足し合わせる方法などがあります。また、より高度な手法であるスタッキングもscikit-learnライブラリにはStackingClassifer/StackingRegressorがあるため容易に実施(スタッキングで分類・回帰 (scikit-learn) より引用 <a href="https://qiita.com/maskot1977/items/de7383898123fa378d86" class="bare">https://qiita.com/maskot1977/items/de7383898123fa378d86</a> )することが可能です。kaggleで活用されている様々なアンサンブルの方法がKAGGLE ENSEMBLING GUIDE( <a href="https://mlwave.com/kaggle-ensembling-guide/" class="bare">https://mlwave.com/kaggle-ensembling-guide/</a> )では紹介されており、英文ですが読む価値があります。</p>
</div>
<div class="paragraph">
<p>ここでは、時価総額に着目して学習の対象を分けて複数個のモデルを作るアプローチを考えてみます。一般的に時価総額が低い銘柄は、大きな値動きが発生しやすいことが知られています。これは市場の流動性に違いがあり、同一額の投資が発生しても、小型株のほうがよりインパクトが大きいためです。今回のコンペティションでは、全銘柄を予測対象としていますが、実際にモデルを作ると全銘柄の時価総額の下位の銘柄を学習対象から除外すると、よりモデルのパフォーマンスが高くなることがあります。これは時価総額が低い銘柄は、ランダム性がより高く、またファンダメンタルに従わないことが多いためです。</p>
</div>
<div class="paragraph">
<p>では、以下の2つのモデルをつくった場合を考えてみます。</p>
</div>
<div class="paragraph">
<p><strong>A</strong>: 全銘柄を対象に学習したモデル</p>
</div>
<div class="paragraph">
<p><strong>B</strong>: 時価総額の下位の銘柄を学習から除外した上で、パフォーマンスをチューニングしたモデル</p>
</div>
<div class="paragraph">
<p>この2つが異なることを学習したとした場合、Bのモデルの出力に対してStandardScalerによる標準化を実施し、Aのモデルの出力に足し合わせると、Bのモデルが学んだことをBの学習対象の銘柄に足し合わせることができます。Bの出力に対しては、StandardScalerによる標準化を実施しているため分布が0平均となっており、学習対象外の銘柄に対する影響も限定することができます。</p>
</div>
<div class="paragraph">
<p>異なる特性をもったデータを学習させることで、モデルが異なることを学び、結果的にモデル同士の出力の相関が低くなります。モデル間の出力の相関が低いもの同士をアンサンブルさせると、相関の高いもの同士をアンサンブルさせた時よりも、アンサンブルの効果は高く出ることが多いため、上記のように学習対象を変えることで複数のモデルを作り、アンサンブルを実施するようなアプローチは有用です。</p>
</div>
</div>
<div class="sect2">
<h3 id="_プライベート期間の性能の向上のために考慮すべきこと">7.10. プライベート期間の性能の向上のために考慮すべきこと</h3>
<div class="paragraph">
<p>金融時系列はサンプル数が少ないため、特徴量を大量に生成し、特徴量選択をすべてモデルに任せるアプローチを採用する場合、ライブ性能の劣化に注意する必要があります。特徴量をどんどん増やすと、訓練期間のパフォーマンスは伸びていても、評価期間のパフォーマンスの向上が止まることがあります。100種類のデータを使うモデルと10種類のデータを使うモデルが、同一の訓練期間で同一の精度を達成した場合、評価期間・ライブ期間では、少ないデータを使ったモデルの方が高い性能を期待できる可能性が高いことが、経験的にわかっています。これは、説明変数の取りうるパターンが多いと、未来で同じ現象を発生する確率が下がっていくためと考えられます。モデルの複雑さとデータへの適合度とのバランスを取るためには、オッカムの剃刀(Wikipedia オッカムの剃刀より引用 <a href="https://ja.wikipedia.org/wiki/%E3%82%AA%E3%83%83%E3%82%AB%E3%83%A0%E3%81%AE%E5%89%83%E5%88%80" class="bare">https://ja.wikipedia.org/wiki/%E3%82%AA%E3%83%83%E3%82%AB%E3%83%A0%E3%81%AE%E5%89%83%E5%88%80</a> ) のような発想が必要となります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_本コンペでは利用できないがモデルを将来的に発展させるために検討する価値のある外部データ">7.11. 本コンペでは利用できないが、モデルを将来的に発展させるために検討する価値のある外部データ</h3>
<div class="paragraph">
<p>日本株のデータ以外に特徴量設計に利用可能と思われるデータを紹介します。本コンペでは、あらかじめ定められたデータしか利用することはできませんが、今後手元で新たなモデルを作成するときの知識としてご活用下さい。</p>
</div>
<div class="paragraph">
<p><strong>為替データ</strong>: ドル円の値動きが株式市場に影響を与えていることはよく知られています。特に日本市場の株式は輸出関連銘柄が多いため、ドル円の値動きは直接収益に関連します。よって、為替データを説明変数に採用するアプローチも想定されます。為替データは、いくつかのFX会社がAPIを提供しています。</p>
</div>
<div class="paragraph">
<p><strong>金利データ</strong>: 金利データとは、例えば米国債10年金利のような各国の債券の金利を指します。一般的に、機関投資家は債券と株式の両方を投資対象とするため、債券市場の動きは株式市場に反映されます。こちらは、APIによるデータ習得は容易ではありませんが、そこまで数は多くないため、説明変数として利用することは難しくありません。</p>
</div>
<div class="paragraph">
<p><strong>米国株データ</strong>: Alpaca US( <a href="https://alpaca.markets/data" class="bare">https://alpaca.markets/data</a> )やIEX Cloud( <a href="https://iexcloud.io/" class="bare">https://iexcloud.io/</a> )など、様々な米国株の株価/ETFのデータを提供するサービスが存在します。日本株式のマーケットは、米国株式のマーケットクローズ後にオープンするため、米国市場が日本市場に与える影響を解析することで、様々な情報を分析することが可能です。</p>
</div>
<div class="paragraph">
<p>他にも政府が発表するGDPなどの各国の経済動向、金などのコモディティ市場も、密接に株式市場の長期トレンドの形成に関わっていますので、様々な外部データの利用を検討することで新たなモデルを作ることができる可能性があります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_モデルの再学習の運用について">7.12. モデルの再学習の運用について</h3>
<div class="paragraph">
<p>長期間に渡りモデルを運用しようとする場合、再学習の運用を考慮しておく必要があります。再学習の運用とは、例えば2019年までのデータを用いてモデルを学習し2020年で運用した場合、2020年末に2020年のデータを用いて再学習を行うといったようなことを指します。再学習を行うにあたっていくつか考慮しておくべきポイントを紹介します。</p>
</div>
<div class="sect3">
<h4 id="_再学習を行う必要があるほど新規のデータが存在するか">7.12.1. 再学習を行う必要があるほど新規のデータが存在するか</h4>
<div class="paragraph">
<p>再学習は、新規のデータが溜まった時に実施します。モデルにも依存しますが、モデルが挙動を変えるには、既存の学習に用いたデータ量と比較してある程度の量の新規データが存在しないと、再学習を実施してもモデルの挙動は変わりません。再学習する際に有用な新規データ量は一概には言えず、モデルによって変わります。毎日モデルをトレーニングするような運用も可能ですが、データ量が多少増えただけでは、ほぼ同じ挙動となる可能性が高いです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_再学習を行うことでモデルの出力分布が変わらないか">7.12.2. 再学習を行うことでモデルの出力分布が変わらないか</h4>
<div class="paragraph">
<p>こちらは、システムで運用する場合に発生しやすい問題です。例えば、投資する際の購入タイミングを、モデルの出力が0.8以上といったしきい値を用いた実装をしていたとします。この際に再学習を行うことでモデルの出力が変わると、想像以上に購入したり、逆に購入を実施しなくなったりします。再学習を行った場合、直近数週間程度のデータは利用せずに、古いモデルと新しいモデルで出力を比較し、出力の分布が変わっていないことを確認するのが良いでしょう。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_google_colaboratoryの使用法">7.13. Google Colaboratoryの使用法</h3>
<div class="paragraph">
<p>Google Colaboratoryは、ブラウザから Python をノートブック形式で記述、実行できるサービスです。環境構築が不要となっており、本チュートリアルもGoogle Colaboratoryで実行することが可能となっています。また、時間等の制限はございますがGPUを利用できることや、ノートブックの共有が簡単にできることなど、多くの利点を備えています (<a href="https://colab.research.google.com/notebooks/intro.ipynb?hl=ja#">参考元</a>  )。</p>
</div>
<div class="sect3">
<h4 id="_colab_でノートブックが動作する時間は">7.13.1. <strong>Colab でノートブックが動作する時間は？</strong></h4>
<div class="paragraph">
<p>本チュートリアルをGoogle Colaboratoryで実行する際には時間制限にご注意ください。ノートブックは、インスタンスが起動された後 12 時間経過すると自動的にランタイムがリセットされ実行環境が初期化されます。また、ノートブックのアイドル状態が 90 分続くとタイムアウトし、こちらもランタイムがリセットされます。(詳細は<a href="https://research.google.com/colaboratory/faq.html#:~:text=How%20long%20can%20notebooks%20run,or%20based%20on%20your%20usage">Google ColaboratoryのQ&amp;A</a>をご参照ください。)。</p>
</div>
</div>
<div class="sect3">
<h4 id="_2章でgoogle_colaboratoryを使用するために">7.13.2. 2章でGoogle Colaboratoryを使用するために</h4>
<div class="paragraph">
<p>本コンペの2章のチュートリアルをGoogle Colaboratory上で動かすためには、まず以下の手順でGoogle Drive上にファイルを設置します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Google DriveのMy Driveに<code>JPX_competition</code>というフォルダーを作成します。</p>
</li>
<li>
<p>SIGNATEのコンペティションサイトよりダウンロードした各種データを1で作成したフォルダーにアップロードします。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>次にGoogle Colaboratory上でチュートリアルのノートブックを展開します。ノートブックはGoogle Colaboratory上でも実行可能となっており、そのまま編集なしで実行できます。以下、具体的な方法を説明します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ノートブックをダウンロードします。 <a href="https://github.com/JapanExchangeGroup/J-Quants-Tutorial/blob/main/handson/Chapter02/20210121-chapter02-tutorial.ipynb">こちらのGithubリポジトリ</a>よりRawボタンを右クリックし、「リンク先を名前をつけて保存」を選択して先程作成した<code>JPX_competition</code>に保存してください。</p>
</li>
<li>
<p>Google Driveにアップロードした <code>20210121-chapter02-tutorial.ipynb</code> ファイルをダブルクリックして Google Colaboratory で開きます。</p>
</li>
<li>
<p>コンペティションデータをノートブックで読み込むために、Google Driveへマウントします。マウント方法については<a href="https://qiita.com/kado_u/items/45b76f9a6f920bf0f786">こちら</a>の記事をご参照ください。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_内国株の売買制度">7.14. 内国株の売買制度</h3>
<div class="paragraph">
<p>本節では、本コンペティションの題材となっている株式の売買制度について説明します。</p>
</div>
<div class="sect3">
<h4 id="_制限値幅">7.14.1. 制限値幅</h4>
<div class="paragraph">
<p>東京証券取引所では、一日の売買における値動きの幅を価格水準に応じて一定に制限しており、この値幅を <strong>制限値幅</strong> といいます。制限値幅は、前日の終値又は最終気配値段など（以下、「基準値段」と言います）を基準としており、その値幅の大きさは基準値段によって異なります。詳細は<a href="https://www.jpx.co.jp/equities/trading/domestic/06.html">こちら</a>をご参照ください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_呼値の単位">7.14.2. 呼値の単位</h4>
<div class="paragraph">
<p>内国株式の売買の注文をする際の値段の刻みことを <strong>呼値の単位</strong> といい、この呼値の単位は、売買の対象となる銘柄及びその値段の水準に応じて異なります。各値段の水準における詳細な呼値の単位については、<a href="https://www.jpx.co.jp/equities/trading/domestic/07.html">こちら</a>をご参照ください。なお、銘柄によっては呼値の単位は整数ではなく、小数点があるものもございますのでご留意ください。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_バックテスト用ライブラリ">7.15. バックテスト用ライブラリ</h3>
<div class="paragraph">
<p>有名なバックテスト/ポートフォリオライブラリとしてはZipline( <a href="https://github.com/quantopian/zipline" class="bare">https://github.com/quantopian/zipline</a> )やBacktrader( <a href="https://github.com/mementum/backtrader" class="bare">https://github.com/mementum/backtrader</a> )があります。Ziplineは人気のあるライブラリでしたが、開発元のQuantopianがなくなったため、現在開発が止まっています。Backtraderは機能が多用ですが、初心者には若干敷居が高いです。バックテストライブラリは定番と言えるものが無く、取引戦略を実装する場合、フレームワークは利用せず個別に自分の取引戦略に合致したバックテストのコードを書いて評価し、結果はmatplotlibなどの描画用ライブラリで直接描画することも多く、本チュートリアルもその方式を採用しています。</p>
</div>
<div class="paragraph">
<p>ポートフォリオを構築せずに、まずはポートフォリオを構築するための予測モデル自体の評価を情報係数(IC)や分位点リターンなどを利用して行うバックテストも存在します。その手法は本チュートリアルでは扱いませんが、qlib( <a href="https://github.com/microsoft/qlib" class="bare">https://github.com/microsoft/qlib</a> )やalphalense( <a href="https://github.com/quantopian/alphalens" class="bare">https://github.com/quantopian/alphalens</a> )などのライブラリに様々な方法が紹介されていますので、是非御覧ください。日本語ではあまり網羅的なサイトは無いのですが、書籍で紹介した「ファイナンス機械学習―金融市場分析を変える機械学習アルゴリズムの理論と実践」において網羅的な説明がされています。</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>ライブラリ名</strong></th>
<th class="tableblock halign-left valign-top"><strong>説明</strong></th>
<th class="tableblock halign-left valign-top"><strong>Github</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zipline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">イベント駆動型のアルゴリズムトレーディングのバックテストライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/quantopian/zipline" class="bare">https://github.com/quantopian/zipline</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">backtrader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バックテストとライブトレードのライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/mementum/backtrader" class="bare">https://github.com/mementum/backtrader</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">qlib</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoftの開発するAI投資向けのバックテストライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/microsoft/qlib" class="bare">https://github.com/microsoft/qlib</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alphalense</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">株式ファクターにフォーカスしたバックテストライブラリ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/quantopian/alphalens" class="bare">https://github.com/quantopian/alphalens</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_j_quantsapi">8. J-QuantsAPI</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_概要">8.1. 概要</h3>
<div class="paragraph">
<p>この章では、各種データをダウンロードできるJ-QuantsAPIについてご紹介します。APIの詳細な仕様はこちら("https://jpx-jquants.com/apidoc.html")をご確認ください。</p>
</div>
</div>
<div class="sect2">
<h3 id="_apiの利用">8.2. APIの利用</h3>
<div class="paragraph">
<p>APIを利用するには、SIGNATEでのコンペティションへのご登録とJ-QuantsAPIの利用登録が必要となります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_必要なパッケージのインポート">8.3. 必要なパッケージのインポート</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">json</span>
<span class="keyword">import</span> <span class="include">requests</span>
<span class="keyword">import</span> <span class="include">base64</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>パッケージ名</strong></th>
<th class="tableblock halign-left valign-top"><strong>目的</strong>　</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">os</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ディレクトリ、ファイル操作のため</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">json</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">レスポンスの加工のため</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">APIのGETやPOSTを利用するため</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">base64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TDnetのファイルダウンロードAPIでBase64形式で返ってくるデータをデコードするため</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_refresh_api">8.4. Refresh API</h3>
<div class="paragraph">
<p>はじめに、idTokenをリフレッシュするRefresh API("/refresh")をご紹介します。このAPIでは、J-Quantsのログイン後の画面でご確認いただくことができるrefreshTokenを使用します。</p>
</div>
<div class="paragraph">
<p>Refresh APIを使うためのサンプルコードは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">call_refresh_api</span>(refreshtoken: <span class="predefined">str</span>):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    idTokenをリフレッシュするメソッド。</span><span class="content">
</span><span class="content">
</span><span class="content">    Parameters</span><span class="content">
</span><span class="content">    ----------</span><span class="content">
</span><span class="content">    refreshtoken : str</span><span class="content">
</span><span class="content">        refreshtoken。ログイン後の画面からご確認いただけます。</span><span class="content">
</span><span class="content">
</span><span class="content">    Returns</span><span class="content">
</span><span class="content">    -------</span><span class="content">
</span><span class="content">    resjson : dict</span><span class="content">
</span><span class="content">        新しいidtokenが格納されたAPIレスポンス(json形式)</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    headers = {<span class="string"><span class="delimiter">&quot;</span><span class="content">accept</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>}
    data = {<span class="string"><span class="delimiter">&quot;</span><span class="content">refresh-token</span><span class="delimiter">&quot;</span></span>: refreshtoken}

    response = requests.post(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">https://api.jpx-jquants.com/refresh</span><span class="delimiter">&quot;</span></span>, headers=headers, data=json.dumps(data)
    )

    resjson = json.loads(response.text)
    <span class="keyword">return</span> resjson</code></pre>
</div>
</div>
<div class="paragraph">
<p>このAPIを使うことで新しいidtokenを払い出すことができます。使用例は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">refreshtoken = &lt;Your refreshtoken&gt;
call_refresh_api(refreshtoken)</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のようなレスポンスが返ります。なお、idtokenの有効期限は１時間（3600sec）となっております。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">idToken</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;Your New idtoken&gt;</span><span class="delimiter">&quot;</span></span>,
<span class="key"><span class="delimiter">&quot;</span><span class="content">expiresIn</span><span class="delimiter">&quot;</span></span>: <span class="integer">3600</span>}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_共通で使用するメソッド">8.5. 共通で使用するメソッド</h3>
<div class="paragraph">
<p>ここでは、API共通の関数を用意しております。</p>
</div>
<div class="paragraph">
<p>サンプルコードは以下の通りです。引数"apitype"に各APIを指定することで呼び出すことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">d</span><span class="error">e</span><span class="error">f</span> <span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">l</span><span class="error">_</span><span class="error">j</span><span class="error">q</span><span class="error">u</span><span class="error">a</span><span class="error">n</span><span class="error">t</span><span class="error">s</span><span class="error">_</span><span class="error">a</span><span class="error">p</span><span class="error">i</span><span class="error">(</span><span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span>: <span class="error">d</span><span class="error">i</span><span class="error">c</span><span class="error">t</span>, <span class="error">i</span><span class="error">d</span><span class="error">t</span><span class="error">o</span><span class="error">k</span><span class="error">e</span><span class="error">n</span>: <span class="error">s</span><span class="error">t</span><span class="error">r</span>, <span class="error">a</span><span class="error">p</span><span class="error">i</span><span class="error">t</span><span class="error">y</span><span class="error">p</span><span class="error">e</span>: <span class="error">s</span><span class="error">t</span><span class="error">r</span>, <span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span>: <span class="error">s</span><span class="error">t</span><span class="error">r</span> <span class="error">=</span> <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>:
    <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
    J-QuantsのAPIを試すメソッド。

    Parameters
    ----------
    params : dict
        リクエストパラメータ。
    idtoken : str
        idTokenはログイン後の画面からご確認いただけます。
    apitype: str
        APIの種類。</span><span class="delimiter">&quot;</span></span><span class="error">n</span><span class="error">e</span><span class="error">w</span><span class="error">s</span><span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span><span class="error">p</span><span class="error">r</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">s</span><span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span><span class="error">l</span><span class="error">i</span><span class="error">s</span><span class="error">t</span><span class="error">s</span><span class="string"><span class="delimiter">&quot;</span><span class="content">などがあります。
    code: str
        銘柄を指定するAPIの場合に設定します。

    Returns
    -------
    resjson : dict
        APIレスポンス(json形式)
    </span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
    <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">f</span><span class="error">r</span><span class="error">o</span><span class="error">m</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">datefrom</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">t</span><span class="error">o</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">dateto</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">i</span><span class="error">n</span><span class="error">c</span><span class="error">l</span><span class="error">u</span><span class="error">d</span><span class="error">e</span><span class="error">d</span><span class="error">e</span><span class="error">t</span><span class="error">a</span><span class="error">i</span><span class="error">l</span><span class="error">s</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="error">)</span>
    <span class="error">k</span><span class="error">e</span><span class="error">y</span><span class="error">w</span><span class="error">o</span><span class="error">r</span><span class="error">d</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">l</span><span class="error">i</span><span class="error">n</span><span class="error">e</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">n</span><span class="error">e</span><span class="error">x</span><span class="error">t</span><span class="error">t</span><span class="error">o</span><span class="error">k</span><span class="error">e</span><span class="error">n</span> <span class="error">=</span> <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span><span class="string"><span class="delimiter">&quot;</span><span class="content">nextToken</span><span class="delimiter">&quot;</span></span>, <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span><span class="error">)</span>
    <span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">e</span><span class="error">r</span><span class="error">s</span> <span class="error">=</span> {<span class="key"><span class="delimiter">&quot;</span><span class="content">accept</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>: <span class="error">i</span><span class="error">d</span><span class="error">t</span><span class="error">o</span><span class="error">k</span><span class="error">e</span><span class="error">n</span>}
    <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">a</span> <span class="error">=</span> {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">f</span><span class="error">r</span><span class="error">o</span><span class="error">m</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>: <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">t</span><span class="error">o</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">includeDetails</span><span class="delimiter">&quot;</span></span>: <span class="error">i</span><span class="error">n</span><span class="error">c</span><span class="error">l</span><span class="error">u</span><span class="error">d</span><span class="error">e</span><span class="error">d</span><span class="error">e</span><span class="error">t</span><span class="error">a</span><span class="error">i</span><span class="error">l</span><span class="error">s</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">nextToken</span><span class="delimiter">&quot;</span></span>: <span class="error">n</span><span class="error">e</span><span class="error">x</span><span class="error">t</span><span class="error">t</span><span class="error">o</span><span class="error">k</span><span class="error">e</span><span class="error">n</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>: <span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">e</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>: <span class="error">k</span><span class="error">e</span><span class="error">y</span><span class="error">w</span><span class="error">o</span><span class="error">r</span><span class="error">d</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>: <span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">l</span><span class="error">i</span><span class="error">n</span><span class="error">e</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span>,
    }

    <span class="error">i</span><span class="error">f</span> <span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span>:
        <span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span> <span class="error">=</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="error">+</span> <span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span>
        <span class="error">r</span> <span class="error">=</span> <span class="error">r</span><span class="error">e</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">s</span><span class="error">t</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span>
            <span class="string"><span class="delimiter">&quot;</span><span class="content">https://api.jpx-jquants.com/</span><span class="delimiter">&quot;</span></span> <span class="error">+</span> <span class="error">a</span><span class="error">p</span><span class="error">i</span><span class="error">t</span><span class="error">y</span><span class="error">p</span><span class="error">e</span> <span class="error">+</span> <span class="error">c</span><span class="error">o</span><span class="error">d</span><span class="error">e</span>,
            <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">=</span><span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">a</span>,
            <span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">=</span><span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">e</span><span class="error">r</span><span class="error">s</span>,
        <span class="error">)</span>
    <span class="error">e</span><span class="error">l</span><span class="error">s</span><span class="error">e</span>:
        <span class="error">r</span> <span class="error">=</span> <span class="error">r</span><span class="error">e</span><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">s</span><span class="error">t</span><span class="error">s</span><span class="error">.</span><span class="error">g</span><span class="error">e</span><span class="error">t</span><span class="error">(</span>
            <span class="string"><span class="delimiter">&quot;</span><span class="content">https://api.jpx-jquants.com/</span><span class="delimiter">&quot;</span></span> <span class="error">+</span> <span class="error">a</span><span class="error">p</span><span class="error">i</span><span class="error">t</span><span class="error">y</span><span class="error">p</span><span class="error">e</span>, <span class="error">p</span><span class="error">a</span><span class="error">r</span><span class="error">a</span><span class="error">m</span><span class="error">s</span><span class="error">=</span><span class="error">d</span><span class="error">a</span><span class="error">t</span><span class="error">a</span>, <span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">=</span><span class="error">h</span><span class="error">e</span><span class="error">a</span><span class="error">d</span><span class="error">e</span><span class="error">r</span><span class="error">s</span>
        <span class="error">)</span>
    <span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">j</span><span class="error">s</span><span class="error">o</span><span class="error">n</span> <span class="error">=</span> <span class="error">j</span><span class="error">s</span><span class="error">o</span><span class="error">n</span><span class="error">.</span><span class="error">l</span><span class="error">o</span><span class="error">a</span><span class="error">d</span><span class="error">s</span><span class="error">(</span><span class="error">r</span><span class="error">.</span><span class="error">t</span><span class="error">e</span><span class="error">x</span><span class="error">t</span><span class="error">)</span>
    <span class="error">r</span><span class="error">e</span><span class="error">t</span><span class="error">u</span><span class="error">r</span><span class="error">n</span> <span class="error">r</span><span class="error">e</span><span class="error">s</span><span class="error">j</span><span class="error">s</span><span class="error">o</span><span class="error">n</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stock_lists_api">8.6. Stock Lists API</h3>
<div class="paragraph">
<p>銘柄一覧を取得するAPIについて紹介いたします。</p>
</div>
<div class="paragraph">
<p>このAPIでは、企業名や業種区分などの基本情報を取得することができます。全銘柄の一覧を取得する"/lists"と銘柄コードを指定した"/lists/{code}"が利用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
<span class="comment"># Codeを指定しない場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">lists</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># Codeを指定する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">lists</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">list</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">33 Sector(name)</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Other Financing Business</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Effective Date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20201230</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">prediction_target</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Section/Products</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">First Section (Domestic)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">33 Sector(Code)</span><span class="delimiter">&quot;</span></span>: <span class="float">7200.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Name (English)</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Japan Exchange Group,Inc.</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">IssuedShareEquityQuote IssuedShare</span><span class="delimiter">&quot;</span></span>: <span class="float">536351448.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>}]}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prices_api">8.7. Prices API</h3>
<div class="paragraph">
<p>株価情報を取得するPrice APIをご紹介します。</p>
</div>
<div class="paragraph">
<p>検索期間や銘柄コードを指定することで、四本値、売買高、前日比変化率などを取得することができます。銘柄コードを指定する場合は"/prices/{code}"でAPIをご利用ください。"includeDetails"をTrueにした場合は、全てのデータ系列を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
<span class="comment"># Codeを指定しない場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-12-30</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">prices</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># Codeを指定する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">datefrom</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-17</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">dateto</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-31</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">prices</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスのサンプルは以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">prices</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>: <span class="float">2005.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1972.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote CumulativeAdjustmentFactor</span><span class="delimiter">&quot;</span></span>: <span class="float">1.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote VWAP</span><span class="delimiter">&quot;</span></span>: <span class="float">1994.792</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Low</span><span class="delimiter">&quot;</span></span>: <span class="float">1989.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1972.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote High</span><span class="delimiter">&quot;</span></span>: <span class="float">2008.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/20</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Close</span><span class="delimiter">&quot;</span></span>: <span class="float">1990.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousExchangeOfficialCloseDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/17</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1990.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ChangeFromPreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">18.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PercentChangeFromPreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">0.913</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousCloseDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/17</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Volume</span><span class="delimiter">&quot;</span></span>: <span class="float">528600.0</span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Open</span><span class="delimiter">&quot;</span></span>: <span class="float">1989.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1990.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote CumulativeAdjustmentFactor</span><span class="delimiter">&quot;</span></span>: <span class="float">1.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote VWAP</span><span class="delimiter">&quot;</span></span>: <span class="float">1976.539</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Low</span><span class="delimiter">&quot;</span></span>: <span class="float">1965.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1990.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote High</span><span class="delimiter">&quot;</span></span>: <span class="float">1995.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/21</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Close</span><span class="delimiter">&quot;</span></span>: <span class="float">1977.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousExchangeOfficialCloseDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/20</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ExchangeOfficialClose</span><span class="delimiter">&quot;</span></span>: <span class="float">1977.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote ChangeFromPreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">-13.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PercentChangeFromPreviousClose</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.653</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote PreviousCloseDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/20</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">EndOfDayQuote Volume</span><span class="delimiter">&quot;</span></span>: <span class="float">571000.0</span>},
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>]}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stock_fins_api">8.8. Stock Fins API</h3>
<div class="paragraph">
<p>各銘柄の財務諸表データを取得するAPIをご紹介します。</p>
</div>
<div class="paragraph">
<p>特定の日の全銘柄の情報を取得する"/stockfins"と１銘柄の情報を取得する"/stockfins/{code}"がございます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
<span class="comment"># Codeを指定しない場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-12-30</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">stockfins</span><span class="delimiter">&quot;</span></span>)


<span class="comment"># Codeを指定する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">datefrom</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">dateto</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-12-30</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">stockfins</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">stockfin</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement TotalAssets</span><span class="delimiter">&quot;</span></span>: <span class="float">56671198.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/01/30</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement FiscalPeriodEnd</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019/12</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Q3</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OrdinaryIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">48586.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromOperatingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>: <span class="float">87433.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromFinancingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromInvestingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement AccountingStandard</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ConsolidatedIFRS</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">33317.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">48176.0</span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement TotalAssets</span><span class="delimiter">&quot;</span></span>: <span class="float">56671198.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020/03/23</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement FiscalPeriodEnd</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2019/12</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement ReportType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Q3</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OrdinaryIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">48586.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromOperatingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetSales</span><span class="delimiter">&quot;</span></span>: <span class="float">87433.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromFinancingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement CashFlowsFromInvestingActivities</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement AccountingStandard</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ConsolidatedIFRS</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement NetIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">33317.0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Result_FinancialStatement OperatingIncome</span><span class="delimiter">&quot;</span></span>: <span class="float">48176.0</span>}]}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stock_labels_api">8.9. Stock Labels API</h3>
<div class="paragraph">
<p>基準日から一定期間の株価の最大上昇率、最大下落率を取得するAPIをご紹介します。</p>
</div>
<div class="paragraph">
<p>Stock Labels APIは期間や銘柄コードを指定することで該当する株価騰落率のデータを取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Codeを指定しない場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2018-05-31</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">stocklabels</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># Codeを指定する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-01</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-28</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">stocklabels</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1301</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスのサンプルは以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">labels</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_10</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.01748</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.10699</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_5</span><span class="delimiter">&quot;</span></span>: <span class="float">0.0021</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>: <span class="float">0.02203</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-04</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_10</span><span class="delimiter">&quot;</span></span>: <span class="float">0.02203</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_5</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-12</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_10</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-19</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_5</span><span class="delimiter">&quot;</span></span>: <span class="float">0.02203</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_20</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-03-05</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1301</span><span class="delimiter">&quot;</span></span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_10</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.02507</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_20</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.11072</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_low_5</span><span class="delimiter">&quot;</span></span>: <span class="float">-0.00557</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_20</span><span class="delimiter">&quot;</span></span>: <span class="float">0.01776</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">base_date</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-05</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_10</span><span class="delimiter">&quot;</span></span>: <span class="float">0.01776</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_5</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-13</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_10</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-20</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_high_5</span><span class="delimiter">&quot;</span></span>: <span class="float">0.01776</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">label_date_20</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-03-06</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Local Code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1301</span><span class="delimiter">&quot;</span></span>}],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">scrollId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">eyJMb2NhbCBDb2RlIjogIjEzMDEiLCAiYmFzZV9kYXRlIjogIjIwMjAtMDItMDUifQ==</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_news_api">8.10. News API</h3>
<div class="paragraph">
<p>日経新聞の記事情報を取得するAPIをご紹介します。</p>
</div>
<div class="paragraph">
<p>News APIはヘッドライン、キーワード、期間などで該当するニュース記事データを検索できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">datefrom</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-01</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">dateto</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-25</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">日本取引所</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">keyword</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">エネルギー</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">news</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスフィールドの詳細は以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>media_code: 媒体の略号です。今回は"TNY"のデータのみ提供しております。</p>
</li>
<li>
<p>men_name: 面の名前です。地方経済面の場合などに収録されますが、今回は全て""です。</p>
</li>
<li>
<p>headline: 見出しです。改行コード"\n"が含まれます。</p>
</li>
<li>
<p>keywords: 記事の文中から主題語として切り出したキーワードです。改行コード"\n"でそれぞれのキーワードが区切られております。</p>
</li>
<li>
<p>classifications: 記事の分類です。当該記事に紐づくさまざまなコードが収録されております。マスタデータは
<a href="https://jquantsmastertable.s3-ap-northeast-1.amazonaws.com/newsmaster.zip">こちら</a>からダウンロードいただけます。</p>
<div class="ulist">
<ul>
<li>
<p>"＃W〜": 記事の主題を表す内容別の136分類です。分類体系は「企業活動」（大分類：企業）と「企業を取り巻く環境」（大分類：政治・経済・技術・社会）から構成しております。マスタデータはtheme.csvをご参照ください。</p>
</li>
<li>
<p>"＃B〜": 記事の主題と関連する業界別の63分類です。日経新業種分類を元に定義しております。マスタデータはindustry.csvをご参照ください。</p>
</li>
<li>
<p>"＃A〜": 記事の主題と関連する地域別に「海外地域」「国」「国内地域」単位で分類しております。マスタデータはregion.csvをご参照ください。</p>
</li>
<li>
<p>"＃K〜": 記事種別です。記事のタイプ別に７種類に分類しております。</p>
</li>
<li>
<p>"＃T〜": 株式コードです。</p>
</li>
<li>
<p>"＃N〜": 日経会社コードです。</p>
</li>
<li>
<p>"＃PD〜": 業界コードです。株式コードおよび一部主要企業の日経会社コードを一括して指定可能なコードです。マスタデータはindustry2.csvをご参照ください。</p>
</li>
<li>
<p>コラム名: 主要なコラムや大型連載記事が検索可能です。例えば「春秋」など。</p>
</li>
<li>
<p>"＄〜": 記事分類キーワードです。新聞を紙面単位で指定可能です。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>レスポンスのサンプルは以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">news</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">article_id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">TDSKDBDGXLASFL21HM9_21022020000000</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">publish_datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-21T16:34:00Z</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">media_code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">TNY</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">media_name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">日本経済新聞電子版</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">men_name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">headline</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">日本取引所ＣＥＯ、東商取のエネルギー市場「早期に統合したい」</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">keywords</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">最高経営責任者</span><span class="char">\n</span><span class="content">東京商品取引所</span><span class="char">\n</span><span class="content">日本取引所グループ</span><span class="char">\n</span><span class="content">清田瞭</span><span class="char">\n</span><span class="content">エネルギー市場</span><span class="char">\n</span><span class="content">大阪取引所</span><span class="char">\n</span><span class="content">統合</span><span class="char">\n</span><span class="content">定例</span><span class="char">\n</span><span class="content">早期</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">classifications</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Ｔ８６９７</span><span class="char">\n</span><span class="content">ＰＤ５２１</span><span class="char">\n</span><span class="content">Ｎ００４０４３１</span><span class="char">\n</span><span class="content">Ｎ００７５１０７</span><span class="char">\n</span><span class="content">Ｎ００４０７７９</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">stock_code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>}],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">scrollId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FGluY2x1ZGVfY29u</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tdnet_api">8.11. TDnet API</h3>
<div class="paragraph">
<p>適時開示を取得できるTDnetAPIを紹介します。</p>
</div>
<div class="paragraph">
<p>TDnetAPIはTDnetで開示された資料に関する情報を取得、またはダウンロードすることができるapiです。</p>
</div>
<div class="paragraph">
<p>資料に関する情報を取得するAPIは、通常は("/tdfiles")、銘柄コードを指定する場合は、”/tdnet/{code}でAPIをご利用ください。
"includeDetails"をTrueにした場合は、全てのデータ系列を取得します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
<span class="comment"># Codeを指定しない場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-12-30</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># Codeを指定する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">datefrom</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-01</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">dateto</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-02-28</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">includedetails</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">True</span><span class="delimiter">&quot;</span></span>
call_jquants_api(paramdict, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">8697</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>レスポンスのサンプルは以下のようになります。なおdisclosureItemsは公開項目コードを示します。一覧はこちらからダウンロードください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>: [{<span class="key"><span class="delimiter">&quot;</span><span class="content">pdfSumaryFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">modifiedHistory</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ＪＰＸ</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">11384</span><span class="delimiter">&quot;</span></span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">86970</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosedDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-30</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-30:12:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">handlingType</span><span class="delimiter">&quot;</span></span>: <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosedTime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">12:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">pdfGeneralFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20200129453073</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">xbrlFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020年３月期 第３四半期決算短信〔ＩＦＲＳ〕（連結） </span><span class="delimiter">&quot;</span></span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">pdfSumaryFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">modifiedHistory</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ＪＰＸ</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">11804</span><span class="delimiter">&quot;</span></span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">86970</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosedDate</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-30</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2020-01-30:12:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">handlingType</span><span class="delimiter">&quot;</span></span>: <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosedTime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">12:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">pdfGeneralFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20200129453074</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">xbrlFlag</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Consolidated financial results for the nine months ended December 31, 2019</span><span class="delimiter">&quot;</span></span>},
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>公開項目コードを用いると出力結果を絞ることが可能です。
例えば、第三四半期決算短信（連結・日本基準・公開項目コード11310）は以下のようなコードとなります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">resp = call_jquants_api({}, idtk, <span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>)
[f <span class="keyword">for</span> f <span class="keyword">in</span> resp[<span class="string"><span class="delimiter">&quot;</span><span class="content">tdnet</span><span class="delimiter">&quot;</span></span>] <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">11310</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> f[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>こちらのコードを実行すると、第3四半期決算短信のみ抽出することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Ｊ－インターライフ</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">11310</span><span class="delimiter">&quot;</span></span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021-01-13:16:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">14180</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">handlingType</span><span class="delimiter">&quot;</span></span>: <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20210112443207</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021年２月期</span><span class="char">\u3000</span><span class="content">第３四半期決算短信〔日本基準〕（連結）</span><span class="delimiter">&quot;</span></span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Ｓ</span><span class="char">\u3000</span><span class="content">ＦＯＯＤＳ</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">11310</span><span class="delimiter">&quot;</span></span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021-01-13:15:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">22920</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">handlingType</span><span class="delimiter">&quot;</span></span>: <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20210113443358</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021年２月期第３四半期決算短信〔日本基準〕(連結)</span><span class="delimiter">&quot;</span></span>},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">いちご</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureItems</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">11310</span><span class="delimiter">&quot;</span></span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datetime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021-01-13:15:00:00</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">23370</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">handlingType</span><span class="delimiter">&quot;</span></span>: <span class="error">N</span><span class="error">o</span><span class="error">n</span><span class="error">e</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">20210113443616</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2021年2月期 第3四半期 決算短信〔日本基準〕（連結）</span><span class="delimiter">&quot;</span></span>},
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>このAPIのレスポンスのdisclosureNumberを用いることで、PDFファイルやXBRLファイルを取得する(/tdfiles)もございます。</p>
</div>
<div class="paragraph">
<p>決算短信はサマリ-PDF("fileTypeFlag"が"s")やXBRL("fileTypeFlag"が"x")をダウンロードすることができます。そのほかの資料は全文PDFのみですので、("fileTypeFlag"が"g")をご指定ください。</p>
</div>
<div class="paragraph">
<p>ただし、これらのファイルが取得できるものは2020年以降開示されたものに限ります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">call_tdfiles_api</span>(params: <span class="predefined">dict</span>, idtoken: <span class="predefined">str</span>, outputdir: str = <span class="predefined-constant">None</span>):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    TDnetで開示された資料をダウンロードするAPI。</span><span class="content">
</span><span class="content">
</span><span class="content">    Parameters</span><span class="content">
</span><span class="content">    ----------</span><span class="content">
</span><span class="content">    params : dict</span><span class="content">
</span><span class="content">        リクエストパラメータ。</span><span class="content">
</span><span class="content">    idtoken : str</span><span class="content">
</span><span class="content">        idtokenはログイン後の画面からご確認いただけます。</span><span class="content">
</span><span class="content">    outputdir : str</span><span class="content">
</span><span class="content">        ダウンロードしたファイルを格納するフォルダパスを指定いただけます。</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    disclnum = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosurenumber</span><span class="delimiter">&quot;</span></span>)
    ftype = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">filetypeflag</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">g</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">if</span> <span class="keyword">not</span> outputdir:
        outputdir = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>

    headers = {<span class="string"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>: idToken, <span class="string"><span class="delimiter">&quot;</span><span class="content">accept</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>}
    data = {<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosureNumber</span><span class="delimiter">&quot;</span></span>: disclnum, <span class="string"><span class="delimiter">&quot;</span><span class="content">fileTypeFlag</span><span class="delimiter">&quot;</span></span>: ftype}

    r = requests.get(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">https://api.jpx-jquants.com/tdfiles</span><span class="delimiter">&quot;</span></span>, params=data, headers=headers
    )
    resjson = json.loads(r.text)

    <span class="keyword">if</span> resjson[<span class="string"><span class="delimiter">&quot;</span><span class="content">responseType</span><span class="delimiter">&quot;</span></span>] == <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>:
        bjson = resjson[<span class="string"><span class="delimiter">&quot;</span><span class="content">fileData</span><span class="delimiter">&quot;</span></span>].encode()
    <span class="keyword">elif</span> resjson[<span class="string"><span class="delimiter">&quot;</span><span class="content">responseType</span><span class="delimiter">&quot;</span></span>] == <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>:
        filedata = requests.get(resjson[<span class="string"><span class="delimiter">&quot;</span><span class="content">fileUrl</span><span class="delimiter">&quot;</span></span>]).text
        bjson = filedata.encode()

    <span class="keyword">if</span> ftype == <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>:
        fname = outputdir + <span class="string"><span class="delimiter">&quot;</span><span class="content">/x_</span><span class="delimiter">&quot;</span></span> + disclnum + <span class="string"><span class="delimiter">&quot;</span><span class="content">.zip</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">elif</span> ftype == <span class="string"><span class="delimiter">&quot;</span><span class="content">g</span><span class="delimiter">&quot;</span></span>:
        fname = outputdir + <span class="string"><span class="delimiter">&quot;</span><span class="content">/g_</span><span class="delimiter">&quot;</span></span> + disclnum + <span class="string"><span class="delimiter">&quot;</span><span class="content">.pdf</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">elif</span> ftype == <span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>:
        fname = outputdir + <span class="string"><span class="delimiter">&quot;</span><span class="content">/s_</span><span class="delimiter">&quot;</span></span> + disclnum + <span class="string"><span class="delimiter">&quot;</span><span class="content">.pdf</span><span class="delimiter">&quot;</span></span>

    <span class="keyword">with</span> <span class="predefined">open</span>(fname, <span class="string"><span class="delimiter">&quot;</span><span class="content">wb</span><span class="delimiter">&quot;</span></span>) <span class="keyword">as</span> theFile:
        theFile.write(base64.b64decode(bjson))

    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Finish Download: </span><span class="delimiter">&quot;</span></span> + disclnum)</code></pre>
</div>
</div>
<div class="paragraph">
<p>このメソッドを利用することで、base64形式のデータをファイルに書き出すことが可能です。実際にこのメソッドを利用する方法は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">idtk=&lt;your idtoken&gt;
<span class="comment"># 出力フォルダを指定</span>
outputdir = <span class="string"><span class="delimiter">&quot;</span><span class="content">./</span><span class="delimiter">&quot;</span></span>
<span class="comment"># 全文PDFを取得する場合</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosurenumber</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">20200129453073</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">filetypeflag</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">g</span><span class="delimiter">&quot;</span></span>
call_tdfiles_api(paramdict, idtk, outputdir)

<span class="comment"># サマリーPDFを取得する場合（決算短信で指定可能です）</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosurenumber</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">20200129453073</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">filetypeflag</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>
call_tdfiles_api(paramdict, idtk, outputdir)

<span class="comment"># XBRLデータを取得する場合（決算短信で指定可能です）</span>
paramdict = {}
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">disclosurenumber</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">20200129453073</span><span class="delimiter">&quot;</span></span>
paramdict[<span class="string"><span class="delimiter">&quot;</span><span class="content">filetypeflag</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>
call_tdfiles_api(paramdict, idtk, outputdir)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_チュートリアル作成環境の参考文献">9. チュートリアル作成環境の参考文献</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本文書の執筆では次のプロダクトと技術資料が使われています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="注記"></i>
</td>
<td class="content">
プロダクト名の隣にライセンスを併記しております。
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Template</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>AsciidoctorとGradleでつくる文書執筆環境 - MIT License -
<a href="https://h1romas4.github.io/asciidoctor-gradle-template/index.html" class="bare">https://h1romas4.github.io/asciidoctor-gradle-template/index.html</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Font</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>源真ゴシック - SIL Open Font License 1.1  - <a href="http://jikasei.me/font/genshin/" class="bare">http://jikasei.me/font/genshin/</a></p>
</li>
<li>
<p>源様明朝 - SIL Open Font License 1.1 - <a href="https://github.com/ButTaiwan/genyo-font" class="bare">https://github.com/ButTaiwan/genyo-font</a></p>
</li>
<li>
<p>Ricty Diminished - SIL Open Font License 1.1 - <a href="https://github.com/edihbrandon/RictyDiminished" class="bare">https://github.com/edihbrandon/RictyDiminished</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Asciidoc</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Asciidoctor - MIT License - <a href="https://asciidoctor.org/" class="bare">https://asciidoctor.org/</a></p>
</li>
<li>
<p>Asciidoctorj - Apache License 2.0 - <a href="https://github.com/asciidoctor/asciidoctorj" class="bare">https://github.com/asciidoctor/asciidoctorj</a></p>
</li>
<li>
<p>Asciidoctor.js - MIT License - <a href="https://asciidoctor.org/docs/asciidoctor.js/" class="bare">https://asciidoctor.org/docs/asciidoctor.js/</a></p>
</li>
<li>
<p>Asciidoctor PDF - MIT License - <a href="https://asciidoctor.org/docs/asciidoctor-pdf/" class="bare">https://asciidoctor.org/docs/asciidoctor-pdf/</a></p>
</li>
<li>
<p>Asciidoctor Gradle Plugin Suite - Apache License 2.0 - <a href="https://github.com/asciidoctor/asciidoctor-gradle-plugin" class="bare">https://github.com/asciidoctor/asciidoctor-gradle-plugin</a></p>
</li>
<li>
<p>asciidoctor-pdf-linewrap-ja - MIT License - <a href="https://github.com/fuka/asciidoctor-pdf-linewrap-ja" class="bare">https://github.com/fuka/asciidoctor-pdf-linewrap-ja</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Build Tool</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>SDKMAN - Apache License 2.0 - <a href="https://sdkman.io/" class="bare">https://sdkman.io/</a></p>
</li>
<li>
<p>Gradle - Apache License 2.0 - <a href="https://gradle.org/" class="bare">https://gradle.org/</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Text Editor</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Visual Studio Code - Microsoft - <a href="https://code.visualstudio.com/" class="bare">https://code.visualstudio.com/</a></p>
</li>
<li>
<p>asciidoctor-vscode - MIT License - <a href="https://github.com/asciidoctor/asciidoctor-vscode" class="bare">https://github.com/asciidoctor/asciidoctor-vscode</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Guide</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>asciidoctor-pdfでかっこいいPDFを作る - <a href="https://qiita.com/kuboaki/items/67774c5ebd41467b83e2" class="bare">https://qiita.com/kuboaki/items/67774c5ebd41467b83e2</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">OGP</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Socialify - <a href="https://github.com/wei/socialify" class="bare">https://github.com/wei/socialify</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="_商標">9.1. 商標</h3>
<div class="ulist">
<ul>
<li>
<p>Windows、PowerShellは、Microsoft Corporation の登録商標または商標です。</p>
</li>
<li>
<p>Docker は、Docker Inc.の登録商標または商標です。</p>
</li>
<li>
<p>CoLaboratory™ は、Google Inc. の登録商標または商標です。</p>
</li>
<li>
<p>GitHub は、GitHub Inc.の登録商標または商標です</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ライセンス">10. ライセンス</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本チュートリアルおよびハンズオンのソースコードは <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a> に従うライセンスで公開しています。</p>
</div>
<div class="paragraph">
<p>教育など非商用の目的での本チュートリアルの使用や再配布は自由に行うことが可能です。
商用目的で本チュートリアルの全体またはその一部を無断で転載する行為は，これを固く禁じます。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="ChapterLicence/images/cc_by_nc_nd.png" alt="cc_by_nc_nd.png" width="400">
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
最終更新 2021-04-09 18:28:23 +0900
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "AMS" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>